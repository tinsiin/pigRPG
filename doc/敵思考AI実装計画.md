# 敵思考AI実装計画

本書は敵の思考AIシステムの実装計画をまとめたもの。現状は大部分が未実装であり、将来の設計方針を記録する。

関連仕様書:
- `doc/友情コンビ登録システム仕様書.md` — コンビの登録・再登場（§9で責務分離を定義）
- `doc/総合戦闘仕様書.md` — 戦闘メカニクス全般

関連メモ:
- `豚岬フォルダ/敵思考AI.md` — ユーザーの構想メモ（未実装多数）

---

## 1. 現状

### 既存の構想（メモより）

- スキル攻撃性質、スキル分散性質、敵HP、精神属性相性などを思考に利用
- ベストダメージ分析AI、デフォルトスキル選別などの部品構想
- 埋め込みScriptableObjectによる**キャラ個別の手書きAI**
- 戦闘後の行動AI（ヒール、付与スキル、復活スキル等）

### 課題

手書きAIは**固定グループ**には向いているが、友情コンビ登録システムで生まれる**ランダムな組み合わせ**には対応できない。誰と組むかわからない状況で「相方のスキルを知っている前提の連携」を実現するには、汎用的な協調行動の仕組みが必要。

---

## 2. 友情コンビのための協調行動AI（案）

友情コンビ登録システム（`doc/友情コンビ登録システム構想書.md`）が「誰と誰が一緒に出るか」を決定した後、「一緒に出た上でどう戦うか」を担う汎用レイヤー。

### 2.1 設計方針

- 特定のスキル組み合わせをハードコードしない
- 誰と組んでも機能する**汎用ルール**で構成する
- 既存の手書きAI（固定キャラの個性）はそのまま残し、**上に被せるオーバーレイ**として機能させる

### 2.2 三層構造

#### 第1層: スキルロールタグ

スキルに抽象的な「役割」タグを付与する。個別スキルの中身を知らなくても、相方のスキル構成を抽象的に認識できるようにする。

```
例:
  炎撃スキル   → [攻撃, 単体, 高火力]
  毒霧スキル   → [デバフ, 範囲]
  治癒スキル   → [回復, 単体]
  鼓舞スキル   → [バフ, 味方対象]
```

タグの付与はスキル定義時に1回だけ行う。ランタイムで動的に変わることはない。

**想定タグ候補**（暫定、追加・削除あり）:

| タグ | 意味 |
|---|---|
| 攻撃 | ダメージを与える |
| 高火力 | 単発で大ダメージ |
| 範囲 | 複数対象 |
| デバフ | 相手を弱体化 |
| バフ | 味方を強化 |
| 回復 | HPを回復 |
| 味方対象 | 味方にかけるスキル |

#### 第2層: リアクティブ行動ルール

事前計画ではなく、**相方の直前の行動に確率的に反応する**汎用ルール群。

| トリガー（相方の行動） | 反応（自分の行動調整） |
|---|---|
| 相方がデバフを使った | 同じ対象を攻撃する確率UP |
| 相方が同じ敵を攻撃した | 自分もその敵に集中する確率UP |
| 相方のHPが低い | 回復/バフスキルの優先度UP |
| 相方が死亡した | 殺した敵を狙う確率UP |
| 相方が高火力スキルを持っている | 自分のデバフスキルの優先度UP（お膳立て） |

これらは**具体的なスキル名に依存しない**。第1層のロールタグを参照するだけ。

#### 第3層: コンビフラグによる有効化

友情コンビ登録システムが提供するフラグで、第1・2層の行動を制御する。

| グループの状態 | 協調行動 |
|---|---|
| 通常ランダムグループ（未登録） | 無効。各自バラバラに行動 |
| 登録済みコンビ | 有効。相方を意識した行動を取る |
| 再遭遇回数が多い | 反応確率がさらに上昇（練度） |

### 2.3 動作例

```
登録済みコンビ: 敵A（高火力スキル持ち）+ 敵B（デバフスキル持ち）

戦闘開始時:
  Aが相方Bのスキルリストをロールタグで確認
  → 「Bはデバフ持ち」と認識
  → Aの高火力スキルの優先度を一時的に下げる（温存）

ターン1:
  Bがデバフスキルを味方キャラXに使用

ターン2（リアクティブ反応）:
  Aが「相方がデバフを使った」トリガーを検知
  → 同じ対象（味方X）への攻撃確率UP
  → 温存していた高火力スキルの優先度が跳ね上がる
  → Aが味方Xに高火力スキルを使用

結果: プレイヤーから見ると「BがデバフしてAが殴る」連携に見える
```

### 2.4 手書きAIとの共存

```
┌─────────────────────────────┐
│ 手書きAI（ScriptableObject）    │ ← 固定キャラの個性。優先度高
│ 「このキャラは回復を優先する」等  │
├─────────────────────────────┤
│ 協調行動オーバーレイ（本案）      │ ← 汎用。コンビ登録時のみ有効
│ ロールタグ認識 + リアクティブ反応  │
├─────────────────────────────┤
│ デフォルト行動                   │ ← 手書きも協調もない場合のフォールバック
│ ランダムなスキル選択等            │
└─────────────────────────────┘

判定順: 手書きAI → 協調行動 → デフォルト
```

手書きAIが明示的に行動を指定している場合はそちらが優先。協調行動は手書きが指定しなかった部分を埋める補助的な役割。

---

## 3. 未決事項

| # | 項目 | 内容 |
|---|---|---|
| 1 | ロールタグの確定リスト | どのタグを用意するか |
| 2 | リアクティブルールの確率値 | 各トリガーの反応確率 |
| 3 | 練度（再遭遇回数）の影響度 | 何回再遭遇で何%上昇するか |
| 4 | 手書きAIとの優先度競合 | 手書きが協調行動と矛盾する場合の解決方法 |
| 5 | デフォルト行動の仕様 | 手書きも協調もない場合のフォールバック行動 |
| 6 | 既存のAIメモとの統合 | 敵思考AI.md の構想との整合性確認 |

---

## 改訂履歴

| 日付 | 内容 |
|---|---|
| 2026-02-27 | 初版作成。友情コンビのための協調行動AI案を記録 |
