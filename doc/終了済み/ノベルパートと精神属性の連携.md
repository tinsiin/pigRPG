# ノベルパートと精神属性の連携

精神属性可視化（P3-7）の設計ドキュメント。

> **ステータス**: ✅ 実装完了（2026-01-27）
> - Phase 1-3 実装済み
> - 立ち絵描き分け（Phase 4）は不要と判断（精神属性は内面概念、表情とは別軸）
> - **CharacterId化**: 新キャラクター追加システム対応で `AllyId` → `CharacterId` に移行予定
>   - 詳細: [新キャラクター追加システム設計.md](../新キャラクター追加システム設計.md) Phase G

## 関連ドキュメント

- [ノベルパート設計.md](../ノベルパート/ノベルパート設計.md)
- [ノベルパート未実装機能一覧.md](../ノベルパート/ノベルパート未実装機能一覧.md)

---

## 設計方針（確定）

### 主人公システム

**コンセプト**: ノベルパートに「主人公（protagonist）」を設定し、精神属性関連の処理対象とする

```
┌─────────────────────────────────────────┐
│  ノベルパート画面                         │
│                                         │
│   [左立ち絵]              [右立ち絵]     │
│                                         │
│   ┌─────────────────────────────────┐   │
│   │ 協力する[Doremis]               │   │
│   │ 断る[Psycho]                     │   │
│   │ 無視する[Sacrifaith]            │   │
│   └─────────────────────────────────┘   │
│                                         │
│   主人公: Geino (現在の精神属性: Pillar)  │
└─────────────────────────────────────────┘
```

### 設定方法（シリアライズ対応）

**Critical**: Unity の `Nullable<T>` はシリアライズ非対応のため、フラグ+値パターンを使用

```csharp
// NovelDialogueStep に追加
[SerializeField] private bool hasProtagonist;
[SerializeField] private CharacterId protagonist;  // ※ AllyId → CharacterId に変更

public CharacterId? GetProtagonist() => hasProtagonist ? protagonist : null;
```

- 主人公は NovelDialogueStep で明示的に設定（暗黙ルールなし）
- 立ち絵配置（左/右）とは独立
- 主人公未設定時は精神属性表示をスキップ
- **CharacterId**: 文字列ベースのID（"geino", "noramlia", "sites", 新キャラも同様）

### 精神属性の2つの用途（明確化）

| 用途 | データソース | 説明 |
|------|-------------|------|
| **選択肢タグ** | `DialogueChoice.SpiritProperty` | 「この選択肢を選ぶとこの属性に染まる」という表示 |
| **現在の精神属性** | `protagonist.MyImpression` | 主人公の現在の精神属性（ディノイドモード等で表示） |

**重要**: 選択肢タグはデータ駆動の静的表示。実際の属性変化はEffectで行う（自動変化なし）。

### 選択肢表示

```
選択肢の文章[精神属性]
```

例: `協力する[Doremis]`、`断る[Psycho]`

- `[精神属性]` は `DialogueChoice.SpiritProperty`（string型）をそのまま表示
- 空の場合は `[]` 部分を非表示

---

## 1. 現状分析

### 1.1. 精神属性（SpiritualProperty）の定義

**場所**: `Assets/Script/BaseStates/BaseStates.StatesState.cs`

```csharp
[Flags]
public enum SpiritualProperty
{
    Doremis = 1 << 0,           // ドレミス
    Pillar = 1 << 1,            // ピラー
    Kindergarten = 1 << 2,      // キンダーガーデン
    LiminalWhiteTile = 1 << 3,  // リミナルホワイトタイル
    Sacrifaith = 1 << 4,        // サクリフェイス
    Cquiest = 1 << 5,           // シークエスト
    Psycho = 1 << 6,             // サイコ
    GodTier = 1 << 7,           // ゴッドティア
    BaleDrival = 1 << 8,        // ベールドライバル
    devil = 1 << 9,             // デビル
    none = 1 << 10,             // なし（補正なし）
    Mvoid = 1 << 11,            // 特殊: 属性消去
    Galvanize = 1 << 12,        // 特殊: 属性奪取
    air = 1 << 13,              // 特殊: 中立
    memento = 1 << 14           // 特殊: デフォルト回帰
}
```

**特徴**:
- `[Flags]`属性により複数属性を組み合わせ可能
- 15種類（うち5つは特殊属性: none, Mvoid, Galvanize, air, memento）
- 戦闘補正、パワー変化、十日能力成長に影響
- UI表示時は単一属性を想定（複合属性の場合は主要なものを表示）

### 1.2. BaseStatesでの精神属性管理

```csharp
// BaseStates.StatesState.cs
public SpiritualProperty MyImpression { get; protected set; }  // 現在の精神属性
public SpiritualProperty DefaultImpression;                     // デフォルト精神属性

public bool HasCharacterImpression(SpiritualProperty imp)
{
    if ((int)imp == -1) return true;  // "Everything" 対応
    return (MyImpression & imp) == imp;
}
```

### 1.3. 精神属性の変化タイミング

| タイミング | 変化内容 | 実装場所 |
|-----------|---------|---------|
| スキル使用後 | スキルの属性に染まる | `BaseStates.Attack.cs:198-222` |
| スキル被撃時 | 条件付きで属性感染 | `BaseStates.ReactionSkill.cs:1013-1036` |
| 歩行中 | デフォルト属性に回帰 | `AllyClass.cs:523-548` |
| 戦闘結果 | パワー変化に影響 | `AllyClass.cs:617-795` |

---

## 2. パーティー管理の仕組み

### 2.1. パーティー構成

```csharp
// CharacterId.cs（新キャラクター追加システムで導入）
public readonly struct CharacterId : IEquatable<CharacterId>
{
    public string Value { get; }

    // 固定3人の静的定義
    public static readonly CharacterId Geino = new("geino");
    public static readonly CharacterId Noramlia = new("noramlia");
    public static readonly CharacterId Sites = new("sites");

    // 固定3人かどうかの判定
    public bool IsOriginalMember =>
        this == Geino || this == Noramlia || this == Sites;
}

// ※ 旧 AllyId enum は廃止予定
```

### 2.2. パーティー管理階層

```
PlayersRuntime（初期化・所有）
    ↓
PlayersRoster（キャラクター配列管理）
    ├── Allies: AllyClass[]  ← 実際のキャラクターデータ
    ├── GetAllyById(AllyId) → BaseStates
    └── GetAllyByIndex(int) → BaseStates
    ↓
PlayersPartyService（BattleGroup構築）
    └── GetParty() → BattleGroup
    ↓
PlayersContext（依存性注入コンテナ）
    ├── Party: IPlayersParty
    └── Roster: IPlayersRoster
```

### 2.3. グローバルアクセス経路

```csharp
// 歩行中
GameContextHub.Current.Players.Roster.GetAlly(CharacterId.Geino)
    → AllyClass → MyImpression

// 戦闘中
BattleContextHub.Current.AllyGroup.Ours[0]
    → BaseStates → MyImpression
```

### 2.4. キャラクター継承構造

```
BaseStates（基盤）
  ├─ AllyClass（味方共通）
  │   └─ CharacterId で識別（派生クラスなし）
  └─ NormalEnemy（敵共通）
```

※ 旧構造では StairStates/BassJackStates/SateliteProcessStates があったが、新キャラクター追加システムで廃止。
  全キャラクターを AllyClass + CharacterId で管理。

---

## 3. ノベルパートのキャラクター管理

### 3.1. 現在の仕組み

```
PortraitDatabase（SO）
    ├── characters: PortraitCharacterData[]
    │   ├── characterId: "geino"  ← 文字列ID
    │   ├── icon: Sprite
    │   ├── defaultPortrait: Sprite
    │   └── expressions: PortraitExpressionData[]
    │
    └── GetPortrait(characterId, expression) → Sprite

DialogueStep
    ├── speaker: string        ← 話者名（表示用）
    ├── leftPortrait: PortraitState
    │   ├── characterId: string  ← PortraitDatabase検索キー
    │   └── expression: string
    └── rightPortrait: PortraitState
```

### 3.2. 重要な特徴: デカップリング → 統合

**旧状態**: ノベルパートとゲームロジックは分離されていた

| 項目 | ノベルパート | ゲームロジック |
|------|------------|--------------|
| ID体系 | characterId（文字列） | ~~AllyId（enum）~~ → **CharacterId（文字列）** |
| キャラ名 | speaker（任意文字列） | CharacterName |
| 管理方式 | PortraitDatabase（SO） | PlayersRoster |
| 精神属性 | **なし** | MyImpression |

**新キャラクター追加システムにより:**
- ノベルパートの characterId とゲームロジックの CharacterId が同じ文字列体系に統一
- 主人公システムで精神属性連携が可能

---

## 4. 主人公システム（確定仕様）

### 4.1. 概要

**課題1,2,3を統合解決するアプローチ**

従来の課題:
- 課題1: ノベルパートからパーティーへのアクセス経路がない
- 課題2: characterIdとAllyIdのマッピングがない
- 課題3: 選択肢の精神属性が「誰の」ものか不明確

**解決策**: ノベルパートに「主人公（protagonist）」を設定

```csharp
// NovelDialogueStep に追加（シリアライズ対応）
[SerializeField] private bool hasProtagonist;
[SerializeField] private CharacterId protagonist;  // ※ AllyId → CharacterId

public CharacterId? GetProtagonist() => hasProtagonist ? protagonist : null;
```

### 4.2. 主人公の役割

| 項目 | 説明 |
|------|------|
| 精神属性表示対象 | ディノイドモードで「現在の精神属性」を表示するキャラ |
| 精神属性変化対象 | 選択結果のEffectで精神属性が変化するキャラ |

**注意**: 立ち絵配置（左/右）とは独立。主人公はデータで明示的に設定する。

### 4.3. 精神属性表示フロー

**現在の精神属性表示（ディノイドモード）:**
```
NovelDialogueStep.GetProtagonist(): CharacterId.Geino
    ↓
GameContext.Players.Roster.GetAlly(CharacterId.Geino)
    ↓
AllyClass.MyImpression → SpiritualProperty.Pillar
    ↓
UI表示: "現在: Pillar"
```

**選択肢の精神属性タグ:**
```
DialogueChoice.SpiritProperty: "Doremis"
    ↓
UI表示: "協力する[Doremis]"
```

### 4.4. characterIdとの関係

**characterId（PortraitDatabase用）と protagonist（CharacterId）は同じ文字列体系**

- characterId: 立ち絵表示用（文字列、NPCも可）
- protagonist: 精神属性処理対象（CharacterId、パーティーメンバーのみ）

これにより:
- NPCも立ち絵に登場可能（精神属性なし）
- 主人公（精神属性を持つキャラ）は CharacterId で明示的に指定
- 同じ文字列体系なので、将来的に PortraitDatabase と CharacterDataSO の統合も可能

---

## 5. UI仕様（確定）

### 5.1. 選択肢表示

```
選択肢の文章[精神属性]
```

例:
- `協力する[Doremis]`
- `断る[Psycho]`
- `無視する[Sacrifaith]`

**実装**:
```csharp
// 選択肢ボタンのラベル生成
var spiritTag = string.IsNullOrEmpty(choice.SpiritProperty) ? "" : $"[{choice.SpiritProperty}]";
string label = $"{choice.Text}{spiritTag}";
```

**注意**: `choice.SpiritProperty` は string 型。表示タグとして使用し、実際の属性変化はEffectで行う。

### 5.2. ディノイドモード

- アイコン下に主人公の「現在の精神属性」をテキスト表示
- 主人公未設定時は非表示

### 5.3. 立ち絵モード

- 立ち絵画像で描き分け（将来）
- または精神属性オーバーレイ表示

---

## 6. 実装アーキテクチャ

### 6.1. NovelDialogueStepへの追加（シリアライズ対応）

```csharp
// NovelDialogueStep.cs に追加
[SerializeField] private bool hasProtagonist;
[SerializeField] private CharacterId protagonist;  // ※ AllyId → CharacterId

public CharacterId? GetProtagonist() => hasProtagonist ? protagonist : null;
```

### 6.2. 精神属性取得ヘルパー

```csharp
// DialogueContext.cs
public CharacterId? Protagonist { get; set; }  // ※ AllyId? → CharacterId?

public SpiritualProperty? GetProtagonistImpression()
{
    if (Protagonist == null || Roster == null) return null;
    var ally = Roster.GetAlly(Protagonist.Value);  // ※ GetAllyById → GetAlly
    return ally?.GetImpressions().Now;
}
```

### 6.3. 選択肢表示処理

```csharp
// NovelPartDialogueRunner または ChoicePresenter
foreach (var choice in step.Choices)
{
    var label = choice.Text;
    if (!string.IsNullOrEmpty(choice.SpiritProperty))
    {
        label += $"[{choice.SpiritProperty}]";
    }
    // ボタン生成
}
```

---

## 7. 実装タスク

### Phase 1: 主人公システム基盤 ✅ 完了

| タスク | 詳細 | 状態 |
|--------|------|------|
| NovelDialogueStep拡張 | `bool hasProtagonist` + `protagonist` 追加（シリアライズ対応） | ✅ |
| DialogueContext拡張 | Roster参照を保持 | ✅ |
| 精神属性取得ヘルパー | GetProtagonist() → MyImpression取得 | ✅ |

### Phase 2: 選択肢表示 ✅ 完了

| タスク | 詳細 | 状態 |
|--------|------|------|
| 選択肢UI更新 | `選択肢文章[精神属性]` 形式で表示 | ✅ |
| 既存DialogueChoice確認 | SpiritPropertyフィールドの使用確認 | ✅ |

### Phase 3: ディノイドモード可視化 ✅ 完了

| タスク | 詳細 | 状態 |
|--------|------|------|
| TextBoxPresenter拡張 | アイコン下に精神属性テキスト表示 | ✅ |
| 主人公未設定時の処理 | 非表示にする | ✅ |

### Phase 4: 立ち絵モード可視化 ❌ 不要

| タスク | 詳細 | 状態 |
|--------|------|------|
| 仕様決定 | 精神属性ごとの立ち絵 or オーバーレイ | ❌ 不要と判断 |
| PortraitPresenter拡張 | 精神属性に応じた表示 | ❌ 不要と判断 |

> 精神属性は内面概念であり、表情（expression）とは別軸。立ち絵描き分けは不要。

### Phase 5: CharacterId化（新キャラクター追加システム連携）

| タスク | 詳細 | 状態 |
|--------|------|------|
| NovelDialogueStep | `AllyId protagonist` → `CharacterId protagonist` | 📋 予定 |
| DialogueContext | `AllyId? Protagonist` → `CharacterId? Protagonist` | 📋 予定 |
| GetProtagonistImpression | `GetAllyById()` → `GetAlly(CharacterId)` | 📋 予定 |

> 詳細: [新キャラクター追加システム設計.md](../新キャラクター追加システム設計.md) Phase G

---

## 8. 検討事項

### 8.1. 精神属性の表示形式

| 案 | 表示例 | 備考 |
|----|--------|------|
| enum名そのまま | `[Doremis]` | シンプル、ゲーム内用語 |
| 日本語名 | `[ドレミス]` | 変換テーブル必要 |

**現時点**: enum名をそのまま使用（変換は将来対応）

### 8.2. 主人公未設定時の挙動

- 選択肢の精神属性: 非表示（SpiritPropertyは空でOK）
- ディノイドモード: 精神属性テキスト非表示
- エラーは出さない（NPCのみのシーンもあり得る）

### 8.3. 選択結果による精神属性変化

選択肢の精神属性と主人公の精神属性変化は別の話:
- 表示: 選択肢に紐づいた静的な精神属性タグ
- 変化: 選択後のEffect（SetSpiritualPropertyEffect等）で実行

---

## 9. 次のアクション

~~1. **Phase 1実装**: NovelDialogueStepにprotagonist追加~~ ✅ 完了
~~2. **Phase 2実装**: 選択肢UIで精神属性表示~~ ✅ 完了
~~3. **Phase 3実装**: ディノイドモードで精神属性表示~~ ✅ 完了
~~4. **動作確認**: テストダイアログで検証~~ ✅ 完了

**残タスク:**
- **Phase 5実装**: CharacterId化（新キャラクター追加システム Phase G で実施）

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-28 | CharacterId化対応: ドキュメント内の AllyId 記述を CharacterId に更新 |
| 2026-01-28 | Phase 5（CharacterId化）追加、Phase 1-3 完了マーク |
| 2026-01-27 | 外部レビュー対応: シリアライズ対応（bool+AllyIdパターン）、仕様矛盾解消 |
| 2026-01-27 | 主人公システム仕様確定（課題1,2,3統合解決） |
| 2026-01-27 | 選択肢UI仕様確定: `選択肢文章[精神属性]` |
| 2026-01-26 | 初版（調査結果統合） |
