# 前のめりトグルボタン化計画

## 目的

前のめりの選択UIを**ラジオボタン（ToggleGroupController）からトグルボタン（ToggleSingleController）に変更**する。
スマホでラジオボタンは視認性が悪く、割り込みカウンターON/OFFや規格切り替えと同様の単一ボタントグルにしたい。

同時に、スキルIDと紐づくトグルボタンの仕組みを**再利用可能な形**で整備し、今後の同様のUI需要に対応する。

---

## 現状の構造

### 前のめりラジオボタン（現行）

```
ToggleGroupController（ラジオボタングループ）
  ├─ Toggle[0]: 前のめり（ON）
  └─ Toggle[1]: その場から（OFF）
```

- `RadioButtonsAndSkillIDHold` がスキルIDとコントローラーをペアで保持
- `AllySkillUILists.aggressiveCommitRadios` にリストとして格納
- コールバック: `OnSkillSelectAggressiveCommitBtnCallBack(int toggleIndex, int skillID)`
- Index 0 = 前のめり, Index 1 = その場

### 割り込みカウンタートグル（参考）

```
ToggleSingleController（単一ボタン）
  └─ Button + Label("する"/"しない")
```

- `CharaconfigController.m_InterruptCounterToggle` で直接参照
- スキルIDとの紐づけ不要（キャラ単位の設定）
- コールバック: `OnSelectInterruptCounterActiveBtnCallBack(int toggleIndex)`

### 規格サイクルボタン（参考）

```
Button + Label（現在の規格名を表示）
```

- トグルではなくサイクル（ボタン押すたびに次の規格へ）
- `CharaconfigController.m_ProtocolCycleButton` で直接参照

---

## 変更計画

### Phase 1: ToggleSingleAndSkillIDHold の作成

`RadioButtonsAndSkillIDHold` のトグルボタン版を作る。

**ファイル**: `PlayersUIBindings.cs` に追記

```csharp
[Serializable]
public class ToggleSingleAndSkillIDHold
{
    public ToggleSingleController Controller;
    public int skillID;

    public void AddToggleFunc(UnityAction<int, int> call)
    {
        if (Controller == null)
        {
            Debug.LogError("ToggleSingleControllerがnullです！ skillID: " + skillID);
            return;
        }
        if (call == null)
        {
            Debug.LogError("callがnullです！ skillID: " + skillID);
            return;
        }
        Controller.AddListener((int toggleIndex) => call(toggleIndex, skillID));
    }

    public void Interactable(bool interactable)
    {
        Controller.interactable = interactable;
    }
}
```

`RadioButtonsAndSkillIDHold` と同じインターフェースで、内部が `ToggleSingleController` になっただけ。

### Phase 2: AllySkillUILists の差し替え

**ファイル**: `PlayersUIBindings.cs`

```csharp
// 変更前
public List<RadioButtonsAndSkillIDHold> aggressiveCommitRadios = new();

// 変更後
public List<ToggleSingleAndSkillIDHold> aggressiveCommitToggles = new();
```

### Phase 3: PlayersUIService の書き換え

**ファイル**: `PlayersUIService.cs` — 3箇所

#### 初期バインド（現: Lines 85-88）

```csharp
// 変更前
foreach (var radio in uiSet.SkillUILists.aggressiveCommitRadios)
{
    radio.AddRadioFunc(actor.OnSkillSelectAggressiveCommitBtnCallBack);
}

// 変更後
foreach (var toggle in uiSet.SkillUILists.aggressiveCommitToggles)
{
    toggle.AddToggleFunc(actor.OnSkillSelectAggressiveCommitBtnCallBack);
}
```

#### 表示切替（現: Lines 163-166）

```csharp
// 変更前
foreach (var hold in uiSet.SkillUILists.aggressiveCommitRadios)
{
    hold.Interactable(activeSkillIds.Contains(hold.skillID));
}

// 変更後
foreach (var hold in uiSet.SkillUILists.aggressiveCommitToggles)
{
    hold.Interactable(activeSkillIds.Contains(hold.skillID));
}
```

#### 状態同期（現: Lines 248-253）

```csharp
// 変更前
foreach (var radio in uiSet.SkillUILists.aggressiveCommitRadios.Where(...))
{
    BaseSkill skill = ally.SkillList[radio.skillID];
    radio.Controller.SetOnWithoutNotify(skill.IsAggressiveCommit ? 0 : 1);
}

// 変更後
foreach (var toggle in uiSet.SkillUILists.aggressiveCommitToggles.Where(...))
{
    BaseSkill skill = ally.SkillList[toggle.skillID];
    toggle.Controller.SetOnWithoutNotify(skill.IsAggressiveCommit);
}
```

**注意**: `ToggleSingleController.SetOnWithoutNotify(bool)` を使えるので、`? 0 : 1` の変換が不要になる。

### Phase 4: AllyClass コールバックの確認

**ファイル**: `AllyClass.cs:429-445` — `OnSkillSelectAggressiveCommitBtnCallBack`

```csharp
public void OnSkillSelectAggressiveCommitBtnCallBack(int toggleIndex, int skillID)
```

このメソッドは**変更不要**。`ToggleSingleController` も int(0/1) でコールバックするため、既存のロジックがそのまま動く。

### Phase 5: ToggleSingleController のラベル設定

前のめりトグルには適切なラベルを設定する。

| 状態 | ラベル |
|------|--------|
| ON（前のめり） | `"前のめり"` |
| OFF（その場から） | `"その場"` |

インスペクタの `m_OnText` / `m_OffText` で設定するか、コードから `SetLabelTexts("前のめり", "その場")` を呼ぶ。

### Phase 6: シーンUI差し替え

各キャラのスキルUI（PlayerContent/SkillObject周辺）で:

1. 既存のラジオボタン（Toggle×2 + ToggleGroupController）を**削除**
2. 代わりにButton + TextMeshProUGUI + `ToggleSingleController` を配置
3. `AllySkillUILists.aggressiveCommitToggles` にアタッチ
4. `ToggleSingleController` のラベルテキストをインスペクタで設定

### Phase 7: RadioButtonsAndSkillIDHold の削除判断

前のめり以外に `RadioButtonsAndSkillIDHold` を使っている箇所がなければ、クラスごと削除可能。使っている箇所があれば残す。

`ToggleGroupController_SelectAggressiveCommit.cs` のファイル名が前のめり専用に見えるが、実体は汎用的な `ToggleGroupController` なので、他で使われていなければリネームまたは削除。

### Phase 8: ランダムターン制仕様書の更新

`doc/ランダムターン制仕様書.md` の以下の記述を更新:

- セクション3「前のめり」の「プレイヤーの選択UI」部分
  - 「ラジオボタン」→「トグルボタン」に書き換え
  - `ToggleGroupController` → `ToggleSingleController` に書き換え
  - `RadioButtonsAndSkillIDHold` → `ToggleSingleAndSkillIDHold` に書き換え
- セクション7「実装状況」の該当行を更新

---

## 変更対象ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `PlayersUIBindings.cs` | `ToggleSingleAndSkillIDHold` 追加、`AllySkillUILists` のフィールド差し替え |
| `PlayersUIService.cs` | 3箇所の `aggressiveCommitRadios` → `aggressiveCommitToggles` |
| シーン（PlayerContent/SkillObject） | ラジオボタン → トグルボタンに差し替え |
| `doc/ランダムターン制仕様書.md` | UI記述の更新 |

**変更不要**:
| ファイル | 理由 |
|---------|------|
| `AllyClass.cs` | コールバックのシグネチャは同じ（int, int） |
| `ToggleSingleController.cs` | 既に汎用的。変更不要 |

---

## 設計判断

### なぜ新クラスを作るのか

`ToggleSingleController` は既に汎用的で優秀。足りないのは**スキルIDとの紐づけ**だけ。`ToggleSingleAndSkillIDHold` はその薄いラッパーであり、`RadioButtonsAndSkillIDHold` と同じパターンで統一感を保つ。

### なぜ ToggleSingleController 自体は変更しないのか

`ToggleSingleController` は割り込みカウンターなど**スキルIDが不要な場面**でも使われている。スキルID対応を本体に入れると、不要な場面でもスキルIDを意識させることになり、汎用性が下がる。

### Prefab化の検討

トグルボタン + ラベルの構成は今後も繰り返し使うため、Prefab化が有効:

```
AggressiveCommitToggle (Prefab)
  ├─ Button
  │   └─ TextMeshProUGUI (ラベル)
  └─ ToggleSingleController (コンポーネント)
```

ただし、スキルごとに位置調整が必要な場合はPrefabのインスタンス化後に個別調整する。Prefabはあくまでベース構成の統一用。
