# ノベルパート未実装機能一覧

Phase 1-6およびUSERUI/EyeArea連携実装後に残っているタスクの一覧。

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート設計.md) - 設計本体
- [ノベルパート_USERUIとEyeArea連携.md](../終了済み/ノベルパート_USERUIとEyeArea連携.md) - UI配置設計・TabState設計
- [リアクションシステム実装計画.md](../終了済み/リアクションシステム実装計画.md) - リアクションシステム詳細
- [EventStep統合実装計画.md](../歩行システム設計/EventStep統合実装計画.md) - **イベント統合設計**

---

## 完了済み

- [x] データ構造（DialogueStep, DialogueContext, DialogueResult, DialogueSO, ReactionSegment）
- [x] NovelPartDialogueRunner（実行・入力待ち・リアクション終了処理）
- [x] Presenter配置（Portrait, TextBox, Background, Noise）
- [x] 入力UI（FieldDialogueUI, EventDialogueUI, NovelChoicePresenter, NovelInputHub）
- [x] TabState拡張（FieldDialogue, EventDialogue, NovelChoice）
- [x] MainContent.SwitchContent() 対応
- [x] データベース作成・エントリ登録（PortraitDatabase, BackgroundDatabase）
- [x] リアクションロジック（ReactionTextBuilder, ReactionTextHandler, AreaController対応）
- [x] エントリポイント接続（WalkingSystemManager.EnsureDialogueRunner()）
- [x] Effect後スナップショット問題修正（ExecuteStep後に移動）
- [x] MessageDropper連携（ディノイドモード時にテキスト送信）
- [x] **EventStep統合**（NovelDialogueStep, BattleStep, EmitEventStep, EffectStep）
- [x] **ズーム責務一本化**（NovelDialogueStep内でズーム制御、DialogueRunnerはズームしない）
- [x] **NodeSO.centralDialogue削除**（EventDefinitionSO経由に統一）
- [x] **ForcedEventTrigger.eventDefinition統一**（DialogueSO直接参照を廃止）

---

## 不要と判断

- [x] ~~バックログUI~~ - イベント会話は左右ボタンで戻れる、フィールド会話はMessageDropperで流れる
- [x] ~~リアクションボタン（USERUI側）~~ - 文字タップ方式採用（EyeArea側で完結）
- [x] ~~会話途中セーブ~~ - 不要（最初からやり直せばよい）

---

## 優先度高（P2）- 動作に必須

### 1. EyeAreaState切替システム（方針B）✅ 完了

- [x] EyeAreaState enum作成（Walk, Novel, Battle）
- [x] EyeAreaContents.cs作成（TabContentsと同様のSetActive切替）
- [x] EyeAreaMainContent.cs作成（レイヤー方式: Walk常時表示 + Novel/Battle排他）
- [x] EyeAreaToggle.cs作成（4階層管理、TabState→EyeAreaState変換）
- [x] WalkContent / NovelContent / BattleContent のシーン構造整理（4階層×3State = 12個）
- [x] TabState変更時にEyeAreaStateも連動して切替
- [x] ノベルパート開始時にNovelContentがアクティブになることを確認

| 項目 | 内容 |
|------|------|
| 設計書 | [ノベルパート_USERUIとEyeArea連携.md](../終了済み/ノベルパート_USERUIとEyeArea連携.md) 方針B |
| 詳細設計 | [USERUI_EyeArea仕様書.md](../USERUI_EyeArea仕様書.md) |
| 実装ファイル | `EyeAreaState.cs`, `EyeAreaContents.cs`, `EyeAreaMainContent.cs`, `EyeAreaToggle.cs` |
| シーン配置 | ViewportArea配下に4階層、各階層にWalk/Novel/BattleContent配置・アタッチ完了 |

### 2. 動作テスト ✅ 完了

- [x] テストシナリオで立ち絵表示確認
- [x] テストシナリオで背景表示確認
- [x] テストシナリオでテキスト表示確認
- [x] モード切替（ディノイド⇔立ち絵）確認
- [x] フィールド会話のログがMessageDropperで流れることを確認

| 項目 | 内容 |
|------|------|
| 関連ファイル | `TestDialogue_Reaction.asset` |
| テスト方法 | Node_0__________のForcedEventTrigger（type: Steps, stepCount: 3）|

---

## 優先度中（P3）- 機能拡張

### 5. リアクションシステム配置・テスト ✅ 完了

- [x] ReactionTextHandlerをDinoidTextにアタッチ
- [x] ReactionTextHandlerをPortraitTextにアタッチ
- [x] TextBoxPresenterにReactionHandler参照追加（コード修正）
- [x] TMP_TextのRaycastTarget有効化
- [x] オレンジ文字タップで戦闘起動テスト
- [x] ノベルパート終了→戦闘→歩行復帰テスト

| 項目 | 内容 |
|------|------|
| 実装ファイル | `TextBoxPresenter.cs`, `NovelPartEventUI.cs` |
| 詳細 | [リアクションシステム実装計画.md](../終了済み/リアクションシステム実装計画.md) |

### 6. ズームシステム ✅ 完了

- [x] 中央オブジェクト会話時のカメラズームイン
- [x] 会話終了時のズームアウト
- [x] ノベルパートUI（立ち絵、テキストボックス）はズームしない制御
- [x] FocusArea（フォーカス領域）による部分フィット機能
- [x] CentralObjectVisual.ZoomOnApproachフラグによる選択可能設計

| 項目 | 内容 |
|------|------|
| 設計書記載 | 中央オブジェクトにカメラズーム（選択可能） |
| 実装ファイル | `NovelZoomController.cs`, `NovelZoomConfig.cs`, `FocusArea.cs` |
| 設定箇所 | `CentralObjectVisual.ZoomOnApproach`, `NovelPartEventUI.ZoomConfig` |
| 詳細仕様 | [ノベルパート設計.md](./ノベルパート設計.md)「ズームシステム実装仕様」セクション |

### 7. 精神属性可視化 ✅ 完了

- [x] NovelDialogueStepに主人公(protagonist)設定追加
- [x] DialogueContextに精神属性取得ヘルパー追加
- [x] ディノイドモード: アイコン下にテキスト表示
- [x] 選択肢の精神属性タグ表示（`選択肢文章[精神属性]`形式）
- [x] **主人公設定を CharacterId 化**（新キャラクター追加システム対応）

| 項目 | 内容 |
|------|------|
| 設計書 | [ノベルパートと精神属性の連携.md](../終了済み/ノベルパートと精神属性の連携.md) |
| 実装ファイル | `NovelDialogueStep.cs`, `DialogueContext.cs`, `TextBoxPresenter.cs`, `NovelPartEventUI.cs`, `NovelPartDialogueRunner.cs` |
| 主人公設定 | `protagonistCharacterId` (string) → `CharacterId?` で取得 |
| 関連設計 | [新キャラクター追加システム設計.md](../終了済み/新キャラクター追加システム設計.md) Phase G |

> **Note**: 立ち絵描き分けは不要と判断。精神属性は内面的概念であり表情で表現すべきものではない。PortraitDatabaseのexpression（表情）とは別軸。

---

## 優先度低（P4）- 演出・仕上げ

### 8. ロックマン案トランジション ✅ 完了

- [x] PortraitCharacterDataにthemeColor追加（rainColor相当）
- [x] 縦線（RainBar）アニメーション実装
- [x] 立ち絵フェードイン連携

| 項目 | 内容 |
|------|------|
| 設計書 | [ロックマン案トランジション設計.md](../終了済み/ロックマン案トランジション設計.md) |
| 設定手順 | [ノベルパート設定仕様書.md](../ノベルパート設定仕様書.md)「立ち絵登場トランジション」セクション |
| 実装ファイル | `PortraitPresenter.cs`, `PortraitDatabase.cs`, `PortraitTransition.cs` |
| 残作業 | シーン設定（RainBar Image配置、themeColor設定） |

### 9. 3者会話構図 ✅ 完了

- [x] CentralObjectPresenter.UpdateSprite() / GetCurrentSprite() 追加
- [x] DialogueStep.centralObjectSprite / HasCentralObjectChange 追加
- [x] INovelEventUI.UpdateCentralObjectSprite() / GetCurrentCentralObjectSprite() 追加
- [x] NovelPartEventUI に CentralObjectPresenter 参照追加・実装
- [x] NovelPartDialogueRunner で中央オブジェクト更新処理
- [x] DialogueStateSnapshot に CentralObjectSprite 追加
- [x] 戻る機能での中央オブジェクト状態復元
- [x] WalkingSystemManager で SetCentralObjectPresenter 呼び出し
- [x] ~~ノベルパート終了時の元スプライト復元~~ → 方針B（変更維持）に決定、不要

| 項目 | 内容 |
|------|------|
| 設計書 | [3者会話構図設計.md](./3者会話構図設計.md) |
| 実装計画 | [3者会話構図実装計画.md](./3者会話構図実装計画.md) |
| 方針 | 新しい立ち絵枠ではなく、既存の中央オブジェクトのスプライトを変更 |
| 実装ファイル | `CentralObjectPresenter.cs`, `DialogueStep.cs`, `DialogueStateSnapshot.cs`, `INovelEventUI.cs`, `NovelPartEventUI.cs`, `NovelPartDialogueRunner.cs`, `WalkingSystemManager.cs` |

### 10. セーブ/ロード対応（イベント発火履歴のみ） ✅ 完了

- [x] ForcedEventState をセーブデータに統合（Export/Import呼び出し追加）

| 項目 | 内容 |
|------|------|
| 目的 | 一度見たイベントをロード後も再発火させない |
| 実装ファイル | `WalkProgressData.cs` |
| 不要 | 会話途中のセーブ（最初からやり直せばよい） |

---

## 推奨実装順序

```
【第1段階: 基盤完成】 ✅ 完了
1. EyeAreaState切替システム（方針B） ✅
2. 動作テスト ✅

【第2段階: リアクション】 ✅ 完了
3. リアクションシステム配置・テスト ✅

【第3段階: 機能拡張】 ✅ 完了
4. ズームシステム ✅
5. 精神属性可視化 ✅（CharacterId化完了）

【第4段階: 演出・仕上げ】 ✅ 完了
6. ロックマン案トランジション ✅
7. 3者会話構図 ✅
8. イベント発火履歴のセーブ対応 ✅
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-24 | 初版（Phase 6完了時点） |
| 2026-01-25 | USERUI/EyeArea連携完了を反映、チェックリスト形式に変更 |
| 2026-01-25 | バックログUI不要、リアクション文字タップ方式決定を反映 |
| 2026-01-25 | P2完了: エントリポイント接続確認済、スナップショット修正、MessageDropper連携 |
| 2026-01-25 | P2追加: EyeAreaState切替システム（方針B）が未実装だったため追加 |
| 2026-01-25 | **P2-1完了**: EyeAreaState切替システム実装・シーン配置・アタッチ完了 |
| 2026-01-25 | **P2完了**: 動作テスト完了（ディノイド/立ち絵モード切替、テキスト表示確認）|
| 2026-01-25 | 外部レビュー対応: リアクション終了TabStateリセット、入力キャンセル処理追加 |
| 2026-01-25 | **P3-5完了**: リアクションシステム配置・テスト完了（オレンジ文字タップ→戦闘起動確認）|
| 2026-01-25 | **P3-6完了**: ズームシステム実装（NovelZoomController, FocusArea, CentralObjectVisual.ZoomOnApproach）|
| 2026-01-27 | **P3-7完了**: 精神属性可視化（主人公システム、選択肢タグ表示、ディノイドモード精神属性表示）|
| 2026-01-28 | P3-7に CharacterId 化タスク追加（新キャラクター追加システム連携）|
| 2026-01-30 | **P3-7完全完了**: CharacterId化実装済み確認、関連ドキュメント参照更新 |
| 2026-01-31 | P4-10明確化: 「セーブ/ロード対応」→「イベント発火履歴のセーブ対応」に変更。会話途中セーブは不要。 |
| 2026-01-31 | **P4-10完了**: ForcedEventStateをWalkProgressDataに統合（Export/Import追加） |
| 2026-01-31 | **P4-8完了**: ロックマン案トランジション（コード実装済み、シーン設定のみ残） |
| 2026-01-31 | **全タスク完了**: doc/終了済みへ移動 |
