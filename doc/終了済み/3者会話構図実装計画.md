# 3者会話構図実装計画

## 概要

「3者会話構図設計」を実現するための実装計画。
歩行システムの中央オブジェクトを会話相手として扱い、ノベルパート中にスプライトを変更可能にする。

## 関連ドキュメント

- [3者会話構図設計.md](./3者会話構図設計.md) - 設計本体
- [ノベルパート設計.md](./ノベルパート設計.md) - ノベルパート基盤設計
- [ノベルパート実装計画.md](../終了済み/ノベルパート実装計画.md) - 基盤実装（完了済み）

---

## 設計決定事項

### 所有権パス（Presenter ownership）

```
NovelPartDialogueRunner
    │
    │  ui.UpdateCentralObjectSprite(sprite)
    │  ui.GetCurrentCentralObjectSprite()
    ↓
INovelEventUI（インターフェース）
    │
    ↓
NovelPartEventUI
    │
    │  centralObjectPresenter?.UpdateSprite(sprite)
    │  centralObjectPresenter?.GetCurrentSprite()
    ↓
CentralObjectPresenter（内部保持）
```

**決定**: NovelPartEventUIがCentralObjectPresenterを内部保持し、INovelEventUI経由でアクセス。
NovelPartDialogueRunnerはCentralObjectPresenterを直接参照しない。

### スナップショット/復元戦略

**方式**: UIから実際の表示状態を取得

```
ExecuteStep() 実行
    ↓
ui.UpdateCentralObjectSprite() で更新
    ↓
スナップショット作成（ExecuteStep後）
    ↓
snapshot.CentralObjectSprite = ui.GetCurrentCentralObjectSprite()
```

**決定**:
- `ApplyStep`での累積更新ではなく、UIから直接取得
- 「2つの真実のソース」問題を回避
- RestoreStateでは常に適用（nullでもクリアとして適用）

### 変更検出の最適化

**決定**: 最適化しない

- `HasCentralObjectChange`のみで判定
- スプライト変更はコストが低い（単純な参照代入）
- 状態管理の複雑性を避ける

### オープンクエスチョンへの回答

**Q1: DialogueStepにhelpers（clone/merge等）が必要か？**
- A: 不要。DialogueStepはSerializeFieldとプロパティのみの単純なデータクラス。
  新フィールドはInspectorでの設定とプロパティアクセスのみで十分。

**Q2: CreateSnapshotはExecuteStepの前後どちらで呼ばれるか？**
- A: **後**（NovelPartDialogueRunner.cs line 90-109）。
  ExecuteStep完了後にUIの実際の状態をキャプチャする。

**Q3: INovelEventUIの実装は他にあるか？**
- A: **NovelPartEventUIのみ**（調査済み）。
  `GetCurrentCentralObjectSprite()`追加でビルドが落ちるリスクはない。

---

## 現状分析

### 実装状況サマリ

| ファイル | 追加内容 | 状態 |
|----------|---------|------|
| CentralObjectPresenter | `UpdateSprite()`, `GetCurrentSprite()` | ✅ 実装済み |
| DialogueStep | `centralObjectSprite` フィールド | ✅ 実装済み |
| INovelEventUI | `UpdateCentralObjectSprite()`, `GetCurrentCentralObjectSprite()` | ✅ 実装済み |
| NovelPartEventUI | CentralObjectPresenter統合 + 両メソッド実装 | ✅ 実装済み |
| NovelPartDialogueRunner | 中央オブジェクト更新処理 + スナップショット取得 | ✅ 実装済み |
| DialogueStateSnapshot | `CentralObjectSprite` フィールド + Clone修正 | ✅ 実装済み |
| WalkingSystemManager | `SetCentralObjectPresenter`呼び出し | ✅ 実装済み |

### 既存ファイルパス

```
Assets/Script/Walk/
├── Presentation/
│   └── CentralObjectPresenter.cs
├── Dialogue/
│   ├── DialogueStep.cs
│   ├── DialogueContext.cs
│   ├── DialogueStateSnapshot.cs
│   └── NovelPartDialogueRunner.cs
└── EventKernel/
    ├── INovelEventUI.cs
    └── NovelPartEventUI.cs
```

---

## 実装タスク

### Task 1: CentralObjectPresenter拡張

**ファイル**: `Assets/Script/Walk/Presentation/CentralObjectPresenter.cs`

```csharp
// 追加メソッド

/// <summary>
/// スプライトのみを変更する（位置・サイズは維持）。
/// ノベルパート中の中央オブジェクト変更用。
/// </summary>
public void UpdateSprite(Sprite sprite)
{
    if (image == null) return;
    image.sprite = sprite ?? GetFallbackSprite();
}

/// <summary>
/// 現在のスプライトを取得する。
/// 状態復元用。
/// </summary>
public Sprite GetCurrentSprite()
{
    return image?.sprite;
}
```

**依存**: なし（最初に実装）

---

### Task 2: DialogueStep拡張

**ファイル**: `Assets/Script/Walk/Dialogue/DialogueStep.cs`

```csharp
// 追加フィールド

[Header("中央オブジェクト")]
[SerializeField] private Sprite centralObjectSprite;

public Sprite CentralObjectSprite => centralObjectSprite;
public bool HasCentralObjectChange => centralObjectSprite != null;
```

**設計方針**:
- `null` = 変更なし（前の状態維持）
- 値あり = 変更
- 左右立ち絵と同じパターン

---

### Task 3: DialogueStateSnapshot拡張

**ファイル**: `Assets/Script/Walk/Dialogue/DialogueStateSnapshot.cs`

```csharp
// 追加フィールド
public Sprite CentralObjectSprite { get; set; }
```

**注意**: `ApplyStep`は**CentralObjectSprite用には**使用しない。
- 既存の立ち絵/背景用の`ApplyStep`呼び出しは継続（Task 6のコード参照）
- CentralObjectSpriteはUIから直接取得（`ApplyStep`後に代入）

**Cloneメソッド修正**:
```csharp
public DialogueStateSnapshot Clone()
{
    return new DialogueStateSnapshot
    {
        StepIndex = StepIndex,
        DisplayMode = DisplayMode,
        LeftPortrait = LeftPortrait?.Clone(),
        RightPortrait = RightPortrait?.Clone(),
        HasBackground = HasBackground,
        BackgroundId = BackgroundId,
        CentralObjectSprite = CentralObjectSprite  // 追加（参照型なのでそのまま代入）
    };
}
```

---

### Task 4: INovelEventUI拡張

**ファイル**: `Assets/Script/Walk/EventKernel/INovelEventUI.cs`

```csharp
// 追加メソッド

/// <summary>
/// 中央オブジェクトのスプライトを変更する。
/// ズーム中の会話でのみ有効。
/// </summary>
void UpdateCentralObjectSprite(Sprite sprite);

/// <summary>
/// 現在の中央オブジェクトスプライトを取得する。
/// スナップショット作成用。
/// </summary>
Sprite GetCurrentCentralObjectSprite();
```

---

### Task 5: NovelPartEventUI実装

**ファイル**: `Assets/Script/Walk/EventKernel/NovelPartEventUI.cs`

```csharp
// 追加フィールド（UIレイヤーで完結する方針B）
private CentralObjectPresenter centralObjectPresenter;

/// <summary>
/// CentralObjectPresenterを設定する。
/// WalkingSystemManager初期化時に呼び出す。
/// </summary>
public void SetCentralObjectPresenter(CentralObjectPresenter presenter)
{
    centralObjectPresenter = presenter;
}

// INovelEventUI実装
public void UpdateCentralObjectSprite(Sprite sprite)
{
    centralObjectPresenter?.UpdateSprite(sprite);
}

public Sprite GetCurrentCentralObjectSprite()
{
    return centralObjectPresenter?.GetCurrentSprite();
}
```

**RestoreState修正**:
```csharp
// RestoreState内に追加（nullでも適用 = 明示的にクリア）
UpdateCentralObjectSprite(snapshot.CentralObjectSprite);
```

**設計根拠**:
- `RestoreState`は「スナップショット時点の状態を完全に復元」する
- nullの場合も明示的に適用することで、戻る時に「スプライト変更前の状態」を正しく復元

---

### Task 6: NovelPartDialogueRunner統合

**ファイル**: `Assets/Script/Walk/Dialogue/NovelPartDialogueRunner.cs`

**ExecuteStep内に追加**（立ち絵変更の後、テキストボックス切り替えの前）:
```csharp
private async UniTask<int> ExecuteStep(DialogueStep step, DialogueContext context, int stepIndex)
{
    // 1. 背景変更（既存）
    // 2. 立ち絵変更（既存）

    // 2.5. 中央オブジェクト変更（新規追加）
    if (step.HasCentralObjectChange && context.CentralObjectRT != null)
    {
        ui.UpdateCentralObjectSprite(step.CentralObjectSprite);
    }

    // 3. テキストボックス切り替え（既存）
    // 4. テキスト表示 + 雑音発火（既存）
    // ... 残りの処理
}
```

**スナップショット作成時の修正**（既存コード line 93-109 付近）:
```csharp
// スナップショット作成（ExecuteStep後）
if (snapshots != null && snapshots.Count <= currentIndex)
{
    var snapshot = new DialogueStateSnapshot(currentIndex, step, ui.CurrentDisplayMode);
    if (previousStep != null)
    {
        var prevSnapshot = snapshots.Count > 0 ? snapshots[snapshots.Count - 1] : null;
        if (prevSnapshot != null)
        {
            snapshot.LeftPortrait = prevSnapshot.LeftPortrait;
            snapshot.RightPortrait = prevSnapshot.RightPortrait;
            snapshot.HasBackground = prevSnapshot.HasBackground;
            snapshot.BackgroundId = prevSnapshot.BackgroundId;
            // 中央オブジェクトは継承しない（UIから実際の状態を取得する）
        }
    }
    snapshot.ApplyStep(step);  // 既存：立ち絵/背景の累積更新

    // 中央オブジェクトはApplyStepではなくUIから直接取得（新規追加）
    snapshot.CentralObjectSprite = ui.GetCurrentCentralObjectSprite();

    snapshots.Add(snapshot);
}
```

**設計根拠**:
- スナップショットは「UIから実際の表示状態を取得」する方式を採用
- `ApplyStep`での累積更新ではなく、`ui.GetCurrentCentralObjectSprite()`で直接取得
- これにより「2つの真実のソース」問題を回避

---

### Task 7: WalkingSystemManager初期化

**ファイル**: `Assets/Script/Walk/WalkingSystemManager.cs`（または初期化担当）

```csharp
// NovelPartEventUI初期化時にCentralObjectPresenterを設定
novelPartEventUI.SetCentralObjectPresenter(centralObjectPresenter);
```

---

## 実装フェーズ

### Phase 1: 基盤（単体で動作確認可能） ✅ 完了

| タスク | 内容 | 状態 |
|--------|------|------|
| Task 1 | CentralObjectPresenter.UpdateSprite/GetCurrentSprite | ✅ |
| Task 2 | DialogueStep.centralObjectSprite | ✅ |
| Task 3 | DialogueStateSnapshot.CentralObjectSprite | ✅ |

### Phase 2: UI層 ✅ 完了

| タスク | 内容 | 状態 |
|--------|------|------|
| Task 4 | INovelEventUI.UpdateCentralObjectSprite | ✅ |
| Task 5 | NovelPartEventUI実装 | ✅ |

### Phase 3: 統合 ✅ 完了

| タスク | 内容 | 状態 |
|--------|------|------|
| Task 6 | NovelPartDialogueRunner統合 | ✅ |
| Task 7 | WalkingSystemManager初期化 | ✅ |

---

## 変更検出ロジック

**採用しない**（最適化不要）

スプライト変更は `image.sprite = value` の単純な代入で、コストが低い。
最適化のために状態管理を追加すると複雑性が増すため、`HasCentralObjectChange`のみで判定する。

```csharp
// シンプルな判定（最適化なし）
if (step.HasCentralObjectChange && context.CentralObjectRT != null)
{
    ui.UpdateCentralObjectSprite(step.CentralObjectSprite);
}
```

---

## テスト計画

### Phase 1 完了時

- [ ] CentralObjectPresenter.UpdateSprite()でスプライトが変わること
- [ ] CentralObjectPresenter.GetCurrentSprite()で現在のスプライトが取得できること
- [ ] DialogueStep.HasCentralObjectChangeがnull時false、値あり時trueを返すこと

### Phase 2 完了時

- [ ] NovelPartEventUI.UpdateCentralObjectSprite()が動作すること
- [ ] CentralObjectPresenter未設定時にNullRefが発生しないこと

### Phase 3 完了時

- [ ] ノベルパート中に中央オブジェクトのスプライトが変更されること
- [ ] centralObjectSprite未指定時は前の状態が維持されること
- [ ] 「戻る」機能で中央オブジェクトのスプライトが復元されること
- [ ] ノベルパート終了後も変更されたスプライトが維持されること

### 戻る機能の詳細テスト（P2対応）

| ステップ | 中央スプライト指定 | 期待される表示 | 戻る時の復元 |
|----------|-------------------|---------------|-------------|
| Step 1 | なし | 初期状態 | 初期状態に戻る |
| Step 2 | Sprite A | Sprite A | Step 1に戻る→初期状態 |
| Step 3 | なし | Sprite A維持 | Step 2に戻る→Sprite A |
| Step 4 | Sprite B | Sprite B | Step 3に戻る→Sprite A |

**重要テストケース**:
- [ ] Step 4からStep 3に戻った時、Sprite Bではなく**Sprite A**が表示されること
  - UIから実際の状態を取得する方式で解決
- [ ] Step 3からStep 1に戻った時、初期状態（null or 歩行システムで設定されたスプライト）が表示されること

### 構図バリエーションテスト

| 構図 | 左立ち絵 | 右立ち絵 | 中央オブジェクト | テスト内容 |
|------|---------|---------|----------------|-----------|
| 左右対話 | ✅ | ✅ | - | 既存動作に影響なし |
| 三者会話 | ✅ | ✅ | ✅ 変更可能 | 中央が変化しながら会話 |
| 問い詰め | ✅ | ✅ | ✅ 固定 | 中央は変化なし |
| 中央のみ | - | - | ✅ 変更可能 | 左右立ち絵なしで中央のみ |

---

## 制約事項

1. **ズーム中のみ有効**: 中央オブジェクトが表示されていない状態では変更しても意味がない
2. **位置・サイズは変更不可**: 歩行システムで決定された位置にズームしているため
3. **ノベルパート終了時は変更維持**: 左右立ち絵と同様、元に戻さない

---

## 備考

- 設計方針Bを採用: NovelPartEventUIがCentralObjectPresenterを内部保持（UIレイヤーで完結）
- 実装順序: Phase 1 → Phase 2 → Phase 3 の順で実施

---

## 実装履歴

| 日付 | 内容 |
|------|------|
| 2026-01-30 | 全Phase（Task 1-7）実装完了、EditModeテスト全パス |
