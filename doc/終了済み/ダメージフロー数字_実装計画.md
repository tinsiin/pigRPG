# ダメージフロー数字 実装計画 【実装完了】

> **ステータス: 完了** — 仕様書は `doc/フロー数字仕様書.md` に移行済み。

## 概要

戦闘情報伝達の第3層（`doc/戦闘情報伝達の設計思想.md` 参照）。
ターゲットアイコン付近にダメージ数字+状況記号をポップアップ表示し、横方向に広がりながら消滅する。

## 採用案: 案E（小ポップ上昇 → 文字が穏やかに左右へ流れて消滅）

### アニメーション仕様

| フェーズ | 演出 | 時間 |
|---|---|---|
| 出現 | ターゲットアイコン付近に scale 0.8→1.0 でポップ | 0.05s |
| 上昇 | やや上方向に移動しながら滞留 | 0.3s |
| 消滅 | 各文字が中央からの距離に比例して左右に広がり + Y方向に微小ランダム揺れ + フェード | 0.5s |

### 消滅の詳細

- 各文字が独立して動く
- X方向: 文字列の中央を基準に、左側の文字は左へ、右側の文字は右へ移動。中央からの距離に比例して移動量が増える
- Y方向: ±6px程度のランダムな揺れ（主軸はあくまで左右）
- 同時にalpha 1→0でフェードアウト
- 全体の印象: 左右に静かに溶けていく。Bほど激しくなく、Cほどパキッとしない穏やかな消え方

### 数字+記号の表示

| 状況 | 表示例 | 色 |
|---|---|---|
| 通常ヒット | `90` | 黄色系 |
| クリティカル | `128!` | 赤系 |
| 乱れ攻撃 | `72^` | 黄色系 |
| かすり | `45?` | 灰青系 |

## 実装方針

### 生成

- ターゲットアイコンのRectTransform位置を基準に、EyeArea内のオーバーレイ用親の子としてTextMeshProUGUIを生成
- 高速連打に対応（複数の数字が同時に存在しうる。プーリングは初期実装では不要、パフォーマンス問題が出たら導入）

### アニメーション

1. **出現**: LitMotionで `localScale` を `(0.8, 0.8, 1)` → `(1, 1, 1)` に0.05sで補間
2. **上昇+滞留**: LitMotionで `anchoredPosition.y` をアイコン上端付近まで0.3sで上昇（easeOut）
3. **消滅**: TMP_TextInfoの頂点操作で各文字のpositionを個別にアニメーション
   - `textInfo.characterInfo[i]` の4頂点のX座標を中央基準で左右にオフセット
   - Y座標に `±6px` のランダムオフセット
   - `vertexColor.a` を0へフェード
   - `UpdateVertexData(TMP_VertexDataUpdateFlags.All)` で反映
   - 0.5sかけてeaseOutで補間

### 破棄

- 消滅アニメーション完了後に `Destroy(gameObject)`
- LitMotionの `MotionScheduler.UpdateIgnoreTimeScale` でポーズ中も進行

## 技術メモ

- TMP_TextInfo頂点操作: `TMP_TextInfo.characterInfo[i].vertexIndex` から4頂点を取得し、`meshInfo[materialIndex].vertices` を直接変更
- 毎フレーム更新ではなく、LitMotionのBindコールバック内で一括更新
- 矢印のターゲット位置は ArrowManager が既に保持しているので流用可能

## 検討した他の案（不採用）

| 案 | 概要 | 不採用理由 |
|---|---|---|
| A: 即出現→横引き伸び | scaleXを引き伸ばしてフェード | シンプルすぎて味気ない |
| B: 小ポップ→文字バラけ | 各文字がランダム方向に激しく飛散 | バラバラすぎて落ち着かない |
| C: 即出現→左右分裂 | 中央で2分割してパキッと割れる | 硬い印象。穏やかさがない |
| D: 矢印方向スライドイン→横伸び | 攻撃者側からスライドして登場 | 出現が派手寄り。連打時に動線混雑 |
