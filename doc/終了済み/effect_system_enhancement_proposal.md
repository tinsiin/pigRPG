# エフェクトシステム拡張提案

エフェクト制作の実践を通じて得られた、音声解析MCPおよび描画システムへの改善要望をまとめる。

---

## 1. 音声解析MCP (audio-envelope) への要望

### 現状

現在MCPが返す情報:

| フィールド | 内容 |
|---|---|
| `amp[]` | 全帯域合計の音量エンベロープ (0.0〜1.0) |
| `peaks[]` | 音量の局所的ピーク (index, amp, time) |
| `duration_sec` | 音声の長さ |
| `frame_count` | フレーム数 |
| `times[]` | 各フレームの時刻 |

### 1-1. 帯域別エネルギー【優先度: 最高】

**概要**: 低域・中域・高域に分離した音量エンベロープを返す。

**現状の問題**: `amp` は全帯域の合計値1本のみ。そのため、音の異なる要素（例: 斬撃の「シャッ」という高周波ノイズと「ドッ」という低周波の衝撃）を視覚的に分離できない。全ての視覚要素が同じタイミングで同じ強度で動いてしまう。

**欲しい形式**:

```json
{
  "bands": {
    "low": [0.1, 0.3, 0.8, ...],
    "mid": [0.2, 0.5, 0.4, ...],
    "high": [0.05, 0.9, 0.3, ...]
  }
}
```

| 帯域 | 周波数目安 | 視覚要素への対応 |
|---|---|---|
| low (低域) | ~300Hz | 衝撃波リング、画面揺れ、大きく重い動き |
| mid (中域) | 300Hz〜2kHz | メインの斬撃弧、エフェクト本体 |
| high (高域) | 2kHz~ | 火花、スパークル、細かい粒子 |

**効果**: 1本のamp曲線を3本の独立した駆動源に分離でき、視覚要素ごとに異なるタイミング・強度で動かせるようになる。これだけで表現力が根本的に変わる。

**実装案**: FFTまたはバンドパスフィルタで3帯域に分離し、それぞれのRMSエンベロープを計算。既存の `amp` と同じ正規化 (0.0〜1.0) で返す。帯域の境界はデフォルト値を持ちつつ、パラメータで調整可能にする。

---

### 1-2. スペクトル重心【優先度: 高】

**概要**: 各フレームで音の「明るさ（高さ）」を示す0.0〜1.0の値を返す。

**現状の問題**: エフェクトの色温度（白→暖色→暗色の遷移）を手動で設計している。音自体が「キラキラ」なのか「ドスン」なのかを数値で判断できない。

**欲しい形式**:

```json
{
  "brightness": [0.8, 0.75, 0.6, 0.3, ...]
}
```

- 値が高い → 音が明るい/鋭い（高周波が支配的）
- 値が低い → 音が暗い/重い（低周波が支配的）

**効果**: 色温度を音から自動決定できる。brightness 高 → 白〜寒色、brightness 低 → 暖色〜暗色。音と映像の色の一体感が生まれる。

**実装案**: スペクトル重心 (spectral centroid) を計算し、全体の最大値で正規化。librosa の `spectral_centroid` 相当。

---

### 1-3. トランジェント検出【優先度: 中】

**概要**: 音量の大小に関わらず、音が急に立ち上がる瞬間（onset）を検出して返す。

**現状の問題**: `peaks` は音量の局所最大値であり、「小さな音が急に鳴る瞬間」を捕捉できない。例えば余韻の中で鳴る小さな「チッ」は peaks に現れないが、視覚的にイベント（光点の明滅など）を起こしたいタイミングである。

**欲しい形式**:

```json
{
  "transients": [
    {"time": 0.12, "frame": 5, "strength": 0.9},
    {"time": 0.85, "frame": 38, "strength": 0.3},
    ...
  ]
}
```

**効果**: ピーク以外の微細なタイミングも拾え、より緻密な音声同期が可能になる。

**実装案**: スペクトルフラックスまたはonset strength envelope からピーク検出。librosa の `onset_detect` 相当。

---

### 1-4. ノイズ度（ざらつき）【優先度: 低】

**概要**: 各フレームで音がどの程度ノイジー（非調和的）かを示す0.0〜1.0の値。

**現状の問題**: 音の質感から形状の選択を手動で判断している（ファイル名やヒアリングに依存）。

**欲しい形式**:

```json
{
  "noisiness": [0.2, 0.3, 0.9, 0.8, ...]
}
```

- 値が高い → ノイジー、ざらついた音（爆発、摩擦、風）
- 値が低い → クリーン、調和的な音（ベル、チャイム、笛）

**効果**: 形状の選択を自動化できる。クリーン → 滑らかな円弧・幾何学。ノイジー → 不規則なポリゴン・粒子散乱・強い揺らぎ。

**実装案**: spectral flatness (Wiener entropy) を計算。0=純音、1=白色ノイズ。

---

## 2. 描画システム (EffectRenderer) への要望

### 現状の Shape 一覧

| type | 概要 |
|---|---|
| `point` | 点 |
| `line` | 直線 |
| `circle` | 円 |
| `ellipse` | 楕円 |
| `arc` | 円弧 |
| `rect` | 矩形 |
| `polygon` | 多角形 |
| `bezier` | ベジェ曲線 |

塗り: `brush` (単色ベタ塗り)、線: `pen` (単色・均一幅)

### 2-1. グラデーション塗り【優先度: 最高】

**概要**: brush に放射状/線形のグラデーションを指定可能にする。

**現状の問題**: 光のグローや炎の芯を表現するために、同心円を5〜6枚重ねて段階的にアルファを変えている。シェイプ数が膨張し（star_shine で 2039シェイプ）、段差が視認できてしまう。

**欲しい形式**:

```json
{
  "type": "circle",
  "x": 50, "y": 50,
  "radius": 30,
  "brush": {
    "type": "radial",
    "center": "#FFFFFFCC",
    "edge": "#FFAA0000"
  }
}
```

```json
{
  "brush": {
    "type": "linear",
    "start": "#FFFFFF",
    "end": "#FF660000",
    "angle": 90
  }
}
```

**効果**: 1シェイプで滑らかなグローを表現可能。シェイプ数が劇的に減少し、見た目も大幅改善。炎の芯、光の拡散、衝撃波のぼかし、全てに適用できる。

**実装参考**: Unity の `UIVertex` カラーに頂点カラーとしてグラデーションを設定するか、Shader で放射グラデーションを描画。

---

### 2-2. 加算ブレンド【優先度: 高】

**概要**: シェイプ単位でブレンドモードを指定可能にする。

**現状の問題**: 全てのシェイプがアルファブレンド（通常合成）で描画される。半透明の白い光を重ねると灰色っぽくなり、光が光として見えない。火花やスパークルが密集する場所ほど「明るく輝く」べきなのに、逆にくすむ。

**欲しい形式**:

```json
{
  "type": "circle",
  "x": 50, "y": 50,
  "radius": 10,
  "brush": { "color": "#FFFFFF80" },
  "blend": "additive"
}
```

| モード | 動作 | 用途 |
|---|---|---|
| `normal` (デフォルト) | 通常のアルファブレンド | ベースの形状 |
| `additive` | RGB値を加算（重なるほど明るい） | 光、火花、グロー、エネルギー |

**効果**: 光源の重なりが自然に明るくなり、エフェクト全体の光の説得力が向上。特にスパークル密集部分と衝撃波の交差部分で顕著。

**実装参考**: Unity の `CanvasRenderer` で `Material` のブレンドモードを切り替え、または `Blend One One` シェーダーを適用。

---

### 2-3. テーパーライン（先細り線）【優先度: 高】

**概要**: 始点と終点で太さが異なる線。

**現状の問題**: `line` の width は均一。斬撃の軌跡（根元が太く先端が細い）、光条（中心が太く端が細い）、彗星の尾が表現できない。

**欲しい形式**:

```json
{
  "type": "tapered_line",
  "x1": 30, "y1": 30,
  "x2": 70, "y2": 70,
  "width_start": 6,
  "width_end": 0.5,
  "pen": { "color": "#FFFFFFCC" }
}
```

**効果**: 斬撃エフェクトの表現力が飛躍的に向上。光条も先細りになることで自然な見た目になる。現状は先端も根元も同じ太さで不自然。

**実装参考**: 線を幅の異なる台形ポリゴンとして描画。4頂点の `Mesh` で実現可能。

---

### 2-4. リング（ドーナツ形状）【優先度: 中】

**概要**: 内径と外径を持つ塗りつぶし可能なリング形状。

**現状の問題**: `circle` の `pen` は細い輪郭線しか描けない。`width` を大きくしても面積感のある帯状リングにはならない。衝撃波を「厚みのある帯が広がる」ように表現したい。

**欲しい形式**:

```json
{
  "type": "ring",
  "x": 50, "y": 50,
  "inner_radius": 20,
  "outer_radius": 28,
  "brush": { "color": "#FFDDCC88" }
}
```

**効果**: 衝撃波、オーラ、魔法陣の帯状リングを1シェイプで表現可能。グラデーション塗りと組み合わせれば、内側から外側にフェードするリングも描ける。

---

### 2-5. パーティクルエミッタ【優先度: 中】

**概要**: 粒子群を1つの宣言的シェイプとして定義し、ランタイムで展開する。

**現状の問題**: 粒子表現のために Python で物理シミュレーションを行い、全フレームの全粒子の座標をJSONに焼き込んでいる。star_shine は 2039シェイプ、JSONファイルが肥大化し、制作コストも高い。

**欲しい形式**:

```json
{
  "type": "emitter",
  "x": 50, "y": 50,
  "count": 20,
  "angle_range": [0, 360],
  "speed_range": [1.0, 4.0],
  "gravity": 0.15,
  "drag": 0.94,
  "lifetime_range": [15, 25],
  "size_range": [1.0, 3.5],
  "color_start": "#FFFFFFCC",
  "color_end": "#FF660000",
  "blend": "additive",
  "seed": 42
}
```

**効果**: JSONサイズを1/10以下に削減。制作時に物理シミュレーションコードを書く必要がなくなり、宣言的にパラメータを調整するだけで粒子表現が作れる。seed指定で再現性も担保。

**実装参考**: フレーム描画時に seed ベースの決定的乱数で粒子を生成し、簡易物理（速度・重力・抵抗）でフレームごとの位置を算出して描画。

---

## 3. 優先度サマリー

### 音声解析 (audio-envelope MCP)

| 優先度 | 機能 | 改善インパクト |
|---|---|---|
| **最高** | 帯域別エネルギー (low/mid/high) | 視覚要素を周波数帯ごとに独立駆動 |
| 高 | スペクトル重心 (brightness) | 色温度の自動決定 |
| 中 | トランジェント検出 | 微細タイミングの音声同期 |
| 低 | ノイズ度 | 形状選択の自動化 |

### 描画システム (EffectRenderer)

| 優先度 | 機能 | 改善インパクト |
|---|---|---|
| **最高** | グラデーション塗り | 光・グローの表現品質が別次元に |
| 高 | 加算ブレンド | 光の重なりが自然になる |
| 高 | テーパーライン | 斬撃・光条の表現力 |
| 中 | リング | 衝撃波・オーラ表現 |
| 中 | パーティクルエミッタ | 制作効率の劇的改善 |
