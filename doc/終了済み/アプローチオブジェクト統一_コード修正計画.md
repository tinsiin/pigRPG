# アプローチオブジェクト統一 コード修正計画

## 概要

ゼロトタイプ歩行システム設計書の更新に伴い、以下の設計変更をコードに反映する。

**設計変更の要点:**
- 全てのアプローチオブジェクト（サイド、中央、門、出口）は、プレイヤーがアプローチまたはスルーを選択する
- 強制イベント（AutoTrigger）は存在しない
- HardBlock/SoftBlock/AutoTriggerモードを廃止し、単一の動作に統一

---

## 影響範囲

### 削除対象

| ファイル | 削除対象 |
|----------|----------|
| `GateMarker.cs` | `GateBlockingMode` enum, `blockingMode` フィールド/プロパティ |
| `NodeSO.cs` | `CenterTriggerMode` enum, `centerTriggerMode` フィールド/プロパティ |
| `CentralDisplayMode.cs` | `HardBlock`, `SoftBlock`, `AutoTrigger` 値（enumの簡素化） |

### 修正対象

| ファイル | 修正内容 |
|----------|----------|
| `AreaController.cs` | blockingMode分岐削除、AutoTrigger処理削除 |
| `CentralObjectPresenter.cs` | mode引数削除、常にボタン有効化 |

### 影響を受けるアセット

| アセット | 現状 | 対応 |
|----------|------|------|
| `Node_0__________.asset` | `blockingMode: 1` (SoftBlock) | フィールド削除後は無視される（互換性維持） |

---

## 修正詳細

### 1. GateMarker.cs

**場所:** `Assets/Script/Walk/Gate/GateMarker.cs`

**現在のコード (18行目, 36行目, 45-49行目):**
```csharp
[SerializeField] private GateBlockingMode blockingMode = GateBlockingMode.HardBlock;
// ...
public GateBlockingMode BlockingMode => blockingMode;
// ...
public enum GateBlockingMode
{
    HardBlock,
    SoftBlock
}
```

**修正後:**
- `blockingMode` フィールドを削除
- `BlockingMode` プロパティを削除
- `GateBlockingMode` enumを削除

---

### 2. NodeSO.cs

**場所:** `Assets/Script/Walk/NodeSO.cs`

**現在のコード (3-7行目, 23行目, 44行目):**
```csharp
public enum CenterTriggerMode
{
    Manual,
    AutoTrigger
}
// ...
[SerializeField] private CenterTriggerMode centerTriggerMode = CenterTriggerMode.Manual;
// ...
public CenterTriggerMode CenterTriggerMode => centerTriggerMode;
```

**修正後:**
- `CenterTriggerMode` enumを削除
- `centerTriggerMode` フィールドを削除
- `CenterTriggerMode` プロパティを削除

---

### 3. CentralDisplayMode.cs

**場所:** `Assets/Script/Walk/Presentation/CentralDisplayMode.cs`

**現在のコード:**
```csharp
public enum CentralDisplayMode
{
    Hidden,
    HardBlock,
    SoftBlock,
    AutoTrigger
}
```

**修正後:**
```csharp
public enum CentralDisplayMode
{
    Hidden,
    Visible  // 旧HardBlock相当（常にボタン表示）
}
```

---

### 4. AreaController.cs

**場所:** `Assets/Script/Walk/AreaController.cs`

#### 4.1 CheckGates() メソッド (323-410行目)

**現在のコード (335-354行目):**
```csharp
// Show gate
var displayMode = gate.BlockingMode == GateBlockingMode.HardBlock
    ? CentralDisplayMode.HardBlock
    : CentralDisplayMode.SoftBlock;
centralPresenter?.ShowGate(gate.Visual, displayMode);

// Wait for approach button (GateApproachButton or walk button to skip)
if (gate.BlockingMode == GateBlockingMode.HardBlock && approachUI != null)
{
    var gateLabel = !string.IsNullOrEmpty(gate.Visual.Label) ? gate.Visual.Label : "門";
    var choice = await approachUI.WaitForGateSelection(gateLabel);

    if (choice == ApproachChoice.Skip)
    {
        // Walk button = skip
        await HandleGateSkipped(gate);
        centralPresenter?.Hide();
        return true;
    }
    // GateApproachButton click = approach and check conditions
}
```

**修正後:**
```csharp
// Show gate (常にボタン表示)
centralPresenter?.ShowGate(gate.Visual);

// Wait for approach button (GateApproachButton or walk button to skip)
if (approachUI != null)
{
    var gateLabel = !string.IsNullOrEmpty(gate.Visual.Label) ? gate.Visual.Label : "門";
    var choice = await approachUI.WaitForGateSelection(gateLabel);

    if (choice == ApproachChoice.Skip)
    {
        // Walk button = skip
        await HandleGateSkipped(gate);
        centralPresenter?.Hide();
        return true;
    }
    // GateApproachButton click = approach and check conditions
}
```

#### 4.2 CheckGates() 末尾 (402-409行目)

**現在のコード:**
```csharp
// Only hide gate visual when blocking (HardBlock)
// SoftBlock gates let the step continue, so leave visual for subsequent content
if (gate.BlockingMode == GateBlockingMode.HardBlock)
{
    centralPresenter?.Hide();
    return true;
}
return false;
```

**修正後:**
```csharp
// ゲート処理完了後は常にHideしてreturn true（歩行をブロック）
centralPresenter?.Hide();
return true;
```

#### 4.3 HandleApproach() メソッド (635-697行目)

**現在のコード (639-647行目):**
```csharp
// AutoTrigger mode: 中央イベントを即時実行
if (hasCentral && centralEvent != null && currentNode.CenterTriggerMode == CenterTriggerMode.AutoTrigger)
{
    await TriggerEvent(centralEvent);
    centralPresenter?.Hide();
    // サイドオブジェクトは選択されず、pendingをクリア
    sideObjectSelector.ClearPending();
    return;
}
```

**修正後:**
- このブロックを**完全削除**
- 中央オブジェクトも常にアプローチ/スルー選択

---

### 5. CentralObjectPresenter.cs

**場所:** `Assets/Script/Walk/Presentation/CentralObjectPresenter.cs`

#### 5.1 ShowGate() メソッド (78-143行目)

**現在のコード:**
```csharp
public void ShowGate(GateVisual visual, CentralDisplayMode mode)
{
    // ...
    currentMode = mode;
    // ...
    if (mode == CentralDisplayMode.HardBlock)
    {
        EnsureButton();
        image.raycastTarget = true;
    }
    else
    {
        image.raycastTarget = false;
    }
    // ...
}
```

**修正後:**
```csharp
public void ShowGate(GateVisual visual)
{
    // ...
    currentMode = CentralDisplayMode.Visible;
    // ...
    // 常にボタン有効化
    EnsureButton();
    image.raycastTarget = true;
    // ...
}
```

#### 5.2 ShowExit() メソッド (145-153行目)

**現在のコード:**
```csharp
public void ShowExit(ExitVisual visual, bool allGatesCleared)
{
    if (!allGatesCleared) return;

    sfxPlayer?.Play(visual.SfxOnAppear);

    ShowGate(visual.ToGateVisual(), CentralDisplayMode.HardBlock);
}
```

**修正後:**
```csharp
public void ShowExit(ExitVisual visual, bool allGatesCleared)
{
    if (!allGatesCleared) return;

    sfxPlayer?.Play(visual.SfxOnAppear);

    ShowGate(visual.ToGateVisual());
}
```

#### 5.3 WaitForInteraction() メソッド (165-180行目)

**現在のコード:**
```csharp
public async UniTask<CentralInteractionResult> WaitForInteraction(...)
{
    if (currentMode != CentralDisplayMode.HardBlock)
        return CentralInteractionResult.Approached;
    // ...
}
```

**修正後:**
```csharp
public async UniTask<CentralInteractionResult> WaitForInteraction(...)
{
    if (currentMode == CentralDisplayMode.Hidden)
        return CentralInteractionResult.Skipped;
    // ...
}
```

---

## 実装順序

1. **CentralDisplayMode.cs** - enumの簡素化
2. **GateMarker.cs** - blockingMode削除
3. **NodeSO.cs** - centerTriggerMode削除
4. **CentralObjectPresenter.cs** - mode引数削除、常にボタン有効化
5. **AreaController.cs** - 分岐削除、AutoTrigger処理削除
6. **コンパイル確認** - エラーがないことを確認
7. **動作テスト** - ゲート/出口がボタン表示されることを確認

---

## 互換性

- 既存アセット（`Node_0__________.asset`等）の`blockingMode`フィールドは、コード側でフィールドを削除するとUnityが無視する
- アセットの再保存時に自動的にクリーンアップされる
- 明示的なアセット移行スクリプトは不要

---

## テスト項目

| テスト | 期待結果 |
|--------|----------|
| ゲート到達時 | ボタンが表示される |
| ゲートボタンクリック | 条件判定が実行される |
| ゲート表示中に歩行ボタン | スルーできる |
| 出口到達時 | ボタンが表示される |
| 出口ボタンクリック | 遷移選択UIが表示される |
| 出口表示中に歩行ボタン | スルーできる |
| 中央オブジェクト表示時 | ボタンが表示される |
| 中央オブジェクトボタンクリック | イベントが実行される |
| 中央オブジェクト表示中に歩行ボタン | スルーできる |

---

## 備考

- 本修正はゼロトタイプ歩行システム設計書（2026-01-21更新）に基づく
- 強制イベントが必要な場合は`onEnter`等のコールバックで実現する
