# 歩行システム残要素 実装計画（補完版）

## 概要

ゼロトタイプ歩行システム設計書に対する未実装項目の実装計画。
優先度と依存関係を明確化し、実装時の迷いをなくす。

## 前提・決定事項

- 参照元: doc/歩行システム設計/ゼロトタイプ歩行システム設計書.md
- アニメーション（appear/hide）は本計画から除外（SFXは対象）。
- 既存UIの入口は維持する。
  - 歩行アプローチ: WalkApproachUI
  - 出口選択: IExitSelectionUI（Walking.CreateAreaButton）
- 抽選は再現性を担保する。NodeSeed + Counters を用いた安定乱数を使用する。
- cooldownの単位は全て「歩数」で統一する。

---

## 仕様の補完（この計画で確定する挙動）

### ExitCandidate/Edgeの扱い

- 既定は「条件を満たす候補をすべて表示」。
- ExitCandidate.weight は既定ではUI表示に影響しない。
- 任意で「重み付きで候補数を制限する」モードを追加する。
  - NodeSO.exitSelectionMode = AllValid | WeightedPick
  - NodeSO.maxExitChoices（0は無制限）
  - WeightedPick時のみweightを使用し、maxExitChoices件まで抽選する。
- **Edge経由の出口生成（シンプルルール）**:
  - `NodeSO.exits`が空の場合のみ、`FlowGraphSO.edges`から出口候補を生成する。
  - `useEdgesAsExits`フラグは使用しない（exitsが空かどうかで自動判定）。
  - 生成時に EdgeSO.conditions と weight を引き継ぐ。
  - exitsが定義されていればそちらを優先。edgesはグラフ可視化とバックアップ用。

### サイドオブジェクトの偏り抑制（varietyBias/varietyDepth）

抽選時の重み計算:
```
実効重み = 基本重み × (履歴にあれば varietyBias、なければ 1.0)
```

| パラメータ | 型 | 意味 | 例 |
|-----------|---|------|---|
| varietyDepth | int | 直近何件の履歴を見るか | 2 → 直近2回分を見る |
| varietyBias | float | 履歴にある場合の重み係数 | 0.3 → 重みが30%に減少 |

**例**: varietyDepth=2, varietyBias=0.3
- 直近2回に出現した「宿屋」の実効重み = 基本重み × 0.3
- 直近2回に出現していない「道具屋」の実効重み = 基本重み × 1.0

**既定値**: varietyDepth=0（履歴を使わない＝現行挙動）

### サイドオブジェクトの「未選択側保持」

- 既定は無効（現行挙動と一致）。
- NodeSO.retainUnselectedSide = true の場合のみ、未選択側を次の1歩だけ保持する。
- 保持はノード遷移・歩数なしリフレッシュ・PositionOnlyリワインドでクリア。
- PositionAndStateリワインド時は`WalkAnchor.SideObjectStateSnapshot`を復元する。

### 固定サイドオブジェクト（fixedOnEnter）

ノード突入時に強制表示するサイドオブジェクトを左右個別に指定する。

```csharp
[Serializable]
public struct FixedSideObjectPair
{
    public SideObjectSO left;   // nullなら抽選
    public SideObjectSO right;  // nullなら抽選
}
```

**例**:
- `left = 案内人, right = null` → 左に案内人固定、右は通常抽選
- `left = null, right = null` → 両方通常抽選（既定）

### EncounterState保存キー

- EncounterTableSOに tableId を追加し、セーブ/ロードは tableId で紐付ける。
- tableIdは手動またはEditor補助で固定する（GUID推奨）。

### AutoTrigger

- 中央イベントの発動方式は NodeSO.centerTriggerMode で定義する。
  - Manual: 既存のアプローチUIから選択
  - AutoTrigger: 表示と同時にEventHost.Trigger（アプローチUIは出さない）

### 遭遇補正Overlayの保存

- Overlayは既定で保存対象外。
- `EncounterOverlay.persistent = true`のもののみWalkProgressDataに保存する。
- フラグ名は`persistent`（「保存するか」を直接表現）。

### 会話システム（Phase 3.2）

- 本計画では最小実装とする。
- 既存の`MessageDropper`をそのまま使用し、選択肢なしの単純会話のみ対応。
- 分岐会話・選択肢UIは将来の専用システムで対応する。
- DialogueDefinitionSO/ConversationRunnerは将来用に構造だけ定義し、実装は最小限。

---

## Phase 1: コア体験（高優先度）

### 1.1 サイドオブジェクト履歴制御

**目的**: 同じサイドオブジェクトの連続出現を抑制し、多様性を確保する。

**実装内容**:
- varietyBias + varietyDepthで直近履歴を加味した抽選を行う。
- cooldownStepsで「選択後N歩は再出現しない」を実装。
- retainUnselectedSide（任意）を実装。
- fixedOnEnter（任意）でノード突入時の強制提示を実装。
- conditionsで候補フィルタを実装。

**データ更新**:
- SideObjectTableSO
  - varietyBias: float（既存）
  - varietyDepth: int（新規、既定=0）
- SideObjectEntry
  - conditions: ConditionSO[]（新規）
  - cooldownSteps: int（新規、単位=歩数）
- NodeSO
  - fixedSideObjects: FixedSideObjectPair（新規）
  - retainUnselectedSide: bool（新規、既定=false）

**新規ファイル**:
```
Assets/Script/Walk/SideObjects/
├── SideObjectSelector.cs        // 抽選ロジック（conditions/variety/cooldown）
├── SideObjectCooldownTracker.cs // クールダウン管理（歩数ベース）
├── VarietyHistory.cs            // 直近履歴（深さ=varietyDepth）
├── SideObjectState.cs           // 保存用状態
└── FixedSideObjectPair.cs       // 左右個別指定構造体
```

**既存ファイル変更**:
- Assets/Script/Walk/SideObjects/SideObjectTableSO.cs
- Assets/Script/Walk/SideObjects/SideObjectResolver.cs（SideObjectSelectorに委譲）
- Assets/Script/Walk/NodeSO.cs
- Assets/Script/Walk/AreaController.cs
- Assets/Script/Walk/WalkProgressData.cs
- Assets/Script/Walk/Anchor/WalkAnchor.cs（SideObjectStateSnapshot追加）
- Assets/Script/Walk/Anchor/WalkAnchorData.cs

**受け入れ条件**:
- varietyDepth=2, varietyBias=0.3で直近2回に出たものの出現率が約30%に低下すること。
- cooldownSteps=5で選択後5歩は出現しないこと。
- retainUnselectedSide=true時のみ未選択側が1歩残ること。
- fixedSideObjects指定時、ノード突入で固定表示されること。

---

### 1.2 分岐条件・重み付け・Edge接続

**目的**: 出口選択肢に条件/重み付けを適用し、FlowGraphSO.edgesを実行に接続する。

**実装内容**:
- ExitCandidate.conditionsで候補をフィルタ。
- ExitCandidate.weightをWeightedPick時にのみ使用。
- EdgeSO.conditionsを追加（weightは既存）。
- ExitResolverで候補生成と抽選を一元化。
- FlowGraphSO.GetEdgesFrom(nodeId)を追加。
- **exitsが空ならedgesから出口生成**（フラグ不要）。

**データ更新**:
- ExitCandidate
  - conditions: ConditionSO[]（新規）
  - weight: float（新規、他と型を統一）
- EdgeSO
  - conditions: ConditionSO[]（新規）
  - weight: int（既存/維持）
- NodeSO
  - exitSelectionMode: AllValid | WeightedPick（新規、既定=AllValid）
  - maxExitChoices: int（新規、既定=0=無制限）
  - ~~useEdgesAsExits~~: 廃止（exitsが空かで自動判定）

**新規ファイル**:
```
Assets/Script/Walk/Exit/
└── ExitResolver.cs  // 条件評価 + 候補生成 + WeightedPick
```

**既存ファイル変更**:
- Assets/Script/Walk/ExitCandidate.cs
- Assets/Script/Walk/EdgeSO.cs
- Assets/Script/Walk/FlowGraphSO.cs（GetEdgesFrom追加）
- Assets/Script/Walk/AreaController.cs（ExitResolver使用）

**受け入れ条件**:
- 条件を満たさない出口はUIに出ないこと。
- WeightedPick + maxExitChoices=2で、重みに基づき2件に絞られること。
- exitsが空のノードでedgesから出口が生成されること。

---

### 1.3 EncounterState保存

**目的**: セーブ/ロード時に遭遇状態を復元する。

**実装内容**:
- EncounterTableSO.tableIdを追加し、保存キーに使用。
- EncounterStateDataを追加し、WalkProgressDataで保存/復元。
- GameContextがEncounterStateをtableIdで保持できるようにする。

**新規ファイル**:
```
Assets/Script/Walk/Encounter/
└── EncounterStateData.cs  // tableId + stateのシリアライズ用
```

**既存ファイル変更**:
- Assets/Script/Walk/Encounter/EncounterTableSO.cs（tableId追加）
- Assets/Script/Walk/Encounter/EncounterState.cs（必要項目の整理）
- Assets/Script/Walk/WalkProgressData.cs
- Assets/Script/Walk/GameContext.cs（tableId→EncounterState解決）

**受け入れ条件**:
- セーブ/ロード後にcooldown/grace/pityが維持されること。

---

## Phase 2: 演出・補正（中優先度）

### 2.1 中央オブジェクト AutoTrigger

**目的**: クリック不要で即時イベント発動。

**実装内容**:
- NodeSO.centerTriggerMode を追加。
- AutoTrigger時は中央表示→EventHost.Trigger→Hide。
- Manual時は既存のアプローチUI経由。

**既存ファイル変更**:
- Assets/Script/Walk/NodeSO.cs
- Assets/Script/Walk/AreaController.cs
- Assets/Script/Walk/Presentation/CentralObjectPresenter.cs（モード引数追加）

**受け入れ条件**:
- AutoTrigger時は入力不要でイベントが完了すること。

---

### 2.2 SFX再生

**目的**: ゲート/出口出現時にサウンドを鳴らす。

**実装内容**:
- GateVisualの既存SFXフィールドを利用。
- ExitVisualにsfxOnAppearを追加。
- WalkSFXPlayerで再生経路を一元化。

**新規ファイル**:
```
Assets/Script/Walk/Audio/
└── WalkSFXPlayer.cs
```

**既存ファイル変更**:
- Assets/Script/Walk/ExitVisual.cs（sfxOnAppear追加）
- Assets/Script/Walk/Presentation/CentralObjectPresenter.cs
- Assets/Script/Walk/AreaController.cs

**受け入れ条件**:
- ゲート/出口出現時にSFXが再生されること。

---

### 2.3 遭遇補正（Overlay/エリア倍率）

**目的**: エリア全体やイベント中の遭遇率補正を行う。

**実装内容**:
- NodeSO.encounterRateMultiplier を追加。
- EncounterOverlay スタックを追加（倍率/残り歩数/persistent）。
- GameContext.IsEncounterDisabledで一時無効化。
- `persistent=true`のOverlayのみWalkProgressDataに保存。

**新規ファイル**:
```
Assets/Script/Walk/Encounter/
└── EncounterOverlay.cs
```

**既存ファイル変更**:
- Assets/Script/Walk/NodeSO.cs
- Assets/Script/Walk/Encounter/EncounterResolver.cs
- Assets/Script/Walk/GameContext.cs
- Assets/Script/Walk/WalkProgressData.cs（persistentなOverlayのみ保存）

**受け入れ条件**:
- multiplier=2.0で遭遇率が2倍になること。
- IsEncounterDisabled=trueで遭遇が発生しないこと。
- persistent=trueのOverlayがセーブ/ロードで維持されること。

---

## Phase 3: 状態拡張（中〜低優先度）

### 3.1 タグ概念

**目的**: 一時的なラベルで状態を表現する。

**実装内容**:
- GameContext.tags: HashSet<string>
- AddTag/RemoveTag/HasTag
- HasTagConditionの追加

**既存ファイル変更**:
- Assets/Script/Walk/GameContext.cs
- Assets/Script/Walk/WalkProgressData.cs
- Assets/Script/Walk/Conditions/HasTagCondition.cs（新規）

**受け入れ条件**:
- タグの追加/削除/判定が機能すること。
- セーブ/ロードでタグが維持されること。

---

### 3.2 会話定義（最小実装）

**目的**: 会話イベントの定義と実行（選択肢なし）。

**実装内容**:
- 既存MessageDropperをそのまま使用。
- DialogueDefinitionSOは将来用に構造だけ定義。
- 選択肢・分岐は将来の専用システムで対応。

**新規ファイル**:
```
Assets/Script/Walk/Dialogue/
├── DialogueDefinitionSO.cs  // 構造定義のみ
└── DialogueNode.cs          // 構造定義のみ
```

**補足**:
- ConversationRunnerは本Phaseでは実装しない。
- Event KernelからはShowMessageEffect経由でMessageDropperを呼ぶ。

**受け入れ条件**:
- ShowMessageEffectで会話メッセージが表示されること。

---

## Phase 4: 検証・デバッグ（低優先度）

### 4.1 履歴・ログ保存

**目的**: デバッグと再現テスト。

**実装内容**:
- サイドオブジェクト履歴
- 遭遇ロールログ（候補/除外理由/重み/結果）
- variety履歴

**新規ファイル**:
```
Assets/Script/Walk/Debug/
├── WalkDebugLog.cs
└── RollLogEntry.cs
```

**受け入れ条件**:
- ログが出力され、抽選結果の検証が可能なこと。

---

### 4.2 Validator/SimRunner

**目的**: データ設計ミスの検出と抽選シミュレーション。

**新規ファイル**:
```
Assets/Editor/Walk/
├── GraphValidator.cs
└── SimRunner.cs
```

**受け入れ条件**:
- 到達不能ノード、出口なしノードが検出されること。
- N歩シミュレーションで遭遇率/サイド出現分布が検証可能なこと。

---

## 実装順序サマリ

```
Phase 1（コア体験）
  1.1 サイドオブジェクト履歴制御
  1.2 分岐条件・重み付け・Edge接続
  1.3 EncounterState保存

Phase 2（演出・補正）
  2.1 AutoTrigger
  2.2 SFX再生
  2.3 遭遇補正

Phase 3（状態拡張）
  3.1 タグ概念
  3.2 会話定義（最小実装）

Phase 4（検証・デバッグ）
  4.1 履歴・ログ保存
  4.2 Validator/SimRunner
```

---

## 依存関係

```
1.1 サイドオブジェクト履歴制御
  ├── WalkProgressDataの拡張
  └── WalkAnchor/WalkAnchorDataの拡張（SideObjectStateSnapshot）
      ↑ 1.3と同時編集時は衝突注意

1.2 分岐条件・重み付け・Edge接続
  └── FlowGraphSO拡張

1.3 EncounterState保存
  ├── EncounterTableSO.tableIdの追加
  └── WalkProgressDataの拡張
      ↑ 1.1と同時編集時は衝突注意

2.3 遭遇補正
  └── 1.3 EncounterState保存（persistentなOverlay保存）

4.1 履歴・ログ保存
  └── 1.1 サイドオブジェクト履歴制御

4.2 Validator/SimRunner
  └── 1.2 Edge接続
```

**推奨実装順序**:
1. 1.3 EncounterState保存（WalkProgressData拡張の基盤）
2. 1.1 サイドオブジェクト履歴制御（1.3の後なら衝突少）
3. 1.2 分岐条件・Edge接続（独立性高い）
4. Phase 2以降は並行可能

---

## 備考

- 既存データに影響を与えない既定値を採用する。
  - exitSelectionMode = AllValid
  - retainUnselectedSide = false
  - varietyDepth = 0（履歴を使わない）
  - encounterRateMultiplier = 1.0
  - cooldownSteps = 0（クールダウンなし）
- 実装開始時に各Phaseの受け入れテストを追加する。
- 会話システムの本格実装は本計画のスコープ外（将来対応）。
