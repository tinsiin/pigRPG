# 3者会話構図設計

## 概要

ノベルパートで「左右の立ち絵 + 中央オブジェクト」の3者会話を実現するための設計。

**重要**: 「3人目を真ん中に表示する」のではなく、**歩行システムの中央オブジェクト自体**を会話相手として扱う。

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート設計.md) - 設計本体（キャラクター配置セクション）
- [ズーム仕様書.md](../ズーム仕様書.md) - 演出ズームの仕組み
- [歩行システム動作解説.md](../歩行システム設計/歩行システム動作解説.md) - 中央オブジェクトの基本動作
- [ノベルパート未実装機能一覧.md](./ノベルパート未実装機能一覧.md) - P4-9

---

## 設計方針

### 前提条件

3者会話が発生するのは以下のフロー：

```
歩行システム
    ↓
中央オブジェクト抽選（CentralObjectTableSO から選択）✅ 実装済み
    ↓
中央オブジェクト表示（CentralObjectSO.Visual で見た目決定）✅ 実装済み
    ↓
ユーザーがアプローチ
    ↓
ズームイン（演出ズーム: ZoomBackContainer がスケール）
    ↓
ノベルパート開始（中央オブジェクトにズームした状態）
    ↓
【ここで中央オブジェクトのスプライトを変更可能にする】
    ↓
ノベルパート終了
    ↓
ズームアウト
```

### 方針: 中央オブジェクトスプライト変更

**新しい立ち絵枠を追加するのではなく**、既存の中央オブジェクト（`CentralObjectPresenter`）のスプライトを会話中に変更する。

| 項目 | 変更する | 変更しない |
|------|---------|-----------|
| スプライト | ✅ 会話中に変更可能 | - |
| 位置（Offset） | - | ✅ 歩行システムで決定済み |
| サイズ（Size） | - | ✅ 歩行システムで決定済み |
| ズーム状態 | - | ✅ NovelDialogueStepで制御済み |

---

## 歩行システムとの連携

### 現状の中央オブジェクト設定 ✅ 抽選システム実装済み

> **Note**: 中央オブジェクト抽選システムは実装完了。
> 詳細: [中央オブジェクト抽選システム実装計画.md](../終了済み/中央オブジェクト抽選システム実装計画.md)

```csharp
// NodeSO.cs（新構造）
[SerializeField] private CentralObjectTableSO centralObjectTable;  // 抽選テーブル
[SerializeField] private CentralObjectSO fixedCentralObject;       // ノード入場時固定（オプション）

// CentralObjectSO.cs（新規）
public sealed class CentralObjectSO : ScriptableObject
{
    public string Id;
    public CentralObjectVisual Visual;        // 見た目
    public EventDefinitionSO EventDefinition; // アプローチ時イベント
}

// CentralObjectVisual 構造体（変更なし）
public struct CentralObjectVisual
{
    public Sprite Sprite;   // 表示スプライト
    public Vector2 Size;    // サイズ
    public Vector2 Offset;  // 位置オフセット
    public Color Tint;      // 色
}
```

### CentralObjectPresenter の現状

```csharp
// CentralObjectPresenter.cs
public void Show(CentralObjectVisual visual, bool forceShow)
{
    image.sprite = visual.HasSprite ? visual.Sprite : GetFallbackSprite();
    // ... サイズ、位置、色を設定
}
```

**問題**: `Show()` は歩行ステップ開始時に呼ばれる。会話中にスプライトだけを変更するAPIがない。

---

## 実装タスク

### 1. CentralObjectPresenter にスプライト変更メソッド追加

```csharp
// CentralObjectPresenter.cs に追加
/// <summary>
/// スプライトのみを変更する（位置・サイズは維持）。
/// ノベルパート中の中央オブジェクト変更用。
/// </summary>
public void UpdateSprite(Sprite sprite)
{
    if (image == null) return;
    image.sprite = sprite ?? GetFallbackSprite();
}

/// <summary>
/// 現在のスプライトを取得する。
/// 状態復元用。
/// </summary>
public Sprite GetCurrentSprite()
{
    return image?.sprite;
}
```

### 2. DialogueStep に中央オブジェクト変更フィールド追加

```csharp
// DialogueStep.cs に追加
[Header("中央オブジェクト")]
[SerializeField] private Sprite centralObjectSprite;

public Sprite CentralObjectSprite => centralObjectSprite;
public bool HasCentralObjectChange => centralObjectSprite != null;
```

**注**: 左右立ち絵と同様、`null` = 変更なし（前の状態維持）、値あり = 変更。

### 3. INovelEventUI に中央オブジェクト変更メソッド追加

```csharp
// INovelEventUI.cs に追加
/// <summary>
/// 中央オブジェクトのスプライトを変更する。
/// ズーム中の会話でのみ有効。
/// </summary>
void UpdateCentralObjectSprite(Sprite sprite);
```

### 4. NovelPartEventUI で実装

```csharp
// NovelPartEventUI.cs に追加
public void UpdateCentralObjectSprite(Sprite sprite)
{
    // CentralObjectPresenter への参照が必要
    // GameContext 経由または直接参照
    centralObjectPresenter?.UpdateSprite(sprite);
}
```

### 5. NovelPartDialogueRunner で中央オブジェクト更新処理

```csharp
// NovelPartDialogueRunner.cs の ExecuteStep() に追加
private async UniTask ExecuteStep(DialogueStep step, DialogueContext context, int index)
{
    // 既存の処理...

    // 中央オブジェクト変更
    if (step.HasCentralObjectChange && context.CentralObjectRT != null)
    {
        ui.UpdateCentralObjectSprite(step.CentralObjectSprite);
    }

    // 残りの処理...
}
```

### 6. DialogueStateSnapshot に中央オブジェクト状態追加（戻る機能対応）

```csharp
// DialogueStateSnapshot.cs に追加
public Sprite CentralObjectSprite { get; set; }
```

```csharp
// スナップショット作成時
snapshot.CentralObjectSprite = centralObjectPresenter?.GetCurrentSprite();

// 復元時
if (snapshot.CentralObjectSprite != null)
{
    ui.UpdateCentralObjectSprite(snapshot.CentralObjectSprite);
}
```

### 7. CentralObjectPresenter への参照経路

**選択肢A: DialogueContext経由**
```csharp
// DialogueContext.cs に追加
public CentralObjectPresenter CentralObjectPresenter { get; set; }
```

**選択肢B: INovelEventUIが内部で保持**
```csharp
// NovelPartEventUI.cs
private CentralObjectPresenter centralObjectPresenter;
public void SetCentralObjectPresenter(CentralObjectPresenter presenter) { ... }
```

→ **選択肢Bを推奨**（UIレイヤーで完結）

---

## 構図バリエーション

| 構図 | 左立ち絵 | 右立ち絵 | 中央オブジェクト | 用途 |
|------|---------|---------|----------------|------|
| 左右対話 | ✅ | ✅ | - | 2人の対話 |
| 三者会話 | ✅ | ✅ | ✅ 変更可能 | 3人が会話 |
| 問い詰め | ✅ | ✅ | ✅ 固定 | 左右から問い詰める |
| チーム構図 | ✅ | ✅ | ✅ 変更可能 | 左右がチームとして中央に対峙 |
| 中央のみ | - | - | ✅ 変更可能 | 静物との会話、モノローグ |

---

## 使用例

### DialogueSO での設定

```yaml
steps:
  - speaker: "Geino"
    text: "あの自販機、動いてるな"
    leftPortrait: { characterId: "geino", expression: "normal" }
    # 中央オブジェクトはNodeSOで設定済み（自販機）、変更なし

  - speaker: "自販機"
    text: "イラッシャイマセ"
    centralObjectSprite: "vending_machine_active"  # 光る自販機に変更

  - speaker: "Noramlia"
    text: "喋った!?"
    rightPortrait: { characterId: "noramlia", expression: "surprised" }
    # centralObjectSprite未指定 = 前のステップの状態を維持
```

---

## 制約事項

1. **ズーム中のみ有効**: 中央オブジェクトが表示されていない（ズームしていない）状態では変更しても意味がない
2. **位置・サイズは変更不可**: 歩行システムで決定された位置にズームしているため、動かすとズームがずれる
3. **ノベルパート終了時は変更維持**: 左右立ち絵と同様、最後のスプライト状態を維持（元に戻さない）

---

## 決定事項

### ノベルパート終了時のスプライト復元

| 方針 | 動作 | メリット | デメリット |
|------|------|---------|-----------|
| A: 自動復元 | 会話終了時に元のスプライトに戻す | 予測可能 | 会話で変化した状態が消える |
| **B: 変更維持** | **会話で変更したスプライトを維持** | **会話の影響が残る** | - |
| C: 明示的指定 | DialogueSOで復元するか選択 | 柔軟 | 設定が複雑 |

→ **方針B（変更維持）に決定**。左右立ち絵と同様、ノベルパート終了後も最後のスプライト状態を維持する。

---

## 実装フェーズ

### Phase 1: 基盤 ✅ 完了

- [x] CentralObjectPresenter.UpdateSprite() 追加
- [x] CentralObjectPresenter.GetCurrentSprite() 追加
- [x] DialogueStep.centralObjectSprite 追加

### Phase 2: UI層 ✅ 完了

- [x] INovelEventUI.UpdateCentralObjectSprite() 追加
- [x] INovelEventUI.GetCurrentCentralObjectSprite() 追加
- [x] NovelPartEventUI に CentralObjectPresenter 参照追加
- [x] NovelPartEventUI.UpdateCentralObjectSprite() 実装

### Phase 3: Runner統合 ✅ 完了

- [x] NovelPartDialogueRunner で中央オブジェクト更新処理追加
- [x] DialogueStateSnapshot に CentralObjectSprite 追加
- [x] 戻る機能での中央オブジェクト復元
- [x] WalkingSystemManager で SetCentralObjectPresenter 呼び出し

### ~~Phase 4: 終了時復元~~ （不要）

方針B（変更維持）に決定したため、復元処理は不要。

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-30 | 初版作成 |
| 2026-01-30 | 歩行システム連携セクション更新：中央オブジェクト抽選システム実装完了を反映 |
| 2026-01-30 | 終了時スプライト復元を方針B（変更維持）に決定、Phase 4削除 |
| 2026-01-30 | **全Phase実装完了** |
