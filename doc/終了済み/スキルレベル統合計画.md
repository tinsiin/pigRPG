# スキルレベル統合計画

## 1. 目的

BaseSkillの**全プロパティ**をSkillLevelDataに統合する。

現行の「ベース固定値 + レベルオプション上書き」二重構造を廃止し、
**SkillLevelDataが唯一の値ソース**となるシンプルなアーキテクチャへ移行する。

## 2. 設計思想

### 2.1 結論に至った経緯

スキルは成長とともに**本質的に変容する**。
名前・属性・攻撃性質すら変わりうる。

この前提では「固定値」と「レベル値」の区分け自体が不自然であり、
開発者に「この値はどこで決まっているのか」という混乱を生む。

### 2.2 採用方針: 明示コピー方式

**全レベルが全プロパティの完全な値セットを持つ。**
哨兵値による継承メカニズムは使わない。

```
SkillLevelData[0]: 全値入り（＝ベース）
SkillLevelData[1]: 全値入り（[+]コピーして、変えたい部分だけ編集）
SkillLevelData[2]: 全値入り（同上）

→ 値の読み取り = そのレベルのデータを直接読むだけ
→ 哨兵値なし、逆向き検索なし、nullチェックなし
```

### 2.3 値の読み取り

```csharp
// 現在のレベルインデックス（リスト上限でクランプ）
int _levelIndex => Math.Min(_nowSkillLevel, FixedSkillLevelData.Count - 1);

// 全プロパティが同じパターン
public string SkillName     => FixedSkillLevelData[_levelIndex].SkillName;
public float  SkillPower    => FixedSkillLevelData[_levelIndex].SkillPower;
public int    SKillDidWaitCount => FixedSkillLevelData[_levelIndex].SkillDidWaitCount;
// ... 以下全て同じ
```

### 2.4 Inspector上での運用

```
[+]ボタンを押す → 前レベルのデータが丸ごとコピーされる（Unity標準動作）
                → 変えたいプロパティだけ編集する
                → 変えないプロパティは前レベルの値がそのまま残る
```

- Lv0を後から修正した場合、Lv1以降への自動伝播はしない（明示コピーなので）
- 必要なら**エディタ拡張で「指定フィールドを全レベルに一括コピー」**ボタンを設ける（将来）

### 2.5 レベルを超えた場合

リスト末尾のデータが使われ続ける（`Math.Min`によるクランプ）。
加えて `_infiniteSkillPowerUnit` / `_infiniteSkillTenDaysUnit` による
無限スケーリング加算が適用される（既存の仕組み、変更なし）。

### 2.6 特殊プロパティパターン

一部のプロパティはレベルデータの直接読み取りに加え、ランタイム合成がある:

| プロパティ | パターン | 説明 |
|-----------|---------|------|
| `SkillType` | `LevelData.BaseSkillType \| bufferSkillType` | 戦闘中バッファとのビット合成 |
| `SubEffects` | `LevelData.SubEffects.Concat(bufferSubEffects)` | バッファとの連結 |
| `DEFATK` | 連続攻撃2回目以降はMoveSetのDEFATKを使用、それ以外はLevelData | 分岐ロジック |
| `CashMoveSet()` | LevelDataからキャッシュに読み込み | 連続攻撃中のレベル変化防止 |

## 3. 全体像

```
【完成形（Phase 2 実施済み）】
  BaseSkill本体フィールド: [HideInInspector]で残存（マイグレーション安全弁）
  SkillLevelData[n]: 全値の完全セット（哨兵なし、Optionなし）
  値の読み取り: FixedSkillLevelData[_levelIndex].Xxx（直接読み）
  GetLevelOption: 廃止済み

  Inspector:
    BaseSkillDrawer: 概要パネル + テンプレート + バリデーション + レベルリスト + 無限スケーリング
    SkillLevelDataDrawer: 各レベルエントリを9セクションfoldoutで表示
```

## 4. SkillLevelData フィールド一覧（全40件）

### 4.1 セクション構成

| # | セクション | フィールド数 |
|---|-----------|------------|
| 1 | 基本情報 | 6 |
| 2 | スキル性質 | 6 |
| 3 | 威力・命中・ダメージ | 7 |
| 4 | コスト・補正 | 7 |
| 5 | 連撃・ストック・トリガー | 7 |
| 6 | 前のめり | 3 |
| 7 | ムーブセット | 2 |
| 8 | (未使用) | 0 |
| 9 | エフェクト・パッシブ付与 | 10 |
| | **合計** | **48** (8欠番含む) |

### 4.2 全フィールド詳細

| セクション | フィールド名 | 型 | デフォルト値 | 備考 |
|-----------|------------|-----|------------|------|
| **① 基本情報** | | | | |
| | SkillName | string | "" | |
| | SkillSpiritual | SpiritualProperty | 0 | |
| | SkillPhysical | PhysicalProperty | 0 | |
| | Impression | SkillImpression | 0 | |
| | MotionFlavor | MotionFlavorTag | null | ScriptableObject参照 |
| | SpecialFlags | SkillSpecialFlag | 0 | Flags enum |
| **② スキル性質** | | | | |
| | BaseSkillType | SkillType | 0 | Flags enum |
| | ConsecutiveType | SkillConsecutiveType | 0 | Flags enum |
| | ZoneTrait | SkillZoneTrait | 0 | Flags enum |
| | DistributionType | AttackDistributionType | 0 | |
| | PowerRangePercentageDictionary | SerializableDictionary | new() | |
| | HitRangePercentageDictionary | SerializableDictionary | new() | |
| **③ 威力・命中** | | | | |
| | SkillPower | float | 0 | |
| | TenDayValues | TenDayAbilityDictionary | null | |
| | SkillHitPer | int | 0 | 百分率 |
| | MentalDamageRatio | float | 0 | |
| | DefAtk | float | 0 | |
| | PowerSpread | float[] | null | |
| | Cantkill | bool | false | |
| **④ コスト・補正** | | | | |
| | RequiredNormalP | int | 0 | |
| | RequiredAttrP | SerializableDictionary | new() | |
| | RequiredRemainingHPPercent | float | 0 | |
| | EvasionModifier | float | **1f** | 乗算補正 |
| | AttackModifier | float | **1f** | 乗算補正 |
| | AttackMentalHealPercent | float | **80f** | |
| | SkillDidWaitCount | int | 0 | |
| **⑤ 連撃・ストック** | | | | |
| | RandomConsecutivePer | float | 0 | |
| | DefaultStockCount | int | **1** | |
| | StockPower | int | **1** | |
| | StockForgetPower | int | **1** | |
| | TriggerCountMax | int | 0 | |
| | CanCancelTrigger | bool | **true** | |
| | TriggerRollBackCount | int | 0 | |
| **⑥ 前のめり** | | | | |
| | AggressiveOnExecute | PhaseAggressiveSetting | new(true, false) | |
| | AggressiveOnTrigger | PhaseAggressiveSetting | new(false, false) | |
| | AggressiveOnStock | PhaseAggressiveSetting | new(false, false) | |
| **⑦ ムーブセット** | | | | |
| | A_MoveSet | List\<MoveSet\> | null | |
| | B_MoveSet | List\<MoveSet\> | null | |
| **⑨ エフェクト・パッシブ** | | | | |
| | SubEffects | List\<int\> | new() | |
| | SubVitalLayers | List\<int\> | new() | |
| | CanEraceEffectIDs | List\<int\> | new() | |
| | CanEraceEffectCount | int | 0 | |
| | CanEraceVitalLayerIDs | List\<int\> | new() | |
| | CanEraceVitalLayerCount | int | 0 | |
| | TargetSelection | SkillPassiveTargetSelection | 0 | |
| | ReactionCharaAndSkillList | List\<....\> | new() | |
| | SkillPassiveEffectCount | int | **1** | |
| | SkillPassiveGibeSkillFilter | SkillFilter | new() | |

### 4.3 対象外フィールド（レベルシステム自体のメタパラメータ）

| フィールド | 型 | 場所 | 理由 |
|-----------|-----|------|------|
| `_infiniteSkillPowerUnit` | float | BaseSkill | 全レベル共通のスケーリング設定 |
| `_infiniteSkillTenDaysUnit` | float | BaseSkill | 同上 |

## 5. 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `BaseSkill.SkillLevel.cs` | `_levelIndex`追加、SkillLevelData全フィールド定義(FormerlySerializedAs付き)、Clone()、GetLevelOption/Nullable廃止 |
| `BaseSkill.Core.cs` | 旧フィールド[HideInInspector]化、全プロパティ直接読み取り化、InitDeepCopy更新 |
| `BaseSkill.DEFATK.cs` | DEFATKフォールバックを直接読み取りに変更 |
| `BaseSkill.Consecutive.cs` | 4件直接読み取り化、IsSingleHitAtkをA_MoveSet_Cash参照に変更 |
| `BaseSkill.Trigger.cs` | 3件直接読み取り化 |
| `BaseSkill.Effects.cs` | 6件直接読み取り化（SubEffectsはバッファ合成維持） |
| `BaseSkill.Distribution.cs` | 3件直接読み取り化 |
| `BaseSkill.AggressiveCommit.cs` | 3件直接読み取り化 |
| `BaseSkill.SkillPassive.cs` | 4件直接読み取り化 |
| `BaseSkill.SkillHit.cs` | 直接読み取り化 |
| `BaseSkill.MentalDamageRatio.cs` | 直接読み取り化 |
| `BaseSkill.PowerSpread.cs` | 直接読み取り化 |
| `BaseSkill.MoveSet.cs` | CashMoveSet直接読み取り化 |
| `SkillLevelDataDrawer.cs` | **新規** — 9セクションfoldout構造のPropertyDrawer |
| `BaseSkillEditor.cs` | 再構成 — 概要パネル+バリデーション+レベルリスト+無限スケーリング |
| `SkillLevelDataMigration.cs` | Phase 2対応（bool/enum再移行 + 全レベル哨兵値解決） |

## 6. マイグレーション

### 6.1 マイグレーション手順

Unity Editor で `Tools > Skill Level Data Migration (Phase 2)` を実行。

### 6.2 マイグレーション内容

1. **lv0: BaseSkill旧フィールドからの再移行**
   - bool型（Cantkill, CanCancelTrigger）: 旧Nullable?がUnityに保存不可だったため再コピー
   - enum型（DistributionType, TargetSelection）: 同上
   - SkillName: 空文字チェックで再コピー

2. **全レベル: 旧哨兵値の解決**
   - lv0: BaseSkillの旧[HideInInspector]フィールドからフォールバック
   - lv1+: 前レベルからの前方コピー
   - int哨兵=-1, float哨兵=-1f or float.MinValue, enum哨兵=(EnumType)(-1), 参照型哨兵=null

## 7. 作業チェックリスト

### Phase 1（完了）
- [x] SkillLevelData に Group F 9フィールド追加
- [x] Clone() 更新
- [x] Core.cs の9フィールドをプロパティ変換
- [x] InitDeepCopy 更新
- [x] 外部代入箇所の洗い出し
- [x] 壊れる代入コードの修正
- [x] データマイグレーション実行（味方5キャラ + 敵2体）

### Phase 2（完了）

#### コード変更
- [x] SkillLevelData 再構成（Optionプレフィックス・哨兵値の廃止）
- [x] Nullable型（bool?, enum?）を非Nullable化
- [x] FormerlySerializedAs 付与（全フィールドリネーム対応）
- [x] 全プロパティを `FixedSkillLevelData[_levelIndex]` 直接読み取りに変更
- [x] `_levelIndex` プロパティ追加
- [x] GetLevelOption / GetLevelOptionNullable 廃止
- [x] BaseSkill旧固定フィールドを `[HideInInspector]` 化（マイグレーション安全弁）
- [x] InitDeepCopy更新（旧フィールド+SkillLevelData Clone()）
- [x] Clone() に全40フィールドのディープコピー対応

#### Inspector / エディタ拡張
- [x] SkillLevelDataDrawer 新規作成（CustomPropertyDrawer, 9セクションfoldout）
- [x] BaseSkillDrawer 再構成（概要パネル + テンプレート + バリデーション + レベルリスト + 無限スケーリング）
- [x] [Header]属性の除去（PropertyDrawerとの高さ計算不整合解消）
- [x] ランタイム専用パッシブリストをInspectorから除外

#### マイグレーション
- [x] Phase 2マイグレーションスクリプト作成
- [x] bool/enum型の再移行ロジック
- [x] 全レベル哨兵値解決ロジック
- [x] DistributionType / TargetSelection のlv1+哨兵値解決追加（監査指摘修正）
- [x] SkillFilter のClone()ディープコピー修正（監査指摘修正）

#### 検証
- [x] コンパイル通過確認
- [x] Inspector表示確認
- [x] 全プロパティ整合性監査（40件全PASS）
- [x] Clone()完全性監査
- [x] Drawer網羅性監査
- [x] デフォルト値一致監査
- [x] 特殊パターン監査（SkillType合成, SubEffects合成, DEFATK分岐, CashMoveSet）

### Phase 3: エディタ拡張 + クリーンアップ（完了）

#### エディタ拡張
- [x] レベル間差分ハイライト（前レベルと値が異なるフィールドをゴールド背景で表示）
- [x] 全レベル一括コピーボタン（各フィールド右端の ▼ ボタンで全レベルに値をコピー、Undo対応）
- [x] SerializedProperty比較ユーティリティ（再帰的に値型・配列・構造体を比較）
- [x] SerializedPropertyコピーユーティリティ（再帰的にディープコピー）

#### クリーンアップ
- [x] BaseSkill旧[HideInInspector]フィールド完全削除（全12ファイル46件）
- [x] InitDeepCopy整理（旧フィールドコピー行を全削除、SkillLevelData Clone + MoveSetキャッシュ + パッシブのみ）
- [x] FormerlySerializedAs属性の全削除（SkillLevelData内46件）
- [x] 不要な `using UnityEngine.Serialization;` の削除（全7ファイル）
- [x] マイグレーションスクリプト削除（SkillLevelDataMigration.cs）
