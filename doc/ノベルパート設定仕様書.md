# ノベルパート設定仕様書

歩行システムからノベルパートを設定する際の仕様書。

---

## 最初に読む: 設定者が決めることは1つだけ

**「この会話イベントを、CentralObjectSO と SideObjectSO のどちらに付けるか？」**

これだけで使える機能が自動的に決まる。

### 機能比較

| 付ける先 | ズーム | スプライト変更 | 用途 |
|----------|:------:|:--------------:|------|
| **CentralObjectSO** | ✅ 可能 | ✅ 可能 | NPC会話、宝箱、調べるオブジェクト |
| **SideObjectSO** | ❌ 不可 | ❌ 不可 | 左右に現れるキャラとの短い会話 |

### 判断フロー

```
会話中にズームしたい？
  → YES → CentralObjectSO に付ける

会話中にオブジェクトの見た目を変えたい？（宝箱を開けるなど）
  → YES → CentralObjectSO に付ける

どちらも不要？
  → どちらでもOK（SideObjectSOでも動く）
```

### 重要ポイント

- **SOの中身（EventDefinitionSO, DialogueSO）の設定は同じ**
- **付ける先が違うだけで、機能が変わる**
- ズームとスプライト変更は独立した機能（両方使う必要はない）

---

## 概要

ノベルパートは「会話シーン」を実現する機能。歩行システムから発火され、テキスト表示・立ち絵・背景・選択肢などを提供する。

---

## SO階層図（NodeSOから辿る）

### 全体像

```
NodeSO（ノード = 歩行システムの1マス）
│
├── sideObjectTable ────→ SideObjectTableSO
│                              └── entries[] ────→ SideObjectEntry
│                                                      ├── sideObject ────→ SideObjectSO
│                                                      │                        └── eventDefinition ─┐
│                                                      ├── weight                                     │
│                                                      ├── conditions[]                               │
│                                                      └── cooldownSteps                              │
│                                                                                                     │
├── centralObjectTable ─→ CentralObjectTableSO                                                       │
│                              └── entries[] ────→ CentralObjectEntry                                │
│                                                      ├── centralObject ─→ CentralObjectSO          │
│                                                      │                        ├── visual           │
│                                                      │                        └── eventDefinition ─┤
│                                                      ├── weight                                     │
│                                                      ├── conditions[]                               │
│                                                      └── cooldownSteps                              │
│                                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┘
│   ↓
│   EventDefinitionSO（イベント定義）
│   └── steps[] ────→ IEventStep（各種Step）
│                          ├── NovelDialogueStep（ノベルパート）
│                          │       └── dialogue ────→ DialogueSO
│                          │                              └── steps[] ────→ DialogueStep（会話1行）
│                          │                                                    ├── speaker, text
│                          │                                                    ├── leftPortrait
│                          │                                                    ├── rightPortrait
│                          │                                                    ├── centralObjectSprite
│                          │                                                    ├── choices[]
│                          │                                                    └── effects[]
│                          ├── BattleStep（戦闘）
│                          ├── MessageStep（簡易メッセージ）
│                          └── etc.
│
├── fixedCentralObject ──→ CentralObjectSO（固定中央オブジェクト）
└── fixedSideObjects ────→ FixedSideObjectPair（固定サイドオブジェクト）
```

---

## 各SOの設定項目（Inspectorで見えるフィールド）

### Level 1: NodeSO（ノード）

```
NodeSO [Create > Walk > Node]
┌────────────────────────────────────────────────────────────────┐
│ nodeId: string              ← ノードID                         │
│ displayName: string         ← 表示名                          │
│ uiHints: NodeUIHints        ← UIテーマ色など                   │
├────────────────────────────────────────────────────────────────┤
│ [サイドオブジェクト]                                           │
│ sideObjectTable: SideObjectTableSO    ← 抽選テーブル          │
│ fixedSideObjects: FixedSideObjectPair ← 固定で出すペア        │
│ retainUnselectedSide: bool  ← 選ばなかった方を残すか          │
├────────────────────────────────────────────────────────────────┤
│ [中央オブジェクト]                                             │
│ centralObjectTable: CentralObjectTableSO ← 抽選テーブル       │
│ fixedCentralObject: CentralObjectSO      ← 固定で出すオブジェ │
├────────────────────────────────────────────────────────────────┤
│ [その他]                                                       │
│ encounterTable: EncounterTableSO ← エンカウント設定           │
│ onEnterEvent: EventDefinitionSO  ← ノード進入時イベント       │
│ onExitEvent: EventDefinitionSO   ← ノード退出時イベント       │
│ exits[], gates[], forcedEventTriggers[] 等                    │
└────────────────────────────────────────────────────────────────┘
```

### Level 2: テーブルSO

```
CentralObjectTableSO [Create > Walk > CentralObject Table]
┌────────────────────────────────────────────────────────────────┐
│ entries[]: CentralObjectEntry[]  ← 抽選候補リスト             │
│ varietyBias: float               ← バラエティ重み（0〜1）     │
│ varietyDepth: int                ← 重複回避の履歴数           │
└────────────────────────────────────────────────────────────────┘

SideObjectTableSO [Create > Walk > SideObject Table]
┌────────────────────────────────────────────────────────────────┐
│ entries[]: SideObjectEntry[]     ← 抽選候補リスト             │
│ varietyBias: float               ← バラエティ重み（0〜1）     │
│ varietyDepth: int                ← 重複回避の履歴数           │
└────────────────────────────────────────────────────────────────┘
```

### Level 2.5: エントリー（抽選候補）

```
CentralObjectEntry（配列の1要素）
┌────────────────────────────────────────────────────────────────┐
│ centralObject: CentralObjectSO  ← 中央オブジェクト本体        │
│ weight: float                   ← 抽選重み（大きいほど出やすい）│
│ conditions[]: ConditionSO[]     ← 出現条件                    │
│ cooldownSteps: int              ← 選択後の再出現禁止ステップ数│
└────────────────────────────────────────────────────────────────┘

SideObjectEntry（配列の1要素）
┌────────────────────────────────────────────────────────────────┐
│ sideObject: SideObjectSO        ← サイドオブジェクト本体      │
│ weight: float                   ← 抽選重み                    │
│ conditions[]: ConditionSO[]     ← 出現条件                    │
│ cooldownSteps: int              ← 再出現禁止ステップ数        │
└────────────────────────────────────────────────────────────────┘
```

### Level 3: オブジェクトSO

```
CentralObjectSO [Create > Walk > CentralObject]  ← ★フル機能
┌────────────────────────────────────────────────────────────────┐
│ id: string                      ← オブジェクトID              │
│ uiLabel: string                 ← UI表示名                    │
│ visual: CentralObjectVisual     ← 表示設定                    │
│   ├── sprite: Sprite            ← 初期スプライト              │
│   ├── size: Vector2             ← サイズ                      │
│   ├── offset: Vector2           ← 位置オフセット              │
│   └── tint: Color               ← 色調整                      │
│ eventDefinition: EventDefinitionSO ← 【ここがイベント本体】   │
└────────────────────────────────────────────────────────────────┘

SideObjectSO [Create > Walk > SideObject]  ← 基本機能のみ
┌────────────────────────────────────────────────────────────────┐
│ id: string                      ← オブジェクトID              │
│ uiLabel: string                 ← UI表示名                    │
│ prefabLeft: GameObject          ← 左側プレハブ                │
│ prefabRight: GameObject         ← 右側プレハブ                │
│ eventDefinition: EventDefinitionSO ← 【ここがイベント本体】   │
└────────────────────────────────────────────────────────────────┘
```

### Level 4: EventDefinitionSO（イベント定義）

```
EventDefinitionSO [Create > Walk > Event Definition]
┌────────────────────────────────────────────────────────────────┐
│ steps[]: IEventStep[]           ← イベントステップ配列        │
│   │                                                            │
│   ├── NovelDialogueStep         ← ノベルパート（会話）        │
│   ├── BattleStep                ← 戦闘                        │
│   ├── MessageStep               ← 簡易メッセージ              │
│   ├── EmitEventStep             ← 別イベント発火              │
│   └── EffectStep                ← Effect実行                  │
│                                                                │
│ terminalEffects[]: EffectSO[]   ← 全Step完了後に適用          │
└────────────────────────────────────────────────────────────────┘
```

### Level 5: NovelDialogueStep（ノベルパート設定）

```
NovelDialogueStep（EventDefinitionSO.stepsの1要素）
┌────────────────────────────────────────────────────────────────┐
│ [ダイアログ参照]                                               │
│ dialogue: DialogueSO            ← 【会話データ本体】          │
├────────────────────────────────────────────────────────────────┤
│ [表示設定]                                                     │
│ displayMode: DisplayMode        ← Dinoid / Portrait           │
│ allowSkip: bool                 ← スキップ許可                │
│ allowBacktrack: bool            ← 戻る機能（←→ボタン）        │
│ showBacklog: bool               ← バックログ表示              │
├────────────────────────────────────────────────────────────────┤
│ [ズーム設定]                                                   │
│ overrideZoom: bool              ← SO設定を上書きするか        │
│ zoomOnApproach: bool            ← ズームするか                │
│ focusArea: FocusArea            ← ズーム領域                  │
├────────────────────────────────────────────────────────────────┤
│ [主人公設定]                                                   │
│ hasProtagonist: bool            ← 精神属性連携するか          │
│ protagonistCharacterId: string  ← 主人公キャラID              │
└────────────────────────────────────────────────────────────────┘
```

### Level 6: DialogueSO（会話データ）

```
DialogueSO [Create > Walk > Dialogue]
┌────────────────────────────────────────────────────────────────┐
│ dialogueId: string              ← 会話ID                      │
│ defaultMode: DisplayMode        ← デフォルト表示モード        │
│ steps[]: DialogueStep[]         ← 【会話ステップ配列】        │
├────────────────────────────────────────────────────────────────┤
│ [Zoom]（NovelDialogueStepでoverrideしない場合に使用）         │
│ zoomOnApproach: bool            ← ズームするか                │
│ focusArea: FocusArea            ← ズーム領域                  │
└────────────────────────────────────────────────────────────────┘
```

### Level 7: DialogueStep（会話の1行）

```
DialogueStep（DialogueSO.stepsの1要素）
┌────────────────────────────────────────────────────────────────┐
│ [基本]                                                         │
│ speaker: string                 ← 話者名（「太郎」など）      │
│ text: string                    ← 本文（セリフ内容）          │
├────────────────────────────────────────────────────────────────┤
│ [表示モード]                                                   │
│ displayMode: DisplayMode        ← このステップの表示モード    │
├────────────────────────────────────────────────────────────────┤
│ [立ち絵]                                                       │
│ leftPortrait: PortraitState     ← 左立ち絵                    │
│   ├── characterId: string       ← キャラID                    │
│   ├── expression: string        ← 表情（"smile", "angry"等）  │
│   └── portraitSprite: Sprite    ← 直接指定する場合            │
│ rightPortrait: PortraitState    ← 右立ち絵（同上）            │
├────────────────────────────────────────────────────────────────┤
│ [中央オブジェクト] ← ★3者会話構図用（NEW!）                   │
│ centralObjectSprite: Sprite     ← 変更するスプライト          │
│                                    （設定すると中央オブジェの  │
│                                    　見た目がこれに変わる）    │
├────────────────────────────────────────────────────────────────┤
│ [背景]                                                         │
│ hasBackground: bool             ← 背景を表示するか            │
│ backgroundId: string            ← 背景ID                      │
├────────────────────────────────────────────────────────────────┤
│ [選択肢]                                                       │
│ choices[]: DialogueChoice[]     ← 選択肢配列                  │
│   ├── text: string              ← 選択肢テキスト              │
│   ├── spiritProperty: string    ← 精神属性タグ                │
│   └── effects[]: EffectSO[]     ← 選択時Effect                │
├────────────────────────────────────────────────────────────────┤
│ [リアクション]                                                 │
│ reactions[]: ReactionSegment[]  ← タップ可能なテキスト範囲    │
├────────────────────────────────────────────────────────────────┤
│ [雑音]                                                         │
│ noises[]: NoiseEntry[]          ← 効果音                      │
├────────────────────────────────────────────────────────────────┤
│ [Effect]                                                       │
│ effects[]: EffectSO[]           ← このステップ完了時に適用    │
└────────────────────────────────────────────────────────────────┘
```

---

## 発火元による分類（詳細）

ノベルパートは**発火元**によって機能が異なる。

| 発火元 | ズーム | 中央オブジェクト<br>スプライト変更 | 用途例 |
|--------|:------:|:--------------------------------:|--------|
| **中央オブジェクト** | 選択可 | 可能 | NPC会話、宝箱、調べられるオブジェクト |
| **サイドオブジェクト** | 不可 | 不可 | 左右に現れるキャラとの短い会話 |
| **強制イベント** | 不可 | 不可 | ストーリーイベント、チュートリアル |

### なぜ違いが生まれるか（技術的背景）

```
【設定者の視点】
CentralObjectSO に付ける → フル機能（ズーム、スプライト変更）
SideObjectSO に付ける    → 基本機能のみ

【システム内部の動作】
CentralObjectSO のイベント発火時:
  → 中央オブジェクトの位置情報（RectTransform）がイベントに渡される
  → この情報があるので、ズームやスプライト変更が可能

SideObjectSO のイベント発火時:
  → 位置情報が渡されない
  → ズームやスプライト変更の対象がないので機能しない
```

**つまり: 同じEventDefinitionSOでも、付ける先で機能が変わる。**

---

## 3者会話構図（中央オブジェクトスプライト変更）

### 概要

会話中に中央オブジェクトのスプライトを変更できる機能。

```
┌──────────────────────────────────────┐
│                                      │
│  [左立ち絵]    [中央]    [右立ち絵]   │
│                 ↑                    │
│            スプライト                │
│            変更可能！                │
│                                      │
└──────────────────────────────────────┘
```

### 設定方法

`DialogueStep.centralObjectSprite` にスプライトを設定するだけ。

```
DialogueStep (ステップ1)
└── centralObjectSprite: 閉じた宝箱.png

DialogueStep (ステップ2)
└── centralObjectSprite: 開いた宝箱.png  ← 変更！
```

### 制約

| 条件 | スプライト変更 |
|------|:--------------:|
| 中央オブジェクト由来 | ✅ 可能 |
| サイドオブジェクト由来 | ❌ 不可 |
| 強制イベント由来 | ❌ 不可 |

**ズームするかどうかは関係ない。** 中央オブジェクト由来であればズームなしでもスプライト変更は可能。

### 会話終了後の状態

**方針B（変更維持）** を採用。会話終了後もスプライトは変更されたまま維持される。

```
会話前: 閉じた宝箱
  ↓
会話中: 開いた宝箱に変更
  ↓
会話後: 開いた宝箱のまま（戻らない）
```

---

## ズームシステム

### タイミング

```
NovelDialogueStep.ExecuteAsync()
│
├── 1. ズームイン（会話開始時）
│
├── 2. try {
│        会話実行（DialogueRunner）
│        ← スプライト変更はここで実行
│      }
│
└── 3. finally {
         ズームアウト（会話終了時）
       }
```

**会話途中でのズーム変更は不可。** 開始時・終了時のみ。

### FocusArea（フォーカス領域）

中央オブジェクトのどの部分をズームターゲットにするか。

| 値 | 説明 |
|----|------|
| Default | オブジェクト全体 |
| Top | 上部（顔など） |
| Center | 中央 |
| カスタム | `FocusArea` コンポーネントで指定 |

---

## 設定フロー

### 共通手順（どちらに付ける場合も同じ）

```
1. DialogueSO を作成
   └── 会話内容を設定（テキスト、立ち絵、選択肢など）

2. EventDefinitionSO を作成
   └── steps に NovelDialogueStep を追加
       └── dialogue に DialogueSO を設定
```

### 分岐: どちらに付けるか？

```
【CentralObjectSO に付ける場合】 ← ズーム/スプライト変更が必要な場合

3. CentralObjectSO を作成
   └── eventDefinition に EventDefinitionSO を設定

4. ノードの CentralObjectTable に CentralObjectSO を登録


【SideObjectSO に付ける場合】 ← 基本機能だけでいい場合

3. SideObjectSO を作成
   └── eventDefinition に EventDefinitionSO を設定

4. ノードの SideObjectTable に SideObjectSO を登録
```

### 図解

```
                    DialogueSO（会話内容）
                          ↓
                  EventDefinitionSO（イベント定義）
                          ↓
            ┌─────────────┴─────────────┐
            ↓                           ↓
    CentralObjectSO               SideObjectSO
    （フル機能）                   （基本機能）
            ↓                           ↓
    CentralObjectTable            SideObjectTable
    に登録                        に登録
```

---

## よくある質問

### Q: サイドオブジェクトでもズームしたい

A: 現状の設計では不可。ズームは中央オブジェクトの機能。
サイドオブジェクトで会話を行いたい場合は、ズームなしのノベルパートを使用。

### Q: 強制イベントでズームしたい

A: 中央オブジェクトを表示した状態で強制イベントを発火させる方法は現状ない。
代替案: 中央オブジェクトのイベント内で強制的なストーリーを進める。

### Q: ズームなしで中央オブジェクトのスプライトを変更したい

A: 可能。`zoomOnApproach = false` にしてもスプライト変更は動作する。
条件は「中央オブジェクト由来」であること。

---

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| **Level 1** | |
| `NodeSO.cs` | ノード定義（歩行システムの1マス） |
| **Level 2** | |
| `CentralObjectTableSO.cs` | 中央オブジェクト抽選テーブル |
| `SideObjectTableSO.cs` | サイドオブジェクト抽選テーブル |
| **Level 3** | |
| `CentralObjectSO.cs` | 中央オブジェクト定義 |
| `SideObjectSO.cs` | サイドオブジェクト定義 |
| **Level 4** | |
| `EventDefinitionSO.cs` | イベント定義（steps配列） |
| **Level 5** | |
| `NovelDialogueStep.cs` | ノベルパート実行Step |
| **Level 6** | |
| `DialogueSO.cs` | 会話データ |
| **Level 7** | |
| `DialogueStep.cs` | 会話の1ステップ |
| `PortraitState.cs` | 立ち絵状態 |
| `DialogueChoice.cs` | 選択肢 |
| **実行系** | |
| `NovelPartDialogueRunner.cs` | 会話実行ロジック |
| `AreaController.cs` | 歩行システム（イベント発火元） |

---

## 立ち絵登場トランジション

立ち絵が登場するときのアニメーション。`PortraitState.transitionType`で指定。

### トランジション一覧

| トランジション | 説明 | 用途 |
|----------------|------|------|
| None | 即時フェードイン | 通常の立ち絵登場 |
| **Rockman** | 縦線降下 → フェードイン | 重要シーン開始 |
| SlideTop | 上からスライドイン | 軽めの登場 |
| SlideBottom | 下からスライドイン | 軽めの登場 |

### ロックマン風トランジション

ファミコン版ロックマンのステージ開始演出を着想源とした演出。
キャラ色の縦線（RainBar）が上から降りてきて、その後立ち絵がフェードインする。

**演出フロー:**
```
1. RainBar（キャラ色の縦長バー）が上から降下
2. RainBarがフェードアウト
3. 立ち絵がフェードイン（生えてくるように）
```

**タイミング:**
- RainBar降下: 0.35秒
- RainBar消失: 0.1秒
- 立ち絵登場: 0.3秒
- 合計: 約0.75秒

### ロックマン風トランジションのシーン設定

#### 1. RainBar用Imageの作成

PortraitPresenter配下に左右2つのImageを追加する。

```
NovelContent > PortraitPresenter
├── LeftPortrait (既存)
├── RightPortrait (既存)
├── LeftRainBar (新規追加)
└── RightRainBar (新規追加)
```

**RectTransform設定:**

| 項目 | LeftRainBar | RightRainBar |
|------|-------------|--------------|
| Anchor | 左立ち絵と同じ | 右立ち絵と同じ |
| Pivot | (0.5, 0) | (0.5, 0) |
| Width | 20 | 20 |
| Height | 100 | 100 |
| Pos X | 左立ち絵の中央 | 右立ち絵の中央 |
| Pos Y | 立ち絵の下端 | 立ち絵の下端 |

**Image設定:**

| 項目 | 値 |
|------|-----|
| Source Image | UISprite（白い矩形）またはNone |
| Color | 白 (255, 255, 255, 255) |
| Raycast Target | false |

**初期状態:** Active = false（非表示）

#### 2. PortraitPresenterへのアサイン

PortraitPresenterコンポーネントの以下フィールドにアサイン：
- `Left Rain Bar` ← LeftRainBar
- `Right Rain Bar` ← RightRainBar

#### 3. PortraitDatabaseのthemeColor設定

各キャラクターの`PortraitCharacterData`に`Theme Color`を設定。

| キャラクター | 推奨色 | Hex |
|--------------|--------|-----|
| Geino | ピンク | #FF6B9D |
| Noramlia | 青 | #6B9DFF |
| Sites | 緑 | #6BFF9D |

### 使用方法

`DialogueStep`の`PortraitState`で指定：

```
DialogueStep
└── leftPortrait
    ├── characterId: "geino"
    ├── expression: "normal"
    └── transitionType: Rockman  ← ここで指定
```

### トラブルシューティング

| 症状 | 原因 | 対処 |
|------|------|------|
| RainBarが表示されない | アサイン漏れ | PortraitPresenterのフィールド確認 |
| RainBarが白のまま | themeColor未設定 | PortraitDatabaseで設定 |
| 立ち絵が出ない | TransitionType未指定 | PortraitStateで`Rockman`を指定 |

### パラメータ調整

PortraitPresenterのSerializeFieldで調整可能：

| フィールド | 説明 | デフォルト |
|------------|------|-----------|
| transitionDuration | 立ち絵フェードイン時間 | 0.3秒 |
| rainBarDuration | RainBar降下時間 | 0.35秒 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-31 | 初版作成 |
| 2026-01-31 | NodeSOからの階層図追加、各SOのInspectorフィールド詳細追加 |
| 2026-01-31 | 立ち絵登場トランジション（ロックマン風）設定手順追加 |
