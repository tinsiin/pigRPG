# パーティ属性仕様書

パーティー属性（`PartyProperty`）の決定処理に関する仕様。

---

## パーティー属性決定

### 味方（Ally）

| 条件 | 決定方法 | ランダム |
|------|----------|----------|
| 固定3人（Geino, Noramlia, Sites）全員 | HP比較 | なし |
| 固定3人のうち2人 | HP比較マッピング | なし |
| 固定1人以下 / 新キャラ含む | 精神属性相性計算 | **あり** |

**実装**: `PartyBuilder.GetPartyImpression()`

### 敵（Enemy）

| 条件 | 決定方法 | ランダム |
|------|----------|----------|
| 全ケース | 精神属性相性計算 | **あり** |

**実装**: `EnemyCollectManager` / `PartyPropertyCalculatorSO`

---

## 固定3人のHP比較（決定論的）

3人のHPの大小関係で6通りに分岐。

| HP順序 | PartyProperty |
|--------|---------------|
| G≥S≥N | MelaneGroup |
| G≥N≥S | Odradeks |
| S≥G≥N | MelaneGroup |
| S≥N≥G | HolyGroup |
| N≥G≥S | TrashGroup |
| N≥S≥G | Flowerees |

※ 3人のHPが許容誤差（各MaxHP×5%）以内なら `MelaneGroup`

**実装**: `PartyBuilder.GetTrioPartyPropertyByHp()`

---

## 固定2人のHP比較マッピング（決定論的）

| ペア | HP関係 | PartyProperty |
|------|--------|---------------|
| Geino + Sites | G≥S | MelaneGroup |
| Geino + Sites | S≥G | Flowerees |
| Geino + Noramlia | G≥N | MelaneGroup |
| Geino + Noramlia | N≥G | Odradeks |
| Sites + Noramlia | S≥N | HolyGroup |
| Sites + Noramlia | N≥S | TrashGroup |

**実装**: `PartyBuilder.GetDuoPartyPropertyByHp()`

---

## 精神属性相性計算（ランダムあり）

敵・味方共通のロジック。`PartyPropertyCalculatorSO.CalculateFromImpressions()` で実装。

### 単独メンバー

精神属性から直接変換。

| 精神属性 | PartyProperty |
|----------|---------------|
| Doremis | Flowerees |
| Pillar | Odradeks |
| Kindergarten | TrashGroup |
| LiminalWhiteTile | MelaneGroup |
| Sacrifaith | HolyGroup |
| Cquiest | MelaneGroup |
| **Psycho** | **ランダム** |
| GodTier | Flowerees |
| BaleDrival | TrashGroup |
| devil | HolyGroup |

### 複数メンバー

1. 全ペアの相性値を取得（CSVテーブル参照）
2. 以下の順で判定：
   - 全相性値≥70 → HolyGroup
   - 全相性値≤30 → Odradeks
   - 平均≥70 → MelaneGroup
   - 標準偏差≥20 → Odradeks
   - 平均>57 → Flowerees
   - 67%確率で TrashGroup/MelaneGroup
   - それ以外 → **完全ランダム**

---

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `PartyBuilder.cs` | 味方パーティー属性決定 |
| `EnemyCollectManager.cs` | 敵パーティー属性決定・相性テーブル管理 |
| `PartyPropertyCalculatorSO.cs` | 精神属性相性計算（共通ロジック） |
| `characterMatchData.csv` | 精神属性相性値テーブル |
