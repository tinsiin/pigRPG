# HP変動パス仕様書

戦闘中にキャラクターのHP・精神HPが変動する全パスの一覧。各パスは戦闘情報伝達の各層（`doc/戦闘情報伝達の設計思想.md` 参照）から参照され、それぞれの層が適切な方法で表現する。

本書は**何が起きるか**を定義する。**どう伝えるか**は各層の仕様書が担う:
- 第1層（線描画）: 特殊イベントの視覚表現
- 第2層（エフェクト）: 生存・蘇生等の演出
- 第3層（フロー数字）: `doc/フロー数字仕様書.md` — 数値ポップアップ
- 第4層（SchizoLog）: `doc/SchizoLog仕様書.md` — テキスト補足

各メカニクスの詳細は `doc/総合戦闘仕様書.md`、`doc/スキル計算仕様書.md` を参照。

---

## HP減少

### 攻撃ダメージ

スキルによる通常の攻撃ダメージ。13段補正チェーンを経由する。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.Damage.cs:536` `DamageOnBattle()` |
| トリガー | `SkillType.Attack` スキルの実行 |
| 計算 | ATK/DEF/EYE/AGI係数、物理抵抗、パッシブ減衰、VitalLayer、クリティカル、かすり、慣れ補正等（`doc/スキル計算仕様書.md` 参照） |
| 場合分け | 通常ヒット / クリティカル / かすり / 乱れ |
| 情報伝達 | 第1層（矢印）+ 第2層（被弾点滅）+ **第3層（フロー数字: 実装済み）** + 第4層（SchizoLog） |

### レイザーダメージ

13段補正チェーンを一切経由しない純HP減算。`DontDamageRatio` を貫通する。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.Damage.cs:758` `RatherDamage()` |
| トリガー | パッシブダメージリンク（`BasePassive.OnAfterDamage()`） / ActionEntryレイザー行動 / 定期戦闘効果（未実装） |
| 計算 | `damage × DamageRatio`。`LayerDamage=true` の場合のみVitalLayer吸収 |
| 場合分け | なし（現時点） |
| 情報伝達 | **第3層（フロー数字: 実装済み `<数字>` 黒文字白ふち）** + 第4層（SchizoLog） |
| 詳細 | `doc/総合戦闘仕様書.md` レイザーダメージ節 |

### ダウナー乖離HP減少

精神HPと実HPの乖離が閾値を超えた場合のHP強制減少。TLOAキャラクター限定。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.BattleEvent.cs:296` `MentalDiverGence()` |
| トリガー | 精神HP < HP の乖離率が人間状況(Demeanor)ごとの閾値を超過し、持続ターン最大値に到達 |
| 計算 | HP → 現HP × 0.76 |
| 場合分け | なし |
| 情報伝達 | 第2層（エフェクト）向き。数値表示より状態悪化の演出が重要 |
| 詳細 | `doc/総合戦闘仕様書.md` 精神HP乖離節 |

---

## HP増加

### 回復

回復スキルによるHP回復。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.ReactionSkill.cs:252` `Heal()` |
| トリガー | `SkillType.Heal` スキルの実行。対象が生存中 |
| 計算 | `HealPoint × (PassivesHealEffectRate() / 100)` |
| 場合分け | なし（現時点） |
| 情報伝達 | **第3層（フロー数字: 実装済み 緑文字白ふち）** + 第4層（SchizoLog） |

### 蘇生

死亡状態からの復帰。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.ReactionSkill.cs:237` Angel復活 |
| トリガー | `SkillType.DeathHeal` スキルの実行。対象が死亡中 |
| 計算 | パワーHigh → HP=30、それ以外 → HP=ε |
| 場合分け | なし |
| 情報伝達 | 第2層（エフェクト）向き。復活の劇的演出が重要。数値よりも「生き返った」ことの伝達 |

### 互角一撃生存

致死ダメージからの奇跡的生還。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.BattleEvent.cs:332` `CalculateMutualKillSurvivalChance()` |
| トリガー | HP≥MaxHP×20%、攻撃者十日能力≤被害者×1.6、ダメージがMaxHPの34%〜66%、精神属性×パワー×人間状況の確率判定成功 |
| 計算 | HP → MaxHP × 7% |
| 場合分け | なし |
| 情報伝達 | 第1層（線描画）+ 第2層（エフェクト）向き。「奇跡的に耐えた」ことの劇的伝達 |
| 詳細 | `doc/総合戦闘仕様書.md` 互角一撃節 |

### 刃物即死生存

刃物即死クリティカルからの生還。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.BattleEvent.cs:588` `CalculateBladeDeathCriticalSurvivalChance()` |
| トリガー | パワー≥High、被害者の刃物能力 vs 攻撃者の刃物能力の乱数比較に勝利 |
| 計算 | HP → `Random(1,2.8) + max(0, 被害者刃物-攻撃者刃物×1.5) × Random(4,5)` |
| 場合分け | なし |
| 情報伝達 | 第1層（線描画）+ 第2層（エフェクト）向き。互角一撃生存と同様の劇的伝達 |
| 詳細 | `doc/総合戦闘仕様書.md` 刃物即死節 |

---

## 精神HP減少

### 精神ダメージ（戦闘中）

攻撃スキルと同時に発生する精神HPへのダメージ。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.Damage.cs:549` `DamageOnBattle()` 内 |
| トリガー | 攻撃ダメージと同時。攻撃者と被害者のLeisure差 + 攻撃者MentalHP×0.2 が精神ATKに加算 |
| 計算 | 攻撃のダメージ計算と並行して `totalMentalDmg` を算出し `MentalHP -= totalMentalDmg` |
| 場合分け | なし（現時点） |
| 情報伝達 | 第2層（エフェクト）。精神HPはHPの相対値でありクランプも受けるため、数字の増減が撃破に直結せずフロー数字には不向き |

### 死亡時精神HP変動

キャラクター死亡時に精神属性ごとに異なる精神HP変動が発生する。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.StatesNumber.cs:139` `MentalHPOnDeath()` |
| トリガー | キャラクター死亡時コールバック |
| 計算 | 精神属性ごとに異なる（Kindergarten: 全回復、Devil: -10%、等） |
| 情報伝達 | 死亡演出の一部。独立した数字表示は不要 |

---

## 精神HP増加

### 精神回復スキル

精神回復スキルによる精神HP回復。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.ReactionSkill.cs:267` `MentalHeal()` |
| トリガー | `SkillType.MentalHeal` スキルの実行。対象が生存中 |
| 計算 | `HealPoint` をそのまま加算 |
| 場合分け | なし（現時点） |
| 情報伝達 | 第2層（エフェクト）。精神ダメージと同様の理由でフロー数字には不向き |

### 攻撃時精神回復

攻撃スキル使用時に攻撃者自身の精神HPが回復する。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.StatesNumber.cs:130` `MentalHealOnAttack()` |
| トリガー | 攻撃スキル使用時に自動発動 |
| 計算 | `ATK.Total × (NowUseSkill.AttackMentalHealPercent / 100)`。デフォルト80% |
| 場合分け | なし |
| 情報伝達 | 自然回復的な性質。毎回数字を出すと煩雑になる可能性あり |

### ターン経過精神回復

毎ターン自動で精神HPが回復する。

| 項目 | 内容 |
|---|---|
| 実装 | `BaseStates.StatesNumber.cs:134` `MentalHPHealOnTurn()` |
| トリガー | ターン経過時に自動発動 |
| 計算 | 十日能力「雨(Rain)」の値をそのまま加算 |
| 場合分け | なし |
| 情報伝達 | 自然回復。数字表示は不要（毎ターン出ると煩雑） |

---

## 対象外（戦闘外・間接的）

以下はフロー数字を含む戦闘情報伝達の対象外。

| パス | 理由 |
|---|---|
| 休憩全回復（`RestPartyEffect.cs:22`） | 戦闘中ではない |
| 戦闘外ダメージ（`Damage()` line 719） | イベント・カットシーン用。戦闘UIが存在しない |
| VitalLayer吸収 | 攻撃ダメージの内部処理。独立した変動ではない |
| Can'tKillクランプ（`Damage.cs:169-180`） | ダメージの下限処理。表示済みダメージの内部補正 |
| DontDamagePassive（`HasPassives.cs:397`） | パッシブによるHP下限。内部安全弁 |
| 戦闘開始時MentalHP初期化 | 戦闘開始処理。変動ではない |
