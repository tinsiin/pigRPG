# ノベルパート課題一覧

EventStep統合（2026-01-26）後に残っている設計課題。

**本ドキュメントは「採用方針確定版」として更新済み（2026-01-26 外部レビュー対応）**

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート設計.md)
- [EventStep統合実装計画.md](../歩行システム設計/EventStep統合実装計画.md)
- [ノベルパート未実装機能一覧.md](./ノベルパート未実装機能一覧.md)
- [ノベルパート_USERUIとEyeArea連携.md](./ノベルパート_USERUIとEyeArea連携.md)

---

## 課題1: 二重ズーム問題 ✅ 実装完了

### 採用方針: 案A（AreaControllerからズームを削除）

### 現状

ズーム処理が**2箇所**で実行される可能性がある：

```
【経路A: AreaController.RunCentralEvent()】
中央オブジェクトアプローチ
    ↓
AreaController.RunCentralEvent()
    ├── ズームイン（EventDefinitionSO.ZoomOnApproach参照）
    ├── TriggerEvent() → EventRunner → NovelDialogueStep
    └── ズームアウト

【経路B: NovelDialogueStep.ExecuteAsync()】
NovelDialogueStep.ExecuteAsync()
    ├── ズームイン（DialogueSO.ZoomOnApproach参照）
    ├── DialogueRunner.RunDialogueAsync()
    └── ズームアウト
```

### 問題

**中央オブジェクトからNovelDialogueStepを含むEventDefinitionSOを実行すると：**

1. AreaController.RunCentralEvent() でズームイン
2. NovelDialogueStep.ExecuteAsync() でズームイン（二重）
3. NovelDialogueStep.ExecuteAsync() でズームアウト
4. AreaController.RunCentralEvent() でズームアウト（二重）

### 現在の回避策（偶然の回避）

NovelDialogueStepは `context.CentralObjectRT != null` のときのみズームする。
AreaController.RunCentralEvent() からTriggerEvent() を呼ぶ際、EventContextにCentralObjectRTを渡していない
→ NovelDialogueStep側ではズームしない。

**これは意図した設計ではない。**

### 確定方針: 案A

```
RunCentralEvent()
    ├── TriggerEvent() のみ（ズームしない）
    └── EventContextにCentralObjectRTを渡す

NovelDialogueStep
    └── ズーム責務を持つ（設計通り）
```

**採用理由:**
- EventStep統合の設計意図（「ズームは会話開始時に発動」）と一致
- EventDefinitionSOのZoomOnApproachは不要になる（NovelDialogueStepのみがズーム設定を持つ）
- サイドオブジェクトからNovelDialogueStepを呼ぶ場合も一貫した動作

### 実装タスク

1. AreaController.RunCentralEvent() からズーム処理を削除
2. TriggerEvent() 呼び出し時にCentralObjectRTを渡すように変更
3. EventDefinitionSOのZoomOnApproach/FocusAreaを削除または `[Obsolete]` 付与
4. テスト：中央オブジェクトからNovelDialogueStepを含むイベントを実行

---

## 課題2: ズーム設定の分散 ✅ 実装完了（課題1と連動）

### 採用方針: EventDefinitionSOのズーム設定を撤去

### 現状

ズーム設定が**3箇所**に存在：

| 場所 | フィールド | 参照元 |
|------|-----------|--------|
| EventDefinitionSO | zoomOnApproach, focusArea | AreaController.RunCentralEvent() |
| DialogueSO | zoomOnApproach, focusArea | NovelDialogueStep（overrideZoom=false時） |
| NovelDialogueStep | overrideZoom, zoomOnApproach, focusArea | NovelDialogueStep（overrideZoom=true時） |

### 確定方針

```
【削除または非推奨化】
EventDefinitionSO.zoomOnApproach  ← 不要（課題1解決で参照元がなくなる）
EventDefinitionSO.focusArea       ← 不要

【残す】
DialogueSO.zoomOnApproach    ← デフォルト設定
DialogueSO.focusArea
NovelDialogueStep.overrideZoom    ← Step単位で上書き
NovelDialogueStep.zoomOnApproach
NovelDialogueStep.focusArea
```

**採用理由:**
- 3箇所分散は運用事故の温床
- 課題1解決後はEventDefinitionSOのズーム設定を参照する箇所がなくなる
- 2箇所（SO + Step上書き）に集約することで責務が明確に

---

## 課題3: EventDialogueSO未実装 ✅ 方針確定（実装不要）

### 採用方針: 案C（SOは作らない、allowBacktrackで制御）

### 現状

ノベルパート設計では2種類の会話SOを定義：

| SO | 用途 | 戻れるか | 実装状況 |
|----|------|---------|---------|
| DialogueSO | フィールド会話 | 戻れない | ✅ 実装済み |
| EventDialogueSO | イベント会話 | 戻れる | ❌ **未実装** |

### 確定方針: SOを分離しない

```csharp
// NovelDialogueStep
[SerializeField] private bool allowBacktrack = false;

// allowBacktrack = false → フィールド会話（戻れない）
// allowBacktrack = true  → イベント会話（戻れる）
```

**採用理由:**
- SOレベルでの分離は過剰設計
- Step単位で「戻れるか」を制御できれば十分
- 同じDialogueSOを「フィールド会話として使う」「イベント会話として使う」が可能
- [ノベルパート設計.md](./ノベルパート設計.md) の「戻れるかどうかが区別の基準」と整合

### TabState切り替え責務

**重要:** [ノベルパート_USERUIとEyeArea連携.md](./ノベルパート_USERUIとEyeArea連携.md) では「TabStateはUSERUIだけ」と定義。

→ allowBacktrackの値からTabState.FieldDialogue / EventDialogueを選ぶ責務は**DialogueRunner側で完結**させる。
→ EventStep側でUI状態に触れない。

---

## 課題4: 中央オブジェクト判定の曖昧さ ✅ 方針確定 + 警告ログ実装済

### 採用方針: 案B（現状維持）+ ファクトリメソッド明確化 + 警告ログ

### 現状

NovelDialogueStepは「自分が中央オブジェクト由来か」を以下で判定：

```csharp
var canZoom = shouldZoom && context.NovelUI != null && context.CentralObjectRT != null;
```

### 確定方針

**基本: CentralObjectRTの有無で判定（現状維持）**

```
CentralObjectRT != null → 中央オブジェクト由来
CentralObjectRT == null → それ以外
```

**改善1: ファクトリメソッドの明確化（推奨）**

誤配線を防ぐため、EventHost.CreateEventContext() を以下のように分離検討：

```csharp
// 明示的なファクトリメソッド
public EventContext CreateCentralEventContext(RectTransform centralRT) { ... }
public EventContext CreateSideEventContext() { ... }
```

**改善2: 警告ログの追加（推奨）**

データ不整合の早期発見のため、NovelDialogueStepに警告を追加：

```csharp
// shouldZoom=true なのに CentralObjectRT=null の場合
if (shouldZoom && context.CentralObjectRT == null)
{
    Debug.LogWarning("[NovelDialogueStep] zoomOnApproach=true but CentralObjectRT is null. Zoom skipped.");
}
```

**採用理由:**
- 現状で動作している
- 過剰な抽象化（EventOrigin enum等）は避ける
- 生成経路を明確にするだけで事故が減る
- 警告ログで設計変更なしに安全性向上

---

## 課題5: DialogueSO 名前変更 ✅ 実装完了

### 採用方針: DialogueSO → DialogueSO に名前変更

### 背景

課題3で「EventDialogueSOは作らない」と決定した。
しかし `DialogueSO` という名前は「フィールド会話専用」という誤解を招く。

実際の役割：
- 会話データ（セリフ、立ち絵、背景等）を持つSO
- `allowBacktrack` で「フィールド会話」「イベント会話」どちらとしても使える
- `EncounterSO`（戦闘データ）と対になる存在

### アーキテクチャ上の位置づけ

```
EventDefinitionSO（イベントの「器」）
├── steps: IEventStep[] [SerializeReference] ← 埋め込み
│   ├── NovelDialogueStep
│   │       └── dialogue: DialogueSO [SerializeField] ← 参照
│   ├── BattleStep
│   │       └── encounter: EncounterSO [SerializeField] ← 参照
│   └── ...
└── terminalEffects: EffectSO[]

【Inspectorでの見え方】
NovelDialogueStep（埋め込みデータ）
├── Dialogue: [SomeDialogue.asset] ← SOへの参照（ドラッグ&ドロップ）
├── Display Mode: Dinoid
├── Allow Backtrack: ☐
└── ...
```

### 確定方針

| 現在 | 変更後 |
|------|--------|
| DialogueSO | **DialogueSO** |
| fieldDialogue | **dialogue** |
| FieldDialogue（プロパティ） | **Dialogue** |

### 実装タスク

#### Phase A: クラス・ファイル名変更

1. `DialogueSO.cs` → `DialogueSO.cs` にリネーム
2. クラス名 `DialogueSO` → `DialogueSO` に変更
3. `CreateAssetMenu` の `menuName` を更新

#### Phase B: 参照箇所の更新

| ファイル | 変更内容 |
|----------|---------|
| `NovelDialogueStep.cs` | `DialogueSO fieldDialogue` → `DialogueSO dialogue` |
| `DialogueContext.cs` | `DialogueSO` → `DialogueSO` |
| `NovelPartDialogueRunner.cs` | 参照更新 |
| その他参照ファイル | 検索して更新 |

#### Phase C: ドキュメント更新

| ファイル | 変更内容 |
|----------|---------|
| ノベルパート設計.md | DialogueSO → DialogueSO |
| ノベルパート未実装機能一覧.md | 同上 |
| EventStep統合実装計画.md | 同上 |
| ノベルパート課題一覧.md | 同上 |

#### Phase D: 既存アセットの移行

- `.asset` ファイルの型参照は自動的に追従（GUIDベース）
- 念のためUnity再起動後に参照が切れていないか確認

### 検証項目

- [ ] コンパイルエラーなし
- [ ] 既存の DialogueSO アセットが正常に読み込まれる
- [ ] NovelDialogueStep の Inspector で DialogueSO を参照できる
- [ ] テストダイアログが正常に動作する

---

## 優先度と状態サマリー

| 課題 | 優先度 | 状態 | 備考 |
|------|--------|------|------|
| 課題1: 二重ズーム | **高** | ✅ 実装完了 | AreaControllerからズーム削除 |
| 課題2: ズーム設定分散 | 中 | ✅ 実装完了 | EventDefinitionSOのズーム設定を非推奨化 |
| 課題3: EventDialogueSO | 低 | ✅ 方針確定 | SOは作らない（allowBacktrackで制御） |
| 課題4: 中央オブジェクト判定 | 低 | ✅ 警告ログ実装済 | 現状維持 + 警告ログ追加 |
| 課題5: SO名前変更 | 中 | ✅ 実装完了 | DialogueSO → DialogueSO |

---

## 次のアクション（課題1・2解決）

### 実装タスク

1. AreaController.RunCentralEvent() からズーム処理を削除
2. TriggerEvent() 呼び出し時にCentralObjectRTを渡すように変更
3. EventDefinitionSOのZoomOnApproach/FocusAreaに `[Obsolete]` 付与または削除
4. NovelDialogueStepに警告ログ追加（shouldZoom=true && CentralObjectRT==null時）
5. EventStep統合実装計画.mdの古い記述を更新

### 検証項目

- [ ] 中央オブジェクト → NovelDialogueStep：ズーム1回のみ
- [ ] サイドオブジェクト → NovelDialogueStep：ズームなし
- [ ] 中央オブジェクト → MessageStep：ズームなし（MessageStepはズームしない）
- [ ] 中央オブジェクト → BattleStep：ズームなし（BattleStepはズームしない）
- [ ] 中央イベント → NovelDialogueStep（戻れる/戻れない）のUI切替

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-26 | 初版（EventStep統合後の課題整理） |
| 2026-01-26 | **採用方針確定版**に更新（外部レビュー対応）|
| 2026-01-26 | **課題5追加**: DialogueSO → DialogueSO 名前変更 |
| 2026-01-26 | **課題1・2・4実装完了**: AreaControllerズーム削除、EventDefinitionSO非推奨化、警告ログ追加 |
| 2026-01-26 | **課題5実装完了**: DialogueSO → DialogueSO 名前変更 |
