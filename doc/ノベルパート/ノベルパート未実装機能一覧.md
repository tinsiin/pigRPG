# ノベルパート未実装機能一覧

Phase 1-6の実装完了後に残っている未実装機能の一覧。

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート設計.md) - 設計本体
- [ノベルパート実装計画.md](./ノベルパート実装計画.md) - 実装計画
- [ノベルパート使い方ガイド.md](./ノベルパート使い方ガイド.md) - 使い方
- [リアクションシステム実装計画.md](./リアクションシステム実装計画.md) - #6 リアクションシステム詳細

---

## 優先度高（P2）- 基本機能に必要

### 1. 入力待ち

| 項目 | 内容 |
|------|------|
| 設計書記載 | 実行シーケンス ステップ5「クリック or タップ」 |
| 現状 | `WaitForInput`が`UniTask.Yield()`のみ |
| 必要な実装 | ユーザーのタップ/クリックを待機する処理 |
| 関連ファイル | `NovelPartDialogueRunner.cs:245-250` |

### 2. 選択肢UI

| 項目 | 内容 |
|------|------|
| 設計書記載 | DialogueStep.choices、精神属性タグ表示 |
| 現状 | `ShowChoices`が常に0を返す |
| 必要な実装 | 選択肢ボタンUI、精神属性タグの表示 |
| 関連ファイル | `NovelPartEventUI.cs:77-83` |

### 3. Effect後のスナップショット問題

| 項目 | 内容 |
|------|------|
| 問題 | スナップショット作成がEffect実行より前 |
| 現状 | Effectで視覚状態が変わってもスナップショットに反映されない |
| 影響 | 戻る機能でEffectの結果が復元されない |
| 関連ファイル | `NovelPartDialogueRunner.cs:68-86` |

**現在の処理順序:**
```
1. スナップショット作成（視覚状態を保存）
2. ExecuteStep実行
   └─ 7. Effect実行 ← ここでHidePortraitEffectなど
```

**修正案:**
- A) スナップショット作成をExecuteStep後に移動
- B) Effect実行後にスナップショット更新処理を追加
- C) INovelEventUIに現在状態取得メソッドを追加し、Effect後に取得

### 4. MessageDropper連携

| 項目 | 内容 |
|------|------|
| 設計書記載 | ディノイドモードでログが流れる |
| 現状 | TextBoxPresenter経由だがDropper併用が未確認 |
| 必要な実装 | ディノイドモード時にMessageDropperへもテキスト送信 |
| 関連ファイル | `NovelPartEventUI.cs`, `MessageDropper.cs` |

---

## 優先度中（P3）- 演出・機能拡張

### 5. ズームシステム

| 項目 | 内容 |
|------|------|
| 設計書記載 | 中央オブジェクトにカメラズーム |
| 現状 | 未実装 |
| 必要な実装 | カメラ/UI制御、ズームイン/アウトアニメーション |

**動作仕様:**
- ズームあり: カメラが中央オブジェクトに向かってズームイン → 会話 → ズームアウト
- ズームなし: フィールド状態のまま会話
- ノベルパートUI（立ち絵、テキストボックス）はズームしない

### 6. リアクションシステム

| 項目 | 内容 |
|------|------|
| 設計書記載 | ピンク文字でリアクション可能マーカー |
| 現状 | 未実装 |
| 必要な実装 | 文字色マッピング、クリック検出、イベント発火 |
| 詳細計画 | **[リアクションシステム実装計画.md](./リアクションシステム実装計画.md)** |

**詳細仕様:**

#### 基本概念
- 1つのセリフ（1クリック分のテキストボックス）内に**複数のリアクション可能文字列**を配置可能
- 各リアクション文字列は**色で区別**される（ダンロンのピンク文字のように）
- リアクション文字列をクリック/タップすると**対応するイベントが発火**

#### 文字色とイベントのマッピング
| 色 | 想定用途 | 発火イベント |
|----|---------|-------------|
| オレンジ | 戦闘起動 | EncounterContext → BattleRunner |


#### イベント規格
**リアクションシステムのイベントは歩行システムで扱えるイベントと同じ規格**
- EventDefinitionSO（既存）
- EncounterContext + BattleRunner（戦闘用）
- 将来の拡張にも対応可能な設計

#### データ構造案
```csharp
[Serializable]
public class ReactionSegment
{
    public string text;              // リアクション可能な文字列
    public Color color;              // 表示色
    public ReactionType type;        // リアクションの種類
    public EventDefinitionSO event;  // 発火するイベント（汎用）
    public EncounterSO encounter;    // 戦闘用（type=Battle時）
}

public enum ReactionType
{
    Event,      // EventDefinitionSO発火
    Battle,     // 戦闘起動
    Inference,  // 推理パート（将来）
    Custom      // カスタム処理
}

[Serializable]
public class DialogueStep
{
    // 既存フィールド...
    public ReactionSegment[] reactions;  // リアクション可能セグメント
}
```

#### UI実装
- TextMeshProのリッチテキストで色付け
- 各リアクションセグメントにクリック判定を付与
- クリック時に対応するイベントを発火

### 7. 精神属性可視化

| 項目 | 内容 |
|------|------|
| 設計書記載 | アイコン下にテキスト、立ち絵で描き分け |
| 現状 | 内部ロジックあり、表示未実装 |
| 必要な実装 | UI表示、立ち絵バリエーション対応 |

**表示仕様:**
- ディノイドモード: アイコンの下にテキストで精神属性を表示
- 立ち絵モード: 立ち絵画像自体で描き分け（画像の分岐）
- 選択肢の精神属性タグは選ぶ前から見える

### 8. セーブ/ロード対応

| 項目 | 内容 |
|------|------|
| 設計書記載 | テスト計画に記載 |
| 現状 | ForcedEventStateManagerのシリアライズ未確認 |
| 必要な実装 | 状態の保存/復元 |

**保存対象:**
- ForcedEventState（強制イベントの発火状態）
- DialogueBacklog（会話ログ、イベント会話用）
- 現在の会話進行状態

---

## 優先度低（P4）- 演出詳細

### 9. ロックマン案トランジション詳細

| 項目 | 内容 |
|------|------|
| 設計書記載 | 縦線（雨粒）が降りてきてフェードイン |
| 現状 | メソッドあるが詳細未実装 |
| 関連ファイル | `PortraitPresenter.cs` |

**詳細仕様:**

#### 演出の流れ
1. キャラクター固有の色の**直方体**が雨のように上から高速で降りてくる
2. 直方体が下に着いたら、生えてくるように立ち絵がフェードイン

#### rainColor設定
- 各キャラクターに`rainColor`（直方体の色）を設定
- PortraitCharacterDataに追加が必要

```csharp
[Serializable]
public sealed class PortraitCharacterData
{
    // 既存フィールド...
    [SerializeField] private Color rainColor;  // ロックマン案用の直方体色
    public Color RainColor => rainColor;
}
```

#### アニメーション詳細
- 直方体のサイズ: 縦長（雨粒のような曖昧なオブジェクト）
- 落下速度: 高速
- 本数: 複数本を時間差で落とす
- 着地後: 立ち絵フェードイン開始

### 10. 3者会話構図（中央オブジェクト統合）

| 項目 | 内容 |
|------|------|
| 設計書記載 | 中央オブジェクト＋左右で3人会話 |
| 現状 | 左右のみ対応 |
| 必要な実装 | 中央の人物表示 |

**重要な認識:**

中央の「3人目」は**中央オブジェクトの画像そのもの**を指す。

#### 実装方針
- 中央オブジェクト（CentralObjectPresenter経由）の画像を、ノベルパート専用の左右立ち絵と同様に**動的に変更可能**にする
- 左右立ち絵と同じレベルで制御できるようにする
- ズームとは独立（ズームなしでも中央表示は可能）

#### 構図バリエーション
| 構図 | 説明 |
|------|------|
| 左右対話 | 2人の対話（従来） |
| 三者会話 | 中央オブジェクト＋左右で3人が会話 |
| 問い詰め | 中央オブジェクトを左右から問い詰める |
| チーム構図 | 左右がチームとして中央オブジェクトに対峙 |

#### DialogueStepへの追加
```csharp
[Serializable]
public class DialogueStep
{
    // 既存フィールド...
    public PortraitState centerPortrait;  // 中央の状態（中央オブジェクト画像）
}
```

---

## 実装優先順位案

### 第1段階（基本機能）
1. 入力待ち実装
2. 選択肢UI実装
3. Effect後スナップショット問題修正

### 第2段階（システム統合）
4. リアクションシステム基盤
5. MessageDropper連携

### 第3段階（演出強化）
6. ロックマン案詳細
7. ズームシステム
8. 3者会話構図

### 第4段階（仕上げ）
9. 精神属性可視化
10. セーブ/ロード対応

---

## 備考

- 本ドキュメントはPhase 6完了時点での未実装項目
- 各項目の詳細仕様は実装時に確定
- 優先度は状況に応じて変更可能
