# ノベルパート未実装機能一覧

Phase 1-6およびUSERUI/EyeArea連携実装後に残っているタスクの一覧。

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート設計.md) - 設計本体
- [ノベルパート_USERUIとEyeArea連携.md](./ノベルパート_USERUIとEyeArea連携.md) - UI配置設計・TabState設計
- [リアクションシステム実装計画.md](./リアクションシステム実装計画.md) - リアクションシステム詳細

---

## 完了済み

- [x] データ構造（DialogueStep, DialogueContext, DialogueResult, FieldDialogueSO, ReactionSegment）
- [x] NovelPartDialogueRunner（実行・入力待ち・リアクション終了処理）
- [x] Presenter配置（Portrait, TextBox, Background, Noise）
- [x] 入力UI（FieldDialogueUI, EventDialogueUI, NovelChoicePresenter, NovelInputHub）
- [x] TabState拡張（FieldDialogue, EventDialogue, NovelChoice）
- [x] MainContent.SwitchContent() 対応
- [x] データベース作成・エントリ登録（PortraitDatabase, BackgroundDatabase）
- [x] リアクションロジック（ReactionTextBuilder, ReactionTextHandler, AreaController対応）
- [x] エントリポイント接続（WalkingSystemManager.EnsureDialogueRunner()）
- [x] Effect後スナップショット問題修正（ExecuteStep後に移動）
- [x] MessageDropper連携（ディノイドモード時にテキスト送信）

---

## 不要と判断

- [x] ~~バックログUI~~ - イベント会話は左右ボタンで戻れる、フィールド会話はMessageDropperで流れる
- [x] ~~リアクションボタン（USERUI側）~~ - 文字タップ方式採用（EyeArea側で完結）

---

## 優先度高（P2）- 動作に必須

### 1. EyeAreaState切替システム（方針B）✅ 完了

- [x] EyeAreaState enum作成（Walk, Novel, Battle）
- [x] EyeAreaContents.cs作成（TabContentsと同様のSetActive切替）
- [x] EyeAreaMainContent.cs作成（レイヤー方式: Walk常時表示 + Novel/Battle排他）
- [x] EyeAreaToggle.cs作成（4階層管理、TabState→EyeAreaState変換）
- [x] WalkContent / NovelContent / BattleContent のシーン構造整理（4階層×3State = 12個）
- [x] TabState変更時にEyeAreaStateも連動して切替
- [x] ノベルパート開始時にNovelContentがアクティブになることを確認

| 項目 | 内容 |
|------|------|
| 設計書 | [ノベルパート_USERUIとEyeArea連携.md](./ノベルパート_USERUIとEyeArea連携.md) 方針B |
| 詳細設計 | [USERUI_EyeArea仕様書.md](../USERUI_EyeArea仕様書.md) |
| 実装ファイル | `EyeAreaState.cs`, `EyeAreaContents.cs`, `EyeAreaMainContent.cs`, `EyeAreaToggle.cs` |
| シーン配置 | ViewportArea配下に4階層、各階層にWalk/Novel/BattleContent配置・アタッチ完了 |

### 2. 動作テスト ✅ 完了

- [x] テストシナリオで立ち絵表示確認
- [x] テストシナリオで背景表示確認
- [x] テストシナリオでテキスト表示確認
- [x] モード切替（ディノイド⇔立ち絵）確認
- [x] フィールド会話のログがMessageDropperで流れることを確認

| 項目 | 内容 |
|------|------|
| 関連ファイル | `TestDialogue_Reaction.asset` |
| テスト方法 | Node_0__________のForcedEventTrigger（type: Steps, stepCount: 3）|

---

## 優先度中（P3）- 機能拡張

### 5. リアクションシステム配置・テスト

- [ ] ReactionTextHandlerをDinoidTextにアタッチ
- [ ] ReactionTextHandlerをPortraitTextにアタッチ
- [ ] NovelPartEventUI.reactionTextHandlerをアサイン
- [ ] オレンジ文字タップで戦闘起動テスト
- [ ] 複数リアクション同時表示テスト
- [ ] ノベルパート終了→戦闘→歩行復帰テスト

| 項目 | 内容 |
|------|------|
| 現状 | ロジック実装済み、シーン配置・テスト未完 |
| 詳細 | [リアクションシステム実装計画.md](./リアクションシステム実装計画.md) |

### 6. ズームシステム

- [ ] 中央オブジェクト会話時のカメラズームイン
- [ ] 会話終了時のズームアウト
- [ ] ノベルパートUI（立ち絵、テキストボックス）はズームしない制御

| 項目 | 内容 |
|------|------|
| 設計書記載 | 中央オブジェクトにカメラズーム |
| 関連 | EyeAreaManager連携 |

### 7. 精神属性可視化

- [ ] ディノイドモード: アイコン下にテキスト表示
- [ ] 立ち絵モード: 立ち絵画像で描き分け
- [ ] 選択肢の精神属性タグ表示（選ぶ前から見える）

| 項目 | 内容 |
|------|------|
| 現状 | 内部ロジックあり、表示未実装 |

---

## 優先度低（P4）- 演出・仕上げ

### 8. ロックマン案トランジション

- [ ] PortraitCharacterDataにrainColor追加
- [ ] 縦線（雨粒）アニメーション実装
- [ ] 立ち絵フェードイン連携

| 項目 | 内容 |
|------|------|
| 設計書記載 | 縦線が降りてきてフェードイン |
| 関連ファイル | `PortraitPresenter.cs` |

### 9. 3者会話構図

- [ ] DialogueStepにcenterPortrait追加
- [ ] 中央オブジェクト画像の動的変更対応
- [ ] 左右立ち絵と同レベルの制御

| 項目 | 内容 |
|------|------|
| 設計書記載 | 中央オブジェクト＋左右で3人会話 |
| 現状 | 左右のみ対応 |

### 10. セーブ/ロード対応

- [ ] ForcedEventStateシリアライズ確認
- [ ] 会話進行状態の保存/復元

| 項目 | 内容 |
|------|------|
| 保存対象 | ForcedEventState、現在の会話進行状態 |

---

## 推奨実装順序

```
【第1段階: 基盤完成】 ✅ 完了
1. EyeAreaState切替システム（方針B） ✅
2. 動作テスト ✅

【第2段階: リアクション】 ← 今ここ
3. リアクションシステム配置・テスト

【第3段階: 機能拡張】
4. ズームシステム
5. 精神属性可視化

【第4段階: 演出・仕上げ】
6. ロックマン案トランジション
7. 3者会話構図
8. セーブ/ロード対応
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-24 | 初版（Phase 6完了時点） |
| 2026-01-25 | USERUI/EyeArea連携完了を反映、チェックリスト形式に変更 |
| 2026-01-25 | バックログUI不要、リアクション文字タップ方式決定を反映 |
| 2026-01-25 | P2完了: エントリポイント接続確認済、スナップショット修正、MessageDropper連携 |
| 2026-01-25 | P2追加: EyeAreaState切替システム（方針B）が未実装だったため追加 |
| 2026-01-25 | **P2-1完了**: EyeAreaState切替システム実装・シーン配置・アタッチ完了 |
| 2026-01-25 | **P2完了**: 動作テスト完了（ディノイド/立ち絵モード切替、テキスト表示確認）|
| 2026-01-25 | 外部レビュー対応: リアクション終了TabStateリセット、入力キャンセル処理追加 |
