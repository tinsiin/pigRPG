# ノベルパート仕様書

ノベルパートシステムの技術的な仕様を定義する。
設計（何を作るか）は [ノベルパート設計.md](./ノベルパート設計.md) を参照。
演出仕様（トランジション、モード切替、ズーム等）は [ノベルパート演出総合.md](./ノベルパート演出総合.md) を参照。

---

## 状態ライフサイクル

### 概要

ノベルパートは複数のPresenter（立ち絵、背景、テキストボックス、雑音、中央オブジェクト）が状態を保持する。
これらの状態は「ダイアログ1回分」を単位としてライフサイクルが管理される。

### 三層の役割

| 層 | クラス | 役割 | 状態を持つか |
|----|--------|------|-------------|
| 実行層 | NovelPartDialogueRunner | ステップの順次実行、入力待ち、戻る/バックログ | `previousStep` のみ（セッション内の差分判定用） |
| 統括層 | NovelPartEventUI (INovelEventUI) | Presenterへの委譲、クリーンアップの一括実行 | 持たない（Presenterへの読み通し） |
| 表示層 | 各Presenter | 実際の表示制御と現在の表示状態の保持 | **持つ（唯一の情報源）** |

### 原則

1. **各状態の情報源は1箇所**。同じ情報を複数箇所で持たない
   - DisplayMode → TextBoxPresenter.CurrentMode が唯一の情報源
   - 立ち絵状態 → PortraitPresenter.currentLeftState / currentRightState
   - 背景 → BackgroundPresenter.currentBackgroundId
2. **NovelPartEventUIは状態を複製しない**。Presenterへの読み通しのみ
3. **DialogueRunnerのpreviousStepはセッション内限定**。ダイアログ開始時にnullリセット

### ダイアログのライフサイクル

```
RunDialogueAsync() 開始
│
├── 初期化フェーズ
│   ├── previousStep = null（Runner内部状態リセット）
│   ├── ui.ClearReactions()
│   ├── ui.HideAllAsync()        ← 全Presenterの状態を一括クリア
│   ├── ui.SetProtagonistSpiritualProperty(...)
│   └── ui.SwitchTextBox(initialMode)（必要時）
│
├── ステップ実行ループ（try）
│   └── ExecuteStep()
│       ├── SetTabState()         ← UI可視化（アニメーション前に呼ぶ）
│       ├── 背景変更
│       ├── 立ち絵変更（トランジション再生）
│       ├── テキストボックス切り替え
│       ├── テキスト表示 + 雑音発火
│       └── 入力待ち
│
└── 終了フェーズ（finally — 正常/リアクション/例外いずれでも実行）
    ├── ui.ClearReactions()
    ├── ui.SetBackButtonEnabled(false)
    ├── ui.SetProtagonistSpiritualProperty(null)
    └── ui.SetTabState(TabState.walk)
```

### HideAllAsync() のクリア対象

全Presenterの状態を漏れなくクリアする。新しいPresenterを追加した場合は必ずここに追加すること。

| Presenter | クリア方法 | クリアされる状態 |
|-----------|-----------|----------------|
| PortraitPresenter | ClearAll() | currentLeftState, currentRightState → null |
| BackgroundPresenter | HideImmediate() | currentBackgroundId → null |
| NoisePresenter | ClearAll() | activeNoises → 空、isAccelerated → false |
| TextBoxPresenter | Hide() | テキストクリア、GameObject非アクティブ（currentModeは維持） |
| CentralObjectPresenter | UpdateSprite(null) | スプライトリセット（GameObject自体はWalkingSystem管轄） |
| Reactions | ClearReactions() | currentReactionCallback → null |

### ステップ間の差分判定

各ステップ実行前に「前ステップと変化があるか」を判定し、変化がある場合のみトランジションを再生する。

| 判定 | 情報源 | 判定基準 |
|------|--------|---------|
| 立ち絵更新 | DialogueRunner.previousStep | CharacterId + Expression の一致 |
| 背景更新 | DialogueRunner.previousStep | HasBackground + BackgroundId の一致 |
| モード切替 | DialogueRunner.previousStep | DisplayMode の一致 |

`previousStep` はダイアログ開始時に `null` にリセットされるため、最初のステップでは必ず更新が走る。

**注意**: Presenter側にも「同キャラ同表情ならスキップ」の判定がある（PortraitPresenter.UpdatePortrait）。
HideAllAsync() で Presenter 状態がクリアされていれば、この判定が誤ってスキップすることはない。
つまり HideAllAsync() の漏れは二重にトランジションスキップを引き起こすので、特に注意すること。

---

## 状態復元（戻る機能）

### 復元契約: 部分復元 + ステップ再実行

DialogueStateSnapshotは視覚状態のみを保存する。

| 保存する | 保存しない（再実行で補完） |
|---------|------------------------|
| 立ち絵（LeftPortrait, RightPortrait） | テキスト内容 |
| 背景（HasBackground, BackgroundId） | 雑音（NoiseEntry） |
| DisplayMode | リアクション状態 |
| CentralObject（Sprite, CharacterId, Expression） | |

### 復元フロー

```
戻るリクエスト検出
├── snapshots[currentIndex - 1] を取得
├── ui.RestoreState(snapshot)
│   ├── TextBoxPresenter.SetModeImmediate()    ← トランジションなし
│   ├── PortraitPresenter.RestoreImmediate()   ← トランジションなし
│   ├── BackgroundPresenter.ShowImmediate()     ← トランジションなし
│   └── CentralObjectPresenter.UpdateSprite()
├── previousStep = steps[currentIndex - 1]
└── continue（while ループ先頭へ → 同じステップを再実行）
    └── ExecuteStep() で テキスト・雑音が自然に再発火
```

---

## Presenter一覧と状態管理

| Presenter | 状態フィールド | Initialize() | ClearAll() | 備考 |
|-----------|--------------|-------------|-----------|------|
| PortraitPresenter | currentLeftState, currentRightState, originalPos | あり | あり | |
| BackgroundPresenter | currentBackgroundId, originalPosition | あり | HideImmediate() | ClearAll()メソッドなし、HideImmediateで代用 |
| TextBoxPresenter | currentMode | あり(mode引数) | Clear() + Hide() | DisplayModeの唯一の情報源 |
| NoisePresenter | activeNoises, isAccelerated | あり | あり | OnDisableでもクリア |
| CentralObjectPresenter | viewObject, currentMode, image等 | なし(setter式) | ClearImmediate() | WalkingSystem管轄。ノベルパートからはスプライトのみ操作 |

---

## 責務分離アーキテクチャ

### インターフェース階層

```
IEventUI（基底：ShowMessage, ShowChoices）
│
├── INovelZoomUI（ズーム制御）
│   ├── ZoomToCentralAsync()
│   ├── ExitZoomAsync()
│   ├── RestoreZoomImmediate()
│   ├── UpdateCentralObjectSprite()
│   ├── GetCurrentCentralObjectSprite()
│   ├── GetCurrentCentralObjectCharacterId()
│   └── GetCurrentCentralObjectExpression()
│
├── INovelReactionUI（リアクション制御）
│   ├── SetReactionText()
│   └── ClearReactions()
│
└── INovelEventUI : IEventUI, INovelZoomUI, INovelReactionUI
    ├── Portrait: ShowPortrait, HidePortrait
    ├── Background: ShowBackground, HideBackground
    ├── Text/Noise: ShowText, SwitchTextBox, PlayNoise, AccelerateNoises
    ├── Navigation: ShowBacklog, HideBacklog, ConsumeBackRequest, etc.
    └── State: HideAllAsync, SetTabState, SetProtagonistSpiritualProperty
```

### 実装構造

```
NovelPartEventUI（MonoBehaviour, INovelEventUI）
├── NovelZoomManager（INovelZoomUI実装）
│   ├── NovelZoomController（ズームアニメーション）
│   └── CentralObjectPresenter参照（スプライト操作）
│
├── NovelReactionHandler（INovelReactionUI実装）
│   ├── currentCallback（リアクションコールバック）
│   └── TextBoxPresenter参照（リッチテキスト設定）
│
└── 直接保持
    ├── PortraitPresenter
    ├── BackgroundPresenter
    ├── NoisePresenter
    ├── TextBoxPresenter
    ├── NovelInputHub
    └── 各入力UI（FieldDialogueUI, EventDialogueUI, NovelChoicePresenter）
```

### ファイル配置

| ファイル | 役割 |
|---------|------|
| `Walk/EventKernel/INovelEventUI.cs` | INovelZoomUI, INovelReactionUI, INovelEventUI の3インターフェース定義 |
| `Walk/EventKernel/NovelPartEventUI.cs` | INovelEventUI実装。ズーム/リアクションは委譲 |
| `Walk/Zoom/NovelZoomManager.cs` | INovelZoomUI実装。ZoomControllerとCentralObjectPresenterを内包 |
| `Walk/Presentation/NovelReactionHandler.cs` | INovelReactionUI実装。コールバック管理とTextBoxPresenter連携 |

### 消費者と依存インターフェース

| 消費者 | 使用インターフェース | 備考 |
|--------|-------------------|------|
| NovelPartDialogueRunner | INovelEventUI | 全機能を使用 |
| NovelDialogueStep | INovelEventUI（INovelZoomUI部分） | ZoomToCentralAsync/ExitZoomAsyncのみ使用 |
| 各Effect（ShowPortrait等） | INovelEventUI | プレゼンテーション系メソッドを使用 |
| WalkingSystemManager | NovelPartEventUI（具象型） | SetCentralObjectPresenter注入のみ |
