# ノベルパート設計書

## 概要

歩行システム上で発生する会話・イベント演出システム。
フィールド会話からイベント会話まで、複数のモードと演出を統合する。

## 関連ドキュメント

- [ノベルパート仕様書](./ノベルパート仕様書.md) - 状態ライフサイクル、復元契約などの技術仕様
- [ゼロトタイプ歩行システム設計書](../歩行システム設計/ゼロトタイプ歩行システム設計書.md) - 歩行システムの基盤設計
- [基礎設計想起/](../歩行システム設計/基礎設計想起/) - Event Kernel、FlowGraph等の設計背景
- [BaseStates_Analysis.md](../BaseStates_Analysis.md) - SpiritualProperty等の戦闘システム解析
- `Assets/Script/MessageDropper.cs` - アールエス風ログの既存実装
- [HTMLモック実装計画](./ノベルパートHTMLモック実装計画.md) - 技術デモの実装計画
- [HTMLモック](./novel_part_mock.html) - 実動する技術デモ

## 用語整理

### 会話の種類

| 用語 | 定義 | 戻れるか |
|------|------|---------|
| フィールド会話 | 歩行中に発生する会話。背景あり/なし両方ある | 戻れない（ログが流れる） |
| イベント会話 | 正式なシナリオパート | 戻れる（左右ボタン） |

**重要**: 背景の有無ではなく「**戻れるかどうか**」が区別の基準。
背景付きでもフィールド会話はフィールド会話。

### 表示モード

| 用語 | 説明 |
|------|------|
| ディノイドモード | アイコンベースの軽量会話モード |
| 立ち絵モード | 左右に立ち絵を表示する会話モード |

### その他

| 用語 | 説明 |
|------|------|
| 雑音 | 主セリフ中に流れる相槌・共感のコメント |
| ズーム会話 | 中央オブジェクト由来で、カメラがオブジェクトに寄る会話 |
| 非ズーム会話 | 中央オブジェクト由来だが、カメラは寄らない会話 |

---

## 会話モード

### ディノイドモード

- ディノイド（キャラクターアイコン）での会話表示
- 軽量・即時の情報伝達に使用
- **専用テキストボックス**：アイコンが内包される形式

### 立ち絵モード

- 左右に立ち絵を表示
- **専用テキストボックス**：ディノイド用とは別デザイン
- ダンロン風の表情変化（前の変化を引きずる）

### テキストボックスの違い

テキストボックスは **DisplayMode × 背景の有無** の2軸で4種類のデザインを持つ。

|  | フィールド背景（歩行画面） | 全画面背景 |
|--|--|--|
| **ディノイド** | アイコン内包型。歩行画面の装飾パーツとして馴染むデザイン | 細い線で囲まれた白い透過背景の矩形。ディノイド表示領域あり。背景を邪魔しない控えめなデザイン |
| **立ち絵** | 立ち絵用デザイン。歩行画面の装飾パーツとして馴染むデザイン | 横長のひし形（四つの頂点がそれぞれの辺の真ん中にある形状）。中央オブジェクトがないため左右の立ち絵を強調する構図。透過・控えめ |

**設計意図**:
- **フィールド背景時**: テキストボックスは歩行画面の画面構成装飾パーツの一部。サイドオブジェクトやステージの色に馴染む
- **全画面背景時**: テキストボックスは背景を大事にする。透過あり・装飾控えめで、背景アートが主役

→ DisplayModeの切替に加え、背景の出現/消滅時にもテキストボックスデザインが切り替わる

### 立ち絵登場トランジション（案）

立ち絵が最初に出現するときの演出。使い分け可能にする。

**重要: 派手な登場トランジションは左右それぞれ最初に出た時にのみ行う。**
キャラ変更や表情変更のたびには行わない。
（現状の実装ではステップごとにTransitionTypeを指定する方式。自動判定は未実装）

**案1: ロックマン案（過剰目）**
- 着想：ファミコン版ロックマンのステージ開始演出
- キャラ特有の色の縦線（雨粒のような曖昧なオブジェクト）が上から高速で降りてくる
- 下に着いたら、生えてくるように立ち絵がフェードイン
- **用途**: ノベルパート開始時に最初から立ち絵の場合

**案2: 上からフェードイン**
- シンプルに上から定位置へフェードイン

**案3: 下からフェードイン**
- シンプルに下から定位置へフェードイン

### モード切り替え演出

**ディノイド → 立ち絵**
1. ディノイド用テキストボックスが閉じる（点滅/回転などの演出）
2. 立ち絵の登場トランジション（上記3案から選択）
3. 立ち絵用テキストボックスが開く

**立ち絵 → ディノイド**
1. 立ち絵が捌ける（右なら右へ、左なら左へ退場）
2. ディノイド用テキストボックスが開く（閉じる時と似た演出）

### モード切り替え時の実行順序

ExecuteStep内でモード切替を検出した際、切替方向に応じた演出シーケンスを自動実行する。

**Portrait→Dinoid（実装済み）:**
1. 左右の立ち絵をExit()で同時にスライドアウト（左:-500px、右:+500px）
2. テキストボックスをDinoidに切替（ダンロン風登場）

**Dinoid→Portrait（実装済み）:**
1. Dinoidテキストボックスをフェードアウト（0.15秒）
2. 立ち絵の登場トランジション（Rockman/Slide等）
3. Portraitテキストボックスをフェードイン（0.3秒、ダンロン風）

ExecuteStep内でdeferPortraitフラグにより、ステップ2の立ち絵変更をスキップしステップ3で一括処理する。

**立ち絵の退場方法の使い分け:**
| 状況 | 使われるメソッド | 演出 |
|------|----------------|------|
| PortraitStateがnull | Hide() | その場でフェードアウト（同一モード内でのキャラ退場） |
| Portrait→Dinoidモード切替 | Exit() | 左右にスライドアウト（モード転換の明確な退場） |

---

## フィールド会話とイベント会話

### 根本的な違い

| 項目 | フィールド会話 | イベント会話 |
|------|---------------|-------------|
| 戻れるか | 戻れない | 戻れる（左右ボタン） |
| ログ | 流れていく（MessageDropper） | 通常バックログ |
| 背景 | あり/なし両方 | 基本的にあり |
| 用途 | 軽い雑談、精神属性変更 | 正式なシナリオ |

### フィールド会話（背景なし）

- 通常の歩行画面のまま
- サイドオブジェクトの景色が見えている状態
- UIだけが出現（ディノイドor立ち絵）

### フィールド会話（背景付き）

- 背景画像が追加されるが、**まだフィールド会話**
- 戻れない、ログは流れる
- シナリオに強い影響を与えないが、雰囲気を出したいとき

### イベント会話

- 正式なシナリオパート
- 戻れる（左右ボタンで進む/戻る）
- シナリオに強い影響を与える

### イベント会話の「戻る」機能

**仕様**
- 最初から最後まで、終わらせない限り戻れる
- **ログビューア**に近い：過去のセリフを読み返すだけ
- 戻る際、背景や立ち絵も**トランジションなしで**その時の状態で表示される

**復元の仕組み**: 部分復元 + ステップ再実行。技術詳細は [仕様書 > 状態復元](./ノベルパート仕様書.md#状態復元戻る機能) を参照。

**巻き戻らないもの**
- 選択肢は選んだ結果が固定（選び直し不可）
- 精神属性の変化は巻き戻らない（その後の歩行や戦闘に影響するため）

### フィールド → イベント会話への切り替え

**立ち絵モードから**
1. 立ち絵はその場に留まる
2. 背景画像が滑り込む（巨大な絵画の中で拡大鏡を動かすイメージ）
3. walkingフィールドの下部が消え、背景に置き換わる

**ディノイドモードから**
1. 背景トランジション
2. トランジション後に立ち絵出現アニメ

### 背景トランジション

- 多様なイージング/回転アニメ
- 立ち絵の移動演出（カットイン線が閉じて再出現など）

---

## 雑音システム

### 概要

ダンロンの雑音セリフ＋ニコニコ動画のコメント演出を組み合わせたシステム。

### 仕様

- 主セリフのタイミングで画面内にセリフが右から左に流れる
- どうでもいい共感や相槌に使用
- **ディノイドアイコン付き**で表示（実装済み: PortraitDatabase.GetIconで取得、テキスト左に表示）

### 動作

- 雑音が流れ切る前に主セリフが飛ばされると、EaseIn加速して左に消える（実装済み）
- 立ち絵表示中は、その人物由来の雑音も発生可能
- **雑音に応じて立ち絵が変化する**（実装済み）
  - NoiseEntry.Expressionに表情IDを指定すると、話者と一致する左右の立ち絵が一時的に変化
  - 次のステップ開始時に自動リバート（ClearTemporaryExpressions）

### 複数雑音の重なり

- 複数の雑音が同時発生した場合、位置・速度を適度に散らす
- 画面上で重なっても問題ない程度にランダム配置

---

## リアクションシステム

### 着想

ダンロンのピンク文字セリフへのリアクション分岐から発想。

### 機能

- 特定のセリフにリアクション可能なマーカーを付与
- リアクション選択で会話が分岐
- 各種ゲームシステムへの入口として機能

### 見た目

- リアクション可能なセリフは**色で区別**する（ダンロンのピンク文字のように）

### 派生先

- 取捨選択可能なイベント
- 強制イベント
- 戦闘起動
- 推理パート
- その他のゲームシステム

### ユーティリティへの能動的誘導（未実装）

リアクションはゲームシステムへの派生だけでなく、**会話中のユーティリティ機能の入口**としても使う構想がある。

- ガイド表示（ヒントや説明の呼び出し）
- 回想（ダンロンの回想のように過去の会話を確認）
- ノート閲覧（ノベルパート中にメモや情報を開く）
- その他の飛ばせるユーティリティ

リアクション後、**会話がそこから発展する**場合もある（単なるディスパッチではなく、戻ってきて続く）。

---

## キャラクター配置

### 基本構図

- 左右に立ち絵を配置（従来）

### 中央オブジェクトとの会話

- 「3人目を真ん中に表示する」のではない
- **中央オブジェクト自体**が会話相手/対象として扱われる
- ズームありの場合、中央オブジェクト（キャラ立ち絵や静物）が拡大される
- 中央オブジェクトも左右の立ち絵と同様に、明示的に切り替え対象となる

### 中央オブジェクトのキャラクター同一性（実装済み）

中央オブジェクトにキャラクターID（`centralObjectCharacterId`）を持たせ、
左右立ち絵と同様に雑音→表情連動に参加できるようにした。

**対応する機能:**
- 雑音→表情連動（Speaker == CentralObjectPresenter.CurrentCharacterIdでマッチング）
- PortraitDatabaseからの表情引き当て（characterId + expression → Sprite）

**制約:**
- 中央オブジェクトは1つの会話中に複数キャラに切り替わることはない
- ズームシステム（`GetCurrentRectTransform()`）には影響を与えない

#### データフロー

```
DialogueStep
  ├── centralObjectSprite: Sprite          ← スプライト直指定（静物/フォールバック）
  └── centralObjectCharacterId: string     ← キャラクターID（null=静物）
         ↓
NovelPartDialogueRunner.ExecuteStep (step 2.5)
  └── ui.UpdateCentralObjectSprite(sprite, characterId)
         ↓
NovelPartEventUI → NovelZoomManager → CentralObjectPresenter.UpdateSprite(sprite, characterId)
  └── currentCharacterId = characterId
  └── image.sprite = sprite ?? PortraitDatabase.GetPortrait(characterId)
```

#### 実装内容

**1. データ層 (DialogueStep)**
- `centralObjectCharacterId`フィールド追加（null = 静物、雑音マッチング対象外）
- `HasCentralObjectChange`: sprite OR characterIdがあれば true

**2. 状態管理 (CentralObjectPresenter)**
- `currentCharacterId`, `currentExpression`, `hasTemporaryExpression`, `portraitDatabase`
- `UpdateSprite(sprite, characterId?, expression?)`: identity更新 + スプライト設定
- `SetTemporaryExpression(expression)`: 雑音連動でスプライトのみ一時差し替え
- `ClearTemporaryExpression()`: 元の表情に復元（ステップ境界で呼ぶ）
- `ClearImmediate` / `FadeOutCurrent` でidentityもリセット

**3. 雑音マッチング (NovelPartEventUI.OnNoiseSpawned)**
- 左右立ち絵のマッチング後、中央オブジェクトもチェック
- `zoomManager.GetCurrentCentralObjectCharacterId() == entry.Speaker` でマッチ

**4. スナップショット (DialogueStateSnapshot)**
- `CentralObjectCharacterId`, `CentralObjectExpression` 追加
- `RestoreState`でidentity込みで復元

#### PortraitDatabaseの共有

左右立ち絵と中央オブジェクトで**同じPortraitDatabase**を使用する。
`NovelPartEventUI.SetCentralObjectPresenter()`内で`zoomManager.SetPortraitDatabase(portraitDatabase)`により配線される。
中央オブジェクト専用の画像が必要な場合は、expression名で区別する。

#### 後方互換性

- `centralObjectCharacterId`未設定（null）の既存アセット → identityシステム不活性、従来通り動作
- Walk mode（AreaController）→ `Show()`/`ShowGate()`はUpdateSpriteを使わないため影響なし
- `UpdateSprite`のoptionalパラメータにより既存呼び出し変更不要

### 構図バリエーション

| 構図 | 説明 |
|------|------|
| 左右対話 | 2人の対話（従来） |
| 三者会話 | 中央オブジェクト＋左右で3人が会話 |
| 問い詰め | 中央オブジェクトを左右から問い詰める |
| チーム構図 | 左右がチームとして中央オブジェクトに対峙 |

---

## 中央オブジェクトとズーム

### 中央オブジェクトの役割

歩行システムの中央オブジェクト（[ゼロトタイプ歩行システム設計書](./ゼロトタイプ歩行システム設計書.md) 参照）は、人やモノを乗せる「器」。
アプローチすることで会話が始まる。

### ズームの選択

中央オブジェクト由来の会話は、**ズームするかしないかを選択可能**。

| ズーム | 例 | 理由 |
|-------|-----|------|
| する | 人、自販機 | 近づいて会話/操作するのが自然 |
| しない | 警察、監視カメラ | 近づきたくない/近づく必要がない |

### 動作の違い

**ズームあり**
1. 中央オブジェクトにアプローチ
2. カメラが中央オブジェクトに向かってズームイン
3. 会話開始（フィールド会話 or イベント会話）
4. 会話終了時、ズームアウトして歩行画面に戻る

**ズームなし**
1. 中央オブジェクトにアプローチ
2. フィールド状態のまま（サイドオブジェクトの景色が見える）
3. 会話開始（UIだけが出現）

### ズームと他の軸の関係

- ズームは他の軸（表示モード、背景）と**完全に独立**
- ズームしても立ち絵モードになるとは限らない
- ズームしても背景が入るとは限らない
- 背景自体にズームは起こらない（中央オブジェクトのみ）

### ズーム時のUI

- **歩行画面の背景ごと**中央オブジェクトにズームイン
- ノベルパートのUI（左右立ち絵、テキストボックス等）は**ズームしない**
- 左右の立ち絵はそのまま表示され続ける

### 他の会話起点との違い

| 起点 | ズーム |
|------|--------|
| サイドオブジェクト | なし（常にフィールド状態） |
| 中央オブジェクト | 選択可能（する/しない） |
| OnEnter等の強制イベント | 設定による |

---

## ズームシステム実装仕様

### アーキテクチャ（EventStep統合後）

**重要: ズーム責務はNovelDialogueStep内で完結する。DialogueRunnerはズームしない。**

```
EventDefinitionSO
        ↓
EventRunner.RunAsync()
        ↓
NovelDialogueStep.ExecuteAsync()
        ├── ズームイン（Step内で制御）
        │   └── INovelEventUI.ZoomToCentralAsync()
        │           ↓
        │       NovelZoomController.EnterZoom()
        │           ↓
        │       ZoomBackContainer (scale + position変更)
        │
        ├── DialogueRunner.RunDialogueAsync()  ← ズームしない
        │
        └── ズームアウト（Step内で制御）
                └── INovelEventUI.ExitZoomAsync()
```

**ズーム責務の一本化:**
- `NovelDialogueStep`: ズームイン/アウトを制御
- `DialogueRunner`: 会話表示のみ（ズームしない）
- `AreaController.RunCentralEvent()`: EventDefinitionSO経由でズーム（Step内で処理）

### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `Assets/Script/Walk/Zoom/NovelZoomConfig.cs` | ズーム設定（TargetRect, Duration等） |
| `Assets/Script/Walk/Zoom/NovelZoomController.cs` | ズーム制御（フィット計算、アニメーション） |
| `Assets/Script/Walk/Zoom/FocusArea.cs` | フォーカス領域（プリセット + カスタム） |

### NovelZoomConfig設定項目

| 項目 | 説明 | デフォルト |
|------|------|-----------|
| TargetRect | フィット先のRectTransform | （要設定） |
| ZoomContainer | ズーム対象コンテナ（ZoomBackContainer） | （要設定） |
| ZoomDuration | ズームアニメーション時間 | 0.4秒 |
| ZoomEase | イージング | OutQuad |
| FitBlend | 縦横フィットブレンド（0=縦, 1=横） | 0.5 |
| Margin | フィット後の余白係数 | 0.9 |

### FocusArea（フォーカス領域）

中央オブジェクトの「どの部分」をターゲット領域にフィットさせるかを指定。

#### プリセット一覧

| プリセット | 領域 (x, y, w, h) | 用途 |
|------------|-------------------|------|
| Full | (0, 0, 1, 1) | 全体表示（デフォルト） |
| UpperHalf | (0, 0.5, 1, 0.5) | 上半分（顔周り） |
| UpperThird | (0, 0.67, 1, 0.33) | 上1/3（顔のみ） |
| LowerHalf | (0, 0, 1, 0.5) | 下半分 |
| Center | (0.25, 0.25, 0.5, 0.5) | 中央正方形 |
| CenterWide | (0.1, 0.25, 0.8, 0.5) | 中央横長 |
| Custom | カスタム値 | 任意領域 |

#### 図解

```
Full (0,0,1,1)     UpperHalf (0,0.5,1,0.5)   Center (0.25,0.25,0.5,0.5)
┌─────────┐        ┌─────────┐              ┌─────────┐
│         │        │ ▓▓▓▓▓▓▓ │              │         │
│         │        │ ▓▓▓▓▓▓▓ │              │  ┌───┐  │
│         │        ├─────────┤              │  │▓▓▓│  │
│         │        │         │              │  └───┘  │
└─────────┘        └─────────┘              └─────────┘
```

### フィット計算ロジック

KZoomController（バトル用）と同様のアルゴリズムを使用：

1. 中央オブジェクトのワールド座標を取得
2. FocusAreaを適用してフォーカス領域の中心・サイズを計算
3. ターゲット領域（TargetRect）のワールド座標を取得
4. フォーカス領域がターゲット領域にフィットするスケールを計算
5. フォーカス領域の中心がターゲット中心に来る位置を計算
6. ZoomBackContainerのscaleとpositionをアニメーション

### 使用例

```csharp
// 呼び出し側でコンテキストを設定
var context = new DialogueContext(eventDialogue, gameContext);
context.CentralObjectRT = centralObjectPresenter.GetCurrentRectTransform();
context.ZoomFocusArea = FocusArea.FromPreset(FocusPreset.UpperHalf);
await dialogueRunner.RunDialogueAsync(context);
```

### GateVisualでの設定

GateVisualにFocusAreaフィールドがあり、Inspector上で設定可能：

```csharp
[Header("Zoom Focus")]
[SerializeField] private FocusArea focusArea;
```

---

## ログ表示

### フィールド会話のログ

- 会話を戻す機能なし
- 代わりにアールエス風のログが画面を流れる
- 過去のセリフが視覚的に残る

### 既存実装: MessageDropper

`Assets/Script/MessageDropper.cs` で実装済み。

- `CreateMessage(txt)` でメッセージ生成
- `MessageUpspeed` で下から上への上昇速度を制御
- 近いメッセージがあれば既存メッセージを押し上げる
- MessageBlockPrefabをInstantiateして管理

これがフィールド会話のログ表示基盤となる。

### イベント会話のログ

- 通常のバックログ機能（詳細は将来設計）

---

## モード関係の全体像

### 4つの独立した軸

| 軸 | 値 | 備考 |
|----|-----|------|
| 会話種類 | フィールド / イベント | 完全に別システム、切り替わらない |
| 表示モード | ディノイド / 立ち絵 | 双方向に切り替わる |
| 背景 | なし / あり | フィールド: 双方向、イベント: 常にあり |
| ズーム | なし / あり | 中央オブジェクト由来のみ、他と独立 |

### 組み合わせ可能性

**フィールド会話**
```
ディノイド × 背景なし  ⇄  立ち絵 × 背景なし
       ⇅                        ⇅
ディノイド × 背景あり  ⇄  立ち絵 × 背景あり

+ ズーム（中央オブジェクト由来なら追加可能）
```

**イベント会話**
```
ディノイド × 背景あり  ⇄  立ち絵 × 背景あり
（背景は常にあり）
```

### トランジション一覧

| 遷移 | 方向 | 演出 |
|------|------|------|
| ディノイド → 立ち絵 | → | テキストボックス閉→立ち絵登場→テキストボックス開 |
| 立ち絵 → ディノイド | ← | 立ち絵捌ける→テキストボックス開 |
| 背景なし → 背景あり | → | スライドイン等 |
| 背景あり → 背景なし | ← | 未定義（単純オンオフでOK） |
| ズームイン | → | 中央オブジェクトに向かってズーム |
| ズームアウト | ← | 歩行画面に戻る |
| フィールド ⇔ イベント | × | トランジションなし（別システム） |

### 省略可能性

- **全トランジションは省略可能**にする
- 省略時は単純なオン/オフ切り替え

---

## 精神属性（SpiritualProperty）との連携

### 概要

戦闘システムで使用される精神属性（`SpiritualProperty`）を、フィールド会話で変化させる。

### 主人公システム

精神属性の変更/表示対象を「主人公（protagonist）」として NovelDialogueStep で明示的に指定する。

- 主人公 = 精神属性の変更対象となるキャラクター
- 立ち絵配置（左/右）とは独立した概念
- 主人公未設定時は精神属性表示をスキップ

詳細: [ノベルパートと精神属性の連携](../終了済み/ノベルパートと精神属性の連携.md)

### 精神属性の種類

`Assets/Script/BaseStates/BaseStates.StatesState.cs` で定義（ビットフラグ）：
- Doremis, Pillar, Kindergarten, LiminalWhiteTile, Sacrifaith, Cquiest, Psycho, GodTier, BaleDrival...

### フィールド会話での使い方

- 歩行中にランダムエンカウントが発生する
- その「戦闘に入る前」の歩行中に仲間との雑談が発生
- 雑談での**返し方（選択肢）**が精神属性を変化させる
- 意味のない返しでも「精神のかたち」として戦闘に影響

### 設計意図

軽いフィールド会話に**戦闘準備としての意味**を持たせる。プレイヤーは「どうでもいい雑談」と思っていても、実はそれが次の戦闘に影響する。

### 精神属性の可視化

| モード | 表示方法 |
|--------|---------|
| ディノイドモード | アイコンの下にテキストで表示 |
| 立ち絵モード | 立ち絵の画像自体で描き分け（画像の分岐） |

選択肢の精神属性タグは選ぶ前から見える。

---

## 雑音のデータ構造（案）

### 発生タイミング

- 次の会話に進むタイミング（クリック/タップ）で発火
- メインセリフが送られると同時に雑音も流れ始める

### データ構造案

```csharp
[Serializable]
public class DialogueStep
{
    public string speaker;
    public string text;              // メインのセリフ
    public NoiseEntry[] noises;      // このセリフ送り時に流れる雑音
}

[Serializable]
public class NoiseEntry
{
    public string speaker;           // 誰の雑音か
    public string text;              // 雑音の内容
}
```

メインセリフと一緒にリストで持ち、セリフ送りで一緒に発火するシンプルな構造。

---

## 歩行システムとの統合

### 設計思想

**ノベルパートは歩行システムの設計思想に則る。**

歩行システムの全てのコールバック/タイミングでノベルパートを使用可能。
ノベルパートは歩行システムに「乗っかる」イベントの一種として設計する。

参照:
- [ゼロトタイプ歩行システム設計書](../歩行システム設計/ゼロトタイプ歩行システム設計書.md)
- [EventStep統合実装計画](../歩行システム設計/EventStep統合実装計画.md) - **EventStep統合による統一API**

### EventStep統合（2026-01-26実装完了）

**全イベントポイントで統一されたEventDefinitionSO + IEventStep[]を使用。**

```
EventDefinitionSO
├── steps: IEventStep[] ([SerializeReference])
│   ├── MessageStep（旧互換メッセージ＋選択肢）
│   ├── NovelDialogueStep（ノベルパート）← DialogueSOを参照
│   ├── BattleStep（戦闘起動）
│   ├── EmitEventStep（別EventDefinitionSO呼び出し）
│   └── EffectStep（Effect適用のみ）
└── terminalEffects: EffectSO[]
```

**ノベルパートの起動方法:**
```yaml
# EventDefinitionSOのsteps配列にNovelDialogueStepを追加
centralEvent:
  steps:
    - NovelDialogueStep:
        fieldDialogue: "SomeDialogue.asset"  # DialogueSOへの参照
        overrideZoom: false                   # SO側のズーム設定を使用
```

### イベント発火タイミング

全タイミングでEventDefinitionSOを使用。NovelDialogueStepを含めることでノベルパートを起動可能：

| タイミング | 設定箇所 | 使用可能なStep |
|-----------|----------|---------------|
| ノード入場時 | NodeSO.OnEnterEvent | Message, NovelDialogue, Battle, ... |
| サイドオブジェクト選択 | SideObjectSO.EventDefinition | 同上 |
| 中央オブジェクト選択 | NodeSO.CentralEvent | 同上 |
| ゲート出現時 | GateMarker.GateEvent (OnAppear) | 同上 |
| ゲート通過時 | GateMarker.GateEvent (OnPass) | 同上 |
| ゲート失敗時 | GateMarker.GateEvent (OnFail) | 同上 |
| 遭遇勝利時 | EncounterSO.OnWin | 同上 |
| 遭遇敗北時 | EncounterSO.OnLose | 同上 |
| 遭遇逃走時 | EncounterSO.OnEscape | 同上 |
| ノード退出時 | NodeSO.OnExitEvent | 同上 |
| 強制イベント | ForcedEventTrigger.EventDefinition | 同上 |

### 強制イベント（自動発生）

ForcedEventTriggerで設定。EventDefinitionSOを参照：

- 歩数条件（例：10歩歩いたら仲間が何か言う）
- 確率条件（例：毎歩5%で雑談発生）

```yaml
forcedEventTrigger:
  type: Steps
  stepCount: 10
  eventDefinition:  # EventDefinitionSOを参照
    steps:
      - NovelDialogueStep:
          fieldDialogue: "仲間の雑談.asset"
```

### 実装基盤

- **EventDefinitionSO**: IEventStep[]を持つイベント定義
- **IEventStep**: 多態的なステップインターフェース
- **EventRunner (IEventRunner)**: IEventStep[]を順次実行
- **NovelDialogueStep**: DialogueSOを参照してノベルパートを実行
- **DialogueSO**: フィールド会話データ（ステップ、表示モード、ズーム設定）

### SO設計方針

| SO | 用途 | 参照方法 |
|----|------|---------|
| DialogueSO | フィールド会話データ | NovelDialogueStep.fieldDialogue |
| EventDefinitionSO | イベント定義（全Step含む） | 各イベントポイントから直接参照 |

- DialogueSOは会話データのみを持つ（ズーム設定含む）
- EventDefinitionSOがDialogueSOを参照する形で統合
- 歩行システムの全イベントポイントはEventDefinitionSOを使用

### 会話中のモード切り替え

**セリフ単位で指定**する。

```csharp
[Serializable]
public class DialogueStep
{
    public string speaker;
    public string text;
    public DisplayMode mode;        // dinoid / portrait
    public bool hasBackground;      // 背景あり/なし
    public string backgroundId;     // 背景画像ID
    public PortraitState leftPortrait;   // 左立ち絵の状態
    public PortraitState rightPortrait;  // 右立ち絵の状態
    public NoiseEntry[] noises;
}
```

- 各セリフに「この時点での状態」を持たせる
- タップで次のセリフに進んだ時に、状態が変わればトランジション発生
- 立ち絵の状態（誰が、どの表情で）も明示的に指定

### 状態ライフサイクル・技術仕様

状態の所有者、ライフサイクル、復元契約などの技術仕様は
[ノベルパート仕様書](./ノベルパート仕様書.md) を参照。

### 拡張方針

1. IEventUIの拡張（立ち絵表示、背景制御、雑音表示）
2. DialogueDefinitionSOの本格実装（ConversationRunner）
3. リアクションシステムの追加（EventStep/EventChoiceの拡張）
4. トランジション演出システムの実装

---

## 実装フェーズ（案）

### Phase 1: 基盤整備
- [ ] DialogueDefinitionSOの本格実装
- [ ] ConversationRunnerの実装
- [ ] 立ち絵表示システム

### Phase 2: 演出システム
- [ ] モード切り替えトランジション
- [ ] 背景トランジション
- [ ] メッセージボックス切り替え

### Phase 3: 雑音・リアクション
- [ ] 雑音システム
- [ ] リアクション分岐システム
- [ ] ゲームシステム連携

---

## 設計意図・全体像

### 軽さと重さのグラデーション

```
歩行中
  ↓
フィールド会話（ディノイド/立ち絵、背景なし）
  │
  ├─ 軽い雑談 → 精神属性が変化 → 次のエンカウントに影響
  │
  ├─ 雑音が流れる（相槌、共感）
  │
  ├─ ログは下から上へ流れていく（MessageDropper）
  │
  ├─ 中央オブジェクトからの会話 → ズームあり/なし選択
  │
  └─ 話が重要になると...
       ↓
     フィールド会話（背景付き）へ移行
       │  ※まだ戻れない
       ↓
     イベント会話へ移行
       │  ※ここで初めて戻れるようになる
       ├─ リアクションシステムで分岐
       │
       └─ ゲームシステム（戦闘、推理等）へ派生
```

### このシステムの特徴

1. **軽い会話にも意味がある**
   - フィールド会話での選択肢が精神属性を形成
   - 「どうでもいい返し」が戦闘に影響する
   - プレイヤーは意識せずとも準備をしている

2. **シームレスな重さの変化**
   - ディノイド → 立ち絵 → 背景付きと段階的に重くなる
   - トランジション演出で「これは重要」と体感で分かる
   - 強制的な演出切り替えではなく、会話の流れで自然に移行

3. **同時性の表現**
   - 雑音システムで「複数人が同時に存在する」感覚
   - ターン制の「A→B→A」ではなく、Aが喋る間もBがいる
   - ニコ動のコメントのような空気感

---

## 未実装・未決定の設計意図

元メモから読み取れるが、設計書・実装に未反映の項目。

### ~~雑音のディノイドアイコン表示~~（実装済み）

`PortraitDatabase.GetIcon(speaker)`で取得したアイコンを雑音テキストの左に表示。
アイコンサイズ40px（fontSize=29の1.4倍）、半透明黒の背景付き。テキスト色は黒。
PortraitDBに未登録のSpeakerは従来通り`[Speaker] Text`でフォールバック。
入力待ち後にAccelerateNoises()が自動発火し、残存雑音をEaseIn Quadで加速（0.3秒で5倍速へ）。
詳細は[演出総合](./ノベルパート演出総合.md)の雑音セクションを参照。

### ~~雑音→立ち絵表情の連動~~（実装済み: 左右立ち絵 + 中央オブジェクト）

NoiseEntry.Expressionフィールドで雑音発火時の一時表情変更を実現。
詳細は[演出総合](./ノベルパート演出総合.md)の雑音セクションを参照。

**中央オブジェクトも対応済み。** CentralObjectPresenterに`currentCharacterId`を追加し、
`DialogueStep.centralObjectCharacterId`でキャラクターを指定可能。
OnNoiseSpawnedで左右立ち絵に加え中央オブジェクトのcharacterIdともマッチングし、
一致時にPortraitDatabaseから表情スプライトを取得して一時差し替えする。
詳細は「中央オブジェクトのキャラクター同一性（実装済み）」セクションを参照。

### 立ち絵登場トランジションの自動判定

元メモ: 「左右それぞれ最初に出た時にのみ行う」
現状はステップごとにTransitionTypeを手動指定。
「その側に初めてキャラが出る時だけ派手なトランジション、以降はシンプル」の自動判定は未実装。

### カットイン線トランジション

元メモ: 「カットインの線が閉じて、背景トランジション後に再出現」
背景トランジションのバリエーションとして、ワイプ/カットイン線スタイルは未実装。
現状はフェード（Show）とスライド（SlideIn）のみ。

### 背景付き会話のテキストボックス変化（設計確定・未実装）

DisplayMode × 背景の有無 = 4種のテキストボックスデザイン。
詳細は「テキストボックスの違い」セクションを参照。
現状のTextBoxPresenterはDisplayMode 2種のみ対応。背景有無による切替は未実装。

---

## 備考

- 本設計書は初期構想段階のまとめ
- 詳細仕様は実装開始時に確定
- 元メモ: `C:\Users\teinshiiin\Documents\20\notes\豚岬フォルダ\ノベルパートシステム.md`（編集禁止）
