# ノベルパート実装計画

## 概要

ノベルパート設計書を満たすための実装計画。
歩行システムの設計思想に則り、既存のEvent Kernel基盤を拡張する形で実装する。

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート設計.md) - 設計本体
- [ゼロトタイプ歩行システム設計書](../歩行システム設計/ゼロトタイプ歩行システム設計書.md) - 歩行システム基盤
- [HTMLモック](./novel_part_mock.html) - 技術デモ

---

## 現状分析

### 既存の実装基盤

| コンポーネント | ファイル | 状態 |
|---------------|---------|------|
| EventDefinitionSO | `Walk/EventKernel/EventDefinitionSO.cs` | ✅ 実装済み |
| EventRunner | `Walk/EventKernel/EventRunner.cs` | ✅ 実装済み |
| EventHost | `Walk/EventKernel/EventHost.cs` | ✅ 実装済み |
| IEventUI | `Walk/EventKernel/EventRunner.cs` | ✅ 最小実装 |
| WalkingEventUI | `Walk/EventKernel/WalkingEventUI.cs` | ✅ 最小実装 |
| MessageDropper | `MessageDropper.cs` | ✅ 実装済み |
| DialogueDefinitionSO | `Walk/Dialogue/DialogueDefinitionSO.cs` | ⚠️ プレースホルダ |
| DialogueNode | `Walk/Dialogue/DialogueNode.cs` | ⚠️ プレースホルダ |

### 現在のIEventUIインターフェース

```csharp
public interface IEventUI
{
    void ShowMessage(string message);
    UniTask<int> ShowChoices(string[] labels, string[] ids);
}
```

→ 立ち絵表示、背景制御、雑音システムの機能がない

### イベント発火タイミング（全て実装済み）

| タイミング | 実装場所 |
|-----------|---------|
| ノード入場 | AreaController.cs:130 |
| サイドオブジェクト選択 | AreaController.cs:614/626 |
| 中央オブジェクト選択 | AreaController.cs:629 |
| ゲート出現/通過/失敗 | AreaController.cs:325-375 |
| 遭遇結果 | AreaController.cs:681-685 |
| ノード退出 | AreaController.cs:494 |
| 歩数/確率トリガー | ❌ 未実装 |

---

## アーキテクチャ方針

### 1. SO設計

```
EventDefinitionSO（既存）
    ↓ 拡張
FieldDialogueSO（新規）  ← フィールド会話用
EventDialogueSO（新規）  ← イベント会話用（将来）
```

- 内部のデータ構造は共通化
- 歩行システム上では別SOとして明示的に区別

### 2. レイヤー構造

```
┌─────────────────────────────────────────┐
│  Presentation層（新規）                  │
│  ├─ PortraitPresenter（立ち絵表示）      │
│  ├─ BackgroundPresenter（背景制御）      │
│  ├─ NoisePresenter（雑音システム）       │
│  └─ TextBoxPresenter（テキストボックス） │
├─────────────────────────────────────────┤
│  IEventUI（拡張）                        │
│  ├─ ShowPortrait()                      │
│  ├─ ShowBackground()                    │
│  ├─ PlayNoise()                         │
│  └─ 既存: ShowMessage(), ShowChoices()  │
├─────────────────────────────────────────┤
│  Event Kernel（既存）                    │
│  ├─ EventRunner                         │
│  ├─ EventHost                           │
│  └─ EffectSO群                          │
├─────────────────────────────────────────┤
│  歩行システム（既存）                    │
│  └─ AreaController.WalkStep()           │
└─────────────────────────────────────────┘
```

---

## データ構造拡張

### DialogueStep（EventStep拡張）

```csharp
[Serializable]
public class DialogueStep
{
    // 基本
    public string speaker;
    public string text;

    // 表示モード
    public DisplayMode displayMode;  // Dinoid / Portrait

    // 立ち絵
    public PortraitState leftPortrait;
    public PortraitState rightPortrait;

    // 背景
    public bool hasBackground;
    public string backgroundId;

    // 雑音
    public NoiseEntry[] noises;

    // 選択肢
    public DialogueChoice[] choices;

    // Effect
    public EffectSO[] effects;
}

[Serializable]
public class PortraitState
{
    public string characterId;
    public string expression;      // 表情ID
    public Sprite portraitSprite;  // 直接指定も可
    public PortraitTransition transitionType;  // None/Rockman/SlideTop/SlideBottom
}

[Serializable]
public class NoiseEntry
{
    public string speaker;
    public string text;
}

public enum DisplayMode { Dinoid, Portrait }
public enum PortraitTransition { None, Rockman, SlideTop, SlideBottom }
```

### FieldDialogueSO

```csharp
[CreateAssetMenu(menuName = "Walk/Field Dialogue")]
public class FieldDialogueSO : ScriptableObject
{
    [SerializeField] private DialogueStep[] steps;
    public DialogueStep[] Steps => steps;
}
```

### EventDialogueSO（将来）

```csharp
[CreateAssetMenu(menuName = "Walk/Event Dialogue")]
public class EventDialogueSO : ScriptableObject
{
    [SerializeField] private DialogueStep[] steps;
    [SerializeField] private bool allowBacktrack;  // 戻る機能
    public DialogueStep[] Steps => steps;
    public bool AllowBacktrack => allowBacktrack;
}
```

---

## IEventUI拡張

```csharp
public interface IEventUI
{
    // 既存
    void ShowMessage(string message);
    UniTask<int> ShowChoices(string[] labels, string[] ids);

    // 立ち絵
    UniTask ShowPortrait(PortraitState left, PortraitState right);
    UniTask HidePortrait(PortraitPosition position);
    UniTask TransitionPortrait(PortraitState state, PortraitPosition position);

    // 背景
    UniTask ShowBackground(string backgroundId);
    UniTask HideBackground();

    // 雑音
    void PlayNoise(NoiseEntry[] entries);
    void AccelerateNoises();  // セリフ飛ばし時

    // テキストボックス
    UniTask SwitchTextBox(DisplayMode mode);

    // モード
    DisplayMode CurrentDisplayMode { get; }
}
```

---

## 新規Presenter一覧

### PortraitPresenter

```csharp
public class PortraitPresenter : MonoBehaviour
{
    [SerializeField] private Image leftImage;
    [SerializeField] private Image rightImage;
    [SerializeField] private PortraitDatabase portraitDB;

    public async UniTask Show(PortraitState left, PortraitState right, PortraitTransition transition);
    public async UniTask Hide(PortraitPosition position);
    public async UniTask Exit(PortraitPosition position);  // 捌ける
}
```

### BackgroundPresenter

```csharp
public class BackgroundPresenter : MonoBehaviour
{
    [SerializeField] private Image backgroundImage;
    [SerializeField] private BackgroundDatabase backgroundDB;

    public async UniTask Show(string backgroundId);
    public async UniTask Hide();
    public async UniTask SlideIn(string backgroundId);
}
```

### NoisePresenter

```csharp
public class NoisePresenter : MonoBehaviour
{
    [SerializeField] private RectTransform noiseContainer;
    [SerializeField] private NoisePrefab noisePrefab;

    public void Play(NoiseEntry[] entries);
    public void Accelerate();  // 全ての雑音を加速
}
```

### TextBoxPresenter

```csharp
public class TextBoxPresenter : MonoBehaviour
{
    [SerializeField] private GameObject dinoidTextBox;
    [SerializeField] private GameObject portraitTextBox;
    [SerializeField] private Image dinoidIcon;
    [SerializeField] private TMP_Text dinoidText;
    [SerializeField] private TMP_Text portraitSpeakerName;
    [SerializeField] private TMP_Text portraitText;

    public async UniTask SwitchMode(DisplayMode mode);
    public void SetText(string speaker, string text, DisplayMode mode);
}
```

---

## Effect拡張一覧

| Effect | 用途 | ファイル |
|--------|------|---------|
| ShowPortraitEffect | 立ち絵表示 | 新規 |
| HidePortraitEffect | 立ち絵非表示 | 新規 |
| ShowBackgroundEffect | 背景表示 | 新規 |
| HideBackgroundEffect | 背景非表示 | 新規 |
| PlayNoiseEffect | 雑音再生 | 新規 |
| SwitchDisplayModeEffect | モード切り替え | 新規 |
| SetSpiritualPropertyEffect | 精神属性変更 | 既存確認 |

---

## 強制イベント（歩数/確率トリガー）

### NodeSOへの追加

```csharp
// NodeSO.cs に追加
[Serializable]
public class ForcedEventTrigger
{
    public ForcedEventType type;  // Steps / Probability
    public int stepCount;         // 歩数条件
    public float probability;     // 確率条件（0-1）
    public FieldDialogueSO dialogue;
    public ConditionSO[] conditions;  // 追加条件
}

public enum ForcedEventType { Steps, Probability }
```

### AreaControllerへの組み込み

```csharp
// WalkStep() 内、遭遇判定の前に追加
private async UniTask CheckForcedEvents()
{
    var triggers = currentNode.ForcedEventTriggers;
    foreach (var trigger in triggers)
    {
        if (ShouldTrigger(trigger))
        {
            await TriggerFieldDialogue(trigger.dialogue);
        }
    }
}
```

---

## 実装フェーズ

### Phase 1: 基盤整備

**目標**: IEventUI拡張とデータ構造の確立

| タスク | 工数目安 | 依存 |
|--------|---------|------|
| DialogueStep構造体定義 | 2h | - |
| FieldDialogueSO作成 | 2h | DialogueStep |
| IEventUI拡張（インターフェース定義） | 2h | - |
| NovelPartEventUI骨格 | 3h | IEventUI拡張 |

### Phase 2: Presenter層

**目標**: 視覚要素の表示システム

| タスク | 工数目安 | 依存 |
|--------|---------|------|
| TextBoxPresenter | 4h | - |
| PortraitPresenter | 6h | - |
| BackgroundPresenter | 4h | - |
| NoisePresenter | 4h | - |
| Prefab作成・配置 | 4h | 各Presenter |

### Phase 3: トランジション

**目標**: 演出システム（LitMotion統合）

| タスク | 工数目安 | 依存 |
|--------|---------|------|
| 立ち絵登場3案実装 | 4h | PortraitPresenter |
| 立ち絵退場（捌ける） | 2h | PortraitPresenter |
| テキストボックス切り替え | 3h | TextBoxPresenter |
| 背景スライドイン | 2h | BackgroundPresenter |

### Phase 4: Effect実装

**目標**: 歩行システムからの呼び出し

| タスク | 工数目安 | 依存 |
|--------|---------|------|
| ShowPortraitEffect | 2h | PortraitPresenter |
| HidePortraitEffect | 1h | PortraitPresenter |
| ShowBackgroundEffect | 2h | BackgroundPresenter |
| HideBackgroundEffect | 1h | BackgroundPresenter |
| PlayNoiseEffect | 2h | NoisePresenter |
| SwitchDisplayModeEffect | 2h | TextBoxPresenter |

### Phase 5: 統合

**目標**: 歩行システムとの完全統合

| タスク | 工数目安 | 依存 |
|--------|---------|------|
| DialogueRunner実装 | 6h | Phase 1-4 |
| AreaControllerへの組み込み | 3h | DialogueRunner |
| 強制イベントトリガー | 4h | DialogueRunner |
| 既存イベントとの共存確認 | 2h | 全て |

### Phase 6: イベント会話（将来）

**目標**: 戻る機能、リアクションシステム

| タスク | 工数目安 | 依存 |
|--------|---------|------|
| EventDialogueSO | 3h | Phase 5 |
| バックログシステム | 8h | EventDialogueSO |
| 戻る機能（状態スナップショット） | 6h | バックログ |
| リアクション分岐 | 8h | Phase 5 |

---

## ファイル構成

```
Assets/Script/Walk/
├── EventKernel/
│   ├── EventDefinitionSO.cs      （既存）
│   ├── EventRunner.cs            （既存）
│   ├── EventHost.cs              （既存）
│   ├── WalkingEventUI.cs         （既存）
│   └── IEventUI.cs               （新規：インターフェース分離）
│
├── Dialogue/
│   ├── DialogueDefinitionSO.cs   （既存→廃止予定）
│   ├── DialogueNode.cs           （既存→廃止予定）
│   ├── DialogueStep.cs           （新規）
│   ├── FieldDialogueSO.cs        （新規）
│   ├── EventDialogueSO.cs        （新規：将来）
│   └── DialogueRunner.cs         （新規）
│
├── Presentation/
│   ├── CentralObjectPresenter.cs （既存）
│   ├── SideObjectPresenter.cs    （既存）
│   ├── PortraitPresenter.cs      （新規）
│   ├── BackgroundPresenter.cs    （新規）
│   ├── NoisePresenter.cs         （新規）
│   └── TextBoxPresenter.cs       （新規）
│
├── Effects/
│   ├── ShowMessageEffect.cs      （既存）
│   ├── ShowPortraitEffect.cs     （新規）
│   ├── HidePortraitEffect.cs     （新規）
│   ├── ShowBackgroundEffect.cs   （新規）
│   ├── HideBackgroundEffect.cs   （新規）
│   ├── PlayNoiseEffect.cs        （新規）
│   └── SwitchDisplayModeEffect.cs（新規）
│
└── Data/
    ├── PortraitDatabase.cs       （新規）
    └── BackgroundDatabase.cs     （新規）
```

---

## 既存システムとの共存

### MessageDropper

- フィールド会話（ディノイドモード）で継続使用
- ログが流れていく動作はそのまま維持
- IEventUI.ShowMessage()経由で呼び出し

### CentralObjectPresenter

- 中央オブジェクトのズーム時に使用
- ノベルパートUIとは別レイヤー（Z-order管理）

### WalkApproachUI

- サイドオブジェクト/ゲート選択は既存のまま
- ノベルパート発火後はTextBoxPresenterに切り替え

---

## テスト計画

### Phase 1-2 完了時

- [ ] ディノイドモードでテキスト表示
- [ ] 立ち絵モードでテキスト表示
- [ ] モード切り替えアニメーション
- [ ] 左右立ち絵の表示/非表示

### Phase 3 完了時

- [ ] 立ち絵登場3案のアニメーション
- [ ] 立ち絵退場（捌ける）
- [ ] 背景スライドイン
- [ ] テキストボックス切り替え演出

### Phase 4 完了時

- [ ] Effectからの立ち絵制御
- [ ] Effectからの背景制御
- [ ] 雑音の発生と流れ
- [ ] 雑音の加速（セリフ飛ばし時）

### Phase 5 完了時

- [ ] サイドオブジェクトからのフィールド会話起動
- [ ] 中央オブジェクトからのフィールド会話起動
- [ ] OnEnterイベントでのフィールド会話
- [ ] 強制イベント（歩数トリガー）
- [ ] 精神属性の変化

---

## リスクと対策

### リスク1: 既存EventDefinitionSOとの互換性

**対策**: FieldDialogueSOは新規作成、既存SOは段階的に移行

### リスク2: パフォーマンス（立ち絵表示）

**対策**:
- Sprite Atlasで立ち絵をまとめる
- ObjectPoolでPrefab再利用

### リスク3: トランジションの調整工数

**対策**:
- HTMLモックで事前検証済み
- LitMotionでイージング調整を容易に

---

## 備考

- 本計画はPhase 1-5を優先し、Phase 6（イベント会話）は後続タスクとする
- 各Phaseの完了時にHTMLモックとの動作比較を行う
- 工数は目安であり、実装中に調整する
