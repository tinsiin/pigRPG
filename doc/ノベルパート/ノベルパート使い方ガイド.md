# ノベルパート使い方ガイド

## 概要

ノベルパートシステムのセットアップと使い方を解説する。

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート設計.md) - 設計本体
- [ノベルパート実装計画.md](./ノベルパート実装計画.md) - 実装計画

---

## 歩行システムとの連携

### イベント発火タイミング一覧

| タイミング | 設定場所 | 説明 |
|-----------|---------|------|
| **ノード入場時** | NodeSO.OnEnterEvent | ノードに入った最初の1歩で発火 |
| **ノード退出時** | NodeSO.OnExitEvent | 出口を選択して次ノードに移動する直前 |
| **サイドオブジェクト選択** | SideObjectSO.EventDefinition | 左右のオブジェクトを選択した時 |
| **中央オブジェクト選択** | NodeSO.CentralEvent | 中央のオブジェクトを選択した時 |
| **ゲート出現** | GateMarker.GateEvent (OnAppear) | ゲートが画面に出現した時 |
| **ゲート通過** | GateMarker.GateEvent (OnPass) | ゲート条件を満たして通過した時 |
| **ゲート失敗** | GateMarker.GateEvent (OnFail) | ゲート条件を満たせず失敗した時 |
| **戦闘勝利** | EncounterSO.OnWin | 戦闘に勝利した時 |
| **戦闘敗北** | EncounterSO.OnLose | 戦闘に敗北した時 |
| **戦闘逃走** | EncounterSO.OnEscape | 戦闘から逃走した時 |
| **強制イベント（歩数）** | NodeSO.ForcedEventTriggers | 指定歩数に到達した時 |
| **強制イベント（確率）** | NodeSO.ForcedEventTriggers | 毎歩の確率判定で発火 |

---

### 方法1: EventDefinitionSO経由（既存システム）

既存のEventDefinitionSOにEffectを追加してノベルパートを呼び出す。

#### 手順

1. **EventDefinitionSO を作成**
```
右クリック → Create → Walk/Event Definition
```

2. **Effects配列に追加**

EventDefinitionSOのInspectorで`Effects`配列に以下を追加:
- `ShowPortraitEffect` - 立ち絵表示
- `ShowBackgroundEffect` - 背景表示
- `ShowMessageEffect` - メッセージ表示（既存）
- `SwitchDisplayModeEffect` - モード切替

3. **各イベントポイントに設定**

| 設定先 | Inspector項目 |
|-------|--------------|
| ノード入場 | NodeSO → On Enter Event |
| ノード退出 | NodeSO → On Exit Event |
| サイドオブジェクト | SideObjectSO → Event Definition |
| 中央オブジェクト | NodeSO → Central Event |
| ゲート | GateMarker → Gate Event |
| 戦闘結果 | EncounterSO → On Win / On Lose / On Escape |

#### 例: サイドオブジェクト選択時に立ち絵を表示

```
SideObjectSO (宝箱)
└── Event Definition: TreasureEvent (EventDefinitionSO)
    └── Effects:
        ├── [0] ShowPortraitEffect
        │       └── Character Id: "geino"
        │       └── Expression: "happy"
        │       └── Position: Left
        ├── [1] ShowMessageEffect
        │       └── Message: "宝箱を見つけた！"
        └── [2] HidePortraitEffect
                └── Position: Left
```

---

### 方法2: FieldDialogueSO経由（推奨）

複数ステップの会話を定義して呼び出す。

#### 手順

1. **FieldDialogueSO を作成**
```
右クリック → Create → Walk/Field Dialogue
```

2. **DialogueSteps を設定**

```
FieldDialogueSO (TreasureDialogue)
└── Steps:
    ├── [0] Speaker: "芸能"
    │       Text: "おっ、宝箱だ！"
    │       Left Portrait: geino/happy
    │
    ├── [1] Speaker: "ノラムリア"
    │       Text: "開けてみましょう"
    │       Right Portrait: noramlia/normal
    │
    └── [2] Speaker: ""
            Text: "中身は空っぽだった..."
            Effects: [アイテム取得Effect等]
```

3. **強制イベントに設定**

```
NodeSO
└── Forced Event Triggers:
    └── [0] Trigger Id: "treasure_event"
           Type: Steps
           Step Count: 1  (ノード入場直後)
           Consume On Trigger: true
           Dialogue: TreasureDialogue (FieldDialogueSO)
```

---

### 方法3: 強制イベント（歩数/確率トリガー）

ゲートやサイドオブジェクトとは独立して、歩数や確率で自動発火。

#### 歩数トリガー

指定歩数に到達したら発火。

```
NodeSO
└── Forced Event Triggers:
    └── [0] Trigger Id: "forest_10steps"
           Type: Steps
           Step Count: 10
           Consume On Trigger: true  (1回限り)
           Dialogue: Forest10StepsDialogue
```

#### 確率トリガー

毎歩の確率判定で発火。

```
NodeSO
└── Forced Event Triggers:
    └── [0] Trigger Id: "random_encounter_talk"
           Type: Probability
           Probability: 0.05  (5%で発火)
           Consume On Trigger: false  (繰り返し発火)
           Cooldown Steps: 10  (発火後10歩はクールダウン)
           Max Trigger Count: 3  (最大3回まで)
           Dialogue: RandomTalkDialogue
```

#### 条件付きトリガー

ConditionSOで追加条件を指定。

```
NodeSO
└── Forced Event Triggers:
    └── [0] Trigger Id: "has_key_event"
           Type: Steps
           Step Count: 5
           Conditions:
               └── [0] HasItemCondition (key_item)
           Dialogue: HasKeyDialogue
```

---

### 処理順序

WalkStep内での処理順序:

```
WalkStep()
├── 1. ノード入場イベント (OnEnterEvent)
├── 2. カウンタ進行
├── 3. サイドオブジェクト抽選・表示
├── 4. 中央オブジェクト表示
├── 5. ゲートチェック ← ゲート発火時はここでreturn
├── 6. エンカウント判定
├── 7. 戦闘実行 ← 戦闘結果イベント
├── 8. 強制イベントチェック ← 強制イベント発火時はここでreturn
├── 9. アプローチ処理 ← サイド/中央選択イベント
└── 10. 出口チェック ← 退出イベント
```

**ポイント:**
- ゲート発火 → エンカウント/強制イベント/アプローチはスキップ
- 強制イベント発火 → アプローチはスキップ
- エンカウント後に強制イベントが発火するため、戦闘結果に応じた会話が可能
- 1歩で複数の強制イベントは発火しない（最初の1件のみ）

---

### 設定例: ノード入場時の会話

```
NodeSO (森の入口)
├── On Enter Event: ForestEntranceEvent (EventDefinitionSO)
│   └── Effects:
│       ├── ShowBackgroundEffect (forest_entrance)
│       ├── ShowPortraitEffect (geino/surprised, Left)
│       ├── ShowMessageEffect ("ここが森の入口か...")
│       └── HidePortraitEffect (Left)
│
└── Forced Event Triggers: (なし、または別途設定)
```

### 設定例: ゲート通過時の会話

```
NodeSO
└── Gates:
    └── [0] GateMarker
        ├── Gate Event: GatePassEvent (EventDefinitionSO)
        ├── Event Timing: OnPass
        └── Effects:
            ├── SwitchDisplayModeEffect (Portrait)
            ├── ShowPortraitEffect (guard/happy, Right)
            ├── ShowMessageEffect ("通ってよし！")
            └── HidePortraitEffect (Right)
```

### 設定例: ランダム会話

```
NodeSO (草原)
└── Forced Event Triggers:
    ├── [0] Trigger Id: "random_talk_1"
    │       Type: Probability
    │       Probability: 0.03
    │       Cooldown Steps: 20
    │       Dialogue: RandomTalk1 (野生の動物を見かけた...)
    │
    └── [1] Trigger Id: "random_talk_2"
            Type: Probability
            Probability: 0.02
            Cooldown Steps: 30
            Conditions: [天気が晴れ]
            Dialogue: RandomTalk2 (いい天気だ...)
```

---

## 1. シーンセットアップ

### 1.1 NovelPartEventUI の配置

シーンに `NovelPartEventUI` コンポーネントを持つGameObjectを配置する。

```
Canvas (または既存のUI Canvas)
└── NovelPartEventUI (GameObject)
    ├── PortraitPresenter (子オブジェクト)
    ├── BackgroundPresenter (子オブジェクト)
    ├── NoisePresenter (子オブジェクト)
    ├── TextBoxPresenter (子オブジェクト)
    ├── BacklogPanel (子オブジェクト、任意)
    └── BackButton (子オブジェクト、任意)
```

### 1.2 各Presenterの参照設定

**NovelPartEventUI Inspector:**
```
[Header("Presenters")]
├── Portrait Presenter: (PortraitPresenterへの参照)
├── Background Presenter: (BackgroundPresenterへの参照)
├── Noise Presenter: (NoisePresenterへの参照)
└── Text Box Presenter: (TextBoxPresenterへの参照)

[Header("Databases")]
├── Portrait Database: (PortraitDatabaseアセットへの参照)
└── Background Database: (BackgroundDatabaseアセットへの参照)

[Header("Backlog UI")]
├── Backlog Panel: (バックログ表示用Panel、任意)
└── Back Button: (戻るボタン、任意)
```

---

## 2. 画像アセットの準備

### 2.1 立ち絵画像

**推奨仕様:**
- フォーマット: PNG（透過あり）
- サイズ: 縦長（例: 800x1200px）
- Texture Type: Sprite (2D and UI)

**命名規則例:**
```
Assets/Sprites/Portraits/
├── geino_normal.png      (芸能キャラ・通常表情)
├── geino_angry.png       (芸能キャラ・怒り)
├── geino_happy.png       (芸能キャラ・喜び)
├── noramlia_normal.png
├── noramlia_sad.png
└── ...
```

### 2.2 背景画像

**推奨仕様:**
- フォーマット: PNG/JPG
- サイズ: 画面解像度に合わせる（例: 1920x1080px）
- Texture Type: Sprite (2D and UI)

**命名規則例:**
```
Assets/Sprites/Backgrounds/
├── forest_day.png
├── forest_night.png
├── town_square.png
└── ...
```

### 2.3 アイコン画像（Dinoidモード用）

**推奨仕様:**
- フォーマット: PNG（透過あり）
- サイズ: 正方形（例: 128x128px）
- 用途: テキストボックス横に表示される小さいアイコン

---

## 3. Databaseアセットの作成

### 3.1 PortraitDatabase

```
右クリック → Create → Walk/Portrait Database
```

**Inspector設定:**
```csharp
[Serializable]
public class PortraitEntry
{
    public string characterId;     // "geino", "noramlia" など
    public string expression;      // "normal", "angry", "happy" など
    public Sprite portrait;        // 立ち絵Sprite
    public Sprite icon;            // Dinoidモード用アイコン
    public Color themeColor;       // ロックマン演出用カラー
}
```

**設定例:**
| Character ID | Expression | Portrait | Icon | Theme Color |
|-------------|------------|----------|------|-------------|
| geino | normal | geino_normal | geino_icon | #FF6B6B |
| geino | angry | geino_angry | geino_icon | #FF6B6B |
| noramlia | normal | noramlia_normal | noramlia_icon | #4ECDC4 |

### 3.2 BackgroundDatabase

```
右クリック → Create → Walk/Background Database
```

**Inspector設定:**
```csharp
[Serializable]
public class BackgroundEntry
{
    public string backgroundId;    // "forest_day" など
    public Sprite sprite;          // 背景Sprite
    public Color tint;             // 色調整（通常はwhite）
}
```

---

## 4. 会話データの作成

### 4.1 FieldDialogueSO（フィールド会話）

```
右クリック → Create → Walk/Field Dialogue
```

**Inspector設定:**
```csharp
[SerializeField] private DialogueStep[] steps;
```

**DialogueStep の各フィールド:**

| フィールド | 説明 |
|-----------|------|
| speaker | 話者名（"芸能", "ノラムリア" など） |
| text | セリフ本文 |
| displayMode | Dinoid / Portrait |
| leftPortrait | 左立ち絵の状態（characterId, expression, transition） |
| rightPortrait | 右立ち絵の状態 |
| hasBackground | 背景表示するか |
| backgroundId | 背景ID |
| noises | 雑音配列 |
| choices | 選択肢配列 |
| effects | Effect配列 |

### 4.2 EventDialogueSO（イベント会話・戻る機能あり）

```
右クリック → Create → Walk/Event Dialogue
```

**追加設定:**
| フィールド | 説明 |
|-----------|------|
| allowBacktrack | 戻る機能を有効にするか |
| showBacklog | バックログを表示するか |
| initialDisplayMode | 初期表示モード |

---

## 5. 強制イベントの設定

### 5.1 NodeSOへの設定

FlowGraphのNodeSOを選択し、`Forced Event Triggers` 配列を設定。

**ForcedEventTrigger の各フィールド:**

| フィールド | 説明 |
|-----------|------|
| triggerId | 一意のID（"node1_event1" など） |
| type | Steps（歩数到達）/ Probability（確率） |
| stepCount | type=Steps時の発火歩数 |
| probability | type=Probability時の確率（0.0〜1.0） |
| conditions | 追加条件（ConditionSO配列） |
| consumeOnTrigger | 1回限りで消費するか |
| cooldownSteps | 再発火までのクールダウン歩数 |
| maxTriggerCount | 最大発火回数（0=無制限） |
| dialogue | 発火時のFieldDialogueSO |

**設定例:**
```
triggerId: "forest_random_event"
type: Probability
probability: 0.1  (10%で発火)
consumeOnTrigger: false
cooldownSteps: 5
dialogue: (FieldDialogueSOへの参照)
```

---

## 6. Presenterの詳細設定

### 6.1 PortraitPresenter

```
[Header("立ち絵表示")]
├── Left Image: (左立ち絵用Image)
├── Right Image: (右立ち絵用Image)
├── Left Transform: (左立ち絵RectTransform)
└── Right Transform: (右立ち絵RectTransform)

[Header("ロックマン演出用")]
├── Left Rain Bar: (左の雨バーImage)
└── Right Rain Bar: (右の雨バーImage)

[Header("設定")]
├── Transition Duration: 0.3  (トランジション時間)
├── Rain Bar Duration: 0.35   (ロックマン演出時間)
├── Exit Slide Distance: 500  (退場スライド距離)
└── Slide Offset: 200         (スライド開始オフセット)
```

### 6.2 TextBoxPresenter

```
[Header("Dinoidモード")]
├── Dinoid Text Box: (DinoidモードのGameObject)
├── Dinoid Canvas Group: (フェード用CanvasGroup)
├── Dinoid Icon: (アイコンImage)
└── Dinoid Text: (テキストTMP_Text)

[Header("Portraitモード")]
├── Portrait Text Box: (PortraitモードのGameObject)
├── Portrait Canvas Group: (フェード用CanvasGroup)
├── Portrait Speaker Name: (話者名TMP_Text)
└── Portrait Text: (テキストTMP_Text)

[Header("設定")]
├── Switch Duration: 0.3      (切り替え時間)
├── Appear Offset: 50         (出現オフセット)
└── Appear Rotation: 5        (出現時の回転角度)
```

### 6.3 BackgroundPresenter

```
[Header("背景表示")]
├── Background Image: (背景用Image)
└── Background Transform: (背景RectTransform)

[Header("設定")]
├── Fade Duration: 0.3        (フェード時間)
└── Slide Distance: 1920      (スライド距離)
```

### 6.4 NoisePresenter

```
[Header("雑音表示")]
├── Noise Container: (雑音を配置するRectTransform)
└── Noise Prefab: (雑音テキストのPrefab)

[Header("設定")]
├── Base Speed: 200           (基本速度 px/sec)
├── Scatter Range: 50         (Y方向散らし範囲)
└── Accelerate Multiplier: 3  (加速時の倍率)
```

---

## 7. コードからの呼び出し

### 7.1 DialogueRunnerの取得

```csharp
// GameContext経由で取得
var dialogueRunner = context.DialogueRunner;

// または WalkingSystemManager経由
var dialogueRunner = walkingSystemManager.GameContext.DialogueRunner;
```

### 7.2 会話の実行

```csharp
// FieldDialogueSOを実行
var dialogue = Resources.Load<FieldDialogueSO>("Dialogues/MyDialogue");
var dialogueContext = new DialogueContext(dialogue, gameContext);
var result = await context.DialogueRunner.RunDialogueAsync(dialogueContext);

// 選択肢の結果を取得
if (result.SelectedChoiceIndex >= 0)
{
    Debug.Log($"選択: {result.SelectedChoiceIndex}");
}
```

### 7.3 EventDialogueSOを実行（戻る機能あり）

```csharp
var eventDialogue = Resources.Load<EventDialogueSO>("Dialogues/MyEventDialogue");
var dialogueContext = new DialogueContext(eventDialogue, gameContext);
var result = await context.DialogueRunner.RunDialogueAsync(dialogueContext);
```

---

## 8. UI階層の推奨構成

```
Canvas (Sort Order: 0)
├── WalkingUI (既存)
│   ├── SideObjectRoot
│   ├── CentralObjectRoot
│   └── ApproachUI
│
└── NovelPartUI (Sort Order: 10, 歩行UIより前面)
    ├── BackgroundPresenter
    │   └── BackgroundImage
    │
    ├── PortraitPresenter
    │   ├── LeftPortrait
    │   │   ├── LeftImage
    │   │   └── LeftRainBar
    │   └── RightPortrait
    │       ├── RightImage
    │       └── RightRainBar
    │
    ├── NoisePresenter
    │   └── NoiseContainer
    │
    ├── TextBoxPresenter
    │   ├── DinoidTextBox
    │   │   ├── DinoidIcon
    │   │   └── DinoidText
    │   └── PortraitTextBox
    │       ├── SpeakerName
    │       └── PortraitText
    │
    ├── BacklogPanel (非表示状態で配置)
    │   └── BacklogScrollView
    │
    └── BackButton (非表示状態で配置)
```

---

## 9. 立ち絵トランジションの種類

| TransitionType | 説明 |
|---------------|------|
| None | フェードイン |
| Rockman | 上から雨バーが降りてきて立ち絵出現 |
| SlideTop | 上からスライドイン |
| SlideBottom | 下からスライドイン |

---

## 10. トラブルシューティング

### 立ち絵が表示されない
1. PortraitDatabaseに該当characterId/expressionが登録されているか確認
2. PortraitPresenterのImage参照が設定されているか確認
3. DialogueStepのleftPortrait/rightPortraitが設定されているか確認

### テキストが表示されない
1. TextBoxPresenterのTMP_Text参照が設定されているか確認
2. DialogueStepのtextフィールドが空でないか確認

### DialogueRunnerがnull
1. シーンにNovelPartEventUIが配置されているか確認
2. WalkingSystemManagerの初期化が完了しているか確認
