# フロー数字仕様書

戦闘情報伝達の第3層（`doc/戦闘情報伝達の設計思想.md` 参照）。
ターゲットアイコン付近に数字+記号をポップアップ表示し、上昇後に各文字が穏やかに左右へ流れて消滅する。

戦闘中のHP・精神HPの変動パスの全体像は `doc/HP変動パス仕様書.md` を参照。本書はその中で**数値ポップアップが適切なパス**のみを扱う。

### フロー数字の対象

| カテゴリ | HP変動パス | 状態 |
|---|---|---|
| 攻撃ダメージ | `DamageOnBattle()` HP減少 | **実装済み** |
| レイザーダメージ | `RatherDamage()` HP減少 | **実装済み** |
| 回復 | `Heal()` HP増加 | **実装済み** |

### フロー数字の対象外

以下のHP変動は数値表示より演出（第1層・第2層）での伝達が適切:

| HP変動パス | 理由 | 適切な伝達層 |
|---|---|---|
| 精神ダメージ / 精神回復 | 精神HPはHPに対する相対値でありクランプも受けるため、数字の増減が結果に直結しない。HPのように「削った爽快感」が数字に乗らない | 第2層（エフェクト） |
| 蘇生 | 「生き返った」ことの劇的伝達が重要 | 第2層（エフェクト） |
| 互角一撃生存 | 「奇跡的に耐えた」ことの劇的伝達が重要 | 第1層（線描画）+ 第2層（エフェクト） |
| 刃物即死生存 | 同上 | 第1層 + 第2層 |
| ダウナー乖離 | 状態悪化の演出が重要 | 第2層（エフェクト） |

## 共通仕様

### アニメーション

全カテゴリ共通の演出フロー。

| フェーズ | 演出 | 時間 | 備考 |
|---|---|---|---|
| ポップ | scale 0.8→1.0 | 0.05s | |
| 上昇 | 上方向に移動しながら滞留 | 1.0s | EaseOutCubic |
| 散り | 各文字が左右に広がり + フェード | 0.5s | EaseOutCubic |
| **合計** | | **1.55s** | |

#### 散りフェーズの詳細

- 各文字が独立して動く（TMP_TextInfo頂点操作）
- X方向: 文字列の中央を基準に、左側の文字は左へ、右側の文字は右へ。中央からの距離に比例して移動量が増える（`_scatterSpreadX: 18`）
- Y方向: ±6px程度のランダムな揺れ（生成時に各文字ごとに確定）
- 同時にalpha 1→0でフェードアウト
- 全体の印象: 左右に静かに溶けていく穏やかな消え方

### 描画方式

- **文字色**: カテゴリごとに固定（攻撃ダメージ/レイザー=黒、回復=緑）。`FlowNumberCategory` enumで制御
- **ふち色**: 状況を表現する唯一の色情報。TMPのShaderUtilitiesでマテリアルインスタンスに設定
- **ふち太さ**: `_outlineWidth: 0.2`（0〜1、Inspectorで調整可能）

### 構成ファイル

| ファイル | 役割 |
|---|---|
| `Assets/Script/EYEAREA_UI/DamageFlowNumber.cs` | 本体MonoBehaviour。自律アニメーション→自壊 |
| `Assets/Script/EYEAREA_UI/BattleIconUI.cs` | `SpawnDamageFlow()` でプレハブをInstantiate |
| `Assets/Script/Players/UI/PlayersUIRefs.cs` | プレハブ参照の保持 |
| `Assets/prefab/キャラクタUI/DamageFlowNumber.prefab` | UIプレハブ（TMP 36pt Bold + DamageFlowNumber） |

### Inspectorパラメータ

#### DamageFlowNumber

| パラメータ | デフォルト | 説明 |
|---|---|---|
| `_riseDistance` | 30 | 上昇距離(px) |
| `_popDuration` | 0.05 | ポップ時間(s) |
| `_riseDuration` | 1.0 | 上昇時間(s) |
| `_scatterDuration` | 0.5 | 散り時間(s) |
| `_scatterSpreadX` | 18 | 散りX方向の広がり係数 |
| `_scatterRandomY` | 6 | 散りY方向のランダム幅(px) |
| `_outlineWidth` | 0.2 | アウトライン太さ(0〜1) |
| `_outlineColor` | 白 | デフォルトふち色 |

#### PlayersUIRefs

| パラメータ | 説明 |
|---|---|
| `DamageFlowPrefab` | DamageFlowNumberプレハブへの参照 |

### 技術メモ

- TMP頂点操作: `characterInfo[i].vertexIndex` から4頂点を取得し、`meshInfo[materialIndex].vertices` を直接変更。LitMotionのBindコールバック内で一括更新
- LitMotionの `MotionScheduler.UpdateIgnoreTimeScale` でポーズ中も進行
- 各`await`後に `if (this == null) return;` で戦闘終了時の破棄を安全にハンドリング
- 複数の数字が同時に存在可能（プーリングなし。パフォーマンス問題が出たら導入を検討）

---

## カテゴリ: 攻撃ダメージ（実装済み）

HP変動パス: `doc/HP変動パス仕様書.md` 攻撃ダメージ節

攻撃タイプスキル（`SkillType.Attack`）がダメージを与えた時に表示。

### 発火条件

`BaseStates.ReactionSkill.cs` 内の攻撃タイプスキルのダメージ処理後:

1. `SkillType.Attack` を持つスキルである
2. `hitResult != HitResult.CompleteEvade`（完全回避でない）
3. パッシブ/割り込みカウンターで無効化されていない
4. `damageAmount.Total > 0`（実際にダメージが発生した）
5. `BattleIcon != null`、`DamageFlowPrefab != null`

被弾点滅（`PlayDamageBlink`）と同時に発火する。

### 表示内容

| 状況 | 表示例 | 文字色 | ふち色 | 記号 |
|---|---|---|---|---|
| 通常ヒット | `90` | 黒 | 白 | なし |
| クリティカル | `128!` | 黒 | 赤 #ff6b6b | `!` |
| かすり | `45?` | 黒 | 灰青 #aabbcc | `?` |
| 乱れ攻撃 | `72^` | 黒 | 白 | `^` |
| クリティカル+乱れ | `128!^` | 黒 | 赤 #ff6b6b | `!^` |
| かすり+乱れ | `45?^` | 黒 | 灰青 #aabbcc | `?^` |

**文字色は常に黒**。ふち色優先度: **Critical > Graze > 通常/乱れ（白）**

乱れ（`^`記号）はヒット種別と独立で、常に末尾に付与される。乱れ単体ではふち色は変わらない（白のまま）。

#### 乱れ攻撃の発生条件

基礎山型分布（±22%補正）が -15% 以下になった場合、攻撃が「乱れた」と判定される（`GetBaseCalcDamageWithPlusMinus22Percent`）。PowerLevelがVeryLow以下の場合は基礎山形補正自体が消えるため、乱れは発生しない。

---

## カテゴリ: レイザーダメージ（実装済み）

HP変動パス: `doc/HP変動パス仕様書.md` レイザーダメージ節

`RatherDamage()` による純HP減算。13段補正チェーンを一切経由しない。

### 発火条件

`BaseStates.Damage.cs` `RatherDamage()` 内の `HP -= damage.Total` 直後に自動発火:

1. `damage.Total > 0`（実際にダメージが発生した）
2. `BattleIcon != null`、`DamageFlowPrefab != null`

`RatherDamage()` 本体内で発火するため、以下の全経路を自動カバー:

| 経路 | トリガー |
|---|---|
| パッシブダメージリンク | `BasePassive.OnAfterDamage()` → `LinkedPassive.DamageLinkRatio` |
| ActionEntryレイザー行動 | `PrepareRatherAct()` → `RatherAct()` → `ApplyRatherDamage()` |
| 定期戦闘効果（毒ダメ等） | パッシブの定時発動 → `RatherDamage()`（ダメージ仕組み未実装） |

### 表示内容

| 状況 | 表示例 | 文字色 | ふち色 | 記号 |
|---|---|---|---|---|
| レイザーダメージ | `†45` | 黒 | 白 | `†` を先頭に付与 |

- `†`（短剣符）を先頭に付与して攻撃ダメージと視覚的に区別する（補正チェーン外の貫通ダメージであるため）
- レイザーダメージは `DontDamageRatio` を貫通する性質がある
- `FlowNumberCategory.RatherDamage` → `BattleIconUI.SpawnRatherDamageFlow()`

---

## カテゴリ: 回復（実装済み）

HP変動パス: `doc/HP変動パス仕様書.md` 回復節

`Heal()` によるHP回復。`PassivesHealEffectRate()` による補正あり。

### 発火条件

`BaseStates.ReactionSkill.cs` 内の `ReactionSkillOnBattle` Heal処理後:

1. `SkillType.Heal` を持つスキルである
2. `ExecuteHealFriendlyCore()` の戻り値 > 0（命中して実際に回復が発生した）
3. `BattleIcon != null`、`DamageFlowPrefab != null`

命中判定（`SkillHitCalc` + `MixAllyEvade`）を経由するため、missの場合は数字が出ない。

### 表示内容

| 状況 | 表示例 | 文字色 | ふち色 | 記号 |
|---|---|---|---|---|
| HP回復 | `30` | 緑 (0.2, 0.8, 0.2) | 白 | なし |

- `FlowNumberCategory.Heal` → `BattleIconUI.SpawnHealFlow()`

