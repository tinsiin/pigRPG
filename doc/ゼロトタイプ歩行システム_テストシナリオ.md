# ゼロトタイプ歩行システム テストシナリオ

## 概要

本ドキュメントは、ゼロトタイプ歩行システムの残要素実装（2026-01-19）で追加された機能のテストシナリオを定義する。

## テスト環境

- **FlowGraph**: `Assets/ScriptableObject/WalkSO/FlowGraph_Stages.asset`
- **メインノード**: `Node_0__________`（エントランスホール）
- **テスト用SO**: `Assets/ScriptableObject/WalkSO/TestFeatures/`

## テスト用アセット一覧

| アセット名 | 種類 | 用途 |
|-----------|------|------|
| Condition_HasTag_VIP | HasTagCondition | tag="vip" |
| Condition_HasTag_Healed | HasTagCondition | tag="healed" |
| Effect_AddTag_VIP | AddTagEffect | "vip"タグ付与 |
| Effect_AddTag_Healed | AddTagEffect | "healed"タグ付与 |
| Effect_RemoveTag_VIP | RemoveTagEffect | "vip"タグ削除 |
| Effect_DoubleEncounter | PushEncounterOverlayEffect | x2.0倍, 10歩間 |
| Effect_HalfEncounter | PushEncounterOverlayEffect | x0.5倍, 永続 |
| Node_TestBranch | NodeSO | 分岐先テスト用ノード |
| Edge_Entrance_to_TestBranch | EdgeSO | エントランス→分岐エリア |

## 現在のテスト設定

### Node_0__________（エントランスホール）

| 項目 | 設定値 |
|------|--------|
| encounterRateMultiplier | 1.5 |
| exitSpawn.mode | Steps (2歩) |
| exitSpawn.requireAllGatesCleared | true |
| exits[0] | id="exit_to_branch", toNodeId="テスト分岐エリア", conditions=[HasTag_VIP] |
| gates[0] (gate_checkpoint) | position=20歩, onPass=[CreateAnchor, AddTag_VIP] |
| gates[1] (gate_loop) | position=80%, repeatable, cooldown=5歩 |

### SideTable_0__________

| Entry | SideObject | cooldownSteps | conditions |
|-------|------------|---------------|------------|
| 0 | RadioTower | 3 | なし |
| 1 | Tower1 | 0 | HasTag_Healed |
| 2 | Tower1 1 | 0 | なし |

---

## テストシナリオ

### シナリオ1: タグと条件付き出口

**テスト対象機能:**
- HasTagCondition
- AddTagEffect
- ExitCandidate.conditions

**前提条件:**
- WalkDebugInspectorが実装済み、またはデバッグ用タグ操作手段がある

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | ゲーム開始 | エントランスホールからスタート | - |
| 2 | 20歩目まで歩行 | gate_checkpoint が出現 | 中央オブジェクト表示 |
| 3 | ゲートをクリア | onPassが実行される | コンソール: `[Walk] AddTagEffect: Added tag 'vip'` |
| 4 | 全ゲートクリア後、出口出現 | 出口選択UIに「分岐エリアへ」が表示 | UI確認 |
| 5 | (比較) VIPタグなしで出口確認 | 「分岐エリアへ」が表示されない | UI確認 |

**検証ポイント:**
- ゲート通過でタグが付与される
- タグ条件を満たす出口のみ表示される
- タグ条件を満たさない出口は非表示

**ステータス:** ✅ 確認済み（2025-01-20）

---

### シナリオ2: サイドオブジェクトのcooldown

**テスト対象機能:**
- SideObjectEntry.cooldownSteps
- SideObjectCooldownTracker

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | 歩行開始 | サイドオブジェクトが出現 | 左右UI確認 |
| 2 | RadioTower（entries[0]）を選択 | アプローチ実行 | - |
| 3 | 次の1〜3歩を歩行 | RadioTowerが出現しない | 左右UI確認 |
| 4 | 4歩目以降 | RadioTowerが再び候補に含まれる | 左右UI確認 |

**検証ポイント:**
- cooldownSteps=3なので、選択後3歩間は同じサイドオブジェクトが出現しない
- cooldown終了後は通常通り抽選対象に戻る

**ステータス:** ✅ 動作確認済み（2026-01-19）

---

### シナリオ3: 条件付きサイドオブジェクト

**テスト対象機能:**
- SideObjectEntry.conditions
- HasTagCondition

**前提条件:**
- WalkDebugInspectorが実装済み、またはデバッグ用タグ操作手段がある

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | ゲーム開始（healedタグなし） | - | - |
| 2 | 複数歩歩行 | Tower1（entries[1]）が出現しない | 左右UI確認、コンソールログ |
| 3 | デバッグでhealedタグを付与 | - | WalkDebugInspector |
| 4 | 複数歩歩行 | Tower1が出現するようになる | 左右UI確認 |

**検証ポイント:**
- conditions未達成のサイドオブジェクトは候補から除外される
- conditions達成後は通常通り抽選対象に含まれる

**ステータス:** ✅ 確認済み（2025-01-20）

---

### シナリオ4: 遭遇率倍率（NodeSO）

**テスト対象機能:**
- NodeSO.encounterRateMultiplier
- EncounterResolver

**前提条件:**
- EncounterTableのbaseRateが0より大きい値に設定されている

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | EncounterTable.baseRateを0.1に設定 | - | インスペクター |
| 2 | エントランスホールで歩行 | 遭遇判定が1.5倍で行われる | コンソールログ |
| 3 | (比較) multiplier=1.0のノードで歩行 | 基本遭遇率で判定 | コンソールログ比較 |

**検証ポイント:**
- encounterRateMultiplier=1.5なので、基本遭遇率×1.5で判定
- ログで実際の判定倍率を確認

**ステータス:** ✅ 動作確認済み（2026-01-19）

---

### シナリオ5: 遭遇オーバーレイ

**テスト対象機能:**
- EncounterOverlay / EncounterOverlayStack
- PushEncounterOverlayEffect
- RemoveEncounterOverlayEffect

**前提条件:**
- WalkDebugInspectorが実装済み、またはEffect実行手段がある

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | Effect_DoubleEncounter を実行 | オーバーレイ追加 | コンソール: `Pushed 'double_encounter'` |
| 2 | 遭遇判定確認 | 遭遇率が2倍 | コンソールログ |
| 3 | 10歩歩行 | オーバーレイが自動削除 | - |
| 4 | 遭遇判定確認 | 遭遇率が元に戻る | コンソールログ |
| 5 | Effect_HalfEncounter を実行 | persistent=trueのオーバーレイ追加 | - |
| 6 | セーブ→ロード | オーバーレイが復元される | コンソールログ |

**検証ポイント:**
- オーバーレイで遭遇率が乗算される
- steps指定のオーバーレイは歩数経過で自動削除
- persistent=trueのオーバーレイはセーブ/ロードで保持

**ステータス:** ✅ 確認済み（2025-01-20）

---

### シナリオ6: Edge fallback制限

**テスト対象機能:**
- ExitResolver
- ExitCandidate.conditions が全てfalseの場合の挙動

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | VIPタグがない状態を維持 | - | - |
| 2 | 全ゲートをクリア | 出口出現条件を満たす | - |
| 3 | 出口確認 | 出口が表示されない（または空の選択肢） | UI確認 |
| 4 | (比較) exitsが空のNodeで同様の操作 | Edge経由で出口が表示される | UI確認 |

**検証ポイント:**
- exitsが設定されている場合、条件が全てfalseでもEdge fallbackしない
- exitsが空の場合のみEdge fallbackが発動

**ステータス:** 🔲 確認済み

---

### シナリオ7: varietyBias（サイドオブジェクト偏り抑制）

**テスト対象機能:**
- SideObjectTableSO.varietyBias
- VarietyHistory
- SideObjectSelector

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | varietyBias=0.5, varietyDepth=3 に設定 | - | インスペクター |
| 2 | 多数回歩行（50歩以上） | サイドオブジェクトが均等に出現 | ログ集計 |
| 3 | (比較) varietyBias=0 で同様の操作 | 完全ランダム（偏りあり） | ログ集計比較 |

**検証ポイント:**
- varietyBiasが高いほど最近出現したものが避けられる
- varietyDepthで履歴追跡数を制御

**ステータス:** 🔲 確認済み　いろいろ機能追加して　その上で確かに偏りが減るように違いが出ていることを確認した

---

### シナリオ8: ゲートの繰り返しとcooldown

**テスト対象機能:**
- GateMarker.repeatable
- GateMarker.cooldownSteps
- GateResolver

**前提条件（テスト用設定）:**

gate_loopを以下のように設定する（Inspectorで変更）:

| 項目 | 値 | 説明 |
|------|-----|------|
| repeatable | true | 既に設定済み |
| cooldownSteps | 5 | 既に設定済み |
| resetOnFail | true | **変更必要** (0→1) |
| passConditions | Condition_GateLoopTest | 条件を満たさないとfail |

**手順:**

| # | 操作 | 期待結果 | 確認方法 |
|---|------|----------|----------|
| 1 | ゲーム開始、40歩目まで歩行 | gate_loop出現、**ボタン表示** | 中央にゲート画像とボタン |
| 2 | ゲートボタンをクリック | 条件判定→失敗（条件未達成の場合） | - |
| 3 | 失敗時、歩数リセット（resetOnFail=true） | TrackProgressが0に戻る | UI歩数表示 |
| 4 | 再度40歩目まで歩行 | **cooldown中（5歩未満）はゲート出現しない** | 40歩目でもゲートなし |
| 5 | さらに歩いてcooldown終了後（計5歩以上経過） | 再度40歩目でゲート出現 | 中央にゲート画像とボタン |
| 6 | (オプション) 条件を満たしてクリア | ゲートクリア、repeatable=trueなので再出現可能 | - |

**検証ポイント:**
- ✅ ゲート出現時に**常にボタンが表示される**（2026-01-21修正で対応）
- ✅ repeatable=trueのゲートは失敗/クリア後も再出現する
- ✅ cooldownSteps中は出現しない
- ✅ resetOnFail=trueで歩数がリセットされる

**ステータス:** 🔲 テスト待ち（設計問題は2026-01-21に修正済み）

---

#### 過去の設計問題（2026-01-20発見→2026-01-21修正済み）

**報告された現象:**
- gate_loopに到達してもボタンが表示されなかった
- 原因: `blockingMode=SoftBlock`の場合、ボタンを表示しない設計だった

**修正内容（2026-01-21）:**
- `GateBlockingMode` enum を削除
- `CenterTriggerMode` enum を削除
- 全てのゲートで常にボタンを表示するように統一
- 詳細: `doc/歩行システム設計/アプローチオブジェクト統一_コード修正計画.md`

---

## 自動テスト（PlayModeテスト）

### 推奨テストケース

以下はUnity Test Frameworkで自動化すべきテストケース：

```csharp
// Assets/Tests/Walk/WalkSystemTests.cs

[Test] public void HasTagCondition_ReturnsFalse_WhenTagNotSet()
[Test] public void HasTagCondition_ReturnsTrue_WhenTagSet()
[Test] public void AddTagEffect_AddsTagToContext()
[Test] public void RemoveTagEffect_RemovesTagFromContext()
[Test] public void SideObjectCooldown_ExcludesRecentlySelected()
[Test] public void EncounterOverlay_MultipliesRate()
[Test] public void EncounterOverlay_ExpiresAfterSteps()
[Test] public void EncounterOverlay_PersistentSurvivesSaveLoad()
[Test] public void ExitResolver_NoFallback_WhenExitsConfigured()
[Test] public void ExitResolver_UsesFallback_WhenExitsEmpty()
```

**ステータス:** 🔲 未実装

---

## テスト結果サマリー

| シナリオ | 機能 | ステータス | 備考 |
|----------|------|------------|------|
| 1 | タグ + 条件付き出口 | ✅ 確認済み | 2025-01-20 |
| 2 | サイドオブジェクトcooldown | ✅ 確認済み | 2026-01-19 |
| 3 | 条件付きサイドオブジェクト | ✅ 確認済み | 2025-01-20 |
| 4 | 遭遇率倍率（Node） | ✅ 確認済み | 2026-01-19 |
| 5 | 遭遇オーバーレイ | ✅ 確認済み | 2025-01-20 |
| 6 | Edge fallback制限 | 🔲 未テスト | WalkDebugInspector必要 |
| 7 | varietyBias | ✅ 確認済み | 2026-01-20、SimRunnerで検証 |
| 8 | ゲート繰り返し/cooldown | 🔲 テスト待ち | 設計問題は2026-01-21修正済み |

---

## 次のステップ

1. **WalkDebugInspector実装** → シナリオ1,3,5,6のテストが可能に
2. **PlayModeテスト作成** → 自動回帰テスト
3. **SimRunnerでシナリオ7検証** → 統計的な偏り確認
