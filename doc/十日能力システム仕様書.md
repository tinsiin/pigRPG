# 十日能力システム仕様書

**ステータス: 実装済み（調査整理）**

「十日で理解できる程簡単につなぎとめた能力値」。キャラクターの個性を形成する37種の能力値システム。
四大ステータス（ATK/DEF/EYE/AGI）の算出基盤であり、ダメージ内訳追跡・思えダメージ・精神分散防御・乖離など複数のシステムに跨って参照される。

> 関連仕様書: `doc/スキル計算仕様書.md`, `doc/精神分散防御仕様書.md`, `doc/十日能力・四大ステ成長レンジ想定.md`

---

## 1. 全37能力一覧

> 実装: `TenDayAbilityManager.cs:11-89`

| # | enum名 | 日本語名 | 主な役割（概要） |
|---|--------|---------|----------------|
| 0 | TentVoid | テント空洞 | 虚無値。精神変換係数を下げる。乖離再充填ターンを伸ばす |
| 1 | NightDarkness | 夜暗黒 | 精神回復頻度。乖離最大カウント除数 |
| 2 | SpringWater | 泉水 | LowKey排他ATK(1.7)。高揚時の思え |
| 3 | StarTersi | 星テルシ | EYE寄与(0.6)。楽観時の思え |
| 4 | Raincoat | レインコート | **ATK共通22.0**（最大係数）。混乱時の思え |
| 5 | WaterThunderNerve | 水雷神経 | EYE共通(1.0)。Showey排他ATK |
| 6 | ColdHeartedCalm | 冷酷冷静 | 精神分散(重み1.0)。怒り時の思え |
| 7 | NightInkKnight | nightinknight | **DEF共通1.3**（DEFの王）。引き締め値 |
| 8 | SpringNap | 春仮眠 | 精神回復ボーナス。乖離持続計算 |
| 9 | Miza | ミザ | 乖離再充填短縮(÷4×スマイラー)。混乱時の思え |
| 10 | Baka | 馬鹿 | AGI共通(2.0)。**ATK共通-11.0**。思えの値(×1.3) |
| 11 | Smiler | スマイラー | **精神分散(重み2.0)**。乖離再充填短縮 |
| 12 | FaceToHand | 顔から手 | EYE寄与(0.8) |
| 13 | UnextinguishedPath | 未消光の道 | LowKey排他ATK。辛い時の思え |
| 14 | Sort | ソート | EYE寄与(0.6)。Doublet排他DEF |
| 15 | HeatHaze | 陽炎 | 精神分散(重み1.0)。AGI寄与(0.6)。怒り時の思え |
| 16 | Vail | ベイル | Showey排他ATK(1.11) |
| 17 | BlazingFire | 烈火 | ATK共通(0.8)。AGI共通(0.9) |
| 18 | FlameBreathingWife | 燃え火吹きウィフ | DEF共通(1.0)。辛い時の思え |
| 19 | Glory | 威光 | Duster排他DEF(0.8) |
| 20 | Rain | 雨 | Tricky排他ATK(0.6)。怒り時の思え。精神HP回復 |
| 21 | Leisure | 余裕 | 精神ATKブースト(攻撃者-被害者の差) |
| 22 | ElementFaithPower | 元素信仰力 | 精神回復(÷3) |
| 23 | CryoniteQuality | クリオネ質 | CentralHeavenStrike排他DEF(1.0) |
| 24 | Dokumamusi | ドクマムシ | ATK共通(0.4)。高揚時の思え |
| 25 | JoeTeeth | ジョー歯 | ATK共通(0.5)。DEF共通(0.8) |
| 26 | Pilmagreatifull | ピルマグレイトフル | ATK共通(0.56)。PotanuVolf排他DEF(1.4) |
| 27 | Blades | 刃物 | ATK共通(1.0)。**刃物即死クリティカル判定** |
| 28 | PersonaDivergence | ペルソナ乖離 | Tricky排他ATK(0.8)。疑念時の思え |
| 29 | SilentTraining | サイレント練度 | ATK共通(0.2)。混乱時の思え |
| 30 | HumanKiller | 人殺し人 | LowKey/Showey排他ATK(1.0)。疑念時の思え |
| 31 | Taraiton | 盥豚 | **精神分散(重み1.4)**。LowKey排他ATK(0.9) |
| 32 | HeavenAndEndWar | 天と終戦 | AGI共通(1.0)。ATK共通(0.3) |
| 33 | Enokunagi | エノクナギ | ATK共通(3.0)。乖離しきい値低下。疑念時の思え |
| 34 | Vond | ヴォンド | Tricky排他ATK(0.7)。覚悟時の思え |
| 35 | KereKere | ケレケレ | 乖離しきい値調整(NightDarkness - KereKere) |
| 36 | Lucky | ラッキー | （個別参照なし。四大ステ係数のみ） |

---

## 2. データ構造

### 2.1 TenDayAbilityDictionary

> 実装: `TenDayAbilityManager.cs:191-396`

```csharp
[Serializable]
public class TenDayAbilityDictionary : SerializableDictionary<TenDayAbility, float>
```

`Dictionary<TenDayAbility, float>` をシリアライズ可能にしたクラス。
演算子 `+`, `-`, `*` をサポートし、辞書同士・辞書とスカラーの演算が可能。

### 2.2 ReadOnlyIndexTenDayAbilityDictionary

> 実装: `TenDayAbilityManager.cs:398-420`

```csharp
[Serializable]
public class ReadOnlyIndexTenDayAbilityDictionary : TenDayAbilityDictionary
```

インデクサのsetを `InvalidOperationException` で封じた読み取り専用ラッパー。
`TenDayValuesBase()` / `TenDayValuesForSkill()` の戻り値に使用。
変更したい場合は `BaseTenDayValues` プロパティ経由で直接操作する。

### 2.3 StatesPowerBreakdown（ダメージ内訳）

> 実装: `BaseStates.StatesNumber.cs:1378-1430`

```csharp
public class StatesPowerBreakdown
{
    public TenDayAbilityDictionary TenDayBreakdown { get; set; }  // 十日能力ごとの寄与値
    public float NonTenDayPart { get; set; }                       // 十日能力以外の寄与（基礎値等）
    public float Total => TenDayBreakdown.Values.Sum() + NonTenDayPart;
    public float TenDayValuesSum => TenDayBreakdown.Values.Sum();

    public void TenDayAdd(TenDayAbility ability, float value);     // 特定能力の寄与を加算
    public float GetTenDayValue(TenDayAbility ability);            // 特定能力の寄与を取得
}
```

四大ステ算出やダメージ計算で「どの十日能力がどれだけ寄与したか」を追跡する。
演算子でBreakdown同士 / Breakdownとスカラーの演算が可能:

| 演算 | 動作 |
|------|------|
| `Breakdown * float` | 全成分を比例スケール（内訳維持） |
| `Breakdown + Breakdown` | 十日能力キーごとに加算 |
| `Breakdown - Breakdown` | 十日能力キーごとに減算 |
| `Breakdown + float` | NonTenDayPartにのみ加算 |
| `Breakdown - float` | NonTenDayPartにのみ減算 |

**内訳が必要な理由**: 思えダメージ計算（セクション7）で、ダメージの十日能力成分ごとに人間状況別ボーナスを加算するため。

---

## 3. キャラクター上の保持と取得

> 実装: `BaseStates.StatesNumber.cs:650-721`

### 3.1 保持

```
_baseTenDayValues : TenDayAbilityDictionary  [NonSerialized] 実行時フィールド
_tenDayTemplate   : シリアライズされた初期テンプレート
```

`EnsureBaseTenDayValues()` で `_tenDayTemplate` から初期化される。
成長は `_baseTenDayValues` に直接加算される。

### 3.2 取得メソッド

```
TenDayValuesBase()       = _baseTenDayValues + 武器NormalData
TenDayValuesForSkill()   = _baseTenDayValues + 武器NormalData + 武器(Blade/Magic/TLOA)Data
```

| メソッド | 武器ボーナス | 用途 |
|---------|------------|------|
| `TenDayValuesBase()` | NormalDataのみ | DEF計算、被害者側の参照、精神分散、パッシブ条件、UI |
| `TenDayValuesForSkill()` | Normal + スキル種別Data | 攻撃側ATK計算、精神状態遷移 |

### 3.3 武器ボーナスの構成

> 実装: `BaseWeapon.cs:117-156`

```
WeaponTenDayAbilityBonusData:
  NormalData  → 常時適用
  BladeData   → スキルがBlade時のみ追加
  MagicData   → スキルがMagic時のみ追加
  TLOAData    → スキルがTLOA時のみ追加
```

複合可能（刃物かつTLOAなら NormalData + BladeData + TLOAData）。

---

## 4. 四大ステへの寄与

> 実装: `BaseStates.StatesNumber.cs:230-340`

### 計算式の共通構造

```
四大ステ = 基礎基礎値(4.0) + Σ(十日能力 × 共通係数) + Σ(十日能力 × 排他係数 × 適応率)
```

四大ステはすべて `StatesPowerBreakdown` として算出され、十日能力ごとの寄与内訳を保持する。

### 4.1 ATK（攻撃力）

> Config: `AttackPowerConfig.cs`

**共通係数**: 21能力が寄与

| 能力 | 係数 | 備考 |
|------|------|------|
| Raincoat | **22.0** | 桁違いに大きい。Raincoat育成でATKが急伸 |
| Enokunagi | 3.0 | |
| Blades | 1.0 | |
| BlazingFire | 0.8 | |
| Pilmagreatifull | 0.56 | |
| JoeTeeth | 0.5 | |
| FlameBreathingWife | 0.5 | |
| Dokumamusi | 0.4 | |
| NightInkKnight | 0.45 | |
| HeavenAndEndWar | 0.3 | |
| ColdHeartedCalm | 0.23 | |
| SilentTraining | 0.2 | |
| Glory | 0.1 | |
| NightDarkness | 0.09 | |
| HeatHaze | 0.0666 | |
| Rain | 0.058 | |
| ElementFaithPower | 0.04 | |
| Smiler | 0.02 | |
| StarTersi | 0.02 | |
| FaceToHand | 0.01 | |
| Leisure | 0.01 | |
| Baka | **-11.0** | 大幅マイナス |

**排他係数**: 戦闘規格(BattleProtocol)別。適応率（`_adaptationRate`）が乗算される。

| LowKey | | Tricky | | Showey | |
|--------|---|--------|---|--------|---|
| SpringWater | 1.7 | Miza | 1.2 | Vail | 1.11 |
| HumanKiller | 1.0 | PersonaDivergence | 0.8 | HumanKiller | 1.0 |
| Taraiton | 0.9 | Vond | 0.7 | WaterThunderNerve | 0.2 |
| UnextinguishedPath | 0.3 | Rain | 0.6 | | |
| | | Enokunagi | 0.5 | | |

### 4.2 DEF（防御力）

> Config: `DefensePowerConfig.cs`

**共通係数**: 20能力が寄与

| 能力 | 係数 | 備考 |
|------|------|------|
| NightInkKnight | **1.3** | DEFの王 |
| FlameBreathingWife | 1.0 | |
| Raincoat | 1.0 | |
| JoeTeeth | 0.8 | |
| Leisure | 0.47 | |
| Pilmagreatifull | 0.38 | |
| Vond | 0.34 | |
| Blades | 0.3 | |
| HeavenAndEndWar | 0.3 | |
| HeatHaze | 0.23 | |
| Rain | 0.2 | |
| SilentTraining | 0.09 | |
| HumanKiller | 0.07 | |
| StarTersi | 0.04 | |
| SpringWater | 0.035 | |
| Vail | 0.02 | |
| FaceToHand | 0.013 | |
| NightDarkness | 0.01 | |
| BlazingFire | 0.01 | |
| Baka | -0.1 | |

**排他係数**: 防ぎ方(AimStyle)別。6スタイルそれぞれに固有の係数セット。

| 中天一弾 | | ダブレット | | 四弾差し込み | |
|---------|---|----------|---|-----------|---|
| CryoniteQuality | 1.0 | BlazingFire | 1.0 | SpringNap | 1.0 |
| JoeTeeth | 0.9 | HeatHaze | 0.7 | Vond | 0.77 |
| Smiler | 0.78 | SpringNap | 0.4 | Enokunagi | 0.5 |
| BlazingFire | 0.6 | Sort | 0.3 | TentVoid | 0.4 |
| Vail | 0.5 | NightInkKnight | 0.3 | SpringWater | 0.3 |
| SilentTraining | 0.4 | Vond | 0.2 | Rain | 0.2 |

| アクロバマイナ | | ダスター | | ポタヌヴォルフ | |
|-------------|---|---------|---|------------|---|
| Blades | 1.1 | Glory | 0.8 | Pilmagreatifull | 1.4 |
| ColdHeartedCalm | 1.0 | Miza | 0.6 | Taraiton | 0.4 |
| WaterThunderNerve | 0.6 | Raincoat | 0.4 | StarTersi | 0.3 |
| NightDarkness | 0.3 | SilentTraining | 0.4 | NightDarkness | 0.2 |
| StarTersi | 0.1 | Sort | 0.1 | WaterThunderNerve | 0.2 |
| Taraiton | 0.1 | TentVoid | -0.2 | BlazingFire | -0.2 |

### 4.3 EYE（命中力）

> Config: `EyePowerConfig.cs`

**共通係数のみ**（排他なし）: 23能力が寄与

| 主要能力 | 係数 |
|---------|------|
| WaterThunderNerve | 1.0 |
| NightInkKnight | 1.0 |
| FaceToHand | 0.8 |
| StarTersi | 0.6 |
| Sort | 0.6 |
| Miza | 0.5 |
| TentVoid | 0.3 |
| CryoniteQuality | 0.3 |
| Vail | 0.25 |
| ColdHeartedCalm | 0.2 |

### 4.4 AGI（敏捷力）

> Config: `AgiPowerConfig.cs`

**共通係数のみ**（排他なし）: 19能力が寄与

| 主要能力 | 係数 |
|---------|------|
| Baka | **2.0** |
| HeavenAndEndWar | 1.0 |
| BlazingFire | 0.9 |
| HeatHaze | 0.6 |
| WaterThunderNerve | 0.6 |
| Vond | 0.4 |
| FlameBreathingWife | 0.3 |
| Taraiton | 0.3 |

### 4.5 MentalDEF（精神防御力）

> 実装: `BaseStates.StatesNumber.cs:615-628`

```
MentalDEF = b_DEF × 0.7 × パワーレベル倍率
```

| PowerLevel | 倍率 | 実効DEF比 |
|-----------|------|----------|
| High | 1.4 | 0.98倍 |
| Medium | 1.0 | 0.70倍 |
| Low | 0.7 | 0.49倍 |
| VeryLow | 0.4 | 0.28倍 |

---

## 5. 成長システム

> 実装: `Battle/Growth/WinGrowthStrategy.cs`, `CommonCalc.cs:73-88`

### 5.1 成長の仕組み

```
成長量 = グラデーション係数 × スキル十日能力値 × 基礎倍率 × 自信ブースト
```

| 要素 | 値 | 備考 |
|------|---|------|
| 基礎倍率（攻撃スキル） | 0.3 | |
| 基礎倍率（非攻撃） | 0.1 | |
| 自信ブースト | 1.0 or 1.3+Baka×0.01 | 格上撃破時 |
| グラデーション係数 | 0〜1.0 | **マンハッタン距離15で0に減衰** |
| 救済下限 | 0.35 | 係数 < 0.3 かつ距離10以内で発動 |

### 5.2 距離減衰（ソフトキャップ）

```
減衰 = 1.0 - (マンハッタン距離 / maxDistance)    // 距離 < maxDistance
減衰 = 0                                         // 距離 >= maxDistance
```

- キャラの十日能力とスキルの十日能力の「距離」が近いほど成長が速い
- 距離15で成長係数が0 → そのスキルからの成長が停止
- ハードキャップなし。成長速度の逓減で実質的に収束
- **100を超えるあたりから目に見えて鈍化**すると推測

> 詳細: `doc/十日能力・四大ステ成長レンジ想定.md`

---

## 6. 引き締め値（NightInkKnight）

> 実装: `BaseStates.Damage.cs:326-472`

NightInkKnightは防御切り替え（AimStyle変更）の成功率に関わる特殊メカニクス。

### 6.1 段階計算

```
引き締め段階 = NightInkKnight / 10（切り捨て）
```

### 6.2 引き締め確率

```
段階 >= 2 のとき:
  確率 = 0.31 + NightInkKnight × 0.01
  成功すると変換カウント -1（AimStyle切り替えが1ターン早まる）

段階 >= 5 のとき（追加）:
  80%の確率でさらにカウント -1
```

- NightInkKnight = 69 で確率が100%に到達（飽和）
- 段階5（NightInkKnight = 50以上）で引き締めが本格機能

---

## 7. 思えダメージ（Resonance）

> 実装: `BaseStates.Damage.cs:965-1085`

格上からの攻撃で蓄積される特殊ダメージ。**ダメージの十日能力内訳を直接参照する**。

### 7.1 発動条件

```
発動 = 攻撃者の十日能力合計 / 被害者の十日能力合計 >= RESONANCE_POWER_THRESHOLD
```

### 7.2 計算式

```
基礎思え = dmg.TenDayValuesSum × BASEDAMGE_TENDAYS
         + 人間状況別の十日能力ボーナス（下記）

危険度 = min(0.8, 1.0 - (HP + MentalHP) / 2 / MaxHP)
強さ倍率 = powerRatio - (しきい値 - 1.0)

最終思え = 基礎思え × 危険度 × 強さ倍率 × (1 - 精神ポテンシャル × 防御係数)
```

### 7.3 人間状況別ボーナス（内訳を直接参照）

**ここがStatesPowerBreakdownの内訳が必要な核心部分。**

| 人間状況 | 参照する十日能力成分 | 精神属性ボーナス(×1.3) |
|---------|-------------------|---------------------|
| **辛い** | `dmg.GetTenDayValue(UnextinguishedPath)` + `FlameBreathingWife` | Devil, LiminalWhiteTile |
| **楽観** | `dmg.GetTenDayValue(NightDarkness)` + `StarTersi` | Doremis |
| **高揚** | `dmg.GetTenDayValue(Dokumamusi)` + `SpringWater` | なし |
| **覚悟** | `dmg.GetTenDayValue(TentVoid)` + `Vond` | Psycho |
| **怒り** | `dmg.GetTenDayValue(HeatHaze)` + `Rain` + `ColdHeartedCalm` | LiminalWhiteTile |
| **疑念** | `dmg.GetTenDayValue(HumanKiller)` + `PersonaDivergence` + `Enokunagi` + `Blades` | Doremis, Psycho |
| **混乱** | `dmg.GetTenDayValue(SilentTraining)` + `Miza` + `Raincoat` | Doremis, Sacrifaith |

例: 被害者が「怒り」状態のとき、ダメージのうち**陽炎・雨・冷酷冷静由来の成分**が思えボーナスに加算される。
内訳がスカラーに潰されていたらこの計算が不可能。

### 7.4 刃物即死クリティカルとの関係

> 実装: `BaseStates.Damage.cs:83-97`

```csharp
dmg.TenDayAdd(TenDayAbility.Blades, LiveHP);
resonanceDmg.TenDayAdd(TenDayAbility.Blades, LiveHP);
```

刃物即死ダメージは `Blades` 成分としてBreakdownに記録される。
被害者が「疑念」状態なら `Blades` は思えボーナスの対象 → 即死クリティカルが思えにも波及する。

---

## 8. 乖離システムとの関係

> 実装: `BaseStates.BattleEvent.cs:183-263`

### 8.1 乖離しきい値

```csharp
ExtraValue = (NightDarkness - KereKere) × 0.01

Normal: 0.9 + ExtraValue
Doubtful: 0.7 + ExtraValue - Enokunagi補正
// 他の人間状況にもそれぞれ固有のしきい値
```

### 8.2 乖離再充填ターン数

```
再充填 = TentVoid × 3 − Miza ÷ 4 × Smiler
```

- **TentVoid**: 再充填を長くする（乖離が再発しにくくなる）
- **Miza × Smiler**: 再充填を短くする（乖離が再発しやすくなる）

### 8.3 苦悩システム（スキル乖離）

> 実装: `BaseStates.BattleEvent.cs:20-172`

- 戦闘中にスキル使用7回以上 かつ 乖離スキル使用率71%超で発動
- 発動すると `_baseTenDayValues -= 平均乖離十日能力 × 1.2f` で直接減少

---

## 9. 精神分散防御での使用

> 詳細: `doc/精神分散防御仕様書.md`

4つの十日能力で分散率を算出し、テント空洞で精神変換係数を制御:

```
分散率 = min(1.0, (Smiler×2 + Taraiton×1.4 + HeatHaze×1 + ColdHeartedCalm×1) / 162)
精神変換係数 = max(0, Random(0.95, 1.0) − TentVoid × 0.00675)
```

分散処理は `StatesPowerBreakdown` のまま比例抽出し、十日能力内訳を保持する
（思えダメージの正確性を維持するため）。

---

## 10. 個別能力の特殊用途まとめ

四大ステ係数以外で個別参照される能力の一覧:

| 能力 | システム | 用途 |
|------|---------|------|
| NightInkKnight | 引き締め | AimStyle切り替え成功率 |
| Blades | 刃物即死 | 即死確率 = atkerBlade / 被害者 × 100。即死dmgをBlades成分に記録 |
| Leisure | 精神ATK | 攻撃者と被害者のLeisure差で精神ダメージブースト |
| TentVoid | 乖離 / 精神分散 | 再充填伸長 × 精神変換係数低下 |
| NightDarkness | 精神回復 / 乖離 | 回復頻度(×2)、乖離しきい値補正、乖離最大カウント除数 |
| SpringNap | 精神回復 / 乖離 | 回復ボーナス、乖離持続計算 |
| Miza | 乖離 | 再充填短縮(÷4 × Smiler) |
| Smiler | 精神分散 / 乖離 | 分散率主役(重み2.0)、再充填短縮(Miza ÷ 4 と乗算) |
| Rain | 精神HP | 精神HP自然回復加算 |
| ElementFaithPower | 精神回復 | 精神回復量(÷3) |
| Baka | 思えの値 | ResonanceValue = 合計×0.56 + **Baka×1.3** |
| Enokunagi | 乖離 | 疑念時の乖離しきい値を下げる |
| KereKere | 乖離 | NightDarkness - KereKereで乖離しきい値を調整 |

---

## 11. 実装箇所一覧

| ファイル | 内容 |
|---------|------|
| `TenDayAbilityManager.cs` | TenDayAbility enum、TenDayAbilityDictionary、ReadOnlyIndex |
| `BaseStates.StatesNumber.cs:230-340` | b_ATK/b_DEF/b_EYE/b_AGI算出 |
| `BaseStates.StatesNumber.cs:650-721` | _baseTenDayValues保持、TenDayValuesBase/ForSkill |
| `BaseStates.StatesNumber.cs:1378-1670` | StatesPowerBreakdown定義・演算子 |
| `Config/AttackPowerConfig.cs` | ATK共通・排他係数 |
| `Config/DefensePowerConfig.cs` | DEF共通・排他係数 |
| `Config/EyePowerConfig.cs` | EYE共通係数 |
| `Config/AgiPowerConfig.cs` | AGI共通係数 |
| `Config/MentalDispersalConfig.cs` | 精神分散防御の重み・条件 |
| `BaseStates.Damage.cs:83-97` | 刃物即死クリティカル |
| `BaseStates.Damage.cs:326-472` | 引き締め値 |
| `BaseStates.Damage.cs:965-1085` | 思えダメージ |
| `BaseStates.BattleEvent.cs:183-263` | 乖離しきい値・再充填 |
| `Battle/Growth/WinGrowthStrategy.cs` | 成長計算 |
| `BaseWeapon.cs:117-156` | 武器ボーナス構成 |

---

## 設計メモソース

- `豚のスキル.md` — スキル・十日能力設計メモ
