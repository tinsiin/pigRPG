# ノベルパート仕様書

ノベルパートの実装詳細仕様。今後の開発・拡張のためのリファレンス。

## 関連ドキュメント

- [ノベルパート設計.md](./ノベルパート/ノベルパート設計.md) - 設計思想・全体像
- [ノベルパート設定仕様書.md](./ノベルパート設定仕様書.md) - SOの設定方法

---

## 背景システム

### 概要

ノベルパートで表示される背景画像の制御システム。
`BackgroundPresenter`が背景の表示/非表示/トランジションを担当。

### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `BackgroundPresenter.cs` | 背景表示制御 |
| `BackgroundDatabase.cs` | 背景画像データベース |
| `NovelPartEventUI.cs` | UI統括（BackgroundPresenterを保持） |
| `NovelPartDialogueRunner.cs` | 会話実行（背景変更タイミング判定） |

### 現在の背景オン/オフ動作

| 操作 | メソッドチェーン | アニメーション |
|------|-----------------|----------------|
| 背景表示 | `ShowBackground()` → `backgroundPresenter.Show()` | フェードイン（0.3秒） |
| 背景非表示 | `HideBackground()` → `backgroundPresenter.Hide()` | フェードアウト（0.3秒） |
| 戻る機能での復元 | `ShowImmediate()` / `HideImmediate()` | なし（即時） |

### 背景変更タイミング

`NovelPartDialogueRunner.ShouldUpdateBackground()`で判定：

```csharp
// 前のステップと比較して変更があれば更新
return previousStep.HasBackground != current.HasBackground
    || previousStep.BackgroundId != current.BackgroundId;
```

つまり：
- `hasBackground`が変わった時
- `backgroundId`が変わった時

### 実装済みアニメーション

#### Show（フェードイン）

```
alpha: 0 → 1
時間: 0.3秒
イージング: OutQuad
```

#### SlideIn（スライドイン）

```
位置: 右端（+1920px）→ 元の位置
alpha: 最初から1（フェードなし）
時間: 0.3秒
イージング: OutQuad
```

**注意:** `SlideInBackground()`メソッドは実装済みだが、通常の会話フローでは未使用。

#### Hide（フェードアウト）

```
alpha: 現在値 → 0
時間: 0.3秒
イージング: InQuad
```

### パラメータ

`BackgroundPresenter`のSerializeField：

| フィールド | 説明 | デフォルト |
|------------|------|-----------|
| fadeDuration | フェード時間 | 0.3秒 |
| slideDistance | スライド距離 | 1920px |

### DialogueStepでの指定

```
DialogueStep
├── hasBackground: bool      ← 背景を表示するか
└── backgroundId: string     ← 背景ID（BackgroundDatabaseで解決）
```

### 背景データベース

`BackgroundDatabase.asset`で管理：

```
BackgroundDatabase
└── backgrounds[]
    ├── [0]
    │   ├── backgroundId: "forest"
    │   ├── sprite: forest.png
    │   └── tint: Color.white
    └── [1]
        ├── backgroundId: "night_city"
        ├── sprite: night_city.png
        └── tint: (0.8, 0.8, 1.0, 1.0)  ← 青みがかった色調
```

### 未実装・今後の拡張候補

設計書に記載されているが未実装の演出：

| 演出 | 状態 | 備考 |
|------|------|------|
| フェードイン | ✅ 実装済み | 現在のデフォルト |
| スライドイン | ✅ 実装済み | 未使用（呼び出し箇所なし） |
| 回転アニメ | ❌ 未実装 | 設計書に記載あり |
| カットイン線 | ❌ 未実装 | 設計書に記載あり |

---

## 立ち絵トランジション

### 概要

立ち絵が登場/退場する際のアニメーション。
`PortraitPresenter`が制御。

### トランジション一覧

| 種類 | enum値 | 説明 |
|------|--------|------|
| なし | `None` | 即時フェードイン |
| ロックマン風 | `Rockman` | 縦線降下→フェードイン |
| 上から | `SlideTop` | 上からスライドイン |
| 下から | `SlideBottom` | 下からスライドイン |

### ロックマン風トランジション

詳細は[ノベルパート設定仕様書.md](./ノベルパート設定仕様書.md)「立ち絵登場トランジション」セクション参照。

**動作フロー:**
```
1. RainBar（キャラ色の縦長バー）が上から降下（0.35秒）
2. RainBarがフェードアウト（0.1秒）
3. 立ち絵がフェードイン（0.3秒）
```

**色の決定:**
```
PortraitState.CharacterId
    → PortraitDatabase.GetThemeColor()
    → PortraitCharacterData.ThemeColor
    → RainBarの色
```

### 退場アニメーション

| メソッド | 動作 |
|----------|------|
| `Hide()` | フェードアウト |
| `Exit()` | 横にスライドアウト（左立ち絵は左へ、右立ち絵は右へ） |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-31 | 初版作成（背景システム、立ち絵トランジション） |
