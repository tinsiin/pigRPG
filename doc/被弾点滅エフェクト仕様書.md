# 被弾点滅エフェクト仕様書

## 概要

ダメージが発生した際、被弾側の BattleIconUI のアイコンを点滅させる。
全攻撃に共通する、最も根源的な「ダメージを受けた」ことの視覚表現。

---

## 攻撃表現の3層構造における位置づけ

```
層                        担当                    対象
─────────────────────────────────────────────────────────
1. 被弾点滅 ← これ        BattleIconUI            全攻撃共通
2. 武器エフェクト          WeaponSlashAnimator     刃物武器のみ
3. スキルエフェクト         EffectPlayer 3スロット  スキルごとに個別定義
```

第1層は他の層と独立しており、刃物スラッシュが出ようがスキルエフェクトがあろうがなかろうが、ダメージが発生すれば常に点滅する。

詳細: `doc/武器スラッシュエフェクト仕様書.md`「なぜ刃物武器だけなのか — 設計判断」セクション

---

## 発動条件

### トリガー

`DamageOnBattle()` の戻り値（`StatesPowerBreakdown.Total`）が 0 より大きい場合。
回避・グレイズで 0 ダメージの場合は点滅しない。

### 対象

**味方・敵の両方**。被弾した側のアイコンが点滅する。
- 味方が敵を攻撃 → 敵アイコンが点滅
- 敵が味方を攻撃 → 味方アイコンが点滅

### フック箇所

`BaseStates.ReactionSkill.cs` — `ReactionSkillOnBattle()` 内、`DamageOnBattle()` 直後:

```
ReactionSkillOnBattle()  ← 被弾側のメソッド
  └── damageAmount = DamageOnBattle(...)  ← HP減少
      └── isAtkHit = true
          └── damageAmount.Total > 0 && BattleIcon != null
              └── BattleIcon.PlayDamageBlink().Forget()  ← fire-and-forget
```

PlayersUIRefs を `FindFirstObjectByType` で取得し、設定値を渡す（WeaponSlash と同じパターン）。
見つからない場合はデフォルト値（0.5秒、4回）を使用。

---

## アニメーション仕様

### パラメータ

| 項目 | 値 | 備考 |
|------|-----|------|
| 点滅回数 | 4回（デフォルト） | PlayersUIRefs で調整可能 |
| 合計時間 | 0.5秒（デフォルト） | PlayersUIRefs で調整可能 |
| 1サイクル | 125ms | = 合計時間 / 点滅回数 |
| 消灯時間 | サイクルの前半 | ~62.5ms |
| 点灯時間 | サイクルの後半 | ~62.5ms |
| 点滅方法 | Icon（Image）の color.alpha を 0 ↔ 1 にトグル | 完全透明 ↔ 完全不透明 |
| 終了保証 | try-finally で必ず alpha=1 で終わる | Icon が破棄されても安全 |

### 見え方

```
時間:  0ms    62ms   125ms  187ms  250ms  312ms  375ms  437ms  500ms
状態:  ■■■■■ □□□□□ ■■■■■ □□□□□ ■■■■■ □□□□□ ■■■■■ □□□□□ ■■■■■
       点灯    消灯    点灯    消灯    点灯    消灯    点灯    消灯    点灯(終了)
       ──1回目──  ──2回目──  ──3回目──  ──4回目──
```

最初は点灯状態から始まり、最後も点灯状態で終わる。

### PlayersUIRefs 設定（味方共通）

| フィールド | 型 | 範囲 | デフォルト | 説明 |
|-----------|-----|------|----------|------|
| `DamageBlinkDuration` | `float` | 0.2 ~ 1.5 | 0.5 | 点滅の合計時間（秒） |
| `DamageBlinkCount` | `int` | 2 ~ 8 | 4 | 点滅回数 |

---

## 他の演出との干渉

| 演出 | 干渉 | 理由 |
|------|------|------|
| HPBar | なし | HPBar は CombinedStatesBar。Icon の alpha とは別 |
| 武器スラッシュ | なし | スラッシュは ViewportArea 上の RawImage。描画レイヤーが異なる |
| スキルエフェクト | なし | EffectPlayer は BattleIconUI の子だが、Icon とは別オブジェクト。点滅中もエフェクトは見える |
| numberEffect | なし | ダメージ数値表示は Icon とは別コンポーネント |

---

## 注意事項

- **点滅の重複**: 点滅中にさらにダメージを受けた場合、新しい点滅が重複して走る。持続時間が短い（0.5秒）ため実害は少ない。必要なら CancellationToken で前の点滅をキャンセル可能
- **シーン遷移**: try-finally で alpha を復帰。Icon が null になった場合は早期リターン
- **BattleIcon 未バインド**: `BattleIcon == null` の場合は何もしない

---

## ソースファイル

| ファイル | 役割 |
|---------|------|
| `Assets/Script/EYEAREA_UI/BattleIconUI.cs` | `PlayDamageBlink()` メソッド（点滅アニメーション本体） |
| `Assets/Script/BaseStates/Battle/BaseStates.ReactionSkill.cs` | ダメージ発生後の点滅トリガー（805行目付近） |
| `Assets/Script/Players/UI/PlayersUIRefs.cs` | `DamageBlinkDuration` / `DamageBlinkCount`（調整用パラメータ） |
