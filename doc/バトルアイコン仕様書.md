# バトルアイコン仕様書

## 概要

バトル画面に表示されるキャラクターアイコン（BattleIconUI）の設定方法と画像規格を定義する。
味方・敵ともに同じ `BattleIconUI` コンポーネントを使用するが、サイズ決定方式と配置方式が異なる。

| 項目 | 味方 | 敵 |
|------|------|-----|
| **サイズ方式** | 固定（RectTransformで固定） | 可変（スプライトのピクセルサイズそのまま） |
| **画像規格** | 476 x 722 px 統一 | 規格なし（画像サイズがそのまま表示サイズ） |
| **配置方式** | 固定3スロット | ランダム配置（衝突回避あり） |
| **生成方式** | シーン上に事前配置 | プレハブから動的インスタンス化 |
| **HPバー** | あり（アイコン幅 × ratio） | あり（アイコン幅 × ratio） |

---

## 共通コンポーネント: BattleIconUI

味方・敵の両方で使用される共通UIコンポーネント。

**ファイル**: `Assets/Script/EYEAREA_UI/BattleIconUI.cs`

### 主要プロパティ

| フィールド | 型 | 説明 |
|-----------|-----|------|
| HPBar | CombinedStatesBar | HP/MentalHPバー |
| Icon | Image | アイコン画像 |
| verticalBob | UIVerticalBob | 縦揺れアニメ用 |
| arrowGrowAndVanish | ArrowGrowAndVanish | 矢印エフェクト |
| numberEffect | IconButtonLinkNumberEffect | 番号エフェクト |

### 子オブジェクト構成

各BattleIconUIは以下の子要素を持つ:

| 子オブジェクト | 説明 |
|--------------|------|
| Icon | キャラクタースプライト画像（Image + UIVerticalBob） |
| HPBar_testAlly | HP/メンタルHPバー（CombinedStatesBar） |
| SystemArrow | 先鋒矢印エフェクト |
| NumberTop/Bottom/Left/Right | ダメージ数値表示（4方向） |

### HPバーサイズ

HPバーのサイズはアイコンの幅を基準に計算される（味方・敵共通）:

| 項目 | 計算式 | デフォルト |
|------|--------|-----------|
| バー幅 | アイコン幅 × `HpBarSizeRatio.x` | × 1.0 |
| バー高 | アイコン幅 × `HpBarSizeRatio.y` | × 0.15 |
| 縦間隔 | バー高 × 0.5 | — |

---

## 味方アイコン

### 画像規格

| 項目 | 値 |
|------|-----|
| **推奨サイズ** | 476 x 722 px |
| **アスペクト比** | 約 0.66:1 (縦長) |
| **ファイル形式** | PNG (透過対応) |
| **Texture Type** | Sprite (2D and UI) |

### 設定例

現在のオリジナルメンバーアイコン:
- `charactorIcon.png` - 476 x 722 px
- `geino.png` - 476 x 722 px
- `normlia.png` - 476 x 722 px

全て同一サイズで統一されている。

### サイズ決定方式

味方アイコンは**動的リサイズなし**。シーン上のRectTransformで固定されている。

- 親GameObjectのsizeDelta: **100 x 100**（配置アンカー）
- 実際のIcon子要素: **169.52 x 257.14**（親からはみ出して表示）
- スプライトを差し替えてもサイズは変わらない

### キャラクター設定

#### AllyClass での設定

バトルアイコンスプライトは `AllyClass` で管理する。

**ファイル**: `Assets/Script/Players/Runtime/AllyClass.cs`

```csharp
[Header("バトルアイコン")]
[Tooltip("戦闘中に表示するキャラクターアイコン（規格: 476 x 722 px）")]
[SerializeField] private Sprite _battleIconSprite;

/// <summary>
/// バトルアイコンスプライトを取得する
/// </summary>
public Sprite BattleIconSprite => _battleIconSprite;
```

#### 設定手順

1. **スプライト画像を準備**
   - 476 x 722 px のPNG画像を作成
   - `Assets/` 以下の適切なフォルダに配置

2. **Texture Import設定**
   - Inspector で `Texture Type` を `Sprite (2D and UI)` に設定
   - `Sprite Mode` は `Single`
   - `Pixels Per Unit` は `100` (デフォルト)

3. **AllyClassテンプレートに設定**
   - キャラクターの AllyClass プレハブ/アセットを開く
   - `Battle Icon Sprite` フィールドにスプライトをドラッグ&ドロップ

4. **DeepCopyでの複製**
   - ゲーム実行時、テンプレートから `DeepCopyTo()` で複製される際に
   - `_battleIconSprite` も参照コピーされる

### UI配置システム

#### スロット構成

```
┌──────────────┬──────────────┬──────────────┐
│     Left     │    Center    │    Right     │
│   (Slot 0)   │   (Slot 1)   │   (Slot 2)   │
│              │              │              │
│   Sites      │    Geino     │   Normlia    │
│  (固定位置)   │   (固定位置)  │   (固定位置)  │
└──────────────┴──────────────┴──────────────┘
```

#### オリジナルメンバー固定位置

| キャラクター | CharacterId | 固定スロット |
|-------------|-------------|-------------|
| Sites | `Sites` | Left (0) |
| Geino | `Geino` | Center (1) |
| Normlia | `Normlia` | Right (2) |

#### 新メンバーの配置ルール

1. オリジナルメンバーは常に固定位置に配置される
2. 新メンバーは空いているスロットに左から順に配置される
3. パーティは最大3人まで

#### 配置例

**例1: オリジナル3人**
```
パーティ: [Geino, Normlia, Sites]
結果: Left=Sites, Center=Geino, Right=Normlia
```

**例2: Normliaが抜けて新メンバーA**
```
パーティ: [Geino, NewMemberA, Sites]
結果: Left=Sites, Center=Geino, Right=NewMemberA
```

**例3: 全員新メンバー**
```
パーティ: [NewA, NewB, NewC]
結果: Left=NewA, Center=NewB, Right=NewC
```

### シーン上の配置

```
AlwaysCanvas
└── EyeArea
    └── ViewportArea
        └── FrontFixedContainer
            └── BattleContent
                └── Charas
                    ├── LeftBattleIcon
                    ├── CenterBattleIcon
                    └── RightBattleIcon
```

#### RectTransform設定

全スロット共通:

| プロパティ | 値 |
|-----------|-----|
| Anchor Min | (0.5, 0.5) |
| Anchor Max | (0.5, 0.5) |
| Pivot | (0.5, 0.5) |
| Size Delta | 100 x 100 |

各スロットの位置:

| スロット | Anchored Position |
|---------|-------------------|
| Left | (-135.32, 14.36) |
| Center | (96.0, 14.36) |
| Right | (324.36, 36.90) |

#### PlayersUIRefsでの参照

**ファイル**: `Assets/Script/Players/UI/PlayersUIRefs.cs`

```csharp
[Header("バトルアイコンUIスロット")]
[Tooltip("スロット順: Left(0), Center(1), Right(2)")]
public BattleIconUI[] BattleIconSlots = new BattleIconUI[3];
```

Inspector で3つのBattleIconUIを順番に登録:
- Element 0: LeftBattleIcon
- Element 1: CenterBattleIcon
- Element 2: RightBattleIcon

---

## 敵アイコン

### 画像規格

| 項目 | 値 |
|------|-----|
| **推奨サイズ** | 規格なし（自由） |
| **サイズ反映** | スプライトのピクセルサイズがそのまま表示サイズになる |
| **ファイル形式** | PNG (透過対応) |
| **Texture Type** | Sprite (2D and UI) |

敵画像はサイズを統一しない設計方針。小さい敵は小さい画像、大きい敵は大きい画像を用意することで、見た目のサイズ差を自然に表現する。

### サイズ決定方式

敵アイコンは**スプライトのピクセルサイズに基づいて動的にリサイズ**される。

**ファイル**: `Assets/Script/EyeArea/EnemyPlacementController.cs`

```csharp
var iconRT = (RectTransform)uiInstance.Icon.transform;
if (uiInstance.Icon.sprite != null)
{
    iconRT.sizeDelta = uiInstance.Icon.sprite.rect.size;  // スプライトのピクセルサイズそのまま
    uiInstance.Icon.SetNativeSize();                      // ネイティブサイズ適用
    uiInstance.Icon.enabled = true;
}
else
{
    iconRT.sizeDelta = new Vector2(100f, 100f);           // フォールバック: 100x100
}
```

例: 200x300 pxの敵画像 → 200x300で表示、500x400 pxの敵画像 → 500x400で表示。

### キャラクター設定

#### NormalEnemy での設定

敵グラフィックスプライトは `NormalEnemy` で管理する。

**ファイル**: `Assets/Script/Enemy/NormalEnemy.cs`

```csharp
/// <summary>
/// 敵グラフィック画像（メインの敵画像）
/// </summary>
public Sprite EnemyGraphicSprite;
```

DeepCopy時に `clone.EnemyGraphicSprite = this.EnemyGraphicSprite;` で参照コピーされる。

### UI配置システム

#### 配置エリア

```
AlwaysCanvas
└── EyeArea
    └── ViewportArea
        └── ZoomFrontContainer
            └── BattleContent
                └── EnemyArea          ← 敵配置エリア (880.57 x 719.78)
                    ├── (動的生成) Enemy1
                    ├── (動的生成) Enemy2
                    └── ...
```

敵アイコンは `enemyUIPrefab` から動的にインスタンス化され、`EnemyArea` の子として配置される。

#### ランダム配置ロジック

- `EnemyArea` の矩形内にランダムな位置を生成
- 既存の敵アイコンとの**衝突回避**あり（`Rect.Overlaps` で判定）
- 最大50回試行し、重ならない位置を探す（失敗時はエリア中央にフォールバック）
- 衝突判定サイズ = アイコン + HPバー + 縦間隔 + マージン

#### 配置設定 (EnemyPlacementConfig)

**ファイル**: `Assets/Script/EyeArea/EnemyPlacementConfig.cs`

| フィールド | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| BattleLayer | Transform | — | 敵配置レイヤー |
| EnemyUIPrefab | BattleIconUI | — | 敵UIプレハブ |
| SpawnArea | RectTransform | — | ランダム配置エリア |
| HpBarSizeRatio | Vector2 | (1.0, 0.15) | HPバーサイズ比（x: 幅, y: 高さ） |
| Margin | float | 10 | 衝突回避マージン(px) |
| ThrottleSpawns | bool | true | フレーム分散生成 |
| SpawnBatchSize | int | 2 | 1フレームあたり生成数 |
| SpawnInterBatchFrames | int | 1 | バッチ間待機フレーム数 |
| EnableVerboseLogs | bool | false | デバッグログ出力 |

---

## レイヤー構造

味方と敵は異なるレイヤーに配置され、奥行き感を演出する。

```
ViewportArea (EyeAreaToggle: 4レイヤー管理)
├── ZoomBackContainer      ← 背景レイヤー
├── MiddleFixedContainer   ← 中間レイヤー（ActionMark等）
├── ZoomFrontContainer     ← 前景レイヤー（敵アイコン）
└── FrontFixedContainer    ← 最前面レイヤー（味方アイコン）
```

- **味方**: `FrontFixedContainer` に配置（ズーム非連動、固定位置）
- **敵**: `ZoomFrontContainer` に配置（ズーム連動）

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `Assets/Script/EYEAREA_UI/BattleIconUI.cs` | バトルアイコンUIコンポーネント（味方・敵共通） |
| `Assets/Script/Players/Runtime/AllyClass.cs` | 味方バトルアイコンスプライト保持 |
| `Assets/Script/Players/PlayersRuntime.cs` | PartyUISlotManager（味方スロット配置管理） |
| `Assets/Script/Players/UI/PlayersUIRefs.cs` | BattleIconSlots参照 |
| `Assets/Script/Enemy/NormalEnemy.cs` | 敵グラフィックスプライト保持 |
| `Assets/Script/EyeArea/EnemyPlacementController.cs` | 敵アイコン配置・サイズ設定 |
| `Assets/Script/EyeArea/EnemyPlacementConfig.cs` | 敵配置設定 |
| `Assets/Script/WatchUIUpdate.cs` | バトルUI統合管理（敵配置設定の注入元） |

---

## チェックリスト

### 新味方キャラクター追加時

1. [ ] 476 x 722 px のアイコン画像を作成
2. [ ] Texture TypeをSprite (2D and UI)に設定
3. [ ] AllyClassテンプレートの `_battleIconSprite` に設定
4. [ ] （オリジナルメンバーの場合）PartyUISlotManagerに固定位置を追加

### 新敵キャラクター追加時

1. [ ] 任意サイズの敵画像を作成（サイズ＝表示サイズ）
2. [ ] Texture TypeをSprite (2D and UI)に設定
3. [ ] NormalEnemyの `EnemyGraphicSprite` に設定
