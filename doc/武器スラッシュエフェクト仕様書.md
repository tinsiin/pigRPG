# 武器スラッシュエフェクト仕様書

## 概要

武器攻撃時に画面上にランダムな折れ線を描画する斬撃エフェクト。
6フレームの短いアニメーションで、線の太さが「細→太→細」と変化し、稲妻のような閃光として見える。

anoyo の攻撃エフェクト（LINE_ANIMATION_SPEC.md）を参考に、pigRPG のバトルシステムに統合したもの。

---

## 発動条件

| 条件 | 詳細 |
|------|------|
| 陣営 | **味方のみ**（敵の攻撃では発動しない） |
| 武器種別 | **刃物武器のみ**（`IsBlade == true`） |
| スキル種別 | **武器スキル** または **掛け合わせスキル** |

### 判定ロジック（`SkillExecutor.TryPlayWeaponSlash()`）

```
1. ActerFaction が Ally でなければ → 不発動
2. NowUseWeapon が null、または IsBlade が false なら → 不発動
3. スキルが以下のいずれかか判定:
   a. 武器スキル: ReferenceEquals(skill, weapon.WeaponSkill)
   b. 掛け合わせスキル: weapon.CombinationEntries 内に skill と一致するものがある
4. いずれでもなければ → 不発動
5. ターゲット位置を収集 → 1つもなければ → 不発動
6. WeaponSlashAnimator.PlayAsync() を fire-and-forget で起動
```

### 他のエフェクトとの関係

スラッシュは3スロットスキルエフェクト（CasterEffectName / TargetEffectName / FieldEffectName）とは**独立**。
同じフレームで両方が発火する:

```
SkillExecutor.SkillACT()
  ├── TryPlayWeaponSlash(skill)       ← 武器スラッシュ（条件付き）
  ├── PlaySkillVisualEffects(skill)    ← 3スロットエフェクト
  └── ResolveSkillEffectsAsync(...)    ← ダメージ計算等
```

スラッシュはあくまで「武器が振られた」ことの基本演出であり、スキルエフェクトは「スキルの効果」の演出。両者は共存する。

---

## 設定

### BaseWeapon フィールド（武器ごと）

| フィールド | 型 | デフォルト | 説明 |
|-----------|-----|----------|------|
| `SlashColor` | `Color` | `Color.white` | スラッシュの色。武器ごとにインスペクタで設定 |

色の例:
- 白（デフォルト / フリーハンド）
- 赤系（暴断系の武器）
- 青系（ヴォ流転系の武器）
- 任意の色を自由に設定可能

### PlayersUIRefs フィールド（味方共通）

| フィールド | 型 | 範囲 | デフォルト | 説明 |
|-----------|-----|------|----------|------|
| `WeaponSlashScale` | `float` | 0.5 ~ 3.0 | 1.0 | 表示倍率。RawImage の localScale に適用。テクスチャ内容（バウンディングボックス・太さ・ポリライン）は変化しない |
| `WeaponSlashSpeed` | `float` | 0.05 ~ 1.0 | 1.0 | 速度。1.0 = 最速（1フレーム間隔）、値が小さいほどゆっくり |

#### スケール動作

RawImage 自体の表示サイズを拡大する方式。テクスチャ座標空間（360×360）の中身は一切変わらないため、バウンディングボックスやターゲット追従ロジックに影響しない。ViewportArea からはみ出した部分はゲーム画面外で自然にクリップされる。

#### 速度の目安

| スライダー値 | フレーム間隔 | 6セグメント合計 | 体感 |
|------------|------------|---------------|------|
| 1.0 | 1フレーム (~17ms) | ~100ms | 最速（デフォルト） |
| 0.5 | 2フレーム (~33ms) | ~200ms | やや遅い |
| 0.25 | 4フレーム (~67ms) | ~400ms | ゆっくり |
| 0.1 | 10フレーム (~167ms) | ~1秒 | かなりゆっくり |
| 0.05 | 20フレーム (~333ms) | ~2秒 | 非常にゆっくり |

---

## アニメーション仕様

### 基本パラメータ

| 項目 | 値 |
|------|-----|
| テクスチャサイズ | 360 x 360 px |
| フレーム数 | 6 |
| フレーム間隔 | WeaponSlashSpeed 依存（デフォルト: 1フレーム ~16.6ms @60fps） |
| 合計時間 | WeaponSlashSpeed 依存（デフォルト: ~100ms @60fps） |
| ポリライン頂点数 | 7点（P0～P6 → 6本のセグメント） |
| 描画方式 | Bresenham + 円充填（太線） |
| 背景 | 透明（RawImage の UI シェーダーでアルファブレンド） |
| テクスチャフィルタ | Point（ピクセル感を保持、レトロ調） |

### 太さベルカーブ（anoyo 準拠）

```
フレーム  太さ範囲(px)  計算式           印象
  0       1 - 3       Random(3) + 1   細い（導入）
  1       5 - 12      Random(8) + 5   中太
  2       8 - 20      Random(13) + 8  最も太い（ピーク）
  3       5 - 13      Random(9) + 5   やや太い
  4       3 - 8       Random(6) + 3   中細
  5       1 - 3       Random(3) + 1   細い（収束）
```

太さが「細→太→細」のベルカーブを描くことで、「斬撃の勢いが増してから収まる」感覚を表現。

### 見え方

```
フレーム0: P0 ──→ P1  (細い線が一瞬表示 → 消える)
フレーム1: P1 ──→ P2  (中太の線が一瞬表示 → 消える)
フレーム2: P2 ──→ P3  (最も太い線が一瞬表示 → 消える)
フレーム3: P3 ──→ P4  (やや太い線が一瞬表示 → 消える)
フレーム4: P4 ──→ P5  (中細の線が一瞬表示 → 消える)
フレーム5: P5 ──→ P6  (細い線が一瞬表示 → 消える)
```

各フレームで **1本の線分だけが一瞬表示されて消える**。
6本の線分は連結されている（前のフレームの終点 = 次のフレームの始点）が、同時に画面上に存在することはない。
全体として「画面上をランダムに走る稲妻のような閃光」に見える。

---

## ターゲット指向

### ポリライン生成アルゴリズム

1. 全ターゲットの BattleIconUI の RectTransform 位置を、ViewportArea のローカル座標で取得
2. ローカル座標をテクスチャ座標（0～359）に正規化変換
3. ターゲット群のバウンディングボックスを計算
4. パディング（テクスチャの20%、最低50px）を上下左右に追加
5. この範囲内で P0～P6 の7点をランダム生成

### 単体ターゲット vs 複数ターゲット

| 状況 | バウンディングボックス | スラッシュの見え方 |
|------|---------------------|------------------|
| 単体 | 小さい（1点+パディング） | 対象の周辺に集中した斬撃 |
| 複数 | 大きい（全対象を包含） | 対象群を横断する大きな斬撃 |

単体攻撃では密集した鋭いスラッシュ、複数攻撃では薙ぎ払うような広いスラッシュになる。

### 座標変換

```
viewport ローカル座標 → テクスチャ座標:
  Rect vpRect = viewportParent.rect;
  nx = (pos.x - vpRect.xMin) / vpRect.width    // 0～1
  ny = (pos.y - vpRect.yMin) / vpRect.height    // 0～1 (下=0, 上=1)
  tx = nx * (TexSize - 1)                       // 0～359
  ty = ny * (TexSize - 1)                       // 0～359
```

テクスチャの座標系は Texture2D 標準の左下原点。RawImage で ViewportArea 全体にストレッチされるため、テクスチャ座標とビューポート表示が自然に対応する。

---

## レンダリング

### 描画パイプライン

```
WeaponSlashAnimator.PlayAsync()
  1. Texture2D(360x360, RGBA32) を new
  2. GameObject "WeaponSlash" を ViewportArea の子として生成
  3. RawImage コンポーネントでテクスチャを表示
     - anchorMin=(0,0), anchorMax=(1,1) でビューポート全体にストレッチ
     - raycastTarget=false（UI操作を妨げない）
     - filterMode=Point（ピクセル調）
  4. 各フレーム:
     a. SetPixels(clearColors) でテクスチャクリア（透明）
     b. DrawThickLine() で1本の太い線分を描画
     c. texture.Apply() でGPUに転送
     d. UniTask.Yield() で1フレーム待機
  5. 完了後に GameObject と Texture2D を Destroy

※ scale != 1.0 の場合、手順3で rt.localScale = (scale, scale, 1) を適用
※ speed は手順4d のフレーム待ち回数に反映: frameWait = Round(1 / speed)
```

### 太線描画（DrawThickLine）

ShapeDrawer.DrawLineThick と同じアルゴリズム:
- Bresenham のライン走査で中心線の各点を取得
- 各点で `width/2` 半径の塗りつぶし円を描画
- 結果として丸い端を持つ太い線分になる

### クリーンアップ

- `try-finally` で確実に破棄（シーン遷移で途中中断しても安全）
- ループ内で `go == null` チェック（外部からの破棄を検知）

---

## 既存エフェクトシステムとの違い

| 項目 | 既存エフェクト（EffectPlayer） | 武器スラッシュ |
|------|------------------------------|--------------|
| データ形式 | JSON定義ファイル | 手続き的生成（コード） |
| 生成 | 事前定義のフレーム列を再生 | 毎回ランダム生成 |
| テクスチャ | 正方形、ShapeDrawer経由 | 専用360x360、直接描画 |
| 配置 | BattleIconUI子（icon）/ ViewportArea子（field） | ViewportArea子（常にフィールド） |
| 寿命 | 定義フレーム数×interval | 固定6フレーム |
| 管理 | EffectManager が一元管理 | fire-and-forget、自己破棄 |
| 用途 | スキル演出（多様な形状・パターン） | 武器斬撃の基本演出のみ |

武器スラッシュは既存エフェクトシステムを**使わない**。理由:
1. 手続き的ランダム生成が根本的にデータ駆動と合わない
2. 非常に短命（デフォルト ~100ms、速度設定で可変）で EffectPlayer のライフサイクル管理が過剰
3. 武器の色という固有パラメータを外部から注入する必要がある

---

## なぜ刃物武器だけなのか — 設計判断

### 武器エフェクトは刃物のみ。非刃物には武器由来のエフェクトは存在しない。

#### 攻撃表現の3層構造

```
層                        担当                    対象
─────────────────────────────────────────────────────────
1. 被弾表現（点滅）        BattleIconUI            全攻撃共通（実装済み）
2. 武器エフェクト          WeaponSlashAnimator     刃物武器のみ
3. スキルエフェクト         EffectPlayer 3スロット  スキルごとに個別定義
```

- **第1層（被弾点滅）**: ダメージを受けた側のアイコンが点滅する。これが最も根源的な「攻撃が当たった」の表現。全攻撃に共通で、武器・スキルの種類を問わない。詳細: `doc/被弾点滅エフェクト仕様書.md`
- **第2層（武器エフェクト）**: 武器そのものを振るった物理的な演出。**刃物のスラッシュのみ**。
- **第3層（スキルエフェクト）**: スキル固有の演出。CasterEffectName / TargetEffectName / FieldEffectName の3スロットで自由に定義。

#### なぜ非刃物に武器エフェクトを作らないのか

**刃物は「斬る」の一語で表現が統一される。** スラッシュという象徴的なエフェクトは、どの刃物武器にも自然に当てはまり、一目でわかり、爽快で、見飽きないシンプルさがある。刃物武器全体をスラッシュで統一することで、ゲーム内での刃物武器の存在感を際立たせられる。

**非刃物は「振るう」の文脈が広すぎる。** 杖なら魔法を発動するかもしれないし、ある武器はTLOA（超能力）を武器スキルとして内包しているかもしれない。武器スキルの中身が多岐にわたるため、「非刃物武器のエフェクト」を1つに統一することに無理がある。

非刃物武器の攻撃には:
- 被弾点滅（第1層）で「攻撃した」ことは伝わる
- 武器スキルにエフェクトを設定すれば（第3層）、そのスキル固有の演出が出る
- 武器由来の汎用エフェクト（第2層）は**意図的に空白**

仮に非刃物にも専用エフェクトが欲しくなった場合、既存のスキルエフェクトシステム（JSON定義 → EffectPlayer）の方が表現力が高く適切。武器の手続き的生成で対応する必然性がない。

---

## anoyo 版との差異

| 項目 | anoyo 原作 | pigRPG 実装 |
|------|-----------|-------------|
| キャンバスサイズ | 300 x 400 | 360 x 360 |
| フレーム間隔 | Sleep(10) ≈ 10ms | WeaponSlashSpeed 依存（デフォルト: 1フレーム ≈ 16.6ms） |
| 合計時間 | ~60ms | WeaponSlashSpeed 依存（デフォルト ~100ms） |
| ポリライン範囲 | キャンバス全体（完全ランダム） | ターゲットのバウンディングボックス＋パディング |
| 色 | カルマ値依存（マゼンタ/シアン/白）or 固定黄色 | 武器ごとに設定（SlashColor） |
| 描画API | Delphi TCanvas (GDI) | Unity Texture2D.SetPixel |
| 背景復元 | CopyRect で毎フレーム復元 | SetPixels で毎フレームクリア |
| バリエーション | 通常攻撃用 / アイテム攻撃用の2種 | 1種（武器スキル＋掛け合わせ共通） |

---

## ソースファイル

| ファイル | 役割 |
|---------|------|
| `Assets/Script/Battle/WeaponSlash/WeaponSlashAnimator.cs` | スラッシュアニメーション本体（静的クラス） |
| `Assets/Script/BaseWeapon.cs` | `SlashColor` フィールド（武器データモデル） |
| `Assets/Script/Battle/CoreRuntime/SkillExecutor.cs` | `TryPlayWeaponSlash()` 発動判定・位置収集・PlayersUIRefs 参照 |
| `Assets/Script/Players/UI/PlayersUIRefs.cs` | `WeaponSlashScale` / `WeaponSlashSpeed`（味方共通設定） |

### 参照ファイル

| ファイル | 参照内容 |
|---------|---------|
| `Assets/Script/Effects/Integration/EffectManager.cs` | FieldEffectLayer の検索パターンを参照 |
| `Assets/Script/EYEAREA_UI/BattleIconUI.cs` | ターゲット位置の RectTransform 取得元 |
| `Assets/Script/Battle/Core/BattleSession.cs` | `ResolveCombination()` 掛け合わせ解決の流れ |
"C:\フリーゲーム\anoyo\LINE_ANIMATION_SPEC.md"  元アイデア

---

## 将来の拡張候補

| 拡張 | 概要 | 優先度 |
|------|------|--------|
| 複数パターン | ジグザグ以外のパターン（直線斬り、X斬り等） | 低 |
| 効果音連動 | スラッシュに専用SEを付与 | 中 |
| 加算ブレンド | RawImage のマテリアルを加算ブレンドに変更して発光表現 | 低 |
| 太さスケーリング | ターゲット数やスキル威力に応じた太さ倍率 | 低 |
| 残像効果 | 前フレームの線を薄く残して軌跡を表示 | 低 |
