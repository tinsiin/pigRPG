# 精神分散防御仕様書

**ステータス: 実装済み**

物理ダメージの一部を精神HPに分散させる防御メカニクス。
特定の人間状況×精神属性の組み合わせでのみ発動し、十日能力で分散率が決まる。

> 関連仕様書: `doc/スキル計算仕様書.md`, `doc/十日能力・四大ステ成長レンジ想定.md`
> 実装: `MentalDispersalConfig.cs`, `BaseStates.Damage.cs`（ApplyMentalDispersal）

---

## 1. 概要

### コンセプト

「思わず精神で受けてしまう」**非自発的な漏洩**メカニクス。
感情状態（人間状況）が物理と精神の境界を曖昧にし、十日能力という回路の太さに応じてダメージが精神に漏れる。

- 物理→精神への「流れ」を生み出す（従来は完全に並列・独立だった）
- 精神HPが削れやすくなり、**乖離システムとのトレードオフ**が自然に生まれる
- 人間状況×精神属性のスキル選択により、プレイヤーが間接的に活用/回避できる

### 設計方針

| 層 | 役割 | 制御 |
|----|------|------|
| 十日能力（4種） | 回路の太さ（分散率） | 成長で固定。AimStyle・人間状況に依存しない |
| 人間状況 | 漏洩のトリガー（on/off） | 直接制御不能。UIに表示 |
| 精神属性 | 人間状況との組み合わせで発動分岐 | スキル選択で間接制御 |
| テント空洞 | 変換途中の損失（精神変換係数） | 成長で固定 |

---

## 2. 計算式

```
分散率 = min(1.0, (スマイラー×2 + 盥豚×1.4 + 陽炎×1 + 冷酷冷静×1) / 162)
精神分散量 = 物理dmg.Total × 分散率
精神変換係数 = max(0, Random(0.95, 1.0) - テント空洞 × 0.00675)

物理dmg -= 精神分散量
mentalDmg += 精神分散量 × 精神変換係数
```

### 各変数の役割

| 変数 | 意味 | 担当 |
|------|------|------|
| **分散率** | どれだけの物理ダメージを精神に回すか（0〜100%） | 4つの十日能力の重み付き合計 |
| **精神分散量** | 実際に物理から引かれる量 | 分散率 × 残存物理ダメージ |
| **精神変換係数** | 精神に回す途中でどれだけ消えるか（0〜1.0） | テント空洞が下げる |

### パラメータ一覧

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| 正規化定数 | 162 | 4能力×均等30=合計120のとき重み付き合計 (30×2+30×1.4+30×1+30×1)=162 |
| 分散率キャップ | 100% | 下記「100%キャップの設計根拠」参照 |
| 精神変換ベース | Random(0.95, 1.0) | テント空洞なしではほぼ全量が精神に到達（最大5%消失） |
| テント空洞係数 | 0.00675 | テント空洞100(カンスト)で係数≈0.3（7割が虚無に消える） |
| 精神変換下限 | 0 | マイナスにはならない |
| 4能力合計の想定最大 | 120 | 終盤〜やりこみの到達点 |

### 100%キャップの設計根拠

成長しきった状態（4能力合計120）ではDEF超過分が**全て**精神HPに行く。
メリットとデメリットが完全に同居するが、プレイヤーの制御手段があるため問題にならない:

- **メリット**: DEFを超えたダメージが物理HPから精神HPに全部移る = 物理HPを守る防御として完全に機能
- **デメリット**: 精神HPが削れる → 乖離リスク
  - 精神HPに余裕があるとき: 純粋にメリット（物理ダメージを精神で肩代わり）
  - 精神HPが枯渇しかけてるとき: 乖離システムが牙を剥く
- **プレイヤーの制御手段**:
  1. 人間状況（高揚/混乱/辛い）は直接制御不能だが、UIに表示される
  2. 精神属性はスキル選択で間接制御できる
  3. 「今この人間状況だから、対応する精神属性のスキルを使うと分散が起きちゃうな」→ **別のスキルに変える**判断ができる
- → 100%でも「常にフル発動」ではなく、プレイヤーが意図的に活用/回避できる設計

### 精神変換係数の直感

- **1.0**: 物理から精神へそのまま振り替え。トータルダメージ不変
- **0.7**: 精神に回した3割が虚無に消える。物理も精神もダメージ減
- **0.3**: 7割が虚無に消える。テント空洞をカンストした状態。精神分散が実質的な防御能力に

---

## 3. 発動条件

> **注意**: 精神属性は精神HP乖離のしきい値には**直接関与しない**（しきい値は人間状況で決まる）。
> 精神属性が「乖離」に関わるのは別の仕組み — **苦悩システム**（勝利時に乖離スキルばかり使った場合の十日能力低下確率の分岐）。
> したがって「この精神属性は乖離しやすい/しにくい」という議論は精神HP乖離メカニクスとは直接リンクしない。
> 精神分散防御における精神属性の役割は、純粋に**「このタイプのキャラが精神で受けられるか」というロールプレイ的な分岐**として設計する。

### 3.1 人間状況（トリガー）

精神分散は以下の3状態でのみ発動する。係数は全て1.0（量に差を付けない）。
リスクの差は乖離しきい値が担う。

#### 人間状況係数を全て1.0にする根拠

人間状況は精神分散が**起きるかどうかのトリガー**であり、**起きる量の差**は付けない。
リスクの差は乖離しきい値が既に大きく分けている。
量に差をつけると乖離しきい値との二重調整になり複雑化する。
**人間状況 = トリガー（on/off）、乖離しきい値 = リスクの大小**、と層を分離する。

| 人間状況 | 乖離しきい値 | イメージ | リスク |
|---------|------------|---------|-------|
| **高揚** (Elated) | 2.6 | アドレナリンで痛みを感じず精神に流れる。本人は気づいていない | 低（しきい値が遠い） |
| **混乱** (Confused) | 0.3 | 防御が機能せずダメージが精神にダダ漏れ | **極高**（ほぼ即乖離） |
| **辛い** (Painful) | 0.6 | 身体の痛みが精神の苦しみに滲み出す | **高** |

**発動しない人間状況:**

| 人間状況 | 理由 |
|---------|------|
| 覚悟 (Resolved) | 物理で正面から受ける構え。精神に漏れる隙がない |
| 普調 (Normal) | 境界が安定しており漏洩が起きない |
| 楽観的 (Optimistic) | ダメージを深刻に受け止めず「まぁいいか」で流れる |
| 怒り (Angry) | 精神が外向きに爆発。内側への漏洩が阻害される |
| 疑念 (Doubtful) | 精神が疑念で占有され、ダメージを受け入れる余地がない |

### 3.2 精神属性（人間状況ごとの対応）

精神属性はスキル選択でプレイヤーが間接制御できる。
人間状況と精神属性の**組み合わせ**が一致した場合のみ発動する。

| 精神属性 | 対応する人間状況 | 根拠 |
|---------|----------------|------|
| **リーミナルホワイトタイル** | 高揚, 混乱 | 境界が薄い存在。高揚で薄さが加速し無自覚に漏れる。混乱でも当然漏れる |
| **キンダーガーデン** | 混乱 | 幼稚だから混乱すると制御できず散らす |
| **デビル** | 辛い, 高揚 | 熱血かつ悪魔的。辛いと精神にいってしまう。高揚でもズルで精神に行かせる |
| **ゴッドティア** | 高揚 | 圧倒的存在が高揚をきっかけに能動的に起こす |
| **ベールドライヴァル** | 辛い | 激しい性格だからこそ辛いと分散してしまう |

**対応なし（精神分散が発動しない）**: ドレミス, 支柱, 自己犠牲, シークイエスト, サイコパス, none, ムヴォイド, ガルヴァナイズ, エア, メメント

#### 人間状況→精神属性 逆引き

```
高揚   × リーミナルホワイトタイル / デビル / ゴッドティア
混乱   × リーミナルホワイトタイル / キンダーガーデン
辛い   × デビル / ベールドライヴァル
```

### 3.3 プレイヤーの能動的選択

1. UIで自キャラの人間状況を確認（例: 今「高揚」だ）
2. 高揚に対応するスキルの精神属性を選べば分散が発動 → 物理HP温存
3. 精神HPが危険なら、対応しない精神属性のスキルに切り替えて分散を回避
4. 人間状況自体は直接制御不能だが、精神属性はスキル選択で制御可能

---

## 4. 十日能力の詳細

### 4.1 分散率を担う4能力

十日能力は人間状況・精神属性に関わらず**固定の共通計算式**で使用する。
AimStyle排他DEFとは別の側面として、独立に機能する。

| 能力 | 重み | 役割 | ポエム的根拠 |
|------|------|------|-------------|
| **スマイラー** (Smiler) | 2.0 | 原動（主役） | 痛くても笑顔を保つ＝物理ダメージを精神で処理して平気なふり |
| **盥豚** (Taraiton) | 1.4 | 中枢基盤（準主役） | 地味な基礎体術が精神回路の中枢を支える。DEFの裏道 |
| **陽炎** (HeatHaze) | 1.0 | 精神側の補助 | 揺らめいて拡散する。ダメージが物理と精神の間で揺れる |
| **冷酷冷静** (ColdHeartedCalm) | 1.0 | 精神側の補助 | 痛みの信号を感情で処理し精神側に流す制御力 |

**設計判断**: 十日能力は「ハードウェア（回路の太さ）」。人間状況は「今その回路を使えるか（倍率）」。
層の役割を分離するため、人間状況ごとに十日能力を切り替えない。

> **検討した案と却下理由**: 人間状況ごとに担当する十日能力を切り替える案も検討したが、固定とした。
> 人間状況で十日能力も切り替えると、人間状況が能力選択と係数の両方に作用し、層の境界が曖昧になる。
> 十日能力のポエム自体が「十日で理解できる程簡単につなぎとめた能力値」＝ 安定した構造的なもの。
> 感情で切り替わるものではない。
> AimStyle排他DEFとは異なり、精神分散は意識的な「防ぎ方」ではなく非自発的な漏洩なので、
> 防御スタイルに応じた切り替えも不要。

### 4.2 採用しなかった候補と理由

| 候補 | 理由 |
|------|------|
| **水雷神経** | 神経の柔軟さは精神への分散とは文脈が違う。排他DEF3箇所+特殊引用6件で既に忙しい |
| **nightinknight** | DEF共通1.3＋引き締め値。防御の王に更に乗せると万能すぎる |
| **余裕** | Leisureブースト（精神攻撃力加算）でも使用中。役割過多の懸念 |

### 4.3 精神変換係数を担う能力

| 能力 | 効果 | ポエム的根拠 |
|------|------|-------------|
| **テント空洞** (TentVoid) | 精神変換係数を下げる | 虚無値。精神への変換途中でダメージが虚無に吸い込まれて消える |

テント空洞は分散率ではなく精神変換係数に作用する。
分散率＝「精神に回す回路」、精神変換係数＝「回された後に虚無に消える」。

### 4.4 ビルド上の個性

重みに傾斜があるため、能力配分によってビルドの個性が出る:
- **スマイラー特化**: 合計120未満でも分散率100%に到達し得る（重み2.0が効く）
- **陽炎・冷酷冷静に偏った育成**: 同じ合計120でも分散率は100%に届かない
- **テント空洞への投資**: 分散率自体は変わらないが、精神HPへの実着弾が大幅に減る

---

## 5. 乖離システムとの相互作用

精神分散防御の**核心的トレードオフ**。

- **ダウナー乖離**: 精神HP < 物理HP が乖離しきい値を超えると発生
  - TLOAならHP76%化、それ以外は強制ダウナーパッシブ+50%でパワーダウン
- **精神分散で精神HPが削れる** → 物理HPは温存される → ダウナー乖離が起きやすい
- 結果: 「物理的には持ちこたえたが精神が崩壊した」という展開が自然に生まれる

### バランス上の注意点

- パワーレベルHighで精神MaxHPが1.3倍+αのため、High時は分散の余裕が大きい
- 乖離再充填ターン数（テント空洞×3 − ミザ÷4 × スマイラー）との兼ね合い
- 混乱（しきい値0.3）での分散は即座に乖離に直結するため、劇的な崩壊を演出する

---

## 6. 実装詳細

### 6.1 ファイル構成

| ファイル | 役割 |
|---------|------|
| `Assets/Script/Config/MentalDispersalConfig.cs` | 全定数・発動条件テーブル（static class） |
| `Assets/Script/BaseStates/Battle/BaseStates.Damage.cs` | ApplyMentalDispersal メソッド + 呼び出し |

### 6.2 ダメージ補正チェーン内の挿入位置

```
 1. 防ぎ方の切り替え              (SwitchDefenceStyle)
 2. 連続攻撃の物理属性ブースト      (CheckPhysicsConsecutiveAimBoost)
 3. ダメージ直前パッシブ効果        (PassivesOnBeforeDamage)
 4. DEF計算 + 防ぎ方クランプ       (DEF() + ClampDefenseByAimStyle)
 5. 基礎ダメージ計算              (魔法 or 非魔法) → dmg, mentalDmg 並列算出
 6. 山型分布 ±22%乱数             (GetBaseCalcDamageWithPlusMinus22Percent)
 7. 物理耐性                     (ApplyPhysicalResistance)
 8. パッシブ軽減                  (PassivesDamageReductionEffect)
 9. がむしゃらブースト             (GetFrenzyBoost)
10. 慣れ補正                     (AdaptToSkill)
    ── ここまでで純正ダメージ ──
11. 思えのダメージ保存             (ResonanceDmg = dmg)
12. バリアレイヤー                (BarrierLayers)
    ★ 精神分散防御 ★              (ApplyMentalDispersal)
13. 刃物即死クリティカル           (BladeCriticalCalculation)
14. 命中段階                     (HitDmgCalculation)
15. TLOA威力減衰                 (ApplyTLOADamageReduction)
16. 乱れ攻撃スレームパッシブ       (PartySlaimsEasterNoshiirEffect...)
17. 思えのダメージ発生             (ResonanceDamage)
    ── ここから適用 ──
18. HP -= totalDmg
19. 殺せないクランプ              (CantKillSkillClamp)
20. MentalHP -= totalMentalDmg
```

**挿入理由**: バリアレイヤー(12)で吸収された後の残りダメージに対して分散するのが自然。
精神分散で物理dmgが減った後に刃物即死判定(13)が走るため、「分散のおかげで即死を免れたが精神に来た」という展開が生まれる。

### 6.3 戦闘外ダメージ

`Damage()` (戦闘外版) では `DamageOptions.MentalDispersal` フラグで制御（デフォルト: false）。
戦闘版 `DamageOnBattle()` では常に有効。
