# ランダムターン制仕様書

## この仕様書の主題

このゲームの戦闘に**速さステータスは存在しない**。ターン順は完全にランダム。テーマは「想像の加速、混戦」。ボクシングやアニメの戦闘シーンのように、ほぼ同時に殴り合っている世界を、ターン制RPGとして表現する。

行動頻度を制御するのは3つの仕組み:

| 層 | 仕組み | 役割 |
|----|--------|------|
| 第1層 | **ランダム選出** | 誰が来るか分からない（混戦の土台） |
| 第2層 | **リカバリーターン** | 行動後のクールダウン（手数のペース制御） |
| 第3層 | **前のめり** | 自ら前に出て手数を増やす（リスクとリターンの選択） |

---

## 1. ランダム選出

`Battle/CoreRuntime/Services/TurnScheduler.cs:27-74` — `SelectRandomActer()`

### 処理フロー

```
1. 陣営コイントス: _random.NextBool() → 50%で味方 / 50%で敵
2. 選ばれた陣営から:
   a. 死亡キャラを除外 (RemoveDeathCharacters)
   b. リカバリーターン未完了のキャラを除外 (RetainActionableCharacters)
3. 候補が残っていれば、その中から _random.GetItem() でランダムに1人選出
4. 候補がいなければ、もう片方の陣営で同じフィルタを実行
5. 選ばれたキャラの RecovelyWaitStart() を呼び、リカバリーカウンタをリセット
```

### 先約リスト（予約行動）

`Battle/CoreRuntime/TurnExecutor.cs:164-208` — `CharacterAddFromListOrRandom()`

ランダム選出の**前に**、先約リスト（`_context.Acts`）が確認される。割り込みカウンターや反撃など、特定のキャラが次に行動することが確定している場合、ランダム選出をスキップして先約通りに行動する。

```
先約リストにエントリがある → そのキャラが行動（ランダム選出をスキップ）
先約リストが空             → ランダム選出へ
```

先約エントリには以下の情報が含まれる:
- 行動者（Actor）と陣営
- 修飾子（Modifiers）— ATK倍率や命中補正など
- 単体ターゲット指定
- 凍結状態（FreezeConsecutive用）
- カウンターDEFATK

### グローバルターンカウント

`Battle/CoreRuntime/BattleState.cs:5` — `TurnCount`

誰かが行動するたびに `TurnCount` が1増える。このカウントは:
- リカバリーターンの経過計算に使用
- ターン経過イベント（`TurnAdvanced`）の発火に使用

`TurnExecutor.cs:144` の `NextTurn()` 内で `IncrementTurnCount()` が呼ばれる。

---

## 2. リカバリーターン

`BaseStates/Battle/BaseStates.ACTUtility.cs:66-185`

行動後、一定ターン数が経過するまで次のターン候補に入れない仕組み。「行動した後の隙」を表現する。

### 基本パラメータ

```csharp
[SerializeField] private int maxRecoveryTurn;  // キャラごとの基礎クールダウン（インスペクタ設定）
private int recoveryTurn;                        // 現在の蓄積カウント
private int _tmpTurnsToAdd;                      // 一時的な加算（スキルのディレイ等）
private int _tmpTurnsToMinus;                    // 一時的な減算（支援効果等）
```

### 行動可能判定

`RecovelyBattleField(int nowTurn)` — Lines 138-155

```
経過ターン = |現在のグローバルターン - 前回チェック時のターン|

前のめり（Vanguard）なら:
    経過ターン × 2

recoveryTurn += 経過ターン

recoveryTurn >= maxRecoveryTurn + 一時加算 - 一時減算 なら:
    → 行動可能（true）
そうでなければ:
    → まだクールダウン中（false）
```

### 行動後のリセット

`RecovelyWaitStart()` — Lines 159-164

行動が確定したら呼ばれる。カウンタと一時修飾子をすべてリセット。

```
recoveryTurn = 0
一時加算 = 0
一時減算 = 0
```

### 即時行動可能化

`RecovelyOK()` — Lines 182-185

特殊な状況でリカバリーを即完了させる。`recoveryTurn = MaxRecoveryTurn` を直接設定。

### パッシブによる恒久的修飾

`BasePassive.cs:1068-1077` — `MaxRecoveryTurnModifier()`

パッシブスキルが `_maxRecoveryTurnModifier` を持ち、`MaxRecoveryTurn` に加算される。

- 正の値: 行動が遅くなる（クールダウン増加）
- 負の値: 行動が速くなる（クールダウン減少）

```
実効MaxRecoveryTurn = maxRecoveryTurn（基礎値） + Σ(パッシブ補正)
```

### 一時的修飾

| 修飾 | メソッド | 用途 |
|------|---------|------|
| クールダウン加算 | `RecovelyCountTmpAdd(int)` | スキル使用後のディレイ（SkillExecutor:89） |
| クールダウン減算 | `RecovelyTurnTmpMinus(int)` | 支援効果（HelpRecoveryEffect:84） |

`RecovelyCountTmpAdd` は `IsActiveCancelInSkillACT` が true の時は無効（アクティブキャンセル中はディレイ免除）。

---

## 3. 前のめり（Aggressive Commit）

スキル使用時に「前に出る」かどうか。前のめり状態（= Vanguard）になると手数が増えるが、被弾リスクが上がる。

### 交換性 — 前のめりの唯一の力学

**各陣営で前のめり（Vanguard）になれるのは常に1人だけ**。新しいキャラが前のめりになると、今いた前のめりキャラと**入れ替わる**。これが前のめりの核心的な力学であり、以下のすべての戦略はこの「交換」から派生する:

- **壁になる**: 前のめりキャラはテラーズヒットで後衛への攻撃を引き受ける。つまり前に出ること自体が仲間を守る行為
- **壁を奪う**: 自分が前のめりになれば、今いた壁役が後衛に戻される。意図的に壁を剥がすこともできる
- **手数と盾のトレードオフ**: 前のめりは行動頻度2倍だが、今の壁役と入れ替わってしまう

### フェーズ別前のめり設定

`BaseSkill.AggressiveCommit.cs`

スキルには3つのフェーズがあり、それぞれ独立に前のめりのデフォルト状態とプレイヤー選択権を持つ:

```csharp
[Serializable]
public class PhaseAggressiveSetting
{
    public bool isAggressiveCommit;  // デフォルトで前のめりするか（ランタイム状態兼用）
    public bool canSelect;           // プレイヤーがトグルで切り替えられるか
}
```

| フェーズ | フィールド | デフォルト | 説明 |
|---------|-----------|----------|------|
| **スキル実行時** | `AggressiveOnExecute` | `{true, false}` | スキルを撃つ瞬間に前に出るか |
| **トリガーカウント時** | `AggressiveOnTrigger` | `{false, false}` | 発動カウント中に前に出るか |
| **ストック時** | `AggressiveOnStock` | `{false, false}` | スキルストック（攻撃回数蓄積）中に前に出るか |

各フェーズの `canSelect = true` なら、プレイヤーがそのフェーズ用のトグルボタンで ON/OFF を切り替えられる。
`canSelect = false` なら、スキル設計者が決めた `isAggressiveCommit` の値が固定で使われる。

### なぜフェーズ別なのか — RPとしての前のめり

前のめりはシステム上のスイッチであると同時に、**スキルの物語の一部**でもある。各フェーズで「なぜ前に出るのか」の意味が異なるため、フェーズごとに独立した設定を持つ。

**例: スキル「鳩」 — 鳩をけしかける。鳩は僕のえさが好きにすぎないんだ。**

| フェーズ | 前のめり | 物語的意味 |
|---------|---------|----------|
| **ストック中** | ON（固定） | 鳩を集めるために前に出て呼び声を響かせている。同時に仲間をかばっている（交換性） |
| **トリガー中** | ON（選択可） | 鳩が集まりきる前に飛び出す覚悟。敵を惑わせている。あるいは下がって静かに待つ |
| **実行時** | ON（選択可） | 一斉にけしかける。前に出るか、一歩引いて指示だけ出すか |

プレイヤーはスキル説明文・エフェクト・ストーリーから「なぜこのフェーズで前に出るのか」を推理し、戦略と物語の両方を楽しむ。

- ストック中に前のめり固定 → 「あ、鳩を集めるために前に出て、呼び声を聞かせてるんだ」
- 同時にそれは交換性を通じて仲間をかばう行為 → 「呼び声の超能力をしつつ、仲間を守ってるんだ」
- トリガー中に選択可 → 「攻めるか待つか、この局面で前に出る意味があるかどうかはプレイヤーが決める」

この「システム上の一手が物語上の複数の意味を持つ」構造が、前のめりのRP設計の核心。

### 前のめりになるタイミング

| タイミング | 実装箇所 | 条件 |
|-----------|---------|------|
| スキル実行時 | `SkillExecutor.cs:101-108` | `skill.AggressiveOnExecute.isAggressiveCommit` |
| トリガー発動時 | `BattleFlow.cs:255-262` | `skill.AggressiveOnTrigger.isAggressiveCommit` |
| スキルストック時 | `ActionSkipExecutor.cs:14-25` | `skill.AggressiveOnStock.isAggressiveCommit` |
| パッシブ適用時 | `BasePassive.cs:326-329` | `BeVanguardOnApply == true` |

いずれも `BattleManager.BeVanguard(BaseStates)` を呼び出す。

### Vanguard状態の管理

`BattleManager.cs:336-348` — `BeVanguard()`

```
1. TryBlockVanruard() で阻止判定（交代阻止パッシブによる抵抗）
2. 阻止されなければ、そのキャラの陣営の InstantVanguard に設定
3. 前の前のめりキャラがいれば、交換される（後衛に戻る）
4. 視覚エフェクト適用
```

- 各陣営（`BattleGroup`）に `InstantVanguard` は**1人だけ**
- 新しいキャラが前のめりになると、前の前のめりキャラと**交換**される
- 前のめりキャラが死亡すると自動解除（`BattleGroup.VanGuardDeath()`）
- 交代阻止パッシブ（`BlockVanguardSwap`系）を持つキャラは、確率判定で交換を拒否できる

### _tempVanguard（前ターンの状態記録）

`BaseStates.ACTUtility.cs:24-29`

```csharp
public bool _tempVanguard;          // 前ターンで前のめりだったか
public bool IsTempVanguard => _tempVanguard;
```

`TurnExecutor.NextTurn()` で毎ターン更新: `chara._tempVanguard = _context.IsVanguard(chara)`

### プレイヤーの選択UI

各フェーズで `canSelect == true` のスキルには、スキルボタンの近くにそのフェーズ用のトグルボタンが表示される（1スキルにつき最大3つ）。

- `ToggleSingleAndSkillIDHold`: スキルIDと `ToggleSingleController` のペア（`PlayersUIBindings.cs`）
- `AllySkillUILists` に3つのトグルリスト:
  - `aggressiveCommitToggles` — 実行時の前のめりトグル
  - `aggressiveTriggerToggles` — トリガー時の前のめりトグル
  - `aggressiveStockToggles` — ストック時の前のめりトグル
- `PlayersUIService.cs` — UI初期化時にトグルの状態をスキルの各 `PhaseAggressiveSetting` から復元
- `AllyClass.cs` — フェーズ別コールバック:
  - `OnSkillSelectAggressiveCommitBtnCallBack(toggleIndex, skillID)` — 実行時
  - `OnSkillAggressiveTriggerBtnCallBack(toggleIndex, skillID)` — トリガー時
  - `OnSkillAggressiveStockBtnCallBack(toggleIndex, skillID)` — ストック時
- トグルON(0) = 前のめりする、トグルOFF(1) = そのまま

### 命中ペナルティの公平性ゲート

`BaseStates.ReactionSkill.cs:55-63`

後衛からの攻撃には命中ペナルティが課されるが、**実行フェーズの前のめりを選択できるスキル（`AggressiveOnExecute.canSelect == true`）でのみ**適用される。

- 選択権がある → 「自分で後衛にいることを選んだ」→ ペナルティは公平
- 選択権がない → 「スキルの性質上、後衛にいるしかない」→ ペナルティなし（DontMove性の担保）

---

## 4. 前のめりの効果

### 利点

| 効果 | 実装箇所 | 詳細 |
|------|---------|------|
| **リカバリーターン2倍速** | `ACTUtility.cs:140-145` | 経過ターン×2でカウント → より頻繁に行動可能 |
| **命中ペナルティ免除** | `ReactionSkill.cs:55-63` | 非前のめり時、`AggressiveOnExecute.canSelect`なスキルは敵AGI×0.2分の命中低下。前のめりなら免除 |

### 欠点

| 効果 | 実装箇所 | 詳細 |
|------|---------|------|
| **回避率半減** | `StatesNumber.cs:525-528` | AGI（回避）が1/2に。被弾しやすくなる |
| **爆発型スキルのかすり** | `StatesNumber.cs:144-164` | 爆発型スキルに対して、完全回避がかすりに変換される（AGI差による例外あり） |
| **テラーズヒット対象** | `TargetingService.cs:268-272` | 後衛を狙った攻撃が前のめりキャラに吸い寄せられる |

### テラーズヒットの判定

`TargetingService.cs:443-450` — `ComparePressureAndRedirect()`

敵が後衛を狙った時、前のめりキャラの**威光（Glory）**と、攻撃者の**ジョー歯 + 水雷神経×0.5**を比較する確率判定。

```
前のめりキャラの威光 vs 攻撃者の(ジョー歯 + 水雷神経×0.5)

判定: 威光 > random(0 〜 威光+攻撃者耐性) → テラーズヒット発動
  → 攻撃が前のめりキャラにリダイレクトされる（後衛を守る）
```

威光が高いキャラほど後衛への攻撃を引き受けやすい。攻撃者のジョー歯と水雷神経が高ければ、テラーズヒットを突破して後衛を直接狙える。

### 爆発型スキルとの相互作用

`BaseStates.StatesNumber.cs:144-164`

爆発型（Explosion）スキルが前のめりキャラに当たる場合、通常なら完全回避できるところが**かすり**に変換される。ただし例外あり:

| 条件 | 結果 |
|------|------|
| 防御者AGI ≧ 攻撃者AGI × 3 | 84%の確率で完全回避維持 |
| 防御者AGI ≧ 攻撃者AGI × 1.6 | 50%の確率で完全回避維持 |
| それ以外 | かすりに変換 |

---

## 5. 3層構造の相互作用

### 行動頻度の決定フロー

```
キャラが行動する
    ↓
RecovelyWaitStart() → カウンタ = 0
    ↓
毎ターン、SelectRandomActer() が呼ばれるたびに:
    ↓
RecovelyBattleField() で判定:
    経過ターン = グローバルターン差分
    前のめりなら × 2
    カウンタ += 経過ターン
    カウンタ >= MaxRecoveryTurn + 一時加算 - 一時減算 ?
        ↓ YES
    候補プールに入る → ランダム選出の対象になる
        ↓ NO
    まだクールダウン中 → スキップ
```

### 前のめりが全体に与える影響

```
前のめりON:
  ├─ リカバリー2倍速 → より頻繁に行動
  ├─ 回避半減 → 被弾増加
  │   └─ 被弾増加 → AimStyle自動防御の重要性UP
  │       └─ 引き締め値が高いキャラは前のめり向き
  ├─ 命中ペナルティ免除 → 攻撃が当たりやすい
  ├─ テラーズヒット → 後衛を守れる（タンク役）
  └─ 爆発かすり → 範囲攻撃に対して脆い

前のめりOFF:
  ├─ リカバリー通常速度 → 行動頻度は普通
  ├─ 回避通常 → 安全
  ├─ 命中ペナルティあり（AggressiveOnExecute.canSelect=trueのスキル限定）
  └─ テラーズヒット対象外 → 後衛は守れない
```

### キャラビルドとの関係

| キャラタイプ | 前のめり | リカバリー基礎値 | パッシブ | 適性 |
|------------|---------|----------------|---------|------|
| 前衛アタッカー | ON多め | 低め | リカバリー減算系 | 手数で押す、引き締め値が高いと安定 |
| タンク | ON常時 | 低め | リカバリー減算系 | 威光が高く、テラーズヒットで後衛を守る |
| 後衛サポート | OFF多め | 高め | 状況次第 | 安全圏から支援、たまに前に出る |

---

## 6. 設計思想

### なぜ速さステータスがないのか

従来のRPG素早さの問題:
- 素早さが高い → 先手を取れる → ノーリスクで有利 → 育て得
- ターン順が固定的 → 展開が予測可能 → 戦術が硬直化

このゲームの解決:
- **ランダム選出** → 誰が来るか分からない緊張感
- **前のめり** → 手数を増やすにはリスクが必要（速さのノーリスク性を排除）
- **リカバリーターン** → キャラごとの行動ペースをパッシブ・スキルで差別化

### なぜ防御コマンドがないのか

ランダムターン制では防御コマンドが機能しない:

1. **ランダムターンは攻撃チャンス** — 降ってきたチャンスを防御に使うのは機会の浪費
2. **「次のターンまで」が不定** — 次に自分が来るまでに敵が何回行動するか予測不能
3. **味方ターンとの重複** — 自分が防御中に味方のターンが来る。何もせず見てるだけ
4. **AimStyle自動防御** — 狙い流れは神経反応であり、防御は自動で処理される
5. **パッシブで代替可能** — ターン数指定・行動非消費・キャラ固有の防御表現が可能

詳細は `doc/防御行動の議論と結論_防御行動の演出について.md` 参照。

---

## 7. 実装状況

### 実装済み

| 機能 | 実装場所 |
|------|---------|
| ランダム陣営選出 | `TurnScheduler.cs:27-74` |
| リカバリーターン判定 | `BaseStates.ACTUtility.cs:138-155` |
| リカバリーリセット | `BaseStates.ACTUtility.cs:159-164` |
| 一時加算/減算 | `BaseStates.ACTUtility.cs:121-134` |
| パッシブによるリカバリー補正 | `BasePassive.cs:1068-1077` |
| 前のめり状態管理 | `BattleManager.cs:336-348` |
| フェーズ別前のめり設定（PhaseAggressiveSetting） | `BaseSkill.AggressiveCommit.cs` |
| 前のめりスキル実行 | `SkillExecutor.cs:101-108` |
| 前のめりトリガー発動 | `BattleFlow.cs:255-262` |
| 前のめりスキルストック | `ActionSkipExecutor.cs:14-25` |
| 前のめりパッシブ適用 | `BasePassive.cs:326-329` |
| 回避率半減 | `BaseStates.StatesNumber.cs:525-528` |
| 命中ペナルティ/公平性ゲート | `BaseStates.ReactionSkill.cs:55-63` |
| テラーズヒット | `TargetingService.cs:268-272, 443-450` |
| 爆発かすり変換 | `BaseStates.StatesNumber.cs:144-164` |
| 前のめりトグルボタンUI（3フェーズ対応） | `PlayersUIService.cs`, `PlayersUIBindings.cs`, `AllyClass.cs` |
| 先約リスト | `TurnExecutor.cs:164-208` |
| グローバルターンカウント | `BattleState.cs:5`, `TurnExecutor.cs:144` |
| 前のめり死亡時解除 | `BattleGroup.cs:83-90` |

---

## 8. 関連ファイル

| ファイル | 役割 |
|---------|------|
| `TurnScheduler.cs` | ランダム選出ロジック |
| `TurnExecutor.cs` | ターン実行、先約リスト、NextTurn |
| `BaseStates.ACTUtility.cs` | リカバリーターン、_tempVanguard |
| `BattleManager.cs` | BeVanguard、IsVanguard、TryBlockVanruard |
| `BattleGroup.cs` | InstantVanguard、VanGuardDeath |
| `BaseSkill.AggressiveCommit.cs` | PhaseAggressiveSetting定義、フェーズ別前のめり設定 |
| `SkillExecutor.cs` | スキル実行時の前のめり適用 |
| `BattleFlow.cs` | トリガー発動時の前のめり適用 |
| `ActionSkipExecutor.cs` | スキルストック時の前のめり適用 |
| `TargetingService.cs` | テラーズヒット判定 |
| `BaseStates.StatesNumber.cs` | 回避半減、爆発かすり変換 |
| `BaseStates.ReactionSkill.cs` | 命中ペナルティ/免除 |
| `PlayersUIService.cs` | 前のめりトグルボタン初期化（3フェーズ対応） |
| `PlayersUIBindings.cs` | トグルリスト定義（実行/トリガー/ストック） |
| `AllyClass.cs` | 前のめり選択コールバック（3フェーズ分） |
| `BattleState.cs` | グローバルターンカウント |

---

## 9. 設計メモへのリンク

| メモファイル | 内容 |
|------------|------|
| `前のめり.md` | 前のめり仕様一覧、トグルボタンUI、DontMove性の担保 |
| `豚争い.md` | テーマ「想像の加速、混戦」 |
| `防御行動の議論と結論_防御行動の演出について.md` | 防御コマンド不要の議論と結論 |
