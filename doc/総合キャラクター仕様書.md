# 総合キャラクター仕様書

本書はキャラクター（`BaseStates`）が持つ属性・状態・システムの全容をまとめたもの。ダメージ計算式やATK/DEF/EYE/AGI係数の詳細は既存仕様書を参照。

関連仕様書:
- `doc/スキル計算仕様書.md` — 四大ステ計算式、SkillPower、ダメージ補正チェーン、命中/回避
- `doc/戦闘規格・狙い流れ仕様書.md` — BattleProtocol/AimStyle、排他ATK/DEF係数テーブル
- `doc/パーティ属性仕様書.md` — パーティー属性の決定ロジック
- `doc/総合戦闘仕様書.md` — パワーレベル影響、前のめり、慣れ補正、互角一撃、ハイネスチャンス等

---

## キャラクターの構成

`BaseStates` は abstract partial class で、多数のpartialファイルに分割されている。

| partialファイル | 役割 |
|---|---|
| `BaseStates.cs` | コア定義（名前、種別、精神属性、依存注入） |
| `BaseStates.StatesNumber.cs` | HP、精神HP、四大ステ、物理属性耐性 |
| `BaseStates.StatesState.cs` | パワーレベル、人間状況、列挙体定義 |
| `BaseStates.WeaponManager.cs` | 武器管理、戦闘規格、適応ラグ |
| `BaseStates.SkillManager.cs` | スキルリスト、連続使用追跡 |
| `BaseStates.PassiveManager.cs` | パッシブ管理 |
| `BaseStates.VitalLayerManager.cs` | VitalLayer(追加HP)管理 |
| `BaseStates.ACTUtility.cs` | リカバリターン、行動準備判定 |
| `BaseStates.CallBack.cs` | 死亡コールバック、戦闘終了処理 |
| `BaseStates.HitCalc.cs` | 命中凌駕（→総合戦闘仕様書） |
| `BaseStates.Damage.cs` | ダメージ計算（→スキル計算仕様書） |
| `BaseStates.ReactionSkill.cs` | スキルへの反応処理、フロー数字トリガー |
| `BaseStates.AdaptToSkill.cs` | 慣れ補正（→総合戦闘仕様書） |
| `BaseStates.BattleEvent.cs` | 互角一撃、刃物即死生存、乖離、オーバーキル（→総合戦闘仕様書） |

---

## アイデンティティ

| フィールド | 型 | 説明 |
|---|---|---|
| `CharacterName` | string | キャラクター名。ログ・UI表示に使用 |
| `Description` | string | キャラクター説明文 |
| `ImpressionStringName` | string | 印象名（表示用別名） |
| `MyType` | CharacterType | 種別（後述） |
| `DefaultImpression` | SpiritualProperty | デフォルト精神属性（固定） |
| `MyImpression` | SpiritualProperty | 現在の精神属性 |

---

## 種別（CharacterType）

`[Flags]` ビットフラグ。複数の種別を持てる。

| 値 | 日本語 | 説明 |
|---|---|---|
| `TLOA` (1<<0) | 時限圧倒能力 | 特殊存在。ダメージ式、殺せない制限、TLOA減衰等に影響 |
| `Machine` (1<<1) | 機械 | オーバーキルBroken率33%。精神乖離ダウナー時の挙動が異なる |
| `Life` (1<<2) | 生命 | オーバーキルBroken率93%（攻撃者性質条件あり）。割り込みカウンター反撃が可能 |

`HasCharacterType(CharacterType)` で特定種別の保持を確認。

実装: `BaseStates.StatesState.cs:2942`

---

## 精神属性（SpiritualProperty）

`[Flags]` ビットフラグ。キャラクターの精神的性質。戦闘計算・成長・慣れ補正・互角一撃など多数のシステムに影響する。

| 値 | 日本語 |
|---|---|
| `Doremis` (1<<0) | ドレミス |
| `Pillar` (1<<1) | 支柱 |
| `Kindergarten` (1<<2) | キンダーガーデン |
| `LiminalWhiteTile` (1<<3) | リミナルホワイトタイル |
| `Sacrifaith` (1<<4) | サクリフェイス（自己犠牲） |
| `Cquiest` (1<<5) | シークイエスト |
| `Psycho` (1<<6) | サイコパス |
| `GodTier` (1<<7) | ゴッドティア |
| `BaleDrival` (1<<8) | ベイルドライヴァル |
| `Devil` (1<<9) | デビル |
| `None` (1<<10) | なし |
| `Mvoid` (1<<11) | ムヴォイド |
| `Galvanize` (1<<12) | ガルヴァナイズ |
| `Air` (1<<13) | エア |
| `Memento` (1<<14) | メメント |

精神属性は以下に影響する:
- 精神補正（スキル計算仕様書 4.1-4.2節）
- 慣れ補正のグルーピング方式（総合戦闘仕様書）
- 互角一撃の確率（総合戦闘仕様書）
- ハイネスチャンス確率（総合戦闘仕様書）
- 乖離スキル発生確率（総合戦闘仕様書）
- 死亡時の精神HP変動（後述）
- パーティー属性の決定（パーティ属性仕様書）

実装: `BaseStates.StatesState.cs:2953`

---

## 人間状況（Demeanor）

キャラクターの感情状態。各種判定の確率テーブルに影響する。

| 値 | 日本語 |
|---|---|
| `Painful` | 辛い |
| `Optimistic` | 楽観的 |
| `Elated` | 高揚 |
| `Resolved` | 覚悟 |
| `Angry` | 怒り |
| `Doubtful` | 疑念 |
| `Confused` | 混乱 |
| `Normal` | 普調 |

### 追跡フィールド

| フィールド | 説明 |
|---|---|
| `NowCondition` | 現在の人間状況 |
| `PreviousCondition` | 直前の人間状況 |
| `ConditionConsecutiveTurn` | 同じ状況の連続ターン数 |
| `TotalTurnsInSameCondition` | 累計同一状況ターン数 |

### 変化タイミング

- `ConditionTransition()` — ターン経過による自然遷移
- `ApplyConditionChangeOnDeath()` — 自身が死亡した時
- `ApplyConditionChangeOnCloseAllyDeath()` — 近くの味方が死亡した時

人間状況が影響するシステム:
- 互角一撃の基本確率（総合戦闘仕様書）
- 精神HP乖離の閾値（総合戦闘仕様書）
- オーバーキル余剰ダメージ通過率（総合戦闘仕様書）

実装: `BaseStates.StatesState.cs:2903`, `BaseStates.StatesState.cs:596`

---

## HP・精神HP

### 物理HP

| フィールド | 説明 |
|---|---|
| `HP` | 現在HP（MaxHPでクランプ） |
| `MaxHP` | 最大HP |

HPが0以下で`Death()` = true。UIの `BattleIcon` と同期。

### 精神HP（MentalHP）

| フィールド | 説明 |
|---|---|
| `MentalHP` | 現在の精神HP |
| `MentalMaxHP` | 精神最大HP（パワーレベルで変動） |

#### MentalMaxHP計算

| パワーレベル | MentalMaxHP |
|---|---|
| High | `HP × 1.3 + MaxHP × 0.08` |
| Medium以下 | `HP`（物理HPと同値） |

#### 精神ダメージ倍率（被害者パワー別）

| パワーレベル | 倍率 |
|---|---|
| High | ×1.4 |
| Medium | ×1.0 |
| Low | ×0.7 |
| VeryLow | ×0.4 |

精神HPと物理HPが大きく乖離すると「精神HP乖離」が発生する（→総合戦闘仕様書）。

実装: `BaseStates.StatesNumber.cs:19-200`

### 死亡時の精神HP変動

死亡コールバック(`OnBattleDeathCallBack`)内で精神属性ごとに精神HPが変動する。

| 精神属性 | 死亡時の精神HP |
|---|---|
| LiminalWhiteTile | 変化なし |
| Kindergarten | 100%回復 |
| Sacrifaith | 100%回復 |
| Cquiest | +10% + 元素信仰力/3 |
| Devil | -10% |
| Doremis | 春仮眠/夜暗黒 の比率 |
| Pillar | 80%回復 |
| GodTier | +35% |
| BaleDrival | 70%回復 |
| Psycho | +20% |

実装: `BaseStates.CallBack.cs`

---

## 物理属性耐性

特定の物理属性からのダメージに対する耐性倍率。

| フィールド | 物理属性 | 日本語 |
|---|---|---|
| `HeavyResistance` | heavy | 暴断 |
| `voltenResistance` | volten | ヴォ流転 |
| `DishSmackRsistance` | dishSmack | 床ずれ |

ダメージ補正チェーンの第4段（スキル計算仕様書参照）で適用。武器とスキルの両方が同じ物理属性を持つ場合は×2で適用。

実装: `BaseStates.StatesNumber.cs:206-222`

---

## 十日能力（TenDayAbility）

キャラクターの根幹をなす37種の能力値。ATK/DEF/EYE/AGIはすべて十日能力から算出される。

### 能力一覧

| ID | Key | 日本語 |
|---|---|---|
| 0 | TentVoid | テント空洞 |
| 1 | NightDarkness | 夜暗黒 |
| 2 | SpringWater | 泉水 |
| 3 | StarTersi | 星テルシ |
| 4 | Raincoat | レインコート |
| 5 | WaterThunderNerve | 水雷神経 |
| 6 | ColdHeartedCalm | 冷酷冷静 |
| 7 | NightInkKnight | 引き締め値(nightinknight) |
| 8 | SpringNap | 春仮眠 |
| 9 | Miza | ミザ |
| 10 | Baka | 馬鹿 |
| 11 | Smiler | スマイラー |
| 12 | FaceToHand | 顔から手 |
| 13 | UnextinguishedPath | 未消光の道 |
| 14 | Sort | ソート |
| 15 | HeatHaze | 陽炎 |
| 16 | Vail | ベイル |
| 17 | BlazingFire | 烈火 |
| 18 | FlameBreathingWife | 燃え火吹きウィフ |
| 19 | Glory | 威光 |
| 20 | Rain | 雨 |
| 21 | Leisure | 余裕 |
| 22 | ElementFaithPower | 元素信仰力 |
| 23 | CryoniteQuality | クリオネ質 |
| 24 | Dokumamusi | ドクマムシ |
| 25 | JoeTeeth | ジョー歯 |
| 26 | Pilmagreatifull | ピルマグレイトフル |
| 27 | Blades | 刃物 |
| 28 | PersonaDivergence | ペルソナ乖離 |
| 29 | SilentTraining | サイレント練度 |
| 30 | HumanKiller | 人殺し人 |
| 31 | Taraiton | 盥豚 |
| 32 | HeavenAndEndWar | 天と終戦 |
| 33 | Enokunagi | エノクナギ |
| 34 | Vond | ヴォンド |
| 35 | KereKere | ケレケレ |
| 36 | Lucky | ラッキー |

### 保持と参照

| フィールド/メソッド | 説明 |
|---|---|
| `_tenDayTemplate` | Inspector編集用テンプレート |
| `_baseTenDayValues` | ランタイム値（テンプレートからコピーして成長する） |
| `TenDayValuesBase()` | 基礎十日能力（武器ボーナス含む） |
| `TenDayValuesForSkill()` | スキル用十日能力（スキルの印象構造を加算） |
| `TenDayValuesSumBase()` | 基礎十日能力の総和 |

### 成長

スキルを使用すると、そのスキルの印象構造（スキル側TenDayValues）分だけキャラの`_baseTenDayValues`が増加する。レベルアップは存在しない。

### 座標システム

各十日能力は2D座標(`Vector2`)を持ち、能力間の「距離」が計算できる。この距離は乖離スキル判定（→総合戦闘仕様書）やスキル成長の減衰に使われる。

実装: `TenDayAbilityManager.cs`, `TenDayAbilityPosition.cs`

---

## 武器

### 構造

| フィールド | 型 | 説明 |
|---|---|---|
| `InitWeaponID` | int | 初期装備武器ID（Inspector設定） |
| `NowUseWeapon` | BaseWeapon | 現在装備中の武器 |
| `NowBattleProtocol` | BattleProtocol | 武器の戦闘規格 |

### WeaponPhysicalProperty（物理属性）

| 値 | 日本語 |
|---|---|
| `heavy` | 暴断 |
| `volten` | ヴォ流転 |
| `dishSmack` | 床ずれ |

AimStyleとの対応は戦闘規格仕様書を参照。

### 武器ボーナス

武器はスキル特性ごとに異なるTenDayAbilityボーナスを持つ:

| ボーナス種 | 適用条件 |
|---|---|
| `NormalData` | 常時 |
| `TLOAData` | スキルがTLOA時のみ |
| `MagicData` | スキルが魔法時のみ |
| `BladeData` | スキルが刃物時のみ |

武器ボーナスはキャラクターのTenDayValuesに加算される（スキルのTenDayValuesには影響しない）。

### 装備条件

`CanEquipWeapon()` — 武器が要求する十日能力値を満たしているか確認。

### 適応ラグ

戦闘規格を切り替えると排他ATKに適応率ペナルティが発生する（→戦闘規格仕様書12節）。

実装: `BaseStates.WeaponManager.cs`

---

## スキル管理

| フィールド | 型 | 説明 |
|---|---|---|
| `SkillList` | IReadOnlyList\<BaseSkill\> | 所持スキル一覧（abstract） |
| `TLOA_SkillList` | List\<BaseSkill\> | TLOAスキルのフィルタ済みリスト |
| `NowUseSkill` | BaseSkill | 今ターンで使用中のスキル |
| `FreezeUseSkill` | BaseSkill | 強制継続中のスキル（連続攻撃途中等） |

### 連続使用追跡

| フィールド | 説明 |
|---|---|
| `DoConsecutiveCount` | 同スキルの連続使用回数 |
| `HitConsecutiveCount` | 同スキルの連続ヒット回数 |

スキルの詳細（SkillPower計算、SkillType、SkillSpecialFlag）は `doc/スキル計算仕様書.md` を参照。

実装: `BaseStates.SkillManager.cs`

---

## リカバリターン

行動後の再行動までのクールダウン。

| フィールド | 説明 |
|---|---|
| `maxRecoveryTurn` | 基礎リカバリターン数（Inspector設定） |
| `MaxRecoveryTurn` | 最終値 = `maxRecoveryTurn + パッシブ補正` |
| `recoveryTurn` | 現在の蓄積リカバリカウンタ |

### 行動準備判定

`RecovelyBattleField(int nowTurn)` — ターン差分だけカウンタを加算し、MaxRecoveryTurnに到達したら行動可能(`true`)を返す。

### 特殊条件

- **前のめり時**: リカバリが2倍速で進行
- **パッシブ**: `PassivesMaxRecoveryTurn()` でMaxRecoveryTurnを増減

実装: `BaseStates.ACTUtility.cs:66-164`

---

## VitalLayer（追加HP / バリア）

ダメージを本体HPより先に吸収するバリアシステム。

| フィールド | 説明 |
|---|---|
| `_vitalLayerList` | アクティブなレイヤーのリスト |
| `InitVitalLaerIDList` | 初期VitalLayer IDリスト |

### 管理メソッド

| メソッド | 説明 |
|---|---|
| `ApplyVitalLayer(id)` | レイヤー追加（既存なら補充）。Priority順にソート |
| `RemoveVitalLayer(id)` | IDで除去 |
| `HasVitalLayer(id)` | 保持確認 |
| `BarrierLayers(ref damage)` | ダメージをPriority順にレイヤーに吸収させる |

### レイヤー破壊時の効果

ダメージ補正チェーン第8番（スキル計算仕様書参照）。

- **暴断(heavy)ダメージ**: 破壊者が +ケレケレ×1.5% のダメージボーナス
- **ヴォ流転(volten)ダメージ**: 破壊者が -(ATK - ケレケレ)×2.2% のダメージペナルティ

実装: `BaseStates.VitalLayerManager.cs`

---

## パッシブ

キャラクターに付与される持続効果。

| フィールド | 説明 |
|---|---|
| `_passiveList` | アクティブなパッシブのリスト |
| `InitpassiveIDList` | 初期パッシブIDリスト |
| `BufferApplyingPassiveList` | バッファ（次ターン適用待ち） |

### 管理メソッド

| メソッド | 説明 |
|---|---|
| `ApplyPassiveByID(id, grantor)` | パッシブ付与（適合条件チェック付き） |
| `ApplyPassiveBufferInBattleByID(id)` | バッファに追加（次ターン開始時に適用） |
| `HasPassive(id)` | 保持確認 |
| `GetPassiveByID(id)` | IDで取得 |
| `CanApplyPassive(passive)` | 種別(OkType)・精神属性(OkImpression)の適合チェック |

### パッシブの効果分類

- ステータス修正（ATK/DEF/EYE/AGI乗算・加算）
- リカバリターン増減
- スキル威力修正
- 生存/復活メカニクス
- 前のめり交代阻止
- 割り込みカウンター（ID:1）
- 強制ダウナー（ID:3）
- アッパー乖離（ID:4）

実装: `BaseStates.PassiveManager.cs`

---

## 死亡・Broken

### 死亡判定

`Death()` — `HP <= 0` で true。virtual のため派生クラスで上書き可能。

### 死亡コールバック

`OnBattleDeathCallBack()` で以下が順に実行される:

1. 連続攻撃のクリア
2. 人間状況の変化（`ApplyConditionChangeOnDeath`）
3. スキルの死亡ハンドラ呼び出し
4. ターゲットボーナスのクリア
5. パッシブによる生存/復活判定
6. 思えの値リセット
7. 精神HPの精神属性別変動（前述の表参照）
8. CalmDownカウンタリセット

`m_BattleDeathProcessed` フラグで1戦闘中に1回だけ実行される。

### Broken（完全破壊）

`broken` (bool) — オーバーキル時に設定される完全破壊フラグ。詳細は総合戦闘仕様書を参照。

実装: `BaseStates.StatesState.cs:2855`, `BaseStates.CallBack.cs`

---

## パーティー属性（PartyProperty）

BattleGroup単位で決定されるパーティー全体の性質。

| 値 | 日本語 | 概要 |
|---|---|---|
| `TrashGroup` | 馬鹿共 | — |
| `HolyGroup` | 聖戦 | 前のめり交代阻止の係数×0.7 |
| `MelaneGroup` | メレーンズ | 王道的 |
| `Odradeks` | オドラデクス | 秩序から離れている |
| `Flowerees` | 花樹 | オサレ |

決定ロジックの詳細は `doc/パーティ属性仕様書.md` を参照。

実装: `BattleGroup.cs:12`

---

## HitResult

攻撃の命中結果。

| 値 | 日本語 | ダメージ倍率 |
|---|---|---|
| `CompleteEvade` | 完全回避 | 0（ダメージなし） |
| `Graze` | かすり | 2%〜35%（EYE差で減衰） |
| `Hit` | 通常ヒット | ×1.0 |
| `Critical` | クリティカル | ×1.5 |
| `none` | 未判定 | — |

命中/回避の計算式は `doc/スキル計算仕様書.md` 8節を参照。

実装: `BaseStates.Damage.cs:1448`

---

## CalmDown（均衡化）

命中/回避のブレを安定させるシステム。

| フィールド | 説明 |
|---|---|
| `CalmDownCount` | 現在のCalmDownカウンタ |
| `CalmDownCountMax` | 最大カウント |

`CalmDownSet()` で初期化、`CalmDownCountDec()` で行動ごとに減算。カウントが残っている間は命中/回避のバラつきが抑えられる。

---

## 思えの値（Resonance Value）

精神的な共鳴を表す値。精神ダメージの分散や人間状況の変化に関連。

- 人間状況変化やスキル使用で変動
- 死亡時にリセットされる
- `ResetResonanceValue()`, `InitializeNowResonanceValue()` で操作
