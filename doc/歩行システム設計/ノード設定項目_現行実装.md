# ノード設定項目（現行実装）

本書はNodeSOおよび関連クラスで**実際に設定可能な項目**をコードベースから調査してまとめたもの。
設計ドキュメントではなく、実装の現状を反映している。

調査日: 2026-01-21

---

## NodeSO（ノード本体）

### 基本情報

| フィールド | 型 | 説明 |
|-----------|-----|------|
| nodeId | string | ノードの一意識別子 |
| displayName | string | 表示名 |
| uiHints | NodeUIHints | UI表示のヒント（後述） |

### サイドオブジェクト関連

| フィールド | 型 | 説明 |
|-----------|-----|------|
| sideObjectTable | SideObjectTableSO | サイドオブジェクトのテーブル |
| fixedSideObjects | FixedSideObjectPair | ノード入場時の固定提示ペア |
| retainUnselectedSide | bool | 未選択側を次歩に保持するか |

### 遭遇関連

| フィールド | 型 | 説明 |
|-----------|-----|------|
| encounterTable | EncounterTableSO | 遭遇テーブル |
| encounterRateMultiplier | float | 遭遇率の乗算補正（デフォルト1） |

### イベント関連

| フィールド | 型 | 説明 |
|-----------|-----|------|
| onEnterEvent | EventDefinitionSO | ノード入場時のイベント |
| onExitEvent | EventDefinitionSO | ノード退出時のイベント |
| centralEvent | EventDefinitionSO | 中央オブジェクトのイベント |
| centralVisual | CentralObjectVisual | 中央オブジェクトの見た目 |

### 出口関連

| フィールド | 型 | 説明 |
|-----------|-----|------|
| exitSpawn | ExitSpawnRule | 出口の出現ルール |
| exits | ExitCandidate[] | 出口候補のリスト |
| exitSelectionMode | ExitSelectionMode | 出口選択モード（ShowAll/WeightedRandom） |
| maxExitChoices | int | 最大表示出口数 |
| exitVisual | ExitVisual | 出口の見た目 |

### 進捗・門関連

| フィールド | 型 | 説明 |
|-----------|-----|------|
| trackConfig | TrackConfig | 内部トラック設定 |
| gates | GateMarker[] | イベント門のリスト |

---

## NodeUIHints（UI表示ヒント）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| useThemeColors | bool | テーマカラーを使用するか |
| frameArtColor | Color | フレームの色 |
| twoColor | Color | 二次色 |
| useActionMarkColor | bool | アクションマーク色を使用するか |
| actionMarkColor | Color | アクションマークの色 |
| backgroundId | string | 背景ID |

---

## TrackConfig（進捗トラック設定）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| length | int | トラックの全長（デフォルト100） |
| stepDelta | int | 1歩あたりの進行量（デフォルト1） |
| progressKey | string | 進捗を保存するカウンターキー |

---

## ExitSpawnRule（出口出現ルール）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| mode | ExitSpawnMode | 出現モード |
| steps | int | Stepsモード時の歩数 |
| rate | float | Probabilityモード時の確率 |
| requireAllGatesCleared | bool | 全門クリア必須か |

### ExitSpawnMode

| 値 | 説明 |
|-----|------|
| None | 出口なし |
| Steps | 指定歩数で出現 |
| Probability | 毎歩確率判定 |

### 重要: 出口位置の計算（ハードル並び設計）

出口の実際位置 = `最大門位置 + steps`

例: 門が30歩、出口設定が100歩 → 実際の出口位置は130歩

---

## ExitCandidate（出口候補）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | string | 出口候補の識別子 |
| toNodeId | string | 遷移先ノードID |
| uiLabel | string | UI表示ラベル |
| weight | int | 重み（WeightedRandom時） |
| conditions | ConditionSO[] | 開放条件 |

---

## ExitVisual（出口の見た目）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| sprite | Sprite | 前面スプライト |
| backSprite | Sprite | 背面スプライト |
| size | Vector2 | サイズ |
| offset | Vector2 | オフセット |
| tint | Color | 前面の色調 |
| backTint | Color | 背面の色調 |
| label | string | ラベル |
| sfxOnAppear | string | 出現時のSFX ID |

---

## GateMarker（イベント門）

### 基本設定

| フィールド | 型 | 説明 |
|-----------|-----|------|
| gateId | string | 門の識別子 |
| order | int | 解決順序（小さい順） |
| positionSpec | GatePositionSpec | 位置指定 |

### イベント・条件

| フィールド | 型 | 説明 |
|-----------|-----|------|
| passConditions | ConditionSO[] | 通過条件 |
| onPass | EffectSO[] | 通過時のEffect |
| onFail | EffectSO[] | 失敗時のEffect |
| gateEvent | EventDefinitionSO | 門のイベント |
| eventTiming | GateEventTiming | イベント発火タイミング |

### 見た目

| フィールド | 型 | 説明 |
|-----------|-----|------|
| visual | GateVisual | 門の見た目 |

### GateEventTiming

| 値 | 説明 |
|-----|------|
| OnAppear | 門出現時 |
| OnPass | 門通過時 |
| OnFail | 門失敗時 |

---

## GatePositionSpec（門位置指定）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| type | PositionType | 位置タイプ |
| absSteps | int | AbsSteps時の絶対歩数 |
| percent | float | Percent時の割合（0〜1） |
| rangeMin | int | Range時の最小値 |
| rangeMax | int | Range時の最大値 |

### PositionType

| 値 | 説明 |
|-----|------|
| AbsSteps | 絶対歩数で固定 |
| Percent | トラック長に対する割合 |
| Range | 入場時にシード付きで範囲内からランダム決定 |

---

## GateVisual（門の見た目）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| sprite | Sprite | 前面スプライト |
| size | Vector2 | サイズ |
| offset | Vector2 | オフセット |
| tint | Color | 前面の色調 |
| backSprite | Sprite | 背面スプライト |
| backTint | Color | 背面の色調 |
| backOffset | Vector2 | 背面のオフセット |
| backSize | Vector2 | 背面のサイズ |
| label | string | ラベル |
| appearAnim | GateAppearAnimation | 出現アニメ |
| hideAnim | GateHideAnimation | 消滅アニメ |
| sfxOnAppear | string | 出現時のSFX ID |
| sfxOnPass | string | 通過時のSFX ID |
| sfxOnFail | string | 失敗時のSFX ID |

### GateAppearAnimation

| 値 | 説明 |
|-----|------|
| None | なし |
| FadeIn | フェードイン |
| ScaleUp | スケールアップ |
| SlideFromTop | 上からスライド |

### GateHideAnimation

| 値 | 説明 |
|-----|------|
| None | なし |
| FadeOut | フェードアウト |
| ScaleDown | スケールダウン |
| Explode | 爆発 |

---

## CentralObjectVisual（中央オブジェクトの見た目）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| sprite | Sprite | スプライト |
| size | Vector2 | サイズ |
| offset | Vector2 | オフセット |
| tint | Color | 色調 |

---

## SideObjectTableSO（サイドオブジェクトテーブル）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| entries | SideObjectEntry[] | エントリのリスト |
| varietyBias | float | 多様性バイアス（0〜1） |
| varietyDepth | int | 多様性追跡の深さ（0で無効） |

### SideObjectEntry

| フィールド | 型 | 説明 |
|-----------|-----|------|
| sideObject | SideObjectSO | サイドオブジェクト |
| weight | float | 重み |
| conditions | ConditionSO[] | 出現条件 |
| cooldownSteps | int | クールダウン歩数（0で無効） |

---

## SideObjectSO（サイドオブジェクト）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | string | 識別子 |
| uiLabel | string | UI表示ラベル |
| prefabLeft | GameObject | 左側のPrefab |
| prefabRight | GameObject | 右側のPrefab |
| eventDefinition | EventDefinitionSO | 選択時のイベント |

---

## FixedSideObjectPair（固定サイドオブジェクトペア）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| left | SideObjectSO | 左側に固定表示 |
| right | SideObjectSO | 右側に固定表示 |

---

## EncounterTableSO（遭遇テーブル）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| tableId | string | テーブルID（保存用） |
| baseRate | float | 基本遭遇率（0〜1） |
| cooldownSteps | int | 遭遇後のクールダウン歩数 |
| graceSteps | int | 入場後の猶予歩数 |
| pityIncrement | float | 天井に向かう増分 |
| pityMax | float | 天井の最大値（0〜1） |
| enableDebugLog | bool | デバッグログを有効化 |
| entries | EncounterEntry[] | エントリのリスト |

### EncounterEntry

| フィールド | 型 | 説明 |
|-----------|-----|------|
| encounter | EncounterSO | 遭遇 |
| weight | float | 重み |
| conditions | ConditionSO[] | 出現条件 |

---

## EncounterSO（遭遇）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | string | 識別子 |
| uiLabel | string | UI表示ラベル |
| enemyList | List\<NormalEnemy\> | 敵リスト |
| enemyCount | int | 敵の数 |
| escapeRate | float | 逃走成功率 |
| onWin | EventDefinitionSO | 勝利時のイベント |
| onLose | EventDefinitionSO | 敗北時のイベント |
| onEscape | EventDefinitionSO | 逃走時のイベント |

---

## EventDefinitionSO（イベント定義）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| steps | EventStep[] | イベントステップのリスト |

### EventStep

| フィールド | 型 | 説明 |
|-----------|-----|------|
| message | string | メッセージ（TextArea） |
| choices | EventChoice[] | 選択肢 |
| effects | EffectSO[] | 適用するEffect |

### EventChoice

| フィールド | 型 | 説明 |
|-----------|-----|------|
| label | string | 選択肢のラベル |
| effects | EffectSO[] | 選択時のEffect |

---

## ConditionSO（条件）

利用可能な条件SO:

| クラス | 説明 |
|--------|------|
| HasFlagCondition | フラグを持っているか |
| HasCounterCondition | カウンターが条件を満たすか |
| HasTagCondition | タグを持っているか |
| ChanceCondition | 確率判定 |
| StepsCondition | 歩数条件（NodeSteps/TrackProgress） |
| AllGatesClearedCondition | 全門クリア済みか |
| AndCondition | AND合成 |
| OrCondition | OR合成 |
| NotCondition | NOT反転 |

---

## EffectSO（効果）

利用可能なEffectSO:

| クラス | 説明 |
|--------|------|
| SetFlagEffect | フラグを設定 |
| SetCounterEffect | カウンターを設定 |
| AddTagEffect | タグを追加 |
| RemoveTagEffect | タグを削除 |
| ShowMessageEffect | メッセージを表示 |
| LaunchBattleEffect | 戦闘を開始 |
| ApplyStageBonusEffect | ステージボーナスを適用 |
| RestPartyEffect | パーティを回復 |
| CreateAnchorEffect | アンカーを作成 |
| RewindToAnchorEffect | アンカーに巻き戻し |
| PushEncounterOverlayEffect | 遭遇オーバーレイを追加 |
| RemoveEncounterOverlayEffect | 遭遇オーバーレイを削除 |

---

## 設計上の注意点

### 廃止された機能（実装しない）

以下の機能はゼロトタイプ歩行システム設計により廃止:

- `GateMarker.repeatable` - 門は障壁、クリアしたら消滅
- `GateMarker.cooldownSteps` - 歩数指定で代替
- `GateMarker.resetOnSkip` - 常にリセット
- `GateMarker.resetOnFail` - 常にリセット
- `GateMarker.resetTarget` - 上記廃止に伴い不要
- `blockingMode` - 全てボタン表示に統一
- `centerTriggerMode` - 強制イベントはonEnterで代替

### 門と出口の位置関係（ハードル並び設計）

- 門: TrackProgressの絶対位置
- 出口: 最大門位置からの相対距離
- 詳細は「ゼロトタイプ歩行システム仕様書.md」を参照

---

