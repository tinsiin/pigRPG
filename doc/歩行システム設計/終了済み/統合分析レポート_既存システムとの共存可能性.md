# çµ±åˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆ: æ­©è¡Œã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã¨æ—¢å­˜å®Ÿè£…ã®å…±å­˜å¯èƒ½æ€§è©•ä¾¡

**ä½œæˆæ—¥**: 2025å¹´10æœˆ19æ—¥  
**åˆ†æè€…**: AIé–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ  
**è©•ä¾¡çµæœ**: âœ… **å®Œå…¨ã«å…±å­˜å¯èƒ½**

---

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### æœ€çµ‚çµè«–
FlowGraphãƒ™ãƒ¼ã‚¹ã®æ­©è¡Œã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã¯ã€**æ—¢å­˜ã®BattleManagerãƒ»WatchUIUpdateç­‰ã‚’ä¸€åˆ‡å¤‰æ›´ã›ãšã«çµ±åˆå¯èƒ½**ã€‚Walking.cs/Stages.csã®ã¿ã‚’å…¨é¢åˆ·æ–°ã—ã€æ–°ã‚·ã‚¹ãƒ†ãƒ ã‚’ã€Œè–„ã„ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã€‚

### ä¸»è¦æŒ‡æ¨™
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸€è‡´åº¦**: 10%ï¼ˆé…åˆ—ãƒ™ãƒ¼ã‚¹ vs ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹ï¼‰
- **æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ä¿è­·ç‡**: 100%ï¼ˆBattleManagerãƒ»WatchUIUpdateå¤‰æ›´ä¸è¦ï¼‰
- **GameObjectè¿½åŠ æ•°**: 1å€‹ï¼ˆWalkingSystemManagerï¼‰
- **UIéšå±¤ã¸ã®å½±éŸ¿**: ã‚¼ãƒ­ï¼ˆæ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã§æ“ä½œï¼‰
- **æ¨å®šå·¥æ•°**: 4é€±é–“ï¼ˆãƒ•ãƒ«ã‚¿ã‚¤ãƒ 1åï¼‰

---

## 1. æ—¢å­˜å®Ÿè£…ã®æ§‹é€ 

### 1.1 ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### Walking.cs - é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ã®ç·šå½¢é€²è¡Œ
```csharp
NowStageData = stages.RunTimeStageDates[ps.NowStageID];
NowStageCut = NowStageData.CutArea[ps.NowAreaID];
NowAreaData = NowStageCut.AreaDates[ps.NowProgress]; // æ•´æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
```

#### Stages.cs - 3éšå±¤ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
```
StageData â†’ StageCut[] â†’ AreaDate[]
å›ºå®šå€¤: EncounterRate, NextID (æ–‡å­—åˆ—åˆ†å‰²)
```

#### ä¸»è¦ã‚·ã‚¹ãƒ†ãƒ 
- **BattleManager**: æˆ¦é—˜ç®¡ç†ã€ACTPop()ã§UIåˆ¶å¾¡ã€CharacterActBranching()ã§è¡Œå‹•åˆ†å²
- **WatchUIUpdate**: UIæ¼”å‡ºï¼ˆFirstImpressionZoomImproved, EnterK/ExitKç­‰ï¼‰
- **EnemyCollectAI**: å±æ€§ç›¸æ€§ãƒ™ãƒ¼ã‚¹ã®æ•µé¸å®šãƒ­ã‚¸ãƒƒã‚¯

### 1.2 è¨­è¨ˆæ›¸ã¨ã®æ¯”è¼ƒ

| é …ç›® | æ—¢å­˜ | è¨­è¨ˆæ›¸ | ä¸€è‡´åº¦ |
|-----|------|--------|-------|
| é€²è¡Œç®¡ç† | é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | ã‚°ãƒ©ãƒ•ãƒãƒ¼ãƒ‰ | 0% |
| é·ç§» | ç·šå½¢ | æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ | 0% |
| ãƒ‡ãƒ¼ã‚¿ | MonoBehaviour | ScriptableObject | 0% |
| ä¼šè©± | ãªã— | DialogueDefinitionSO | 0% |
| æˆ¦é—˜é€£æº | BattleManagerç›´æ¥ | IBattleRunner | 70% |

**ç·åˆä¸€è‡´åº¦**: **10%**

---

## 2. å…±å­˜å¯èƒ½æ€§ã®æ ¸å¿ƒè©•ä¾¡

### 2.1 BattleManagerã¨ã®çµ±åˆ âœ… **100%äº’æ›**

#### æ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ä¸è¦ï¼‰
```csharp
// BattleManager.cs - 1è¡Œã‚‚å¤‰æ›´ã—ãªã„
public BattleManager(BattleGroup ally, BattleGroup enemy, 
                     BattleStartSituation first, MessageDropper md)
public TabState ACTPop()
public async UniTask<TabState> CharacterActBranching()
public async UniTask OnBattleEnd()
```

#### æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã®å‘¼ã³å‡ºã—
```csharp
// UnityBattleRunner.csï¼ˆæ–°è¦ã‚¢ãƒ€ãƒ—ã‚¿ã‚¯ãƒ©ã‚¹ï¼‰
public class UnityBattleRunner : IBattleRunner
{
    public async UniTask<BattleOutcome> Run(EnemyRef[] ids, GameContext ctx)
    {
        // æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’ãã®ã¾ã¾èµ·å‹•
        var bm = new BattleManager(allyGroup, enemyGroup, 
                                    BattleStartSituation.Normal, 
                                    MessageDropper.Instance);
        
        await WatchUIUpdate.Instance.FirstImpressionZoomImproved();
        Walking.Instance.USERUI_state.Value = bm.ACTPop();
        
        await WaitUntilBattleEnd(bm);
        await bm.OnBattleEnd();
        
        return DetermineBattleOutcome(bm);
    }
}
```

**é‡è¦**: BattleManagerã¯**ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ã—ã¦åˆ©ç”¨**

### 2.2 WatchUIUpdateã¨ã®çµ±åˆ âœ… **100%äº’æ›**

#### æ—¢å­˜ã®publicãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå¤‰æ›´ä¸è¦ï¼‰
```csharp
FirstImpressionZoomImproved()
StageDataUIUpdate(sd, sc, pla)
EnterK(iconRT, title) / ExitK()
MoveActionMarkToActor(actor)
ShowActionMark() / HideActionMark()
```

#### æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã®åˆ©ç”¨
```csharp
// EffectSOå®Ÿè£…ï¼ˆãƒãƒ¼ãƒ‰ã®onEnter/onExitã‹ã‚‰å®Ÿè¡Œï¼‰
public class ZoomEffect : EffectSO {
    public override async UniTask Apply(GameContext ctx) {
        await WatchUIUpdate.Instance.FirstImpressionZoomImproved();
    }
}

// EventStepå®Ÿè£…
public class CustomUIEventStep : EventStep {
    public override async IAsyncEnumerable<EffectSO> Execute(EventContext ctx) {
        WatchUIUpdate.Instance.ShowActionMark();
        await WatchUIUpdate.Instance.EnterK(someIcon, "ç‰¹åˆ¥æ¼”å‡º");
        yield return new SetFlagEffect { key = "event_completed" };
    }
}
```

**é‡è¦**: WatchUIUpdateã‚‚**publicãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã§å®Œå…¨åˆ¶å¾¡å¯èƒ½**

---

## 3. GameObjectã¨UIéšå±¤ã¸ã®å½±éŸ¿

### 3.1 å¿…è¦ãªGameObject: **ãŸã£ãŸ1å€‹**

```
Scene Hierarchy
â”œâ”€ [æ–°è¦] WalkingSystemManager  â† +1å€‹ã ã‘
â”œâ”€ [æ—¢å­˜] Walking               â† è‹¥å¹²æ”¹ä¿®
â”œâ”€ [æ—¢å­˜] WatchUIUpdate         â† å¤‰æ›´ãªã—
â”œâ”€ [æ—¢å­˜] PlayersStates         â† å¤‰æ›´ãªã—
â””â”€ [æ—¢å­˜] UI (Canvasç­‰)         â† å®Œå…¨ã«è§¦ã‚‰ãªã„
```

#### WalkingSystemManager.cs
```csharp
public class WalkingSystemManager : MonoBehaviour
{
    [Header("ScriptableObjectãƒ‡ãƒ¼ã‚¿")]
    public FlowGraphSO rootGraph;
    public GameContextSO initialContext;
    
    [Header("æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å‚ç…§")]
    public Walking walking;
    public WatchUIUpdate watchUI;
    
    private AreaController _areaController;
    private ConversationRunner _conversationRunner;
    private UnityBattleRunner _battleRunner;
    
    void Start() {
        _areaController = new AreaController(rootGraph, new GameContext(initialContext));
        _conversationRunner = new ConversationRunner();
        _battleRunner = new UnityBattleRunner();
        
        _areaController.SetBattleRunner(_battleRunner);
        _areaController.SetConversationRunner(_conversationRunner);
    }
    
    public async UniTask ExecuteWalkStep() {
        await _areaController.WalkStep();
    }
}
```

**ç‰¹å¾´**: ãƒ‡ãƒ¼ã‚¿ã‚’æŒãŸãªã„è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ã€å®Ÿãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ScriptableObject

### 3.2 ScriptableObjectãƒ‡ãƒ¼ã‚¿ç®¡ç†

```
Project/WalkSystem/
â”œâ”€ Graphs/Stage1_Graph.asset
â”œâ”€ Nodes/Area_Forest_1.asset
â”œâ”€ Encounters/Enc_Slime.asset
â”œâ”€ Dialogues/Talk_Intro.asset
â””â”€ Conditions/HasFlag_Key.asset
```

**åˆ©ç‚¹**: GameObjectã¨ã¯å®Œå…¨åˆ†é›¢ã€Inspectorã§ç·¨é›†å¯èƒ½

### 3.3 UIéšå±¤ã¨ã®é–¢ä¿‚

#### âŒ ã‚„ã‚‰ãªã„ã“ã¨
```csharp
// UIéšå±¤ã®ç›´æ¥æ“ä½œãƒ»å‹•çš„ç”Ÿæˆãƒ»æ§‹é€ ä¾å­˜ã¯ä¸€åˆ‡ã—ãªã„
transform.Find("Canvas/Panel/...").GetComponent<Text>().text = "...";
var ui = Instantiate(prefab, canvas.transform);
```

#### âœ… ã‚„ã‚‹ã“ã¨
```csharp
// æ—¢å­˜ã®publicãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã ã‘
MessageDropper.Instance.Show(dialogue.text);
await Walking.Instance.CreateAreaButton(choices);
WatchUIUpdate.Instance.MoveActionMarkToActor(actor);
```

### 3.4 Inspectorè¨­å®š

```
WalkingSystemManager
â”œâ”€ Root Graph: [Stage1_Graph.asset]
â”œâ”€ Initial Context: [GameContext_Start.asset]
â”œâ”€ Walking: [Walking GameObject]
â””â”€ Watch UI: [WatchUIUpdate GameObject]
```

**è¨­å®šé …ç›®: 4ã¤ã ã‘**

---

## 4. å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### 4.1 å¿…è¦ãªä½œæ¥­

#### âœ… å¤‰æ›´ä¸è¦ï¼ˆ100%å†åˆ©ç”¨ï¼‰
- BattleManager
- WatchUIUpdate
- PlayersStates
- BaseStates
- BattleGroup
- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå…¨èˆ¬
- EnemyCollectAIï¼ˆå±æ€§ç›¸æ€§ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

#### ğŸ”¨ æ–°è¦ä½œæˆ
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å·¥æ•° |
|--------------|------|
| ScriptableObjectç¾¤ï¼ˆNode/Edge/Condition/Effectï¼‰ | 1é€±é–“ |
| GameContext/FlagStore | 3æ—¥ |
| AreaControllerï¼ˆã‚°ãƒ©ãƒ•å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³ï¼‰ | 1é€±é–“ |
| ConversationRunner | 1é€±é–“ |
| UnityBattleRunnerï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ï¼‰ | 2æ—¥ |
| EncounterSystem | 3æ—¥ |
| EffectSOå®Ÿè£… | 1é€±é–“ |

**å°è¨ˆ: ç´„4é€±é–“**

#### â™»ï¸ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
| å¯¾è±¡ | ä½œæ¥­å†…å®¹ | å·¥æ•° |
|------|---------|------|
| Walking.cs | AreaControllerå‘¼ã³å‡ºã—ã«å·®ã—æ›¿ãˆ | 2æ—¥ |
| Stages.cs | SOåŒ–ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ | 3æ—¥ |
| USERUIåˆ¶å¾¡ | æ¥ç¶šç¶­æŒ | 1æ—¥ |

**å°è¨ˆ: ç´„1é€±é–“**

### 4.2 æ®µéšçš„å®Ÿè£…ï¼ˆ4ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

#### Phase 1: æœ€å°å‹•ä½œç¢ºèªï¼ˆ1é€±é–“ï¼‰
- SOåŸºæœ¬æ§‹é€ ã€GameContext/FlagStore
- å˜ç´”ãªAreaControllerï¼ˆé­é‡ãƒ»ä¼šè©±ãªã—ï¼‰
- Walking.cså·®ã—æ›¿ãˆ
- **ç›®æ¨™**: ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹ã§æ­©ã‘ã‚‹ã ã‘

#### Phase 2: é­é‡ã‚·ã‚¹ãƒ†ãƒ çµ±åˆï¼ˆ1é€±é–“ï¼‰
- EncounterSOã€UnityBattleRunner
- WatchUIUpdateé€£æº
- **ç›®æ¨™**: æˆ¦é—˜ãŒæ­£å¸¸ã«å‹•ã

#### Phase 3: ä¼šè©±ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ï¼ˆ1é€±é–“ï¼‰
- DialogueSOã€ConversationRunner
- PreTalk/PostTalkçµ±åˆ
- **ç›®æ¨™**: æˆ¦é—˜å‰å¾Œã«ä¼šè©±ãŒæŒŸã¾ã‚‹

#### Phase 4: å®Œå…¨çµ±åˆï¼ˆ1é€±é–“ï¼‰
- AmbientTalkTriggerã€ExitCandidate
- Overlay/DSLæ‹¡å¼µ
- **ç›®æ¨™**: è¨­è¨ˆæ›¸ã®å…¨æ©Ÿèƒ½ãŒå‹•ã

---

## 5. æ‡¸å¿µç‚¹ã¨è§£æ±ºç­–

### 5.1 GameObjectè¤‡é›‘åŒ–ã®æ‡¸å¿µ âœ… **è§£æ±ºæ¸ˆã¿**

**æ‡¸å¿µ**: GameObjectã‚„UIéšå±¤ãŒè¤‡é›‘åŒ–ã™ã‚‹ã®ã§ã¯ï¼Ÿ

**è©•ä¾¡**: 
- è¿½åŠ GameObjectã¯**1å€‹ã®ã¿**
- UIéšå±¤ã«ã¯**ä¸€åˆ‡è§¦ã‚‰ãªã„**
- ãƒ‡ãƒ¼ã‚¿ã¯SOåŒ–ï¼ˆéšå±¤ã‚’æ±šã•ãªã„ï¼‰

**å®Ÿè¨¼**:
```
å¤‰æ›´å‰: ç´„20å€‹ã®GameObject
å¤‰æ›´å¾Œ: ç´„21å€‹ï¼ˆ+1ã®ã¿ï¼‰
UIéšå±¤: å®Œå…¨ã«éæ¥è§¦
```

### 5.2 æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ç ´å£Šã®æ‡¸å¿µ âœ… **è§£æ±ºæ¸ˆã¿**

**æ‡¸å¿µ**: BattleManagerã‚„WatchUIUpdateã‚’æ”¹ä¿®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã¯ï¼Ÿ

**è©•ä¾¡**:
- BattleManager: **1è¡Œã‚‚å¤‰æ›´ä¸è¦**
- WatchUIUpdate: **1è¡Œã‚‚å¤‰æ›´ä¸è¦**
- æ—¢å­˜APIã‚’ã‚¢ãƒ€ãƒ—ã‚¿çµŒç”±ã§å‘¼ã¶ã ã‘

### 5.3 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®æ‡¸å¿µ âœ… **è§£æ±ºæ¸ˆã¿**

**æ‡¸å¿µ**: æ—¢å­˜ã®StageDataã‚’ã©ã†ç§»è¡Œã™ã‚‹ã‹ï¼Ÿ

**è§£æ±ºç­–**:
1. æ—¢å­˜ã®StageCut/AreaDateã‹ã‚‰è‡ªå‹•å¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
2. SOåŒ–ã•ã‚ŒãŸNodeSO/EdgeSOã«å¤‰æ›
3. æ—§ãƒ‡ãƒ¼ã‚¿ã‚‚ä¸¦è¡Œç¨¼åƒå¯èƒ½ï¼ˆæ®µéšçš„ç§»è¡Œï¼‰

### 5.4 UIæ“ä½œã®è¤‡é›‘åŒ– âœ… **è§£æ±ºæ¸ˆã¿**

**æ‡¸å¿µ**: æ–°ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ—¢å­˜UIã‚’ã©ã†æ“ä½œã™ã‚‹ã‹ï¼Ÿ

**è©•ä¾¡**:
- æ—¢å­˜ã®publicãƒ¡ã‚½ãƒƒãƒ‰ãŒãã®ã¾ã¾ä½¿ãˆã‚‹
- MessageDropperã€CreateAreaButtonã€WatchUIUpdateã®å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç›´æ¥å‘¼ã¶
- å†…éƒ¨å®Ÿè£…ã¯ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã¾ã¾

---

## 6. çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°: FlowGraphæ­©è¡Œã‚·ã‚¹ãƒ†ãƒ ï¼ˆè¨­è¨ˆæ›¸ï¼‰           â”‚
â”‚  - NodeSO (AreaNode)                        â”‚
â”‚  - EdgeSO (é·ç§»æ¡ä»¶)                         â”‚
â”‚  - EventRunner (ä¼šè©±ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ)              â”‚
â”‚  - AreaController (1ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œ)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ è–„ã„æ¥ç¶šãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ï¼‰
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â†“          â†“          â†“         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
    â”‚ æ—¢å­˜:    â”‚ â”‚ æ—¢å­˜:    â”‚ â”‚ æ—¢å­˜:  â”‚ â”‚ æ—¢å­˜ â”‚
    â”‚ Battle   â”‚ â”‚ WatchUI  â”‚ â”‚Players â”‚ â”‚ UI   â”‚
    â”‚ Manager  â”‚ â”‚ Update   â”‚ â”‚States  â”‚ â”‚éšå±¤  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
     å¤‰æ›´ä¸è¦     å¤‰æ›´ä¸è¦     å¤‰æ›´ä¸è¦   å®Œå…¨ä¿è­·
```

---

## 7. å®Ÿè£…ä¾‹: ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ãƒãƒˆãƒ«ã¾ã§ã®å®Œå…¨ãƒ•ãƒ­ãƒ¼

```csharp
// ========== ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆScriptableObjectï¼‰ ==========
[CreateAssetMenu(menuName="Walk/Encounter")]
public class EncounterDefinitionSO : ScriptableObject {
    public EnemyRef[] enemyIds;
    public DialogueDefinitionSO preTalk;
    public OutcomeDialoguePair[] postTalkByOutcome;
}

// ========== é­é‡ã‚·ã‚¹ãƒ†ãƒ  ==========
public static class EncounterSystem {
    public static async UniTask RunEncounter(
        EncounterDefinitionSO enc, GameContext ctx,
        UnityBattleRunner battleRunner,
        ConversationRunner conversationRunner)
    {
        // PreTalkï¼ˆæ—¢å­˜UIã§ä¼šè©±è¡¨ç¤ºï¼‰
        if (enc.preTalk != null)
            await conversationRunner.Run(enc.preTalk, ctx);
        
        // æˆ¦é—˜èµ·å‹•ï¼ˆæ—¢å­˜ã®BattleManagerï¼‰
        var outcome = await battleRunner.Run(enc.enemyIds, ctx);
        
        // PostTalkï¼ˆOutcomeåˆ¥ï¼‰
        var postTalk = Array.Find(enc.postTalkByOutcome, 
                                   x => x.outcome == outcome)?.dialogue;
        if (postTalk != null)
            await conversationRunner.Run(postTalk, ctx);
    }
}

// ========== ã‚¢ãƒ€ãƒ—ã‚¿ ==========
public class UnityBattleRunner : IBattleRunner {
    public async UniTask<BattleOutcome> Run(EnemyRef[] ids, GameContext ctx) {
        var enemies = ConvertToEnemyGroup(ids);
        var allies = PlayersStates.Instance.GetParty();
        
        // BattleManagerèµ·å‹•ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
        var bm = new BattleManager(allies, enemies, 
                                    BattleStartSituation.Normal,
                                    MessageDropper.Instance);
        
        // UIæ¼”å‡ºï¼ˆæ—¢å­˜ã®WatchUIUpdateï¼‰
        await WatchUIUpdate.Instance.FirstImpressionZoomImproved();
        
        // ãƒãƒˆãƒ«ãƒ«ãƒ¼ãƒ—ï¼ˆæ—¢å­˜ã®UIåˆ¶å¾¡ï¼‰
        Walking.Instance.USERUI_state.Value = bm.ACTPop();
        Walking.Instance._nextWaitBtn.onClick.AddListener(/*...*/);
        
        await UniTask.WaitUntil(() => IsBattleFinished(bm));
        
        await bm.OnBattleEnd();
        await WatchUIUpdate.Instance.RestoreZoomViaOrchestrator(true);
        
        return DetermineBattleOutcome(bm);
    }
}
```

---

## 8. æœ€çµ‚è©•ä¾¡ã‚µãƒãƒªãƒ¼

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ | èª¬æ˜ |
|---------|-------|------|
| **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸€è‡´åº¦** | 10% | é…åˆ—ãƒ™ãƒ¼ã‚¹ vs ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹ã§æ ¹æœ¬çš„ã«ç•°ãªã‚‹ |
| **BattleManageräº’æ›æ€§** | 100% | å®Œå…¨ã«å†åˆ©ç”¨å¯èƒ½ |
| **WatchUIUpdateäº’æ›æ€§** | 100% | publicãƒ¡ã‚½ãƒƒãƒ‰ã§å®Œå…¨åˆ¶å¾¡å¯ |
| **GameObjectè¿½åŠ æ•°** | +1å€‹ | WalkingSystemManagerã®ã¿ |
| **UIéšå±¤ã¸ã®å½±éŸ¿** | 0% | ä¸€åˆ‡è§¦ã‚‰ãªã„ |
| **æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ä¿è­·** | 100% | å¤‰æ›´ä¸è¦ |
| **å®Ÿè£…å·¥æ•°ã®ç¾å®Ÿæ€§** | è‰¯å¥½ | 4é€±é–“ã§å®Ÿç¾å¯èƒ½ |
| **æ®µéšçš„é©ç”¨å¯èƒ½æ€§** | é«˜ã„ | 4ãƒ•ã‚§ãƒ¼ã‚ºã§æ®µéšçš„ã«å°å…¥ |

---

## 9. æ¨å¥¨äº‹é …

### 9.1 å³åº§ã«ç€æ‰‹å¯èƒ½
1. WalkingSystemManagerä½œæˆï¼ˆ1æ—¥ï¼‰
2. ScriptableObjectã®åŸºæœ¬æ§‹é€ ï¼ˆ2-3æ—¥ï¼‰
3. GameContext/FlagStoreå®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰

### 9.2 ä¸¦è¡Œé–‹ç™ºæˆ¦ç•¥
- **æ—¢å­˜ã‚¹ãƒ†ãƒ¼ã‚¸**: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œç¶™ç¶š
- **æ–°è¦ã‚¹ãƒ†ãƒ¼ã‚¸**: è¨­è¨ˆæ›¸ãƒ™ãƒ¼ã‚¹ã§ä½œæˆ
- **æ—§ã‚¹ãƒ†ãƒ¼ã‚¸**: æ®µéšçš„ã«ç§»è¡Œï¼ˆè‡ªå‹•å¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆåˆ©ç”¨ï¼‰

### 9.3 ãƒªã‚¹ã‚¯ç®¡ç†
- Phase 1å®Œäº†å¾Œã€æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½
- å„Phaseã§æ—¢å­˜ã®æˆ¦é—˜ãƒ»UIæ¼”å‡ºãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- å•é¡Œç™ºç”Ÿæ™‚ã¯å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½ãªæ§‹æˆã‚’ç¶­æŒ

---

## 10. çµè«–

### âœ… **å®Œå…¨ã«å…±å­˜å¯èƒ½**

1. **Walking.cs/Stages.csã®å…¨é¢åˆ·æ–°**: OKï¼ˆå½±éŸ¿ç¯„å›²ã¯é™å®šçš„ï¼‰
2. **BattleManager**: å¤‰æ›´ä¸è¦ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ã§èµ·å‹•ï¼‰
3. **WatchUIUpdate**: å¤‰æ›´ä¸è¦ï¼ˆpublicãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ï¼‰
4. **GameObjectã®è¿½åŠ **: ãŸã£ãŸ1å€‹
5. **UIéšå±¤**: ä¸€åˆ‡è§¦ã‚‰ãªã„

è¨­è¨ˆæ›¸ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œè–„ã„ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ã¨ã—ã¦ã€æ—¢å­˜ã®é‡ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’**ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ã—ã¦å‘¼ã³å‡ºã™**ã ã‘ã€‚

**ãƒãƒ¼ãƒ‰ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æ—¢å­˜UIã‚’æ“ä½œã™ã‚‹å½¢ã§å®Œå…¨ã«çµ±åˆå¯èƒ½ã€‚ã‚ãªãŸã®æ¨æ¸¬ã¯å®Œå…¨ã«æ­£ã—ã‹ã£ãŸã€‚**

---

## ä»˜éŒ²: å‚ç…§æƒ…å ±

### åˆ†æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `Walking.cs` (347è¡Œ)
- `Stages.cs` (589è¡Œ)
- `BattleManager.cs` (2351è¡Œ)
- `WatchUIUpdate.cs` (å¤§è¦æ¨¡)

### è¨­è¨ˆæ›¸ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `æ­©è¡Œã‚·ã‚¹ãƒ†ãƒ å°å…¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆä¼šè©±å…ˆè¡Œãƒ»æœ€å°ã‚³ã‚¢ï¼‰v_0.md`
- `flow_graph_ä¸­æ ¸ä»•æ§˜_v_0_1_ï¼ˆæš«å®šãƒ»æ­©è¡Œ_åˆ†å²_é­é‡ã®åŸºç›¤è¨­è¨ˆï¼‰.md`
- `flow_graph_æ‹¡å¼µæ¡ˆ_v_0_1_ï¼ˆgate_track_pool_anchor_ã»ã‹ï¼‰.md`
- `event_kernel_æ‹¡å¼µå¯èƒ½ã‚¤ãƒ™ãƒ³ãƒˆæ©Ÿæ§‹_è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ_v_0.md`

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ç™ºãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰
2. Phase 1ã®è©³ç´°è¨­è¨ˆé–‹å§‹
3. ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®Ÿè£…ï¼ˆ1é€±é–“ï¼‰
4. çµ±åˆãƒ†ã‚¹ãƒˆãƒ»è©•ä¾¡

---

## è£œè¶³æƒ…å ±: è©³ç´°ãªçµ±åˆæ–¹æ³•

### A. EnemyCollectAIã®å®Œå…¨çµ±åˆ

#### A.1 æ—¢å­˜ã®å±æ€§ç›¸æ€§ãƒ­ã‚¸ãƒƒã‚¯ã®æ´»ç”¨

ç¾åœ¨ã®`StageCut.EnemyCollectAI()`ã¯éå¸¸ã«æ´—ç·´ã•ã‚ŒãŸæ•µé¸å®šã‚·ã‚¹ãƒ†ãƒ :

```csharp
// æ—¢å­˜ã®æ©Ÿèƒ½ï¼ˆä¿æŒã•ã‚Œã‚‹ï¼‰
- ç²¾ç¥å±æ€§ç›¸æ€§ãƒãƒƒãƒãƒ³ã‚°ï¼ˆImpressionMatchUpï¼‰
- ã‚­ãƒ£ãƒ©ã‚¿ã‚¤ãƒ—ç›¸æ€§ï¼ˆTypeMatchUpï¼‰
- åŒæƒ…è£œæ­£ï¼ˆHPåŠåˆ†ä»¥ä¸‹ã§ç›¸æ€§åˆ¤å®š2å€ï¼‰
- Lonelyåˆ¤å®šï¼ˆå˜ä½“æˆ¦ã®ç¢ºç‡å‡¦ç†ï¼‰
- æ®µéšçš„ãªäººæ•°æ±ºå®šï¼ˆ1äºº88%, 2äºº65%ã§æ‰“ã¡åˆ‡ã‚Šï¼‰
- å¾©æ´»åˆ¤å®šï¼ˆRebornå¯èƒ½ãªæ•µã®è‡ªå‹•é¸å®šï¼‰
- ç›¸æ€§å€¤ã®äº‹å‰è¨ˆç®—ï¼ˆCompatibilityDataï¼‰
```

#### A.2 æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã®çµ±åˆæ–¹æ³•

```csharp
// UnityBattleRunnerå†…ã§ã®åˆ©ç”¨
private BattleGroup CreateEnemyGroup(EnemyRef[] enemyIds, GameContext ctx)
{
    // æ–¹æ³•1: æ—¢å­˜ã®AIã‚’ãã®ã¾ã¾ä½¿ã†ï¼ˆè‡ªå‹•é¸å®šï¼‰
    var stageCut = GetCurrentStageCut(ctx);
    var enemyGroup = stageCut.EnemyCollectAI(enemyIds.Length);
    
    // æ–¹æ³•2: enemyIdsã§æŒ‡å®šã•ã‚ŒãŸæ•µã‚’ç›´æ¥å–å¾—ï¼ˆå›ºå®šæ•µï¼‰
    if (enemyIds.Length > 0 && enemyIds[0].IsSpecific)
    {
        var enemies = enemyIds.Select(id => FindEnemyByID(id)).ToList();
        
        // æ—¢å­˜ã®ç›¸æ€§è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨
        var compatibilityData = CalculateCompatibility(enemies);
        var partyProperty = EnemyCollectManager.Instance.calculatePartyProperty(enemies);
        
        return new BattleGroup(enemies.Cast<BaseStates>().ToList(), 
                               partyProperty, 
                               allyOrEnemy.Enemyiy,
                               compatibilityData);
    }
    
    return enemyGroup;
}
```

#### A.3 EncounterDefinitionSOã§ã®åˆ¶å¾¡

```csharp
[CreateAssetMenu(menuName="Walk/Encounter/Definition")]
public class EncounterDefinitionSO : ScriptableObject
{
    public EnemyRef[] enemyIds;  // ç©ºãªã‚‰è‡ªå‹•é¸å®šã€æŒ‡å®šã™ã‚Œã°å›ºå®š
    public int enemyCount = -1;  // -1=è‡ªå‹•ã€1-3=æ‰‹å‹•æŒ‡å®š
    public bool useAISelection = true;  // AIãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ã†ã‹
    
    public DialogueDefinitionSO preTalk;
    public OutcomeDialoguePair[] postTalkByOutcome;
}
```

**åˆ©ç‚¹**: æ—¢å­˜ã®è¤‡é›‘ãªç›¸æ€§ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ã«ä¿è­·ã—ã¤ã¤ã€æ–°ã‚·ã‚¹ãƒ†ãƒ ã§æŸ”è»Ÿã«åˆ¶å¾¡å¯èƒ½

---

### B. ã‚µã‚¤ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆ

#### B.1 æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹é€ 

```csharp
// Stages.cs
[SerializeField] private GameObject[] _sideObject_Lefts;
[SerializeField] private GameObject[] _sideObject_Rights;

public GameObject[] GetRandomSideObject()
{
    var leftItem = RandomEx.Shared.GetItem<GameObject>(_sideObject_Lefts);
    var rightItem = RandomEx.Shared.GetItem<GameObject>(_sideObject_Rights);
    return new GameObject[] { leftItem, rightItem };
}
```

#### B.2 æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã®å®Ÿè£…

```csharp
// SideObjectTableSOï¼ˆè¨­è¨ˆæ›¸ï¼‰
[CreateAssetMenu(menuName="Walk/SideObject/Table")]
public class SideObjectTableSO : ScriptableObject
{
    public SideObjectEntry[] entries;
    public float varietyBias = 0.5f;
}

[Serializable]
public class SideObjectEntry
{
    public SideObjectSO sideObject;
    public float weight = 1.0f;
    public ConditionSO[] conditions;
    
    // æ—¢å­˜ã®GameObject Prefabã¸ã®å‚ç…§
    public GameObject prefabLeft;
    public GameObject prefabRight;
}

// å®Ÿè¡Œæ™‚ã®å‡¦ç†
public class SideObjectSystem
{
    public async UniTask<(GameObject left, GameObject right)> RollSideObjects(
        SideObjectTableSO table, GameContext ctx)
    {
        // æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿
        var candidates = table.entries.Where(e => 
            e.conditions.All(c => c.IsMet(ctx))).ToList();
        
        // é‡ã¿ã§æŠ½é¸
        var selected = WeightedRandom.Pick(candidates, e => e.weight);
        
        // æ—¢å­˜ã®Prefabã‚’è¿”ã™ï¼ˆWatchUIUpdateãŒè¡¨ç¤ºï¼‰
        return (selected.prefabLeft, selected.prefabRight);
    }
}
```

**çµ±åˆãƒã‚¤ãƒ³ãƒˆ**: 
- æ—¢å­˜ã®GameObject Prefabã‚’ãã®ã¾ã¾ä½¿ç”¨
- WatchUIUpdateã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ä¸è¦
- æ–°ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œã©ã®Prefabã‚’é¸ã¶ã‹ã€ã ã‘ã‚’æ±ºå®š

---

### C. æ‹¡å¼µæ©Ÿèƒ½ï¼ˆGate/Track/Anchorï¼‰ã®çµ±åˆå¯èƒ½æ€§

#### C.1 ã‚¤ãƒ™ãƒ³ãƒˆé–€ï¼ˆGateMarkerï¼‰

```csharp
// NodeSOã«è¿½åŠ 
public class AreaNodeSO : ScriptableObject
{
    public TrackConfig track;  // å†…éƒ¨é€²è¡Œãƒˆãƒ©ãƒƒã‚¯
    public GateMarker[] gates;  // å›ºå®šä½ç½®ã®ã‚¤ãƒ™ãƒ³ãƒˆé–€
}

// å®Ÿè£…
public class AreaController
{
    private async UniTask CheckGates(GameContext ctx)
    {
        var currentProgress = ctx.GetCounter("progress");
        var nextGate = _currentNode.gates
            .Where(g => g.position <= currentProgress && !g.IsPassed(ctx))
            .OrderBy(g => g.position)
            .FirstOrDefault();
        
        if (nextGate != null)
        {
            // æ—¢å­˜ã®UIã‚·ã‚¹ãƒ†ãƒ ã§é–€ã‚’è¡¨ç¤º
            var result = await ShowGateUI(nextGate);
            
            if (result == GateResult.Pass)
            {
                ApplyEffects(nextGate.onPass, ctx);
            }
            else
            {
                // Rewindå‡¦ç†
                await HandleGateFailure(nextGate, ctx);
            }
        }
    }
}
```

**æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ¥ç¶š**: é–€UIã‚‚æ—¢å­˜ã®MessageDropper/CreateAreaButtonã§å®Ÿè£…å¯èƒ½

#### C.2 Overlayï¼ˆçŠ¶æ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰

```csharp
// é­é‡ç‡ã®å‹•çš„èª¿æ•´
public class EncounterSystem
{
    public static float CalculateEncounterRate(EncounterTableSO table, GameContext ctx)
    {
        var baseRate = table.baseRate;
        
        // Overlayå€ç‡ã‚’é©ç”¨
        var overlayMods = ctx.GetActiveOverlays()
            .Select(o => o.encounterRateMod)
            .Aggregate(1.0f, (a, b) => a * b);
        
        // ã‚¨ãƒªã‚¢å€ç‡
        var areaMod = GetAreaMod(ctx);
        
        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œå€ç‡
        var storyMod = GetStoryMod(ctx);
        
        return Mathf.Clamp01(baseRate * overlayMods * areaMod * storyMod);
    }
}

// Overlayã®é©ç”¨
public class OverlaySO : ScriptableObject
{
    public string id;
    public float encounterRateMod = 1.0f;
    public Dictionary<string, float> sideObjectCategoryMods;
    public EffectSO[] onEnter;
    public EffectSO[] onExit;
}
```

**çµ±åˆ**: æ—¢å­˜ã®EncountCheck()ã‚’ç½®ãæ›ãˆã‚‹ã ã‘ã€‚BattleManagerã«ã¯å½±éŸ¿ãªã—

---

### D. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿åˆ†æ

#### D.1 ScriptableObjectã®ãƒ¡ãƒªãƒƒãƒˆ

```
ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡:
- æ—¢å­˜: MonoBehaviourãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚·ãƒ¼ãƒ³ä¿å­˜æ™‚ã«è‚¥å¤§åŒ–ï¼‰
- æ–°: ScriptableObjectï¼ˆProjectãƒ•ã‚¡ã‚¤ãƒ«ã§å…±æœ‰ã€ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ï¼‰

èµ·å‹•æ™‚é–“:
- æ—¢å­˜: DeepCopy()ã§å…¨ãƒ‡ãƒ¼ã‚¿è¤‡è£½ï¼ˆStages.Start()ï¼‰
- æ–°: SOå‚ç…§ã®ã¿ï¼ˆè¤‡è£½ä¸è¦ï¼‰

å®Ÿè¡Œæ™‚:
- ã‚°ãƒ©ãƒ•æ¢ç´¢: O(E)ï¼ˆã‚¨ãƒƒã‚¸æ•°ï¼‰ã€é€šå¸¸10å€‹æœªæº€ãªã®ã§ç„¡è¦–å¯èƒ½
- æ¡ä»¶è©•ä¾¡: O(C)ï¼ˆæ¡ä»¶æ•°ï¼‰ã€é€šå¸¸3-5å€‹
- åŠ¹æœé©ç”¨: O(E)ï¼ˆåŠ¹æœæ•°ï¼‰ã€é€šå¸¸1-3å€‹
```

**è©•ä¾¡**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ã¯ã»ã¼ã‚¼ãƒ­ï¼ˆã‚€ã—ã‚æ”¹å–„ã®å¯èƒ½æ€§ï¼‰

#### D.2 æ—¢å­˜ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼ˆå¤‰ã‚ã‚‰ãªã„ï¼‰

```
ä¸»è¦ãªå‡¦ç†æ™‚é–“:
1. FirstImpressionZoomImproved() - æ•µUIç”Ÿæˆãƒ»é…ç½®ï¼ˆ50-200msï¼‰
2. EnemyCollectAI() - å±æ€§ç›¸æ€§è¨ˆç®—ï¼ˆ1-5msï¼‰
3. BattleManageråˆæœŸåŒ–ï¼ˆ10-30msï¼‰

æ–°ã‚·ã‚¹ãƒ†ãƒ ã®è¿½åŠ ã‚³ã‚¹ãƒˆ:
- ãƒãƒ¼ãƒ‰é·ç§»åˆ¤å®š: <1ms
- æ¡ä»¶è©•ä¾¡: <0.1ms
- SOå‚ç…§: <0.01ms
```

**çµè«–**: æ—¢å­˜ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯ä¿æŒã•ã‚Œã‚‹ãŒã€æ–°ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è¿½åŠ ã‚³ã‚¹ãƒˆã¯ç„¡è¦–ã§ãã‚‹ãƒ¬ãƒ™ãƒ«

---

### E. ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ­ã‚°æˆ¦ç•¥

#### E.1 è¦³æ¸¬æ€§ã®å‘ä¸Š

```csharp
public class WalkDebugger
{
    [Conditional("UNITY_EDITOR")]
    public static void LogNodeTransition(NodeSO from, NodeSO to, EdgeSO via)
    {
        Debug.Log($"[Walk] {from.nodeId} â†’ {to.nodeId} (via {via.policy})");
    }
    
    [Conditional("UNITY_EDITOR")]
    public static void LogEncounterRoll(float rate, bool success, EncounterDefinitionSO enc)
    {
        var result = success ? "SUCCESS" : "FAIL";
        Debug.Log($"[Encounter] Roll={rate:P} â†’ {result} ({enc?.id ?? "none"})");
    }
    
    [Conditional("UNITY_EDITOR")]
    public static void LogConditionEval(ConditionSO cond, bool result)
    {
        var resultStr = result ? "âœ“" : "âœ—";
        Debug.Log($"[Condition] {resultStr} {cond.GetType().Name}");
    }
}
```

#### E.2 Inspectorã§ã®Runtime Stateè¡¨ç¤º

```csharp
// WalkingSystemManager.cs
public class WalkingSystemManager : MonoBehaviour
{
    [Header("Runtime State (Read Only)")]
    [SerializeField, ReadOnly] private string _currentNodeId;
    [SerializeField, ReadOnly] private string[] _activeFlags;
    [SerializeField, ReadOnly] private int _stepCount;
    
#if UNITY_EDITOR
    void OnValidate()
    {
        if (!Application.isPlaying) return;
        
        _currentNodeId = _areaController?.CurrentNode?.nodeId ?? "None";
        _activeFlags = _context?.GetAllFlags().ToArray() ?? Array.Empty<string>();
        _stepCount = _context?.GetCounter("stepCount") ?? 0;
    }
#endif
}
```

#### E.3 ãƒªãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½

```csharp
public class ReplayRecorder
{
    private List<WalkEvent> _events = new();
    
    public void RecordNodeEnter(string nodeId, int seed)
    {
        _events.Add(new WalkEvent { 
            type = "NodeEnter", 
            nodeId = nodeId, 
            seed = seed 
        });
    }
    
    public void SaveReplay(string path)
    {
        var json = JsonUtility.ToJson(new ReplayData { events = _events });
        File.WriteAllText(path, json);
    }
    
    public async UniTask PlayReplay(string path)
    {
        var json = File.ReadAllText(path);
        var replay = JsonUtility.FromJson<ReplayData>(json);
        
        foreach (var evt in replay.events)
        {
            await ExecuteEvent(evt);
        }
    }
}
```

**åˆ©ç‚¹**: ãƒ‡ãƒãƒƒã‚°æ™‚ã«å®Œå…¨å†ç¾å¯èƒ½ã€QAåŠ¹ç‡ãŒåŠ‡çš„ã«å‘ä¸Š

---

### F. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### F.1 ã‚°ãƒ©ãƒ•ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

```csharp
[MenuItem("Tools/Validate Walk Graph")]
public static void ValidateGraph()
{
    var graphs = Resources.FindObjectsOfTypeAll<FlowGraphSO>();
    
    foreach (var graph in graphs)
    {
        // åˆ°é”ä¸èƒ½ãƒãƒ¼ãƒ‰ã®æ¤œå‡º
        var reachable = FindReachableNodes(graph);
        var unreachable = graph.nodes.Except(reachable);
        foreach (var node in unreachable)
        {
            Debug.LogWarning($"Unreachable node: {node.nodeId}", graph);
        }
        
        // å‡ºå£ãªã—ãƒãƒ¼ãƒ‰ã®æ¤œå‡º
        foreach (var node in graph.nodes)
        {
            var exits = graph.edges.Where(e => e.fromNodeId == node.nodeId);
            if (!exits.Any() && !node.isTerminal)
            {
                Debug.LogError($"Node has no exits: {node.nodeId}", node);
            }
        }
        
        // å­˜åœ¨ã—ãªã„ãƒãƒ¼ãƒ‰ã¸ã®å‚ç…§
        foreach (var edge in graph.edges)
        {
            if (!graph.nodes.Any(n => n.nodeId == edge.toNodeId))
            {
                Debug.LogError($"Edge references non-existent node: {edge.toNodeId}", edge);
            }
        }
    }
}
```

#### F.2 Runtime ã‚¨ãƒ©ãƒ¼ã®å®‰å…¨ãªå‡¦ç†

```csharp
public class AreaController
{
    public async UniTask WalkStep()
    {
        try
        {
            // é€šå¸¸å‡¦ç†
            await ExecuteNode(_currentNode, _context);
        }
        catch (NodeExecutionException ex)
        {
            Debug.LogError($"Node execution failed: {ex.Message}");
            
            // ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•: å®‰å…¨ãªãƒãƒ¼ãƒ‰ã«å¼·åˆ¶é·ç§»
            await EmergencyTransition(GetSafeNode(), _context);
        }
        catch (Exception ex)
        {
            Debug.LogException(ex);
            
            // è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ç”»é¢ã‚’è¡¨ç¤º
            MessageDropper.Instance.Show("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            
            // çŠ¶æ…‹ã‚’ã‚»ãƒ¼ãƒ–ãƒã‚¤ãƒ³ãƒˆã«å·»ãæˆ»ã—
            await RewindToLastSafePoint();
        }
    }
}
```

---

### G. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

#### G.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆæ¡ä»¶ãƒ»åŠ¹æœï¼‰

```csharp
[Test]
public void HasFlagCondition_WhenFlagSet_ReturnsTrue()
{
    var ctx = new GameContext();
    ctx.SetFlag("test_flag");
    
    var condition = ScriptableObject.CreateInstance<HasFlagCondition>();
    condition.flagKey = "test_flag";
    
    Assert.IsTrue(condition.IsMet(ctx));
}

[Test]
public void SetFlagEffect_WhenApplied_SetsFlag()
{
    var ctx = new GameContext();
    var effect = ScriptableObject.CreateInstance<SetFlagEffect>();
    effect.flagKey = "test_flag";
    
    effect.Apply(ctx);
    
    Assert.IsTrue(ctx.HasFlag("test_flag"));
}
```

#### G.2 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆãƒãƒ¼ãƒ‰é·ç§»ï¼‰

```csharp
[UnityTest]
public IEnumerator NodeTransition_WhenConditionMet_TransitionsCorrectly()
{
    var controller = CreateTestController();
    var ctx = controller.Context;
    ctx.SetFlag("key_obtained");
    
    yield return controller.WalkStep().ToCoroutine();
    
    Assert.AreEqual("area_dungeon_2", controller.CurrentNode.nodeId);
}
```

#### G.3 æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ

```csharp
[UnityTest]
public IEnumerator BattleIntegration_WhenEncounterTriggered_BattleManagerStartsCorrectly()
{
    var controller = CreateTestController();
    
    // é­é‡ã‚’å¼·åˆ¶ç™ºç”Ÿ
    controller.ForceEncounter("test_encounter");
    
    yield return new WaitUntil(() => Walking.Instance.bm != null);
    
    Assert.IsNotNull(Walking.Instance.bm);
    Assert.AreEqual(TabState.SelectSkill, Walking.Instance.USERUI_state.Value);
}
```

---

### H. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®è©³ç´°æ‰‹é †

#### H.1 è‡ªå‹•å¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```csharp
[MenuItem("Tools/Convert Legacy Stage Data")]
public static void ConvertLegacyData()
{
    var stages = Stages.Instance.StageDates;
    
    foreach (var stage in stages)
    {
        var graph = CreateFlowGraph(stage);
        
        foreach (var stageCut in stage.CutArea)
        {
            ConvertStageCut(stageCut, graph);
        }
        
        AssetDatabase.CreateAsset(graph, $"Assets/WalkSystem/Graphs/{stage.StageName}_Graph.asset");
    }
    
    AssetDatabase.SaveAssets();
}

private static void ConvertStageCut(StageCut cut, FlowGraphSO graph)
{
    // AreaDate[] â†’ NodeSO[]
    for (int i = 0; i < cut.AreaDates.Count; i++)
    {
        var areaDate = cut.AreaDates[i];
        var node = CreateAreaNode(areaDate, cut, i);
        graph.nodes.Add(node);
        
        // ç·šå½¢é·ç§»ã®Edgeä½œæˆ
        if (i < cut.AreaDates.Count - 1)
        {
            var edge = CreateLinearEdge(node.nodeId, $"area_{i+1}");
            graph.edges.Add(edge);
        }
        
        // åˆ†å²ã®å¤‰æ›
        if (!string.IsNullOrEmpty(areaDate.NextID))
        {
            var exitEdges = ConvertExitChoices(areaDate);
            graph.edges.AddRange(exitEdges);
        }
    }
    
    // EncounterTableå¤‰æ›
    var encounterTable = ConvertEncounterTable(cut);
    foreach (var node in graph.nodes)
    {
        node.encounterTable = encounterTable;
    }
    
    // SideObjectå¤‰æ›
    var sideObjectTable = ConvertSideObjectTable(cut);
    foreach (var node in graph.nodes)
    {
        node.sideObjects = sideObjectTable;
    }
}
```

#### H.2 æ®µéšçš„ç§»è¡Œè¨ˆç”»

```
Week 1-2: æ–°ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®Œæˆ
â”œâ”€ å¤‰æ›ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
â”œâ”€ ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸ã§å‹•ä½œç¢ºèª
â””â”€ æ—¢å­˜ã‚¹ãƒ†ãƒ¼ã‚¸ã¯æ—§ã‚·ã‚¹ãƒ†ãƒ ã§ç¨¼åƒç¶™ç¶š

Week 3-4: ä¸¦è¡Œç¨¼åƒ
â”œâ”€ æ–°è¦ã‚¹ãƒ†ãƒ¼ã‚¸ã¯æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ä½œæˆ
â”œâ”€ æ—§ã‚¹ãƒ†ãƒ¼ã‚¸ã®è‡ªå‹•å¤‰æ›ãƒ†ã‚¹ãƒˆ
â””â”€ å•é¡Œç™ºè¦‹æ™‚ã¯å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

Week 5-6: æ®µéšçš„ç§»è¡Œ
â”œâ”€ æ—§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’1ã¤ãšã¤å¤‰æ›
â”œâ”€ å„ã‚¹ãƒ†ãƒ¼ã‚¸ã§å‹•ä½œç¢ºèª
â””â”€ å•é¡Œãªã‘ã‚Œã°æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸

Week 7-8: å®Œå…¨ç§»è¡Œ
â”œâ”€ å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ãŒæ–°ã‚·ã‚¹ãƒ†ãƒ ã«ç§»è¡Œ
â”œâ”€ æ—§ã‚³ãƒ¼ãƒ‰ï¼ˆWalking.Walk, Stages.csï¼‰ã‚’å‰Šé™¤
â””â”€ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†
```

---

### I. ä¼šè©±ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°çµ±åˆ

#### I.1 MessageDropperã¨ã®çµ±åˆ

```csharp
public class ConversationRunner
{
    public async UniTask Run(DialogueDefinitionSO dialogue, GameContext ctx)
    {
        // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
        if (!dialogue.conditions.All(c => c.IsMet(ctx))) return;
        
        // æ—¢å­˜ã®MessageDropperã‚’ä½¿ç”¨
        foreach (var step in dialogue.steps)
        {
            // ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼ˆæ—¢å­˜UIï¼‰
            MessageDropper.Instance.Show(step.text);
            await UniTask.WaitUntil(() => MessageDropper.Instance.IsClosed);
            
            // é¸æŠè‚¢ãŒã‚ã‚‹å ´åˆ
            if (step.choices.Length > 0)
            {
                var choice = await ShowChoices(step.choices);
                ApplyEffects(step.choices[choice].effects, ctx);
            }
        }
        
        // çµ‚äº†æ™‚ã®åŠ¹æœ
        ApplyEffects(dialogue.effectsOnEnd, ctx);
        
        // Cooldownè¨­å®š
        if (dialogue.cooldownSteps > 0)
        {
            ctx.SetCounter($"dialogue_{dialogue.id}_cooldown", dialogue.cooldownSteps);
        }
    }
    
    private async UniTask<int> ShowChoices(DialogueChoice[] choices)
    {
        // æ—¢å­˜ã®CreateAreaButtonã‚’æµç”¨
        var texts = choices.Select(c => c.text).ToArray();
        var ids = Enumerable.Range(0, choices.Length).Select(i => i.ToString()).ToArray();
        
        return await Walking.Instance.CreateAreaButton(texts, ids);
    }
}
```

#### I.2 DialogueDefinitionSOã®æ§‹é€ 

```csharp
[CreateAssetMenu(menuName="Walk/Dialogue")]
public class DialogueDefinitionSO : ScriptableObject
{
    public string id;
    public ConditionSO[] conditions;
    
    public DialogueStep[] steps;
    public EffectSO[] effectsOnEnd;
    
    public bool once = false;
    public int cooldownSteps = 0;
}

[Serializable]
public class DialogueStep
{
    [TextArea(3, 10)]
    public string text;
    
    public DialogueChoice[] choices;
}

[Serializable]
public class DialogueChoice
{
    public string text;
    public EffectSO[] effects;
}
```

**æ—¢å­˜UIã¨ã®å®Œå…¨äº’æ›æ€§**: MessageDropperãƒ»CreateAreaButtonã‚’ãã®ã¾ã¾ä½¿ç”¨

---

### J. è³ªå•ã¸ã®å›ç­”ã¾ã¨ã‚

#### è³ªå•1: ã€Œã‚¹ãƒ†ãƒ¼ã‚¸é–¢é€£ã‚’å¤‰ãˆã¦ã‚‚ã„ã„ã‹ï¼Ÿã€
**å›ç­”**: âœ… ã¯ã„ã€‚Walking.cs/Stages.csã¯å½±éŸ¿ç¯„å›²ãŒé™å®šçš„ã€‚BattleManagerç­‰ã®é‡ã„ã‚·ã‚¹ãƒ†ãƒ ã¯å®Œå…¨ä¿è­·ã€‚

#### è³ªå•2: ã€Œãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¯å‹•ä½œã™ã‚‹ã‹ï¼Ÿã€
**å›ç­”**: âœ… ã¯ã„ã€‚UnityBattleRunnerã‚¢ãƒ€ãƒ—ã‚¿ã§æ—¢å­˜ã®BattleManagerã‚’ãã®ã¾ã¾èµ·å‹•ã€‚1è¡Œã‚‚å¤‰æ›´ä¸è¦ã€‚

#### è³ªå•3: ã€ŒWatchUIUpdateã¨å…±å­˜ã§ãã‚‹ã‹ï¼Ÿã€
**å›ç­”**: âœ… ã¯ã„ã€‚publicãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã§å®Œå…¨åˆ¶å¾¡å¯èƒ½ã€‚UIéšå±¤ã«ã¯ä¸€åˆ‡è§¦ã‚‰ãªã„ã€‚

#### è³ªå•4: ã€ŒGameObjectãŒè¤‡é›‘åŒ–ã™ã‚‹ã‹ï¼Ÿã€
**å›ç­”**: âœ… ã„ã„ãˆã€‚è¿½åŠ ã¯1å€‹ã®ã¿ï¼ˆWalkingSystemManagerï¼‰ã€‚UIéšå±¤ã¯éæ¥è§¦ã€‚

#### è³ªå•5: ã€Œãƒãƒ¼ãƒ‰ã‹ã‚‰æ—¢å­˜UIã‚’æ“ä½œã§ãã‚‹ã‹ï¼Ÿã€
**å›ç­”**: âœ… ã¯ã„ã€‚EffectSO/EventStepã‹ã‚‰æ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç›´æ¥å‘¼ã³å‡ºã—å¯èƒ½ã€‚

---

### K. æœ€é‡è¦ãƒã‚¤ãƒ³ãƒˆã®å†ç¢ºèª

1. **BattleManager**: ã‚¢ãƒ€ãƒ—ã‚¿ã§èµ·å‹•ã€å†…éƒ¨ã¯ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
2. **WatchUIUpdate**: publicãƒ¡ã‚½ãƒƒãƒ‰ã§æ“ä½œã€å†…éƒ¨ã¯éæ¥è§¦
3. **EnemyCollectAI**: å±æ€§ç›¸æ€§ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾å†åˆ©ç”¨
4. **UIéšå±¤**: ä¸€åˆ‡è§¦ã‚‰ãªã„ã€æ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã®ã¿
5. **GameObject**: +1å€‹ã®ã¿ã€ãƒ‡ãƒ¼ã‚¿ã¯ScriptableObject
6. **æ®µéšçš„ç§»è¡Œ**: 4ãƒ•ã‚§ãƒ¼ã‚ºã€å„ãƒ•ã‚§ãƒ¼ã‚ºã§æ—¢å­˜å‹•ä½œã‚’ç¢ºèª
7. **å·¥æ•°**: 4é€±é–“ã€Phase 1ã§1é€±é–“å¾Œã«å‹•ä½œç¢ºèªå¯èƒ½

---

**è£œè¶³æƒ…å ±çµ‚äº†**
