# 歩行システム動作解説

本書は歩行システムが**実際にどう動くか**を解説する。
設計意図ではなく、実装に基づいた動作説明。

---

## 全体像

```
┌─────────────────────────────────────────────────────────┐
│                    FlowGraphSO                          │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐            │
│  │ NodeSO  │───▶│ NodeSO  │───▶│ NodeSO  │            │
│  │ (森)    │    │ (洞窟)   │    │ (城)    │            │
│  └─────────┘    └─────────┘    └─────────┘            │
│      │              │              │                   │
│      ▼              ▼              ▼                   │
│   歩行ループ      歩行ループ      歩行ループ            │
└─────────────────────────────────────────────────────────┘
```

**FlowGraphSO**がノード（場面）の接続を定義し、プレイヤーは各ノード内で**歩行ループ**を繰り返す。出口に到達すると次のノードへ遷移する。

---

## 1歩の処理フロー

プレイヤーが「歩く」ボタンを押すと、以下の順序で処理される：

```
WalkStep() 開始
    │
    ├─1. ノード入場イベント（初回のみ）
    │     └─ onEnterEvent を実行
    │
    ├─2. カウンター進行
    │     └─ GlobalSteps, NodeSteps, TrackProgress を +1
    │
    ├─3. サイドオブジェクト抽選
    │     └─ 左右ペアをランダム決定、画面に表示
    │
    ├─4. 中央オブジェクト表示（設定があれば）
    │     └─ centralVisual / centralEvent を表示
    │
    ├─5. イベント門チェック
    │     └─ 門の位置に到達していれば門を表示
    │     └─ 門が出現したらこの歩は終了（遭遇/出口をスキップ）
    │
    ├─6. 遭遇判定
    │     └─ 確率でランダムエンカウント
    │     └─ 戦闘が発生したら戦闘処理
    │
    ├─7. アプローチ選択待ち
    │     └─ サイド/中央オブジェクトへのアプローチを待機
    │
    └─8. 出口チェック
          └─ 出口条件を満たしていれば出口を表示
          └─ 出口から次のノードへ遷移可能
```

---

## NodeSO - ノード（場面）の設定

**NodeSO**は1つの「場面」を定義する。森、洞窟、町など。

### 基本情報

| 項目 | 役割 |
|------|------|
| nodeId | このノードの識別子。保存/遷移で使用 |
| displayName | UI表示用の名前 |
| uiHints | 画面の色やテーマを制御 |

### ノード入退場イベント

| 項目 | 役割 |
|------|------|
| onEnterEvent | ノードに入った瞬間に1回だけ実行されるイベント |
| onExitEvent | ノードから出る瞬間に1回だけ実行されるイベント |

**使い方の例：**
- 「洞窟に入った」というメッセージを表示
- フラグを立てる（「洞窟訪問済み」）
- 初期状態を設定する

---

## サイドオブジェクト - 左右の寄り道イベント

```
  ┌───────────────────────────────────┐
  │           画面                     │
  │                                    │
  │  【宝箱】              【商人】     │
  │   (左)                  (右)       │
  │                                    │
  │         ▲ プレイヤー ▲            │
  │                                    │
  │      [歩く]  [左へ]  [右へ]        │
  └───────────────────────────────────┘
```

### SideObjectTableSO - 出現候補テーブル

毎歩、このテーブルから左右それぞれ1つずつ抽選される。

| 項目 | 役割 |
|------|------|
| entries | 出現候補のリスト |
| varietyBias | 同じものが連続で出にくくする強さ（0〜1） |
| varietyDepth | 何回分の履歴を見るか |

### SideObjectEntry - 個別の候補

| 項目 | 役割 |
|------|------|
| sideObject | 実際のサイドオブジェクト |
| weight | 出現しやすさ（大きいほど出やすい） |
| conditions | 出現条件（フラグ等） |
| cooldownSteps | 選択後、何歩の間出現しないか |

**条件の例：**
- 「鍵を持っている」場合のみ宝箱が出現
- 「商人フラグ」が立っていないと商人が出ない

### SideObjectSO - サイドオブジェクト本体

| 項目 | 役割 |
|------|------|
| id | 識別子 |
| uiLabel | ボタンに表示されるラベル |
| prefabLeft / prefabRight | 左右に表示するPrefab |
| eventDefinition | アプローチ時に実行されるイベント |

**動作：**
1. 毎歩、テーブルから左右1つずつ抽選
2. 画面に表示
3. プレイヤーが「左へ」または「右へ」を選ぶとイベント実行
4. 選ばなかった側は次の歩で別のものに変わる

### NodeSO側の設定

| 項目 | 役割 |
|------|------|
| sideObjectTable | このノードで使うテーブル |
| fixedSideObjects | ノード入場時に固定で出すペア |
| retainUnselectedSide | 選ばなかった側を次歩でも残すか |

---

## 中央オブジェクト - 中央に出現するイベント

サイドとは別に、画面中央に出現するオブジェクト。

```
  ┌───────────────────────────────────┐
  │           画面                     │
  │                                    │
  │          ┌─────┐                  │
  │          │ 謎の│                  │
  │          │石碑 │                  │
  │          └─────┘                  │
  │                                    │
  │      [歩く]  [調べる]              │
  └───────────────────────────────────┘
```

### NodeSO側の設定

| 項目 | 役割 |
|------|------|
| centralVisual | 表示する画像（Sprite、サイズ、色等） |
| centralEvent | アプローチ時に実行されるイベント |

**動作：**
- 設定があれば毎歩表示される
- プレイヤーが「調べる」を選ぶとイベント実行
- 門や出口とは排他（門/出口が出る歩では中央オブジェクトは出ない）

---

## イベント門 - 進行を阻む障壁

```
  ┌───────────────────────────────────┐
  │           画面                     │
  │                                    │
  │          ╔═════╗                  │
  │          ║ 門  ║                  │
  │          ║ #1  ║                  │
  │          ╚═════╝                  │
  │    「通過条件: 鍵を3つ所持」       │
  │                                    │
  │      [歩く]  [挑む]                │
  └───────────────────────────────────┘
```

門は「出口への障壁」。全ての門をクリアしないと出口に到達できない。

### GateMarker - 門の定義

| 項目 | 役割 |
|------|------|
| gateId | 門の識別子 |
| order | 解決順序（1, 2, 3...の順にクリアが必要） |
| positionSpec | 出現位置の指定方法 |
| passConditions | 通過条件 |
| onPass | 通過成功時のEffect |
| onFail | 通過失敗時のEffect |
| gateEvent | 門に紐づくイベント（任意） |
| visual | 門の見た目 |

### GatePositionSpec - 位置の指定

| タイプ | 説明 |
|--------|------|
| AbsSteps | 「30歩目に出現」のような絶対指定 |
| Percent | 「トラック長の50%地点」のような割合指定 |
| Range | 「20〜40歩の間のどこか」をノード入場時に決定 |

### 門の動作フロー

```
TrackProgress が門の位置に到達
    │
    ▼
門が出現（サイド/中央/遭遇はこの歩では出ない）
    │
    ├─ [挑む] を選択
    │     │
    │     ▼
    │   passConditions を判定
    │     │
    │     ├─ 成功 → onPass 実行 → 門はクリア（消滅）
    │     │
    │     └─ 失敗 → onFail 実行 → TrackProgress を0にリセット
    │
    └─ [歩く] を選択（スルー）
          │
          ▼
        TrackProgress を0にリセット
```

**重要：** 門をスルーまたは失敗すると、進捗が0に戻る。再び歩いて門の位置に到達するまで門は出現しない。

### TrackConfig - 進捗トラック設定

| 項目 | 役割 |
|------|------|
| length | トラックの全長（Percent計算用） |
| stepDelta | 1歩あたりの進行量（通常は1） |
| progressKey | 進捗をカウンターに保存するキー |

---

## 出口 - ノード遷移

```
  ┌───────────────────────────────────┐
  │           画面                     │
  │                                    │
  │          ┌─────┐                  │
  │          │出口 │                  │
  │          └─────┘                  │
  │                                    │
  │      [歩く]  [出る]                │
  └───────────────────────────────────┘

    [出る] を選択後：

  ┌───────────────────────────────────┐
  │      どこへ向かいますか？           │
  │                                    │
  │      [1. 森へ戻る]                 │
  │      [2. 山を越える]               │
  │      [3. 町へ向かう]               │
  └───────────────────────────────────┘
```

### ExitSpawnRule - 出口の出現条件

| 項目 | 役割 |
|------|------|
| mode | 出現モード（Steps/Probability/None） |
| steps | Stepsモード: 何歩で出現するか |
| rate | Probabilityモード: 毎歩の出現確率 |
| requireAllGatesCleared | 全門クリア必須か（通常はtrue） |

**重要：ハードル並び設計**
```
出口の実際位置 = 最大門位置 + steps

例: 門が30歩、出口設定が100歩
  → 実際の出口位置 = 30 + 100 = 130歩
  → 門通過後、「あと100歩」と表示される
```

### ExitCandidate - 出口候補

| 項目 | 役割 |
|------|------|
| id | 候補の識別子 |
| toNodeId | 遷移先のノードID |
| uiLabel | 選択肢に表示されるラベル |
| weight | 重み（WeightedRandomモード用） |
| conditions | この候補が有効になる条件 |

### 出口の動作フロー

```
出口条件を満たす（位置到達 & 全門クリア）
    │
    ▼
出口が出現
    │
    ├─ [出る] を選択
    │     │
    │     ▼
    │   条件を満たす候補をリストアップ
    │     │
    │     ▼
    │   選択UIを表示
    │     │
    │     ▼
    │   選択されたノードへ遷移
    │
    └─ [歩く] を選択（スルー）
          │
          ▼
        TrackProgress を0にリセット
        （再び歩いて条件を満たすまで出口は出ない）
```

### NodeSO側の出口設定

| 項目 | 役割 |
|------|------|
| exitSpawn | 出口の出現ルール |
| exits | 出口候補のリスト |
| exitSelectionMode | ShowAll（全表示）/ WeightedRandom（抽選） |
| maxExitChoices | 最大表示数 |
| exitVisual | 出口の見た目 |

---

## 遭遇 - ランダムエンカウント

```
  ┌───────────────────────────────────┐
  │                                    │
  │     ！敵が現れた！                  │
  │                                    │
  │     ゴブリン x2                     │
  │                                    │
  │      [戦う]  [逃げる]              │
  └───────────────────────────────────┘
```

### EncounterTableSO - 遭遇テーブル

| 項目 | 役割 |
|------|------|
| baseRate | 基本遭遇率（0.1 = 10%） |
| cooldownSteps | 遭遇後、何歩の間遭遇しないか |
| graceSteps | ノード入場後、何歩の間遭遇しないか |
| pityIncrement | 遭遇しないと確率が上がる量 |
| pityMax | 天井（最大遭遇率） |
| entries | 遭遇候補のリスト |

### 遭遇率の計算

```
実効遭遇率 = baseRate × encounterRateMultiplier × overlay補正 + pity蓄積

※ cooldown中またはgrace中は遭遇しない
```

### EncounterEntry - 遭遇候補

| 項目 | 役割 |
|------|------|
| encounter | 実際の遭遇内容 |
| weight | 出現しやすさ |
| conditions | 出現条件 |

### EncounterSO - 遭遇内容

| 項目 | 役割 |
|------|------|
| id | 識別子 |
| enemyList | 出現する敵のリスト |
| enemyCount | 敵の数 |
| escapeRate | 逃走成功率 |
| onWin | 勝利時のイベント |
| onLose | 敗北時のイベント |
| onEscape | 逃走時のイベント |

### NodeSO側の遭遇設定

| 項目 | 役割 |
|------|------|
| encounterTable | このノードで使う遭遇テーブル |
| encounterRateMultiplier | このノードでの遭遇率補正（1.5で1.5倍など） |

---

## EventDefinitionSO - イベントの定義

全てのイベント（サイドオブジェクト、中央オブジェクト、門、遭遇結果等）は**EventDefinitionSO**で定義される。

### EventStep - イベントの1ステップ

| 項目 | 役割 |
|------|------|
| message | 表示するメッセージ |
| choices | 選択肢（あれば） |
| effects | このステップで適用するEffect |

### EventChoice - 選択肢

| 項目 | 役割 |
|------|------|
| label | 選択肢のラベル |
| effects | この選択肢を選んだ時のEffect |

### イベントの流れ

```
EventDefinitionSO
    │
    ├─ Step 1: message表示 → effects適用
    │
    ├─ Step 2: message表示 → choices表示 → 選択 → effects適用
    │
    └─ Step 3: message表示 → effects適用
```

---

## Condition / Effect - 条件と効果

### ConditionSO - 条件判定

| Condition | 判定内容 |
|-----------|----------|
| HasFlagCondition | フラグを持っているか |
| HasCounterCondition | カウンターが条件を満たすか |
| HasTagCondition | タグを持っているか |
| ChanceCondition | 確率判定 |
| StepsCondition | 歩数条件 |
| AllGatesClearedCondition | 全門クリア済みか |
| AndCondition | 複数条件のAND |
| OrCondition | 複数条件のOR |
| NotCondition | 条件の反転 |

### EffectSO - 効果の適用

| Effect | 効果 |
|--------|------|
| SetFlagEffect | フラグを設定/解除 |
| SetCounterEffect | カウンターを設定 |
| AddTagEffect | タグを追加 |
| RemoveTagEffect | タグを削除 |
| ShowMessageEffect | メッセージを表示 |
| LaunchBattleEffect | 戦闘を開始 |
| RestPartyEffect | パーティを回復 |
| CreateAnchorEffect | アンカーを作成（巻き戻し地点） |
| RewindToAnchorEffect | アンカーに巻き戻し |
| PushEncounterOverlayEffect | 遭遇率を一時的に変更 |
| RemoveEncounterOverlayEffect | 遭遇率変更を解除 |

---

## 状態管理と保存

### GameContext - ゲーム状態

歩行システムは以下の状態を管理する：

| 状態 | 内容 |
|------|------|
| Flags | on/offのフラグ（「ボス撃破」等） |
| Counters | 数値（「鍵の数」「討伐数」等） |
| Tags | タグの集合（複数付与可能） |
| WalkCounters | 歩数カウンター |
| GateStates | 各門のクリア状態 |
| EncounterState | 遭遇のcooldown/grace/pity状態 |
| SideObjectState | サイドオブジェクトのcooldown/履歴 |

### WalkCounters - 歩数の種類

| カウンター | 役割 |
|-----------|------|
| GlobalSteps | ゲーム開始からの総歩数 |
| NodeSteps | このノードでの歩数 |
| TrackProgress | 門/出口判定用の進捗（スルー/失敗でリセット） |

---

## 巻き戻し（Anchor/Rewind）

敗北や逃走時に、過去の状態に戻す機能。

### CreateAnchorEffect
- 現在の状態を保存（スナップショット作成）

### RewindToAnchorEffect
- 保存した状態に巻き戻し
- TrackProgress、門の状態、カウンター等が復元される

---

## まとめ: 歩行システムで実現できること

| やりたいこと | 使う機能 |
|-------------|----------|
| 歩くたびにランダムなイベント | サイドオブジェクト |
| 特定の場所で固定イベント | 中央オブジェクト / onEnterEvent |
| 進行を阻むチャレンジ | イベント門 |
| 複数の行き先から選択 | 出口候補 |
| ランダムに敵と遭遇 | 遭遇テーブル |
| 条件付きで出現/遷移 | Condition |
| フラグやカウンターを操作 | Effect |
| 失敗時にやり直し | Anchor/Rewind |
