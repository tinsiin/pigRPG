# ノード設定可能要素 完全一覧

**目的**: 歩行システムで想定されているノード設定要素を全て抽出し、不必要なものを省くための判断材料とする

---

## 1. NodeSO 基本構造

**出典**: `flow_graph_中核仕様_v_0_1_（暫定・歩行_分岐_遭遇の基盤設計）.md`

### 1.1 基本フィールド
- ✅ **nodeId**: ノードの一意識別子
- ✅ **tags**: タグ（グルーピング用）
- ✅ **onEnter**: ノード進入時のEffect
- ✅ **onExit**: ノード退出時のEffect
- ⚠️ **uiHints**: 背景/SE/演出ヒント
  - 背景画像
  - BGM/SE
  - 演出ヒント

### 1.2 イベント関連
- ✅ **sideObjects**: サイドオブジェクトテーブル（左右の寄り道）
- ✅ **encounters**: 遭遇テーブル（ランダムエンカウント）

---

## 2. Overlay（状況レイヤ）

**出典**: `flow_graph_中核仕様_v_0_1_（暫定・歩行_分岐_遭遇の基盤設計）.md`  
**概要**: 天候・警戒度・分岐モードなどの状況を重ねる仕組み

### 2.1 Overlayの種類（例示されているもの）
- ⚠️ **Night（夜）**: 遭遇率×1.3
- ⚠️ **Alert（警戒）**: 対人系重み+50%
- ⚠️ **天候**: 遭遇率や出現候補の倍率変更
- ⚠️ **Branch-X**: 特定サイドオブジェクトのみ解放
- ⚠️ **ExitBoost**: 出口確率を上げる

### 2.2 Overlayで制御できる内容
- **sideObjectMods**: カテゴリ/ID単位で×倍率/禁止
- **encounterMods**: 遭遇率×倍率、個別重み補正
- **onEnter**: Overlay適用時のEffect
- **onExit**: Overlay解除時のEffect

### 2.3 OverlayのトリガーとなるCondition
**出典**: `flow_graph_拡張案_v_0_1_（gate_track_pool_anchor_ほか）.md`
- ⚠️ **TimeOfDay**: 時間帯判定（朝/昼/夕/夜）
- **OverlayActive**: 特定Overlayが有効か

---

## 3. TrackConfig（内部トラック・進行管理）

**出典**: `flow_graph_拡張案_v_0_1_（gate_track_pool_anchor_ほか）.md`

### 3.1 進行管理
- ⚠️ **length**: 内部トラックの全長（例：100歩相当）
- ⚠️ **stepDelta**: 1手の基本進行量（既定=1）
- ⚠️ **progressKey**: 進捗カウンタ名

### 3.2 GateMarker（イベント門）
- ⚠️ **gateId**: 門の識別子
- ⚠️ **positionSpec**: 位置指定
  - `absSteps = n`: 絶対歩数で固定
  - `percent = 0..1`: 進捗割合
  - `range = [a..b]`: 入場時にシード付きで1度だけ位置を確定
- ⚠️ **spawnPolicy**: 出現ポリシー
  - `Always`: 常に出現
  - `RollOnEnter(p)`: 入場時に確率判定
  - `RollOnSegment(p)`: 区間ごとに判定
- ⚠️ **passConditions**: 通過条件（鍵・フラグ・確率・会話結果）
- ⚠️ **onPass**: 通過時の処理
  - `OpenAndAdvance`: 開放して前進
  - `Jump(node)`: 別ノードへ遷移
  - `SetFlag(..)`: フラグ設定
- ⚠️ **onFail**: 失敗時の処理
  - `JumpToAnchor(..)`: アンカーへジャンプ
  - `RewindToAnchor(..)`: 状態巻き戻し
  - `PlayHintSO(..)`: ヒント表示
  - `PushOverlay(..)+Jump(..)`: Overlay適用して遷移
- ⚠️ **blockingMode**: ブロックモード
  - `HardBlock`: 門解決に専念（左右・遭遇を停止）
  - `SoftBlock`: 左右は続行、前進のみ停止
- ⚠️ **repeatable**: 繰り返し可能か
- ⚠️ **cooldown**: クールダウン歩数
- ⚠️ **priority**: 優先度（同歩数で複数門が重なる場合）

### 3.3 Anchor / Rewind（巻き戻し）
- ⚠️ **anchorId**: アンカー識別子
- ⚠️ **nodeId**: 巻き戻し先ノード
- ⚠️ **snapshotKeys**: 巻き戻すキー白リスト
- ⚠️ **ttl**: 生存期間
- ⚠️ **scope**: 効果範囲（Node/Region/Graph）
- ⚠️ **復元モード**:
  - `PositionOnly`: 進捗位置だけ戻す
  - `PositionAndState`: 一部状態も復元

### 3.4 StayPolicy（滞在ポリシー）
- ⚠️ **FixedSteps(n)**: 最低n手滞在
- ⚠️ **SoftExit(curve)**: 滞在手数に応じて退出確率を上げる
- ⚠️ **ProgressGate(key, need)**: 進捗カウンタで出口開放

---

## 4. SideObjectTable（サイドオブジェクト・寄り道）

**出典**: `flow_graph_中核仕様_v_0_1_（暫定・歩行_分岐_遭遇の基盤設計）.md`

### 4.1 テーブル設定
- ✅ **entries**: サイドオブジェクトエントリのリスト
  - `sideObject`: サイドオブジェクトSO
  - `weight`: 重み
  - `conditions`: 出現条件
  - ⚠️ `fixedOnEnter`: 入場時に固定提示するか
  - ⚠️ `cooldownSteps`: クールダウン歩数
- ⚠️ **varietyBias**: 連発抑止設定
  - 履歴長（例：4）
  - 同カテゴリ連続制限（例：2回まで）
  - 減衰率

### 4.2 SideObjectSO（個別）
- ✅ **id**: 識別子
- ⚠️ **category**: カテゴリ（連発抑止用）
- ✅ **uiLabel**: UI表示ラベル
- ✅ **effects**: 選択時のEffect
- ⚠️ **exclusiveKey**: 排他キー（同時出現防止）
- ⚠️ **oneShot**: 一度きりか
- ⚠️ **cooldownSteps**: クールダウン歩数

### 4.3 SpawnSource（候補ソースの合流）
**出典**: `flow_graph_拡張案_v_0_1_（gate_track_pool_anchor_ほか）.md`
- ⚠️ **type**: ソースタイプ
  - `LocalEntries`: ローカルエントリ
  - `PoolRef`: 共有プール参照
  - `TagQuery`: タグで候補を拾う
- ⚠️ **filters**: このソースに限る条件
- ⚠️ **weightScale**: 倍率
- ⚠️ **scope**: oneShot/cooldown/exclusiveの効き先
  - `Node`: ノード内のみ
  - `Region(tag)`: タグで括った範囲
  - `Graph`: グラフ全体

---

## 5. EncounterTable（遭遇テーブル）

**出典**: `flow_graph_中核仕様_v_0_1_（暫定・歩行_分岐_遭遇の基盤設計）.md`

### 5.1 テーブル設定
- ✅ **baseRate**: 基本遭遇率（0〜1、メモリレス）
- ✅ **entries**: 遭遇エントリのリスト
  - `encounter`: 遭遇SO
  - `weight`: 重み
  - `conditions`: 出現条件
- ⚠️ **varietyBias**: 連発抑止設定
- ⚠️ **suppressionRules**: 遭遇全体を抑止する条件

### 5.2 EncounterSO（個別）
- ✅ **id**: 識別子
- ⚠️ **tags**: タグ
- ✅ **resolver**: 遭遇解決方法
  - 戦闘/会話/取引/分岐/複合
- ✅ **onStart**: 開始時Effect
- ✅ **onEnd**: 終了時Effect

### 5.3 遭遇率の追加制御
**出典**: `歩行システム導入アプローチ（会話先行・最小コア）v_0.md`
- ⚠️ **M_overlay**: Overlay倍率（夜/警戒/天候など）
- ⚠️ **M_area**: 難易度/地形での倍率
- ⚠️ **M_story**: ストーリー抑制/強制（0 or 1以上）
- ⚠️ **R_pity(t)**: 遭遇間隔の揺らぎ抑制（線形ランプ/ハザード制御）
- ⚠️ **graceSteps**: 入場直後の遭遇猶予期間
- ⚠️ **cooldownSteps**: 遭遇直後の連発抑止
- ⚠️ **minGapSteps / maxGapSteps**: 最小/最大間隔のハードガード
- ⚠️ **softCap**: 同カテゴリ連続時の重み指数減衰

---

## 6. AmbientTalkTrigger（独立会話トリガ）

**出典**: `歩行システム導入アプローチ（会話先行・最小コア）v_0.md`

### 6.1 トリガー設定
- ✅ **type**: トリガータイプ
  - `Step`: 歩数（例：5歩目で発火）
  - `Random`: ランダム（確率p）
  - `Flag`: フラグ（特定フラグが立ったら）
- ⚠️ **stepMin**: 最小歩数（Stepタイプ）
- ⚠️ **p**: 確率（Randomタイプ）
- ⚠️ **flagKey**: フラグキー（Flagタイプ）
- ✅ **dialogue**: 会話定義SO
- ⚠️ **once**: 一度きりか
- ⚠️ **cooldownSteps**: クールダウン歩数

---

## 7. ExitCandidate（出口候補）

**出典**: `歩行システム導入アプローチ（会話先行・最小コア）v_0.md`

### 7.1 出口設定
- ✅ **toNodeId**: 遷移先ノードID
- ⚠️ **uiLabel**: UI表示ラベル（選択肢）
- ✅ **conditions**: 出口の開放条件
- ⚠️ **weight**: 重み（複数出口がある場合の抽選）

---

## 8. WeightMod / CurveByCounter（動的重み補正）

**出典**: `flow_graph_拡張案_v_0_1_（gate_track_pool_anchor_ほか）.md`

- ⚠️ **Multiply(factor)**: 固定倍率
- ⚠️ **CurveByCounter(key, AnimationCurve)**: カウンタに応じた曲線補正
  - 例：`sideTripCount`に応じて×1.0→×1.8へ漸増
- ⚠️ **When(condition){...}**: 条件付き補正

---

## 9. EventDefinition（イベントカーネル）

**出典**: `event_kernel_拡張可能イベント機構_設計ドキュメント_v_0.md`

### 9.1 イベント定義
- ✅ **id**: イベント識別子
- ⚠️ **tags**: タグ
- ⚠️ **releaseFlags**: リリース出し分けフラグ
- ✅ **conditions**: 発火条件
- ✅ **steps**: イベントステップ（Dialog/Puzzle/CombatHandoff等）
- ✅ **terminalEffects**: 終了時の確定Effect

### 9.2 OutcomeHook（遭遇結果フック）
- ⚠️ **outcome**: 戦闘結果（Win/Escape/Lose/Purchase）
- ⚠️ **conditions**: フック条件
- ⚠️ **effects**: 適用Effect
- ⚠️ **emitEventId**: 発火するイベントID
- ⚠️ **priority**: 優先度

---

## 10. Condition（条件DSL）

**出典**: 各設計書

### 10.1 基本Condition
- ✅ **HasFlag(key)**: フラグ所持
- ✅ **HasItem(id)**: アイテム所持
- ✅ **HasTag(tag)**: タグ所持
- ⚠️ **Visited(node)**: ノード訪問済み
- ⚠️ **Chance(p)**: 確率判定
- ⚠️ **OverlayActive(name)**: Overlay有効
- ⚠️ **TimeOfDay(...)**: 時間帯判定
- ⚠️ **StepCountInArea >= N**: エリア内歩数
- ⚠️ **VisitedCountSinceAreaEntry >= K**: エリア入場からの歩数
- ⚠️ **EnemyTag==X**: 敵のタグ判定
- ⚠️ **プレイヤーLv**: レベル判定
- **合成**: `Not`, `And`, `Or`

---

## 11. Effect（効果DSL）

**出典**: 各設計書

### 11.1 基本Effect
- ✅ **SetFlag(key)**: フラグ設定
- ✅ **UnsetFlag(key)**: フラグ解除
- ✅ **AddTag(tag)**: タグ追加
- ✅ **RemoveTag(tag)**: タグ削除
- ⚠️ **PushOverlay(id)**: Overlay適用
- ⚠️ **PopOverlay(id)**: Overlay解除
- ⚠️ **UnlockEdge(edgeId)**: エッジ開放
- ⚠️ **LockEdge(edgeId)**: エッジロック
- ✅ **Jump(nodeId)**: ノードへ遷移
- ⚠️ **EmitEvent(eventId)**: イベント発火
- ⚠️ **IncCounter(key)**: カウンタ加算
- ⚠️ **DecCounter(key)**: カウンタ減算
- ⚠️ **Heal(X or Full)**: HP回復

---

## 12. FeatureFlags / ReleaseFlags（段階リリース）

**出典**: `flow_graph_中核仕様_v_0_1_（暫定・歩行_分岐_遭遇の基盤設計）.md`

### 12.1 フラグ制御
- ⚠️ **featureFlags**: FlowGraphSOに設定
- ⚠️ **releaseTags**: Node/SideObject/Encounterに付与
- ビルド時にフィルタリング
- データは前方互換（未知フィールド無視）

---

## 判定: 必要度マーキング

### ✅ **必須要素**（基本機能に必要）
- nodeId, tags, onEnter/onExit
- sideObjects, encounters
- 基本Condition（HasFlag, HasItem, HasTag）
- 基本Effect（SetFlag, UnsetFlag, AddTag, RemoveTag, Jump）
- encounters基本設定（baseRate, entries）
- dialogue, ambientTalks
- exitCandidates

### ⚠️ **拡張要素**（将来的に実装・不要なら省略可能）
- **Overlay関連全般**（Night, Alert, 天候, TimeOfDay等）
- **TrackConfig関連全般**（length, stepDelta, GateMarker等）
- **Anchor/Rewind**（巻き戻し機能）
- **StayPolicy**（滞在ポリシー）
- **varietyBias**（連発抑止）
- **SpawnSource**（共有プール、TagQuery）
- **WeightMod/CurveByCounter**（動的重み補正）
- **OutcomeHook**（戦闘結果フック）
- **FeatureFlags/ReleaseFlags**（段階リリース）
- **遭遇率の高度な制御**（pity, grace, cooldown, softCap等）
- **uiHints**（背景/SE/演出ヒント）
- **固定提示**（fixedOnEnter）
- **exclusiveKey, oneShot, cooldownSteps**（サイドオブジェクト）

---

## 推奨削減候補（最小実装向け）

### 確実に省けるもの
1. **Overlay全般** - Night, 天候, TimeOfDayなど状況レイヤ
2. **TrackConfig全般** - 内部歩数管理、GateMarker
3. **Anchor/Rewind** - 状態巻き戻し機能
4. **StayPolicy** - 滞在ポリシー（FixedSteps等）
5. **varietyBias** - 連発抑止（初期は単純ランダムでOK）
6. **SpawnSource拡張** - 共有プール、TagQuery（ローカルエントリのみ）
7. **WeightMod/CurveByCounter** - 動的重み補正
8. **OutcomeHook** - 戦闘結果フック（通常処理のみ）
9. **FeatureFlags/ReleaseFlags** - 段階リリース機能
10. **遭遇率の高度制御** - pity, grace, softCap等
11. **uiHints** - 背景/SE/演出ヒント（直接指定で対応）

### 判断が必要なもの
- **cooldownSteps** - クールダウン（連発抑止の最小版、あると便利）
- **oneShot** - 一度きりフラグ（あると便利）
- **exclusiveKey** - 排他キー（複雑なら省略可）
- **weight** - 重み（複数候補がある場合は必要）
- **uiLabel** - UIラベル（選択肢表示に必要）

---

## 最小構成の推奨

### NodeSOの最小構成
```csharp
public class NodeSO : ScriptableObject {
    public string nodeId;
    public string[] tags;
    public EffectSO[] onEnter;
    public EffectSO[] onExit;
    public SideObjectTableSO sideObjects;      // または null
    public EncounterTableSO encounters;        // または null
    public AmbientTalkTrigger[] ambientTalks;  // または null
    public ExitCandidate[] exits;
}
```

### 削減後の利点
- 実装工数: **半減以下**（4週間 → 2週間程度）
- データ作成: **シンプル**（複雑な設定不要）
- デバッグ: **容易**（追跡する要素が少ない）
- 拡張性: **保持**（後から追加可能な設計）

---

**結論**: Overlay、TrackConfig、Anchor/Rewindを削除するだけで大幅に簡素化できます。
