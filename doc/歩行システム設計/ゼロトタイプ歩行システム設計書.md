ゼロトタイプ歩行システム設計書

目的
- 歩行・分岐・遭遇・イベント門・サイドオブジェクトを1つの設計に統合し、現段階で実装可能な最小コアと拡張点を明文化する。
- 既存BattleManager/WatchUIUpdateと共存しつつ、将来の拡張を阻害しない構造を維持する。

スコープ
- 歩行の進行制御、分岐、遭遇、サイドオブジェクト、イベント門、イベント統一実行基盤（Event Kernel）。
- 戦闘UIや戦闘ロジックの詳細は非スコープ（既存BattleManagerに委譲）。

前提（運用ルール）
- 歩行中のイベントはUnityのシーン分割を行わず、同一シーン内のUI/アニメーションで実行する。
- サイドオブジェクトは一本道の「寄るだけのイベント装置」として扱う。
- 自動戦闘は前提にしない（敵AIはBattleAIBrain等で処理）。

用語整理
- ノード: 歩行の1サイクル単位で処理される場面。
- エッジ: ノード間の遷移。
- ステージ: 運用上のまとまり。基本は「1ノード=1ステージ」運用で開始し、必要なら複数ノードで1ステージを構成する。
- アプローチオブジェクト: 歩行中に出現し、プレイヤーがアプローチまたはスルーを選択できる視覚的オブジェクトの総称。
  - 通常オブジェクト: サイドオブジェクト、中央オブジェクト（共存可能）
  - ユニークオブジェクト: イベント門、出口（排他的に出現、他のオブジェクトと共存しない）
- サイドオブジェクト: 左右に出現する寄り道イベント。イベント本体を宿す容器。
- 中央オブジェクト: 中央に画像として出現するイベント。会話や戦闘など様々なイベントの容器。
- イベント門: 中央に出現するゲート。固定位置で発生し、通過条件を持つ。「突破できるかどうか」のゲームプレイを提供する。
- 出口: ノード遷移のためのオブジェクト。アプローチ後に次エリア選択UIを表示する。

コア構造
- FlowGraph: Nodeとexits（ExitCandidate）で進行を表現する。
- GameState: フラグ/タグ/カウンタ/乱数シード/進捗などの状態。
- DSL: Condition/Effectで条件判定と副作用を定義。
- Event Kernel: EventDefinition/EventHost/EventRunnerでイベント実行を統一する。

視覚オブジェクト/Presenter層
- 見た目はPresenterに分離し、ロジックはEvent Kernelに統一する。
- Presenterは「生成/表示/アニメ/破棄」だけを担当し、状態変更はEffect経由で行う。
- サイドオブジェクトPresenter
  - 左右ペアのPrefabを表示する。既存のLine描画（UILineRenderer）やSideObjectMoveのアニメを利用してよい。
  - エディタ拡張（位置/スケール/回転の記録）を使って見た目調整を行う。
- 中央オブジェクトPresenter
  - 画像ベース（Sprite/UI Image）を基本とし、サイドのプログラム描画とは別系統で扱う。
  - 中央オブジェクト、イベント門、出口を同じPresenterで表示する。
- 共通方針
  - 全てのアプローチオブジェクトは、プレイヤーがアプローチまたはスルー（歩行ボタン）を選択する。
  - 強制イベント（自動トリガ）は以下の方法で実現する:
    - onEnter/onExit: ノード入場・退場時の即時発火
    - 歩数トリガー: 指定歩数到達で自動発火
    - 確率トリガー: 毎歩の確率判定で自動発火
  - 強制イベントは歩行を一時停止し、完了後に歩行を再開する。
  - ロジックは共通、見た目は別（中央は中央専用UI、サイドは左右UI）。

中央オブジェクトPresenter仕様（具体）
- 目的: 中央オブジェクト、イベント門、出口を画像で表示し、Event Kernelの起動口を統一する。
- Prefab構成（例）
  - CentralObjectPresenter（RectTransform）
    - Image（本体Sprite）
    - BackImage（門/出口の背面Sprite）
    - TMP_Text（任意のラベル）
    - Button/Collider（クリック判定）
    - CanvasGroup（フェード/ブロック制御）
- 表示データ（CentralObjectVisual）
  - sprite, size, anchor, offset, tint, label
  - backSprite, backTint, backOffset
  - appearAnim, hideAnim, sfx（任意）
- フロー（全てのアプローチオブジェクト共通）
  1) オブジェクトが出現条件を満たす
  2) CentralObjectPresenter.Show(visual) でビジュアルとボタンを表示
  3) プレイヤーがアプローチボタンをクリック → EventHost.Trigger でイベント実行
  4) プレイヤーが歩行ボタンを押す → スルー（イベントは実行されない）
  5) Effect適用後にHide
- 既存UIとの接続
  - MessageDropper/CreateAreaButtonを使う場合は中央表示を維持し、選択完了でHideする。
  - WatchUIUpdateに中央Presenterの親Rectを持たせ、同一シーン内で制御する。
- 描画順の方針
  - BackImage（門/出口）→ CentralObject（前面）の順に重ねる。
  - サイドオブジェクトとは独立したレイヤで描画する。

Unityでの作業フロー（運用ガイド）
- 目的: 「どのノードにどのイベントを入れるか」をUnity上で具体的に操作できる状態にする。
- 作成するSO一覧（プロジェクト内で資産化する単位）
  - FlowGraphSO: ノードの一覧（進行の全体像）。各NodeSOのexitsで接続を定義。
  - NodeSO: ノード単位の設定（sideObjects/encounters/gates/exits/centralObject）。
  - SideObjectTableSO / SideObjectSO: サイドオブジェクトの候補と個別定義。
  - EncounterTableSO / EncounterSO: 遭遇候補と個別定義（戦闘/会話/取引）。
  - EventDefinitionSO: イベント本体（EventStepの並びとEffects）。中央オブジェクトのイベントもここで定義。
- 配置の流れ（最短）
  1) EventDefinitionSOを作成（例: 戦闘起動/推理/会話）。
  2) SideObjectSOまたはEncounterSOからEmitEvent/Effectで参照する。
  3) SideObjectTableSO/EncounterTableSOにエントリを追加する。
  4) NodeSOにsideObjects/encounters/gates/exitsを設定する。
  5) FlowGraphSOにノードを登録し、NodeSO.exitsでノード間の接続を定義する（Choice/Conditional/Weightedなど）。
     歩行フローの遷移は出口候補（ExitCandidate）で制御し、Auto遷移は使わない。
- 既存Manager連携（例）
  - BattleManager起動: EncounterSOのresolverやEventStepでLaunchBattleEffectを呼ぶ。
  - 中央オブジェクト: CentralObjectPresenterで表示し、アプローチ時にEventHost.Triggerで実行。会話/戦闘など様々なイベントを起動可能。
  - イベント門/出口: 中央オブジェクトと同じPresenterで表示。アプローチ時に条件判定または遷移選択UIを表示。
- エディタ拡張の想定
  - まずはInspectorで配列編集（NodeSO/FlowGraphSO）。
  - 後からGraph Toolkitでノード/出口/門位置を可視化する。
  - SimRunner/Validatorで抽選結果・条件の検証を行う。
- 注意点
  - 旧StageData/StageCutからの移行はNodeSOへの変換スクリプトで行う。
  - UIの見た目はPresenter層で統一し、ロジックはEvent Kernel側で固定する。

歩行サイクル（1歩の更新順序）
1) サイドオブジェクト更新（左右ペアの見た目更新）
2) 中央オブジェクト更新（門/出口の出現判定と背面描画）
3) 遭遇判定（BattleManager起動の有無を決定）
4) 遭遇が発生した場合は戦闘へ移行し、復帰後に同じサイド/中央へアプローチ選択（再抽選しない）
5) 進捗更新と次歩行へ

サイドオブジェクト仕様
- 歩数に依存せず、毎歩ランダム抽選で更新する。
- 左右ペア提示を基本とし、どちらか一方のみ選択可能。選ばれなかった側は次の歩行で更新。
- fixedOnEnter指定は固定提示可。繰り返し抑止はvarietyBias/cooldownで管理。
- サイドオブジェクトはイベントを起動する容器であり、Event Kernelを通じて実行する。
- 表示は左右Prefabを前提とし、SideObjectMove/UILineRendererによるアニメと相性が良い。
- アプローチ（選択）は遭遇判定の後に可能になる。
- 遭遇が発生した歩は、戦闘後に同じサイド/中央へアプローチできる（再抽選しない）。
- 逃走/敗北で巻き戻しが発生した場合は、歩数なしリフレッシュでサイド/中央を再抽選する。
- 将来的に「安息地帯」イベントは片側のみ固定提示できる（例: 右だけ病院固定、反対側は通常抽選）。

遭遇仕様
- メモリレス判定（1歩ごとにbaseRate×倍率でロール）。
- Overlayやエリア倍率で遭遇率を補正。
- cooldown/grace/pityで体感のムラを抑制。

逃走/敗北時の巻き戻し（設計枠）
- 逃走/敗北時は歩行システムの進捗を巻き戻すためのフックを用意する。
- 仮実装としては「10歩巻き戻し」を既定とする。
- トリガはEncounterのOutcomeHook（Lose）またはEventStepからRewindToAnchor/JumpToAnchorを実行する。
- 巻き戻し対象は歩数/内部進捗/門の解除状態/出口出現判定など歩行系の進捗を含む。
- 巻き戻し先はAnchor（nodeId/anchorId）で指定し、PositionOnly/PositionAndStateを切り替え可能にする。
- 巻き戻し直後に「歩数を進めない歩行リフレッシュ」を1回挟める（サイド/中央の再抽選のみ、遭遇ロールはスキップ）。
- 詳細（復元対象キーや門/出口の扱い）は実装開始時に確定する。

イベント門仕様

基礎設計の意図
- 門は「出口への障壁」である。全ての門をクリアしないと出口に到達できない。
- 門は連番で並び、順番にクリアして出口に向かう構造を基本とする。
- 門の役割は「突破すべき障壁」に限定し、オプショナルな挑戦要素は別の仕組み（サイドオブジェクト、中央オブジェクト、onEnter等の強制イベント）で実現する。
- この役割分担により、各システムの責務が明確になり、疎結合を保てる。

出現と再出現
- 門は中央に出現し、内部進捗（TrackConfig）による固定位置（歩数または確率）で発生する。
- 複数門を1ノード内に設置可能。orderで解決順を制御する。
- 門は「段階的に解除される」仕様をサポートする。
  - 例: Gate01→Gate02→Gate03→Gate04の順に解除。
  - 解除条件はフラグ/カウンタ/条件式で表現し、次の門は前門の解除後のみ有効。
- Gateを全て解除したとき、出口条件を満たしていれば出口が開く。

スルー/失敗時の動作
- プレイヤーが門をスルーまたは失敗した場合、該当Gateの進捗は0に戻る。
- 進捗リセット後、再度歩いて門の位置に到達すると再出現する。
- 例: position=20なら、スルー/失敗後に20歩歩くと再び門が出現する。
- このタイムラグ（再出現までの歩数）が冒険性を生む。
  - タイムラグの間に他のイベント（サイドオブジェクト、遭遇等）に遭遇する。
  - 情報収集や材料獲得の機会となる。
  - 突破のための準備や判断材料を得られる。

クリア時の動作
- 門をクリアしたら、その門は消滅する（二度と出現しない）。
- 「何度クリアしても出現する門」は本システムでは扱わない（後述の非機能要件を参照）。

表示と操作
- 門はイベントの一種であり、Event Kernelで同一形式により実行可能。
- 門は中央オブジェクトPresenterで表示し、画像ベースの表現を採用する。
- 排他性: 門が出現する歩では、サイドオブジェクトや中央オブジェクトは出現しない。門は「突破チャレンジ」として単独で提示される。
- インタラクション: 門が出現するとアプローチボタンが表示され、プレイヤーはアプローチ（条件判定）またはスルー（歩行ボタン）を選択できる。

出口仕様
- 歩行による遷移は必ず出口アプローチを経由する（Auto遷移は歩行フローでは使用しない）。
- 出口候補が1つのみでも、出口オブジェクトのアプローチ後に選択UIを必ず表示する（分岐の有無に関わらず体験を統一）。
- 門が存在しないノードでは、出口は歩数または確率で出現する。
  - 歩数: 指定歩数到達で出口出現。スルーされた場合は歩数カウンタをリセットし、再度ループ。
  - 確率: 歩行ごとにロールし、成立した歩で出口出現。スルーされた場合は次の歩で再ロール。
- 門が存在するノードでは、全門解除後にのみ出口が出現する。
- 出口は中央オブジェクトの背面に描画され、アプローチ時に次エリア選択UIを開く。
- 出口/門のBackObjectは中央オブジェクトと同様、画像（Sprite/UI Image）で扱う。
- 出口の選択肢はフラグ条件で一択または複数を制御できる。
- 排他性: 出口が出現する歩では、サイドオブジェクトや中央オブジェクトは出現しない。出口はノード遷移の明示的な選択として単独で提示される。
- インタラクション: 出口が出現するとアプローチボタンが表示され、プレイヤーはアプローチ（遷移選択UI）またはスルー（歩行ボタン）を選択できる。

強制イベント仕様

基本設計
- 強制イベントはプレイヤーの選択なしに自動発火するイベントである。
- アプローチオブジェクト（サイド/中央/門/出口）とは独立したシステムとして設計する。
- 強制イベント発火時は歩行を一時停止し、イベント完了後に歩行を再開する。

発火タイミング
- onEnter/onExit: ノード入場・退場時に即時発火（既存）。
- 歩数トリガー: 指定歩数到達で自動発火。
- 確率トリガー: 毎歩の確率判定で自動発火。

強制イベントトリガー（ForcedEventTrigger）
- triggerId: 消費済み管理用の一意ID。
- type: Steps（歩数）/ Probability（確率）。
- stepCount: 歩数条件（type=Steps時）。
- probability: 確率条件 0-1（type=Probability時）。
- conditions: 追加条件（フラグ等）。
- consumeOnTrigger: true=1回限り、false=繰り返し可。
- cooldownSteps: 再発火までの歩数（0=即再発火可）。
- maxTriggerCount: 最大発火回数（0=無制限）。
- dialogue/event: 発火するイベント本体。

発火制御
- 1歩で最大1件の強制イベントのみ発火する（多重発火防止）。
- 遭遇判定の前に強制イベント判定を行う。
- 強制イベント発火時はサイド/中央オブジェクトの抽選をスキップする。
- 消費済み/クールダウン/最大回数の状態はGameContextで管理する。

歩行サイクルへの統合
- WalkStep()内の処理順序:
  1) 強制イベント判定（新規）
  2) サイドオブジェクト更新
  3) 中央オブジェクト更新（門/出口の出現判定）
  4) 遭遇判定

アプローチオブジェクトとの役割分担

| システム | 役割 | 発火方式 |
|----------|------|----------|
| onEnter/onExit | ノード入退場時のイベント | 即時・自動 |
| 強制イベントトリガー | 歩数/確率による自動イベント | 自動 |
| サイドオブジェクト | 寄り道イベント | プレイヤー選択 |
| 中央オブジェクト | 様々なイベントの容器 | プレイヤー選択 |
| イベント門 | 出口への障壁 | プレイヤー選択 |
| 出口 | ノード遷移の選択 | プレイヤー選択 |

分岐仕様
- 分岐はExitCandidateで表現する。歩行の遷移は必ず出口アプローチで決定する。
- Auto遷移は歩行フローでは使用しない（イベントのJump/強制遷移は例外）。
- 既存ステージデータの「エリア分岐」は、Node/ExitCandidateに変換して扱う。

データ構造（概略）
- Node
  - nodeId, tags, onEnter/onExit
  - sideObjects, encounters
  - trackConfig (length, stepDelta, progressKey)
  - gates: GateMarker[]
  - exitSpawn: ExitSpawnRule
  - exits: ExitCandidate[]
  - forcedEventTriggers: ForcedEventTrigger[]（新規）
- GateMarker
  - gateId, order, positionSpec
  - passConditions, onPass, onFail
  - visual (GateVisual)
- ForcedEventTrigger（新規）
  - triggerId, type (Steps/Probability)
  - stepCount, probability
  - conditions: ConditionSO[]
  - consumeOnTrigger, cooldownSteps, maxTriggerCount
  - dialogue/event: EventDefinitionSO

統合ポイント
- BattleManager: 既存の戦闘処理をそのまま起動する（IBattleRunner経由）。
- DialogueRunner: 会話/ノベルパートを起動する（IDialogueRunner経由、将来実装）。
- WatchUIUpdate/MessageDropper/CreateAreaButton: 既存UIを流用する。
- Unityシーンは分割せず、イベントは同一シーン内のUI/演出として実装する。

拡張インターフェース設計
- GameContextに各種Runnerを統合し、疎結合を維持する。
- IBattleRunner: 戦闘処理の抽象化（実装済み）。
- IDialogueRunner: 会話/ノベルパート処理の抽象化（将来実装）。
- IEventUI: メッセージ/選択肢表示の抽象化（実装済み）。
- INovelEventUI: 立ち絵/背景/雑音を含む拡張UI（将来実装、IEventUIを継承）。

既存実装との整合・移行メモ
- 目的: 旧ステージ設計とNowProgress依存をノード/出口前提に置き換えるための整理。
- 旧ステージ→ノード移行（計画）
  - StageData/StageCut/AreaDates: 1 AreaDate = 1 NodeSOで直列化。分岐はExitCandidateに変換する。
  - NextID/NextStageID/選択肢: ExitCandidate（toNodeId/uiLabel/conditions）へ移行する。
  - EncounterRate/EscapeRate: EncounterTableSO.baseRate/EncounterSO側の設定へ移行する。
  - _sideObject_Lefts/_sideObject_Rights: SideObjectTableSO.entriesへ移行する（weight/conditions付与）。
  - StageThemeColorUI/MapLine: NodeのuiHints/Presenter設定へ移行する。
  - StageID/AreaID/NowProgress: nodeId + trackProgress + walkCountersに置換する。
- 合わない要素（要調整）
  - NowProgressを「移動距離」として使う処理（再遭遇/復活歩数）が、ノード遷移/巻き戻しと衝突する。
  - 再遭遇コールバックが「前回遭遇との差分=距離」をNowProgressで計算しており、ノード切替や巻き戻しで距離が壊れる。
  - 敵の復活歩数（RecovelySteps）がNowProgress差分に依存しており、巻き戻し時に早期復活/遅延復活が起きうる。
  - NowProgressをAreaDatesのインデックスに使う線形前提（一本道）が、分岐グラフと整合しない。
  - NowProgress前提の線形マップUIが、分岐グラフと整合しない。
  - EncounterRate/EscapeRateがStageDataに結び付いており、ノード単位のEncounterTableへ移し替えが必要。
  - 歩行効果（パッシブ減衰/回復/属性ポイント減衰）が歩数カウンタと直結しており、巻き戻し後の「歩数なしリフレッシュ」と混線する。
  - 歩行効果が「歩数=進捗」と結び付いているため、歩数なしリフレッシュの挙動を分離する必要がある。
- 対応方針（設計）
  - WalkCountersを新設（globalSteps/nodeSteps/trackProgress）し、用途ごとに参照を分ける。
  - 再遭遇/復活はglobalStepsまたはnodeStepsで判定し、巻き戻し時の戻し方を仕様で決める。
  - 再遭遇/復活は「前回遭遇時のglobalSteps」を持たせ、巻き戻しの影響を受けない方式も選択肢にする。
  - 歩数なしリフレッシュ用に「視覚更新のみ」の更新パスを用意し、歩数カウンタや歩行効果を通さない。
  - UIはノード内進捗バー/門位置表示に切り替え、線形マップ依存を廃止する。
  - BattleManager自体は独立して呼び出せるため、歩行側のEncounterResolverから起動する。

保存・再現性
- 進捗（trackProgress/stepCount）、門の解除状態、cooldown、variety履歴、乱数シードを保存対象とする。
- デバッグ用途でロールログ（候補/除外理由/重み/結果）を保持する。

実装フェーズ（最短）
- Phase 0: FlowGraph/AreaController/WalkStateで歩行ループを稼働。
- Phase 1: Event Kernelでイベント実行を統一。
- Phase 2: TrackConfig + GateMarkerで固定門/順次解除/ループ歩数を実装。

備考
- 本書は「現段階の最新設計の単一ソース」とする。他ドキュメントは参照用に留め、仕様の更新は本書を優先する。

---

実装状況（2026-01-19 更新）

概要
- 本設計書に記載された機能は、意図的に最小実装としたものを除き、すべて実装完了。
- 実装ベース: Assets/Script/Walk/

実装完了項目

コア構造
- [x] FlowGraphSO: Node/ExitCandidate進行表現
- [x] GameContext: フラグ/タグ/カウンタ/乱数シード/進捗
- [x] DSL: ConditionSO/EffectSO による条件判定と副作用
- [x] Event Kernel: EventDefinitionSO/EventHost/EventRunner

視覚オブジェクト/Presenter層
- [x] サイドオブジェクトPresenter: 左右ペア表示
- [x] 中央オブジェクトPresenter: CentralObjectPresenter.cs
- [x] GateVisual/ExitVisual: 門/出口の視覚表現

中央オブジェクトPresenter
- [x] ボタン表示とアプローチ/スルー選択
- [x] SFX再生: WalkSFXPlayer/SFXDatabaseSO
- [x] blockingMode/centerTriggerMode廃止: 全てのアプローチオブジェクトでボタン表示に統一（2026-01-21実装）
- [ ] appear/hideアニメ: 意図的に最小実装（将来拡張）

歩行サイクル
- [ ] 強制イベント判定（新規：ノベルパート実装時に追加）
- [x] サイドオブジェクト更新
- [x] 中央オブジェクト更新（門/出口の出現判定）
- [x] 遭遇判定
- [x] 遭遇後の再抽選スキップ（RequestRefreshWithoutStep）
- [x] 進捗更新

強制イベント仕様
- [ ] ForcedEventTrigger: 歩数/確率トリガー定義（新規）
- [ ] ForcedEventState: 消費済み/クールダウン/発火回数管理（新規）
- [ ] ForcedEventStateManager: 状態管理（新規）
- [ ] AreaController.CheckForcedEvents(): 発火判定（新規）

サイドオブジェクト仕様
- [x] 毎歩ランダム抽選
- [x] 左右ペア提示、未選択側は次歩で更新
- [x] fixedOnEnter: ノード入場時の固定提示
- [x] varietyBias/cooldown: 繰り返し抑止
- [x] VarietyHistoryIndex/NodeSeed連動
- [x] conditions: 出現条件

遭遇仕様
- [x] メモリレス判定（baseRate×倍率）
- [x] EncounterOverlay: 一時的な遭遇率補正スタック
- [x] NodeSO.encounterRateMultiplier: エリア倍率
- [x] cooldown/grace/pity: EncounterState で管理
- [x] EncounterState の保存/復元

逃走/敗北時の巻き戻し
- [x] Anchor/AnchorManager: 巻き戻し先の定義と管理
- [x] WalkAnchorData: アンカー状態の保存/復元
- [x] RequestRefreshWithoutStep: 歩数なしリフレッシュ

イベント門仕様
- [x] TrackConfig による固定位置発生
- [x] 複数門 + order による優先度
- [x] 段階的解除（前門解除後に次門有効）
- [x] スルー/失敗時の進捗リセットと再出現
- [x] クリア時の門消滅
- [x] GateRuntimeState/GateResolver
- [x] 門状態の保存/復元
- [ ] repeatable/cooldown/resetOnSkip/resetOnFail/resetTarget の削除（非機能要件により廃止）

出口仕様
- [x] ExitSpawnRule: 歩数(Steps)/確率(Probability)/門解除後(AfterGates)
- [x] ExitCandidate: 条件/重み付き出口候補
- [x] ExitResolver: 条件評価と重み付き選択

分岐仕様
- [x] ExitCandidate による分岐表現
- [x] ExitSelectionMode: ShowAll/WeightedRandom

状態管理
- [x] フラグ (flags): SetFlag/HasFlag
- [x] カウンタ (counters): SetCounter/GetCounter
- [x] タグ (tags): AddTag/RemoveTag/HasTag
- [x] HasTagCondition: タグ条件SO

会話/メッセージ
- [x] DialogueDefinitionSO: 会話定義の骨格（最小実装）
- [x] DialogueNode: 会話ノード構造（最小実装）
- [x] ShowMessageEffect: メッセージ表示Effect
- [ ] ConversationRunner: 会話実行エンジン（将来実装）

保存・再現性
- [x] WalkProgressData: 進捗/門状態/cooldown/variety/seed/タグの保存
- [x] EncounterStateData: 遭遇状態の保存
- [x] SideObjectState: サイドオブジェクト状態の保存
- [x] EncounterOverlayData: 永続オーバーレイの保存

デバッグ/検証ツール
- [x] WalkDebugLog: ロール履歴のシングルトン
- [x] RollLogEntry: ロールログエントリ
- [x] GraphValidator: グラフ整合性検証（Editor）
- [x] SimRunner: N歩シミュレーション（Editor）

主要ファイル一覧

新規作成
- Assets/Script/Walk/ExitResolver.cs
- Assets/Script/Walk/Encounter/EncounterOverlay.cs
- Assets/Script/Walk/Audio/WalkSFXPlayer.cs
- Assets/Script/Walk/Audio/SFXDatabaseSO.cs
- Assets/Script/Walk/Conditions/HasTagCondition.cs
- Assets/Script/Walk/Dialogue/DialogueDefinitionSO.cs
- Assets/Script/Walk/Dialogue/DialogueNode.cs
- Assets/Script/Walk/Effects/ShowMessageEffect.cs
- Assets/Script/Walk/Debug/WalkDebugLog.cs
- Assets/Script/Walk/Debug/RollLogEntry.cs
- Assets/Script/Walk/SideObjects/SideObjectSelector.cs
- Assets/Script/Walk/SideObjects/SideObjectState.cs
- Assets/Script/Walk/SideObjects/SideObjectCooldownTracker.cs
- Assets/Script/Walk/SideObjects/VarietyHistory.cs
- Assets/Script/Walk/SideObjects/FixedSideObjectPair.cs
- Assets/Script/Walk/Encounter/EncounterStateData.cs
- Assets/Script/Walk/Encounter/EncounterOverlay.cs
- Assets/Editor/Walk/GraphValidator.cs
- Assets/Editor/Walk/SimRunner.cs

主要変更
- Assets/Script/Walk/GameContext.cs: タグ/オーバーレイ/乱数/SideObjectSelector追加
- Assets/Script/Walk/NodeSO.cs: exitSelectionMode/encounterRateMultiplier追加
- Assets/Script/Walk/ExitCandidate.cs: conditions/weight追加
- Assets/Script/Walk/AreaController.cs: ExitResolver統合
- Assets/Script/Walk/WalkProgressData.cs: 新規状態の保存/復元
- Assets/Script/Walk/Presentation/CentralObjectPresenter.cs: SFX対応、blockingMode廃止（2026-01-21）
- Assets/Script/Walk/Encounter/EncounterResolver.cs: multiplier対応

意図的に最小実装とした項目
- appear/hideアニメーション: Presenterでのフェード/アニメ演出
- ConversationRunner: 会話の逐次実行エンジン（DialogueDefinitionSOは骨格のみ）
- Graph Toolkit エディタ: ノード/出口の可視化編集UI

---

非機能要件（実装しない機能）

以下の機能は設計上の理由により実装しない。将来、誤って実装しないよう明記する。

イベント門関連の廃止機能

| 機能 | 廃止理由 |
|------|----------|
| repeatable | 門は「障壁」であり、クリアしたら消滅する。何度クリアしても出現する門は、門の役割（出口への障壁）を曖昧にする。オプショナルな繰り返し挑戦はサイドオブジェクトや中央オブジェクトで実現すべき。 |
| cooldown | スルー/失敗後の再出現までのタイムラグは、歩数/確率指定（positionSpec）で既に実現されている。cooldownはこれと機能が重複し、設計を複雑にする。 |
| resetOnSkip | スルー時は常に進捗リセットする。選択肢は不要。再出現させない門は存在しない（門は障壁だから）。 |
| resetOnFail | 失敗時もスルーと同様に進捗リセットする。選択肢は不要。 |
| resetTarget | 上記の廃止に伴い不要。 |
| blockingMode | 全てのアプローチオブジェクトでボタンを表示する。HardBlock/SoftBlockの区別は不要。（2026-01-21廃止済み） |

設計の意図

門/出口は「出口への障壁」という明確な役割を持つ。以下の役割分担を守ることで、各システムの責務が明確になり、疎結合を保てる。

| システム | 役割 |
|----------|------|
| イベント門 | 出口への障壁。全てクリアしないと出口に到達できない。 |
| 出口 | ノード遷移の選択。全門クリア後に出現。 |


「出口をブロックしないオプショナルな挑戦」を門で実現しようとすると、門の役割が曖昧になる。そのような要素はそれ以外の仕組みで実現する。
