# ゼロトタイプ歩行システム仕様書

本書は実装の詳細仕様を記録する。設計意図については「ゼロトタイプ歩行システム設計書」を参照。

---

## イベント門と出口の位置計算（ハードル並び設計）

### 概要

イベント門と出口は「ハードルの並び」として設計されている。各障壁は前の障壁を越えた先に配置され、設定値がそのまま「越えるべき距離」となる。

### 位置の解釈

| 要素 | 設定値の意味 | 実際の出現位置 |
|------|-------------|---------------|
| イベント門 | 開始地点からの絶対位置 | `TrackProgress >= 設定値` |
| 出口 | 最後の門からの相対距離 | `TrackProgress >= 最大門位置 + 設定値` |

### 計算式

```
出口の実際位置 = max(全門の解決位置) + 出口の設定歩数
```

門がない場合は `max = 0` となり、出口の設定値がそのまま絶対位置となる。

### 具体例

**設定:**
- 門1: 30歩
- 門2: 50歩
- 出口: 100歩

**実際の動作:**
1. 開始（TrackProgress=0）
2. 30歩で門1出現
3. 50歩で門2出現
4. 門2通過後「あと100歩」と表示
5. 150歩（= max(30,50) + 100）で出口出現

### 設計意図

- 門と出口を独立して設定可能（兼ね合いを考える必要がない）
- 「門を100歩に、出口を50歩に」と設定すれば、門通過後50歩で出口が出る
- 直感的な数値設定が可能

### 関連コード

- `GateResolver.GetMaxResolvedPosition()` - 最大門位置の取得
- `ExitSpawnRule.ShouldSpawn()` - 出口出現判定
- `ProgressCalculator.CalculateExitPosition()` - 出口位置計算

---

## WalkStep 処理順序（現在の仕様）

### 概要

`AreaController.WalkStep()` が1歩ごとに実行する処理の順序を定義する。

### 処理順序

```
WalkStep()
│
├── 1. ノード同期チェック
│       └── Anchor rewind後にノードが変わっていないか確認
│
├── 2. リフレッシュ処理（巻き戻し後）
│       └── RequestRefreshWithoutStep が true の場合、カウンタを進めずにUI更新のみ
│
├── 3. ノード入場イベント
│       └── hasEnteredCurrentNode が false の場合、OnEnterEvent を発火
│       └── 初回入場時のみ実行
│
├── 4. カウンタ進行
│       ├── Counters.Advance(1) - GlobalSteps, NodeSteps, TrackProgress を+1
│       └── UpdateTrackProgress() - TrackConfig に基づく追加進行
│
├── 5. クールダウン進行
│       ├── sideObjectSelector.AdvanceStep() - サイドオブジェクトのクールダウン
│       └── context.AdvanceEncounterOverlays() - エンカウントオーバーレイ
│
├── 6. サイドオブジェクト抽選
│       └── RollPair() でその歩の左右オブジェクトを決定
│
├── 7. 中央オブジェクト取得
│       └── CentralEvent と CentralVisual を取得
│
├── 8. アプローチオブジェクト表示
│       └── ShowApproachObjects() で左右・中央を画面に表示
│
├── 9. ゲートチェック
│       └── CheckGates() でゲート出現・通過・失敗を処理
│       └── ゲート処理が発生した場合は return（後続処理スキップ）
│
├── 10. エンカウント判定
│       └── encounterResolver.Resolve() で敵遭遇を判定
│       └── 遭遇した場合は RunEncounter() で戦闘実行
│       └── 戦闘結果イベント（OnWin/OnLose/OnEscape）を発火
│
├── 11. 強制イベントチェック
│       └── CheckForcedEvents() で歩数/確率トリガーを判定
│       └── 発火した場合は return（後続処理スキップ）
│
├── 12. アプローチ処理
│       └── HandleApproach() でユーザーの選択を待機
│       └── 左/右/中央/スキップ の選択に応じてイベント発火
│
├── 13. リワインドチェック
│       └── イベントで RewindToAnchorEffect が発火した場合は return
│
└── 14. 出口チェック
        └── ExitSpawn.ShouldSpawn() で出口出現を判定
        └── 出口選択 → ノード遷移 → OnExitEvent 発火
```

### 各処理の詳細

| # | 処理 | 発火するイベント | 中断条件 |
|---|------|----------------|---------|
| 3 | ノード入場 | OnEnterEvent | - |
| 9 | ゲートチェック | GateEvent (OnAppear/OnPass/OnFail) | ゲート処理発生時 |
| 10 | エンカウント | OnWin/OnLose/OnEscape | - |
| 11 | 強制イベント | ForcedEventTrigger.Dialogue | イベント発火時 |
| 12 | アプローチ | SideObject.Event / CentralEvent | - |
| 14 | 出口 | OnExitEvent | 出口選択時 |

### 中断（return）の影響

| 中断ポイント | スキップされる処理 |
|-------------|------------------|
| ゲート処理後 | エンカウント、強制イベント、アプローチ、出口 |
| 強制イベント後 | アプローチ、出口 |
| リワインド後 | 出口 |

### 関連コード

- `AreaController.WalkStep()` - メイン処理ループ
- `AreaController.CheckGates()` - ゲート処理
- `AreaController.CheckForcedEvents()` - 強制イベント処理
- `AreaController.HandleApproach()` - アプローチ処理
