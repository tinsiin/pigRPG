# 総合戦闘仕様書

本書は、既存の個別仕様書（`doc/スキル計算仕様書.md`, `doc/戦闘規格・狙い流れ仕様書.md`）ではカバーされていない戦闘メカニクスをまとめたもの。ダメージ計算式やATK/DEF/EYE/AGI係数、戦闘規格・AimStyleの排他係数については既存仕様書を参照。

関連仕様書:
- `doc/スキル計算仕様書.md` — ダメージ計算式、SkillType/SkillSpecialFlag、命中/回避、かすり率、ダメージ補正チェーン
- `doc/戦闘規格・狙い流れ仕様書.md` — BattleProtocol/AimStyle、排他ATK/DEF係数、防御切替、0.7クランプ、適応ラグ
- `doc/HP変動パス仕様書.md` — 戦闘中の全HP・精神HP変動パスの一覧と情報伝達層の対応
- `doc/フロー数字仕様書.md` — 第3層フロー数字の表示仕様

---

## パワーレベル

キャラクターの戦闘状態を表す4段階の指標。多数のシステムに影響する。

### 列挙体

| 値 | 日本語 |
|---|---|
| `VeryLow` | たるい |
| `Low` | 低い |
| `Medium` | 普通（初期値） |
| `High` | 高い |

実装: `BaseStates.StatesState.cs` / `PowerLevelExtensions.cs`

### パワーの変動

- **Power1Up()** / **Power1Down()**: 1段階上下。上下限でクランプ
- **歩行時変化**: `TransitionPowerOnWalkByCharacterImpression()` 精神属性ごとに確率的に変動
- **精神HP乖離**: ダウナー乖離時に50%でPower1Down
- **ハイネスチャンス**: 敵撃破時にPower1Up（後述）

### パワーレベルが影響するシステム一覧

| 影響先 | 効果 | 条件 |
|---|---|---|
| 基礎山型分布 | 山型分布±22%補正が消滅 | VeryLow以下 |
| 精神MaxHP | ×1.3 + MaxHP×0.08 加算 | High |
| 互角一撃 | 精神属性ごとにパワー条件あり | 属性による（後述） |
| 刃物即死生存 | 生存判定が発動する | High以上 |
| 割り込みカウンター | 発動条件 | Medium以上 |
| 0.7クランプ | High超は不適切DEFでもパワーで押せる | High超 |
| 引き締め値 | High時50%で補正段階+1 | High |

---

## 前のめり（ヴァンガード）

パーティ内で1名が前線に出る状態。グループ(`BattleGroup`)ごとに`InstantVanguard`で1人を管理。

実装: `BattleManager.cs:336` `BeVanguard()`, `BattleGroup.cs:372` `InstantVanguard`

### 前のめりの効果

- **AGI命中補正の低下**: 前のめりでない場合、敵のAGI分だけ命中補正が下がる。前のめり状態ではこのペナルティなし
- **慣れフラットロゼ**: 前のめり中に攻撃スキルを使うと追撃が発生しうる（後述）
- **`IsTempVanguard`**: 一時的な前のめり（スキルによるもの）。フラットロゼの対象外

### 前のめり交代阻止

現在の前のめり者がブロックパッシブを持つ場合、新しいキャラが前のめりになるのを阻止できる。

```
引き留め側合算 = 余裕 + 春仮眠 + 泉水 + 燃え火吹きウィフ
なろうとする側 = 烈火(- 冷酷冷静×0.8) + ピルマグレイトフル(- 冷酷冷静×0.2) + ミザ - エノクナギ
パーティー属性補正 = HolyGroupなら ×0.7
```

引き留め側が勝てばブロック成功。

実装: `BattleManager.cs:353` `TryBlockVanruard()`

---

## 慣れフラットロゼ（淡々としたロゼ）

前のめり状態で攻撃スキルを使用した際に追加行動（追撃）を予約するシステム。

実装: `FlatRozeEffect.cs`

### 発動条件

以下を**すべて満たす**場合に発動判定が行われる:

1. パッシブID 0 を保持している
2. スキルが`SkillType.Attack`を持つ
3. `IsTempVanguard`ではない（正規の前のめり）
4. グループ内で前のめり状態である
5. スキルの累計使用回数 > 20
6. 連続攻撃の2回目以降ではない

### 発動確率: Ideal50or60Easing

スキル命中率が**50〜60に近いほど**発動確率が高い。

```
d = min(|命中率 - 50|, |命中率 - 60|)

d ≥ 25: 0% + 冷静補正
12 ≤ d < 25: 0〜4.44% (線形) + 冷静補正
d < 12: 4.44〜27% (べき乗イージング, α=4.3) + 冷静補正
```

冷静補正 = `floor(泉水 / 16.7) × 0.01` （`GetCoolnessFlatRozeChance`）

### 追撃の性能

| 項目 | 値 |
|---|---|
| ATK倍率 | ×1.6 + 冷静ボーナス |
| 冷静ボーナス | 泉水(ForSkill) × 0.005 |
| パワー倍率 | ×0.5（威力半減） |
| 即前のめり | true |

---

## 慣れ補正（AdaptToSkill）

同じスキル印象の攻撃を繰り返し受けると、防御側がその攻撃に「慣れて」ダメージ補正が発生するシステム。スキル計算仕様書のダメージ補正チェーン第7番。

実装: `BaseStates.AdaptToSkill.cs`

### 概要

- 被弾したスキルの**スキル印象**を記録し、記憶回数を管理
- 記憶回数が多いスキル印象ほど、そのスキルへの慣れ補正が大きくなる
- 精神属性ごとに**グルーピング方式**が異なる（同じ印象のスキルが同じグループに入るかの分類が異なる）

### 精神属性別グルーピング

| 精神属性 | グルーピング方式 | 概要 |
|---|---|---|
| BaleDrival | 3分割 | 優先度を3で割る |
| GodTier | 6分割 | 優先度を6で割る |
| Pillar | 5分割 | 優先度を5で割る |
| LiminalWhiteTile | 素数ベース | 素数判定による分割 |
| Cquiest | 10分割 | 優先度を10で割る |
| Doremis | 6+7複合 | 複雑な分割ロジック |

### 記憶回数の減衰

食らっていないスキル印象の記憶は時間（ターン経過）とともに減衰する。

```
記憶忘却回数 = 序列補正 × DEF基礎減少値 × 経過ターン
序列補正 = 1 + finalSkillRank/8 + (二位以降なら +0.08)
```

記憶回数の序列割合による乱数判定成功時、忘却回数が1/3に減衰（忘れにくくなる）。

### 戸惑い

同じスキル印象を**別の攻撃者**から初めて食らった場合、精神属性によっては「戸惑い」が発生し、その回の慣れ補正が無効になる。

戸惑わない属性: ドレミス、ゴッドティア、キンダーガーデン、シークイエスト

---

## 命中凌駕（Supremacy）

攻撃者のEYEが防御者のAGIを大幅に上回る場合、命中率にボーナスが加算される。

実装: `BaseStates.HitCalc.cs:16` `AccuracySupremacy()`

### 計算式

```
補正AGI = 被害者AGI × 倍率閾値(デフォルト 2.5)

攻撃者EYE ≥ 補正AGI の場合:
  supremacyBonus = (攻撃者EYE - 補正AGI) / 2

攻撃者EYE < 補正AGI の場合:
  supremacyBonus = 0
```

このボーナスは `SkillHitCalc` 内で命中率に加算される（`doc/スキル計算仕様書.md` 8.1節参照）。

---

## 互角一撃の生存率

致死ダメージを受けた際に「奇跡的に生き残る」判定。大体半分くらいの一撃をバランスの取れた相手から受けた場合に発動。

実装: `BaseStates.BattleEvent.cs:319` `CalculateMutualKillSurvivalChance()`

### 発動条件

以下を**すべて満たす**:

1. 被害者のHP ≥ MaxHP × 20%
2. 攻撃者の十日能力合計 ≤ 被害者の十日能力合計 × 1.6
3. ダメージが MaxHP × 34% 〜 MaxHP × 66% の範囲内

### 生存確率

`GetMutualKillSurvivalChance()` で精神属性 × パワーレベル × 人間状況(Demeanor)の3軸で決定。

#### パワー条件（精神属性別）

パワー条件を満たさない場合、確率は0%。

| 精神属性 | 必要パワー |
|---|---|
| GodTier | 条件なし（常にOK） |
| Cquiest, BaleDrival | Low以上 |
| LiminalWhiteTile, Sacrifaith, Doremis, Pillar, Psycho | Medium以上 |
| Kindergarten, Devil | High |

#### 基本確率（Demeanor別）

| 人間状況 | 基本確率 |
|---|---|
| 怒り / 高揚 / 辛い / 混乱 | 0% |
| 覚悟 | 7% |
| 普調 | 4% |
| 楽観的 | 2% |
| 疑念 | 1% |

#### 特殊上書き（精神属性 × 人間状況）

| 精神属性 | 人間状況 | 上書き確率 |
|---|---|---|
| GodTier | 楽観的 | **12%** |
| Sacrifaith | 怒り | **6%** |
| Doremis | 疑念 | **14%** |
| Pillar | 辛い | **6%** |
| BaleDrival | 高揚 | **11%** |
| Devil | 楽観的 | **0%** |

### 生存時

HP = MaxHP × 7% に復帰。

---

## ハイネスチャンス

敵を撃破した際にパワーが1段階上昇する判定。

実装: `BaseStates.StatesState.cs:183` `HighNessChance()`

### 発動条件

倒した敵のスキルリストに、**TLOAスキルかつ自分の精神属性と一致するスキル**が1つ以上ある場合に判定が発生。

### 確率計算

```
基礎確率 = 精神属性による分岐:
  Kindergarten: 40%
  LiminalWhiteTile: 30%
  その他: 20%

最終確率 = 基礎確率 + 一致スキル数 × 5%
```

成功時、`Power1Up()` が呼ばれる。

---

## 刃物即死の生存判定

刃物(`Blade`)による即死クリティカルで致死した場合の復活判定。スキル計算仕様書で「刃物即死」自体は記載あるが、その**生存側の判定**は記載なし。

実装: `BaseStates.BattleEvent.cs:573` `CalculateBladeDeathCriticalSurvivalChance()`

### 発動条件

- パワー ≥ High

### 生存判定

```
被害者の刃物能力 vs 攻撃者の刃物能力 を乱数比較（rollComparison）
被害者の値が出れば生存
```

### 生存時HP

```
攻撃者の刃物レート = 攻撃者刃物能力 × (攻撃者がHighなら 1.5, それ以外 1.0)
生存HP = Random(1, 2.8) + max(0, 被害者刃物能力 - 攻撃者刃物レート) × Random(4, 5)
```

---

## 乖離スキル使用による十日能力値減少

スキルの印象構造（精神属性）とキャラクターのデフォルト精神属性が大きく離れている場合、十日能力が低下する。

実装: `BaseStates.BattleEvent.cs:20` `ResolveDivergentSkillOutcome()`

### 乖離スキルの判定

`GetIsSkillDivergence()` でスキルが「乖離している」かを判定:

1. スキルの印象構造キーの80%-1個をランダムに選択
2. 各キーとデフォルト精神属性の互換十日能力との距離の平均を計算
3. 平均距離 ≥ 8 で「乖離スキル」と判定

### 発動条件

1. バトル内スキル実行回数 ≥ 7回
2. 精神属性による発生確率判定（LiminalWhiteTile: 0%, Kindergarten: 95%, Psycho: 20% 等）
3. 全スキル実行のうち71%以上が乖離スキルであること

### 減少量

```
減少値 = (最後に使った乖離スキルの印象 + 全乖離スキルの印象平均) の平均 × 1.2
```

この減少値が `_baseTenDayValues` から直接引かれる。

---

## 精神HP乖離

実HPと精神HPが一定以上離れた状態が持続すると、アッパー系/ダウナー系の効果が発動する。

実装: `BaseStates.BattleEvent.cs:226` `MentalDiverGence()`

### 乖離率と閾値

```
乖離率 = |精神HP - HP| / HP
閾値 = Demeanor(人間状況)ごとに異なる基本値 + 十日能力補正
```

| 人間状況 | 基本閾値 | 補正 |
|---|---|---|
| 混乱 | 0.3 | + (夜暗黒 - ケレケレ)×0.01 |
| 怒り | 0.47 | 同上 |
| 辛い | 0.6 | 同上 |
| 疑念 | 0.7 | 同上 - エノクナギ×0.005 |
| 普調 | 0.9 | 同上 |
| 覚悟 | 1.2 | 同上 |
| 楽観的 | 1.4 | 同上 |
| 高揚 | 2.6 | 同上 |

乖離率 > 閾値 の状態が持続ターン最大値を超えると発動。発動後は再充填カウントが設定される。

### アッパー乖離（精神HP > HP）

パッシブID 4 を付与。

### ダウナー乖離（精神HP < HP）

- **TLOA**: HP = 現HP × 0.76
- **それ以外**: パッシブID 3（強制ダウナー）付与 + 50%でPower1Down

---

## オーバーキル・Brokenシステム

敵を倒した際、余剰ダメージが閾値を超えるとBroken（完全破壊）状態になる。

実装: `BaseStates.BattleEvent.cs:605` `OverKilledBrokenCalc()`

### 発動条件

1. 被害者が機械(`Machine`)か生物(`Life`)であること
2. 余剰ダメージ × 通過率 > MaxHP × OverKillBrokenRate（閾値）

### 被害者種別による最終判定率

| 種別 | 最終判定率 |
|---|---|
| 機械 | 33% |
| 生物 | 93%（ただし攻撃者の性質チェックあり） |

### 生物に対するBrokenの攻撃者条件

- **攻撃者が生命**: サイコパスのみ発動
- **攻撃者が機械**: サイコパス、ベイルドライヴァル×怒り、キンダーガーデン×高揚 のいずれか
- **その他の種別**: 制限なし

### 余剰ダメージの最大値・通過率

攻撃者の十日能力と精神属性で決まる `GetOverkillOverflowMax()` と、被害者のDemeanorで決まる `GetOverkillOverflowPassRate()` で計算。詳細はコード参照。

---

## レイザーダメージ（RatherDamage）

スキルのダメージ計算チェーン（13段補正）を一切経由しない、純粋なHP減算によるダメージ処理。パッシブのダメージリンクやアクション予約による独立ダメージパスとして使われる。

実装: `BaseStates.Damage.cs:745` `RatherDamage()`

### 処理内容

```
RatherDamage(damage, LayerDamage, DamageRatio):
  1. damage × DamageRatio で実ダメージを算出
  2. LayerDamage=true の場合、VitalLayer（バリア層）で先に吸収
  3. 残りを HP から直接減算
```

通常の攻撃ダメージと異なり、命中判定・かすり・クリティカル・防御係数・慣れ補正などは**一切適用されない**。

### 発火経路1: パッシブダメージリンク

パッシブの `LinkedPassive` が持つ `DamageLinkRatio` により、パッシブ保持者がダメージを受けた際にリンク先にもダメージを伝搬する。

実装: `BasePassive.cs:411` `OnAfterDamage()`

```
OnAfterDamage(攻撃者, ダメージ):
  各リンク先パッシブについて:
    DamageLinkRatio > 0 なら:
      リンク先._owner.RatherDamage(ダメージ, link.LayerDamage, link.DamageLinkRatio)
```

- `DamageLinkRatio`: 元ダメージの何割をリンク先に転嫁するか（例: 0.5 = 50%）
- `LayerDamage`: リンク先でVitalLayer吸収を行うかどうか

### 発火経路2: ActionEntryによるレイザー行動予約

通常のスキル実行とは独立したターン内アクションとして予約・実行される。

| ファイル | 役割 |
|---|---|
| `ActionEntry.cs` | `RatherTargets`（対象リスト）と`RatherDamage`（ダメージ値）を保持 |
| `BattleActionContext.cs:146` | `PrepareRatherAct()` でキューに積む / `ConsumeRatherAct()` で取り出す |
| `BattleFlow.cs:131` | `RatherAct()` でレイザー行動を独立実行 |
| `EffectResolver.cs:51` | `ApplyRatherDamage()` で全対象に `RatherDamage(damage, false, 1.0)` を適用 |

この経路では `DamageRatio=1.0`、`LayerDamage=false`（VitalLayer無視）。

### フロー数字との関係

レイザーダメージ発生時の数字ポップアップ表示は未実装。`doc/フロー数字仕様書.md` にカテゴリスタブあり。

---

## 未実装メカニクス

以下はメモ（`豚争い.md`）に記載があるが未実装のもの。

### ぱーてぃか（運命の回転）

戦闘中の特定条件で発生する運命的イベント。敵側・味方側で別仕様。メモには発生条件、判断基準、報酬、敵パーティカの変動タイミングまで詳細あり。

### 乱雑する力

未定義。メモに見出しのみ。

### 離人システム / 離人攻撃

PersonaDivergence（ペルソナ乖離）は十日能力として存在するが、独立した離人メカニクスは未実装。

### 幻覚効果

未実装。メモに見出しのみ。

### 散開と追跡システム

未実装。戦闘中のポジショニングに関する将来構想。

### 完全的な死亡 → 天国

完全死亡時に「豚の天国」に遷移する処理。未実装。
