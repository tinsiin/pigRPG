# ズーム仕様書

## 概要

本プロジェクトには**2つの独立したズーム機構**が存在する。
それぞれ用途が異なり、共通化されていない。

---

## 2つのズーム機構

| 機構 | 用途 | 共通化 |
|------|------|--------|
| **演出ズーム**（IZoomController / IntroOrchestrator） | バトルイントロ、ノベルパート、歩行演出 | ✅ 共通 |
| **KZoom**（EnterK / ExitK） | バトル中アイコンタップ詳細表示 | ❌ 独自実装 |

---

## 1. 演出ズーム（共通）

### 概要

背景や前景をズームイン/アウトする汎用的な演出機構。
バトル、ノベル、歩行など**複数システムで共用**される。

### 対象コンテナ

```
ViewportArea
├── ZoomBackContainer    ← ズームされる（背景）
├── MiddleFixedContainer ← ズームされない（固定レイヤー）
└── ZoomFrontContainer   ← ズームされる（前景）
```

### 特徴

| 項目 | 動作 |
|------|------|
| ZoomBackContainer | ズームされる |
| ZoomFrontContainer | ズームされる |
| MiddleFixedContainer | **ズームされない** |
| ActionMark | 表示されたまま |
| 他UI | そのまま |

### アーキテクチャ

```
EyeAreaManager（共通入口）
└── IntroOrchestrator（Facade）
    └── IIntroOrchestrator
        └── IZoomController（操作層）
            ├── CaptureOriginal()  - 原状キャプチャ
            ├── ZoomInAsync()      - ズームイン
            ├── ZoomOutAsync()     - ズームアウト
            ├── RestoreImmediate() - 即時復帰
            └── RestoreAsync()     - アニメ付き復帰
```

### 使い方

```csharp
// ズームイン
await EyeAreaManager.Instance.PrepareZoomAsync();  // 原状キャプチャ
await EyeAreaManager.Instance.PlayZoomAsync();     // ズームイン

// ... 演出中 ...

// ズームアウト
await EyeAreaManager.Instance.RestoreZoomAsync(animated: true, duration: 0.4f);
```

### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `Assets/Script/EyeArea/EyeAreaManager.cs` | 共通入口（ラッパー） |
| `Assets/Script/Orchestration/IIntroOrchestratorFacade.cs` | Facadeインターフェース |
| `Assets/Script/Orchestration/IntroOrchestratorFacade.cs` | Facade実装 |
| `Assets/Script/Orchestration/IZoomController.cs` | 操作層インターフェース |
| `Assets/Script/EyeArea/ViewportZoomController.cs` | 操作層実装 |

---

## 2. KZoom（独自実装・共通化対象外）

### 概要

バトル中にキャラアイコンをタップした際の**ステータス詳細表示**専用機構。
特殊な要件に特化しており、**共通化の対象外**。

### 対象コンテナ

```
ViewportArea（= kZoomRoot）
└── 全子要素 ← 全部一緒にズーム
```

### 特徴

| 項目 | 動作 |
|------|------|
| ViewportArea全体 | 全部一緒にズーム |
| MiddleFixedContainer | 全体と一緒にズーム |
| ActionMark | **非表示化** |
| 他キャラUI | **非表示化** |
| K専用テキスト | スライド表示 |

### なぜ共通化しないか

KZoomは以下の**特殊な要件**に特化している:

1. **親ごとズーム**: ViewportArea全体をスケール・移動
2. **他UI非表示化**: `SetActive(false)`で他キャラUIを隠す
3. **ActionMark非表示化**: `HideActionMark()`で隠す
4. **K専用テキスト表示**: 名前、パッシブ一覧をスライド表示
5. **フィット計算**: 特定アイコンがkTargetRectにフィットするよう計算

これらはKZoom固有の仕様であり、汎用化する必要がない。

### 使い方

```csharp
// バトル専用（WatchUIUpdate経由）
await WatchUIUpdate.Instance.EnterK(iconRectTransform, "キャラ名");
await WatchUIUpdate.Instance.ExitK();

// または IKZoomController経由
await EyeAreaManager.Instance.KZoom.EnterK(iconRT, "キャラ名");
await EyeAreaManager.Instance.KZoom.ExitK();
```

### 関連ファイル

| ファイル | 役割 |
|----------|------|
| `Assets/Script/EyeArea/IKZoomController.cs` | インターフェース |
| `Assets/Script/EyeArea/KZoomController.cs` | 実装 |
| `Assets/Script/EyeArea/KZoomConfig.cs` | 設定 |
| `Assets/Script/EyeArea/KZoomState.cs` | 状態管理 |

---

## 比較表

| 項目 | 演出ズーム | KZoom |
|------|-----------|-------|
| **対象** | ZoomBack + ZoomFront（個別） | ViewportArea全体 |
| **MiddleFixed** | ズームしない | 全体と一緒にズーム |
| **ActionMark** | 表示されたまま | 非表示化 |
| **他UI** | そのまま | 非表示化 |
| **用途** | バトルイントロ、ノベル、歩行 | アイコンタップ詳細（バトル専用） |
| **共通入口** | `EyeAreaManager` | `IKZoomController` |
| **共通化** | ✅ 対象 | ❌ 対象外 |

---

## 図解

```
【演出ズーム】
┌─────────────────────────────┐
│ ZoomBackContainer  ← ズーム │
│ MiddleFixed        ← 固定   │  ← ノベルUIはここに置けばズームされない
│ ZoomFrontContainer ← ズーム │
└─────────────────────────────┘

【KZoom】
┌─────────────────────────────┐
│ ViewportArea全体   ← 全部   │
│   └ 全子要素       ← ズーム │  ← 全部一緒に動く
│   └ 他UIは非表示            │
└─────────────────────────────┘
```

---

## 関連ドキュメント

- [UI構造の問題点.md](./UI/UI構造の問題点.md) - 背景と課題
- [ズーム共通化_実装計画.md](./UI/ズーム共通化_実装計画.md) - 共通化の実装計画（完了）
- [シングルトン依存解消計画.md](./UI/シングルトン依存解消計画.md) - DI化の計画（完了）

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-24 | 初版作成。2つのズーム機構（演出ズーム/KZoom）の仕様を記載 |
