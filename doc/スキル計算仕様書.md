# スキル計算仕様書

スキルの威力・命中・ダメージ・回復に関わる計算式を中心とした仕様書。
スキルの性質分類、四大ステとの関係、精神補正、武器上昇能力の影響範囲を網羅する。

> 参照メモ: `豚のスキル.md`

---

## 1. スキルの性質分類

### 1.1 スキル特殊判別性質（SkillSpecialFlag）

ビットフラグで複合可能。各フラグで計算式やルールが分岐する。

| フラグ | 意味 | 主な影響 |
|---|---|---|
| TLOA | 時限圧倒能力 | 精神補正40%、ゆりかご適用、HP38%以下で0.7倍減衰、殺しきれない制限 |
| Magic | 魔法 | 専用ダメージ計算式（ロジスティックブレンド）、命中失敗時1/3かすり |
| Blade | 刃物 | 即死クリティカル判定、刃物武器で精神補正無効化 |

これらに該当しないスキルは「通常スキル」として基本計算式を使用する。

> 実装: `BaseSkill.Core.cs` SkillSpecialFlag enum

### 1.2 スキル行動種別（SkillType）

スキルが持つ効果の種類。一つのスキルが複数の種別を持てる（攻撃+回復など）。

| 種別 | 用途 |
|---|---|
| Attack | 攻撃（ダメージ計算へ） |
| Heal | HP回復 |
| MentalHeal | 精神HP回復 |
| DeathHeal | 死亡回復 |
| addPassive / RemovePassive | パッシブ付与/除去 |
| AddVitalLayer / RemoveVitalLayer | バリア層付与/除去 |
| addSkillPassive / removeGoodSkillPassive / removeBadSkillPassive | スキルパッシブ操作 |

---

## 2. SkillPower（スキル威力）

### 2.1 基本構造

スキルレベルに応じてSkillPowerが決まる。有限リストと無限成長の二段構成。

```
Level < 有限リスト数:
  SkillPower = FixedSkillLevelData[Level].SkillPower

Level >= 有限リスト数:
  base = FixedSkillLevelData[末尾].SkillPower
  超過 = Level - (有限リスト数 - 1)
  SkillPower = base + _infiniteSkillPowerUnit × 超過
```

最終値にはスキルパッシブ乗算率がかかる:

```
最終SkillPower = 上記計算値 × SkillPassiveSkillPowerRate()
```

`SkillPassiveSkillPowerRate` = 全ReactiveSkillPassiveの `(1 + SkillPowerRate)` を累積乗算。

> 実装: `BaseSkill.SkillPowe.cs:17-49`

### 2.2 本体/精神への分配

スキルの `MentalDamageRatio`（精神攻撃率、0〜1）で分配される。

```
GetSkillPower       = _skillPower × (1 - MentalDamageRatio)   ← 本体HP向け
GetSkillPowerForMental = _skillPower × MentalDamageRatio      ← 精神HP向け
```

> 実装: `BaseSkill.SkillPowe.cs:53,57`
> メモ参照: 「精神攻撃率 — 精神HPの方にどのくらい攻撃するかどうか」

### 2.3 ゆりかご（TLOA専用）

TLOAスキルの場合、`_nowSkillLevel` の代わりに `_cradleSkillLevel` が使われる。
ゆりかごレベルは戦闘中に毎回動的計算される。

詳細 → `doc/ゆりかごシステム仕様書.md`

### 2.4 味方専用オーバーライド（AllySkill）

味方キャラのスキルは `_skillPower` をオーバーライドし、感情愛着による加算がある:

```
AllySkillPower = base._skillPower + CurrentHPFixedAdditionSkillPower(actor)
```

感情愛着があるスキルに対し、`愛着量 × 現在HP` が加算される。

> 実装: `AllySkill.cs:55-59`

---

## 3. 四大ステータスと十日能力の関係

### 3.1 四大ステの構成

四大ステ（ATK, DEF, EYE, AGI）はすべて同じ構造で計算される:

```
四大ステ = 基礎基礎値(b_b_xxx) + Σ(十日能力 × 共通係数) + Σ(十日能力 × 排他係数 × 適応率)
         + 補正乗算 + パッシブ乗算 + 固定値補正 + パッシブ固定値 + 条件付加算
```

| 四大ステ | 基礎基礎値 | 共通係数 | 排他係数 | 追加要素 |
|---|---|---|---|---|
| ATK | `b_b_atk` (4.0) | `AttackPowerConfig.CommonATK` | 戦闘規格(Protocol)別 | 範囲意志ボーナス、単体暴断でAGI/6加算 |
| DEF | `b_b_def` (4.0) | `DefensePowerConfig.CommonDEF` | 防ぎ方(AimStyle)別 | 防御低減率(DEFATK)による減算 |
| EYE | `b_b_eye` (4.0) | `EyePowerConfig.CommonEYE` | なし | 範囲意志ボーナス、単体でAGI/6加算(暴断2倍) |
| AGI | `b_b_agi` (4.0) | `AttackPowerConfig.CommonATK`系 | なし | 前のめり時1/2 |

> 実装: `BaseStates.StatesNumber.cs:253-610`

### 3.2 武器上昇能力の適用

キャラの十日能力 `TenDayValues(IsSkillEffect)` に武器ボーナスが加算される:

```
キャラ十日能力 = _baseTenDayValues + 武器ボーナス
```

武器ボーナスは `WeaponTenDayAbilityBonusData` の4辞書から構成:

| 辞書 | 適用条件 |
|---|---|
| NormalData | **常時**（どのスキルでも） |
| TLOAData | `skill.IsTLOA` の場合のみ追加 |
| MagicData | `skill.IsMagic` の場合のみ追加 |
| BladeData | `skill.IsBlade` の場合のみ追加 |

**重要**: 武器ボーナスはキャラの十日能力を上昇させる → ATK/DEF/EYE/AGIに影響する。
スキル自体のSkillPowerやスキルの印象構造（skill.TenDayValues）には影響しない。

> 実装: `BaseWeapon.cs:115-151`, `BaseStates.StatesNumber.cs:680-706`

### 3.3 排他ATKと適応ラグ

戦闘規格（Protocol）に紐づく排他ATK係数は、武器/規格切替後に適応率（0.77〜1.0）が乗算される。

```
排他ATK寄与 = 十日能力 × 排他係数 × _adaptationRate
```

適応率は6戦で線形回復する。

> 詳細 → `doc/武器システム仕様書.md`

---

## 4. ComputeSkillPowers（統合スキル威力計算）

攻撃・回復問わず、スキル実行時に呼ばれる共通の威力計算ヘルパ。

```csharp
ComputeSkillPowers(attacker, skill, spread, out skillPower, out skillPowerForMental)
```

### 4.1 計算手順

1. **精神補正の取得**: `GetSkillVsCharaSpiritualModifier(skill精神属性, attacker)`
   - キー: `(スキル精神属性, 被害者の精神属性)`
   - 被害者(`this`)の精神属性と、スキルの精神属性の相性で補正値が決まる
2. **補正適用率の決定**:
   - 通常スキル: 20%
   - TLOA: **40%**
3. **刃物武器例外**: 攻撃者の武器が刃物(`IsBlade`) → 本体威力の精神補正を**1.0に固定**（無効化）
4. **最終計算**:
   ```
   skillPower         = SkillPowerCalc(IsTLOA) × 精神補正(適用率) × spread
   skillPowerForMental = SkillPowerForMentalCalc(IsTLOA) × 精神補正(100%) × spread
   ```
   精神HP向け威力には常に精神補正が100%で適用される（刃物例外なし）。

> 実装: `BaseStates.ReactionSkill.cs:21-32`

### 4.2 精神補正の意味

| パラメータ | 説明 |
|---|---|
| 適用率20% | 補正値の20%だけがSkillPowerに影響。例: 補正150% → 実効 `1.0 + 0.5×0.2 = 1.1` |
| 適用率40%(TLOA) | TLOAは精神の噛み合わせの影響が大きい。例: 補正150% → 実効 `1.0 + 0.5×0.4 = 1.2` |
| 100%(精神向け) | 精神HP向けは常に全量。例: 補正150% → 実効 `1.5` |

### 4.3 精神補正の参照先

2種類の精神補正が存在する:

| 関数 | キー構成 | 用途 |
|---|---|---|
| `GetSkillVsCharaSpiritualModifier` | (スキル精神属性, 被害者精神属性) | スキル威力への補正（ComputeSkillPowers内） |
| `GetOffensiveSpiritualModifier` | (攻撃者精神属性, 被害者精神属性) | キャラ同士の直接相性 |

> 実装: `BaseStates.ReactionSkill.cs:1068-1083`, `BaseStates.DictionaryData.cs:109-114`

---

## 5. 攻撃ダメージ計算

### 5.1 非魔法ダメージ（基本計算式）

```
本体ダメージ = (ATK(攻撃補正率) - DEF) × SkillPower + SkillPower
```

展開すると:
```
= (ATK × SkillAttackModifier - DEF) × SkillPower + SkillPower
= SkillPower × (ATK × SkillAttackModifier - DEF + 1)
```

ATKとSkillPowerは**乗算関係**。DEFはATKから引かれて差分にSkillPowerが掛かる。
`+ SkillPower` の項により、ATK < DEF でも最低SkillPower分のダメージが保証される。

> 実装: `BaseStates.Damage.cs:783`

### 5.2 魔法ダメージ

```
本体ダメージ = MagicBlend(ATK, DEF) × (SkillPower × 0.5) + SkillPower × ATK() × 0.09
```

**MagicBlend**: ATK-DEFの差が大きいほど通常計算、差が小さいほど除算計算にブレンドする。

```
重み = sigmoid(-0.02 × (ATK - DEF - 140))

差分計算 = ATK - DEF
除算計算 = ATK / DEF + 8 + (ATK-DEF) / 1.6

ATK-DEF ≤ 0: 除算計算のみ（最低ダメージ保証）
ATK-DEF > 0: 重み × 差分 + (1-重み) × 除算
```

魔法は防御力に負けても一定のダメージを出せる設計。

> 実装: `BaseStates.Damage.cs:788-855`

### 5.3 精神ダメージ

**非魔法**:
```
精神ダメージ = (ATK() × 余裕ブースト - MentalDEF()) × SkillPowerForMental + SkillPowerForMental
```

**魔法**:
```
精神ダメージ = ATK() × 余裕ブースト / MentalDEF() × (SkillPowerForMental × 0.6) + SkillPowerForMental × 0.7
```

**余裕ブースト**:
```
余裕ブースト = max(0, 攻撃者.Leisure - 被害者.Leisure) × 攻撃者.MentalHP × 0.2
```

> 実装: `BaseStates.Damage.cs:800-812`

### 5.4 スキル攻撃補正率（SkillAttackModifier）

スキルの攻撃率（メモ: 「ATKに掛けられるスキル回避率と同様に落ち着きで平準化する値」）。
落ち着きカウント経過により基準値1.0に線形補間で戻る。

```
progress = 1.0 - (残りカウント / 最大カウント)
SkillAttackModifier = _skillAttackModifier + (1.0 - _skillAttackModifier) × progress
```

> 実装: `BaseStates.ATKCalc.cs:31-46`

---

## 6. ダメージ補正チェーン

`DamageOnBattle`内で以下の順に適用される:

| 順序 | 補正 | 内容 |
|---|---|---|
| 1 | 防ぎ方切替 | AimStyle対応（不一致ならDEFクランプ） |
| 2 | 基本計算 | 非魔法 or 魔法の計算式 |
| 3 | 山型分布 | ±22%の乱数補正（8d5501）。-15%以下で「乱れ」判定 |
| 4 | 物理耐性 | 物理属性(heavy/volten/dishSmack)の耐性適用。武器+スキル一致で2回適用 |
| 5 | パッシブ減衰 | パッシブによるダメージ百分率削減 |
| 6 | がむしゃら | 連続2回目以降、被害者(EYE+AGI)/2 > 攻撃者EYEなら差分×0.01倍ブースト |
| 7 | 慣れ補正 | スキルへの慣れによる補正 |
| 8 | VitalLayer | バリア層によるダメージ吸収 |
| 9 | 刃物即死 | `atkerBlade/150 × 5/12 × 100`% で即死判定発生 |
| 10 | 命中段階 | Critical=1.5倍, Hit=1.0倍, Graze=0.02〜0.35倍 |
| 11 | TLOA減衰 | 被害者HP < 38%で0.7倍 |
| 12 | 殺せない制限 | TLOA: 3.4%止め（パッシブ5で10%止め）、CantKill: 1止め |
| 13 | 思えダメージ | 強さ比1.4倍以上で発生する追加ダメージ（別枠） |

> 実装: `BaseStates.Damage.cs:449-613`

---

## 7. 回復計算

### 7.1 HP回復

攻撃と異なり、ATK/DEFは関与しない。SkillPowerがそのまま回復量の基礎値。

```
回復量 = SkillPower × (パッシブ回復率 / 100)
```

命中判定あり（Hit以外は回復しない）。

> 実装: `BaseStates.ReactionSkill.cs:253-263, 567-571`

### 7.2 精神HP回復

```
回復量 = SkillPowerForMental（直接加算）
```

> 実装: `BaseStates.ReactionSkill.cs:576-581`

### 7.3 攻撃と回復でのSkillPowerの意味の違い

| | 攻撃 | 回復 |
|---|---|---|
| ATK/DEF | `(ATK-DEF) × SkillPower + SkillPower` | 使わない |
| 精神補正 | 適用（20% or 40%） | 適用（ComputeSkillPowersで共通計算） |
| spread | 適用（分散割合） | 適用（同上） |
| 最終的な意味 | 乗算係数+加算最低保証 | そのまま回復量 |

---

## 8. 命中/回避計算

### 8.1 命中判定（SkillHitCalc）

```
命中成功 = Random(100) < SkillHitPer + supremacyBonus - Random(0,3)
```

- `SkillHitPer`: スキルレベルに応じた命中率（FixedSkillLevelDataから検索）
- `supremacyBonus`: 攻撃優越度（EYEとAGIから計算される外部パラメータ）
- 0〜3%のランダム減算あり

結果は4段階: `CompleteEvade`, `Graze`, `Hit`, `Critical`

> 実装: `BaseSkill.SkillHit.cs:61-86`

### 8.2 魔法のかすり救済

魔法スキルで完全回避が発生した場合、1/3の確率で `Graze` に格上げされる。

### 8.3 かすりダメージ倍率

```
基本かすり率 = 0.35
減衰 = max(0, 被害者EYE - 攻撃者EYE) × 0.007
最終かすり率 = max(0.02, 0.35 - 減衰)
```

範囲: 2%〜35%

> 実装: `BaseStates.Damage.cs:1154-1170`

### 8.4 EYEとAGIの役割

| ステ | 攻撃側での役割 | 防御側での役割 |
|---|---|---|
| EYE | 命中に寄与（supremacy計算）、単体時AGI/6加算 | かすりダメージ減衰 |
| AGI | 単体暴断時ATKにAGI/6加算 | 回避に寄与（supremacy計算）、前のめり時1/2 |

EYE/AGIはダメージ計算式に直接入らない。**命中/回避/かすり率**を通じて間接的にダメージに影響する。

---

## 9. スキルの印象構造（十日能力値）

### 9.1 スキル側の十日能力

スキルはレベルに応じた印象構造（TenDayAbilityDictionary）を持つ。
計算方式はSkillPowerと同一（有限リスト + 無限成長）。

```
Level < 有限リスト数:
  skill.TenDayValues = FixedSkillLevelData[Level].TenDayValues

Level >= 有限リスト数:
  base = FixedSkillLevelData[末尾].TenDayValues
  超過 = Level - (有限リスト数 - 1)
  skill.TenDayValues = base + _infiniteSkillTenDaysUnit × 超過
```

> 実装: `BaseSkill.TenDays.cs:16-47`

### 9.2 スキル印象構造の用途

| 用途 | 説明 |
|---|---|
| キャラ成長 | スキル実行ごとに印象構造分キャラの十日能力が増える |
| ライバハル蓄積 | `Σ(攻撃者十日能力/スキル十日能力) × 精神補正` |
| 使いこなし度 | スキル印象構造とキャラの素の十日能力の構造一致度 |
| 分散割合 | ビーム型などの範囲効果時の威力配分 |

### 9.3 キャラ十日能力 vs スキル十日能力

混同注意。**別の値**。

| | キャラ十日能力 | スキル十日能力 |
|---|---|---|
| 参照 | `BaseStates.TenDayValues(IsSkillEffect)` | `BaseSkill.TenDayValues(IsCradle)` |
| 武器ボーナス | **あり** | **なし** |
| ATK/DEF/EYE/AGIへの影響 | あり（係数を通じて） | なし |
| ゆりかごへの影響 | 使いこなし度で素値のみ参照 | スキルレベルで変動 |

---

## 10. スキル特殊判別ごとの計算差異まとめ

### 10.1 TLOA固有

| 項目 | 通常 | TLOA |
|---|---|---|
| SkillPower参照レベル | `_nowSkillLevel` | `_cradleSkillLevel`（ゆりかご） |
| 精神補正適用率 | 20% | **40%** |
| HP38%以下 | 変化なし | ダメージ**0.7倍** |
| 殺しきれない | なし（CantKill別） | 3.4%止め（パッシブ5で10%止め） |
| ライバハル蓄積 | なし | 命中時に被害者に蓄積 |

### 10.2 魔法固有

| 項目 | 通常 | 魔法 |
|---|---|---|
| ダメージ計算式 | `(ATK-DEF)×SP + SP` | `MagicBlend×(SP×0.5) + SP×ATK×0.09` |
| 精神ダメージ式 | `(ATK×余裕-MentalDEF)×SPm + SPm` | `ATK×余裕/MentalDEF×(SPm×0.6) + SPm×0.7` |
| ATK<DEF時 | ダメージ激減 | **最低保証あり**（除算計算にブレンド） |
| 命中失敗時 | 完全回避 | 1/3で**かすりに格上げ** |

### 10.3 刃物固有

| 項目 | 通常 | 刃物 |
|---|---|---|
| 精神補正（本体） | 通常適用 | 刃物**武器**で**1.0固定**（精神補正なし） |
| 精神補正（精神HP向け） | 通常適用 | 通常適用（例外なし） |
| 即死クリティカル | なし | `atkerBlade/150×5/12×100`%で発生判定 |
| 互角一撃生存 | あり | **なし**（刃物は互角一撃を免除） |

---

## 11. 計算全体フロー図

```
AttackChara() 開始
  │
  ├─ spread = スキル分散割合の取得
  │
  └─ 対象ごとに ReactionSkillOnBattle()
       │
       ├─ 命中判定: IsReactHIT() → HitResult
       │    └─ SkillHitPer + supremacy vs Random(100)
       │
       ├─ 攻撃系:
       │    ├─ ComputeSkillPowers() → skillPower, skillPowerForMental
       │    │    ├─ SkillPowerCalc(IsTLOA) × 精神補正(20%/40%) × spread
       │    │    └─ SkillPowerForMentalCalc(IsTLOA) × 精神補正(100%) × spread
       │    │
       │    └─ DamageOnBattle(skillPower, skillPowerForMental, hitResult)
       │         ├─ 基本計算: (ATK-DEF)×SP + SP  or  MagicBlend
       │         ├─ 補正チェーン: 山型→物理耐性→パッシブ→がむしゃら→慣れ
       │         ├─ VitalLayer → 刃物即死 → 命中段階 → TLOA減衰
       │         └─ HP -= ダメージ → 殺せない制限 → OnKill判定
       │
       ├─ 回復系:
       │    ├─ ComputeSkillPowers() → skillPower（同じ関数）
       │    └─ Heal(skillPower) → HP += skillPower × パッシブ回復率
       │
       ├─ パッシブ付与/除去
       ├─ VitalLayer付与/除去
       ├─ ライバハル蓄積（TLOA命中時）
       └─ 被害記録(DamageData)作成
```

---

## 12. 実装箇所一覧

| ファイル | 主な内容 |
|---|---|
| `BaseSkill.SkillPowe.cs` | SkillPower計算、精神攻撃率分配 |
| `BaseSkill.TenDays.cs` | スキル印象構造（十日能力値） |
| `BaseSkill.SkillHit.cs` | 命中率計算 |
| `BaseSkill.SkillLevel.cs` | スキルレベル、ゆりかご計算 |
| `BaseSkill.PowerSpread.cs` | 分散割合 |
| `BaseSkill.MentalDamageRatio.cs` | 精神攻撃率 |
| `BaseSkill.Core.cs` | スキル性質フラグ、SkillType定義 |
| `BaseStates.StatesNumber.cs:253-610` | ATK/DEF/EYE/AGI計算、b_ATK/b_DEF |
| `BaseStates.StatesNumber.cs:680-706` | キャラ十日能力（武器ボーナス込み） |
| `BaseStates.ATKCalc.cs` | スキル攻撃補正率（落ち着き平準化） |
| `BaseStates.Damage.cs:449-613` | DamageOnBattle（メインダメージ処理） |
| `BaseStates.Damage.cs:778-855` | 非魔法/魔法/精神 各計算式 |
| `BaseStates.ReactionSkill.cs:21-32` | ComputeSkillPowers |
| `BaseStates.ReactionSkill.cs:700-950` | スキル実行メインフロー |
| `BaseStates.ReactionSkill.cs:1068-1083` | 精神補正(スキルvs被害者) |
| `BaseWeapon.cs:115-151` | 武器上昇能力データ構造 |
| `AllySkill.cs:55-59` | 味方SkillPowerオーバーライド |

---

## 設計メモソース

- `豚のスキル.md` — スキル全般の設計メモ（本仕様書の原典）
- `豚のライバハル.md` — ライバハル設計メモ
- `スキルレベル.md` — ゆりかご設計メモ
